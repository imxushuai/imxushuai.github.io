---
title: Spring Cloud Alibaba ä»å…¥é—¨åˆ°ç²¾é€š
tags:
  - Spring Cloud
  - Spring Cloud Alibaba
  - Nacos
  - Nacos Config
  - Sentinel
  - Gateway
  - Sleuth
  - Zipkin
  - RocketMQ
  - Seata
categories:
  - - Spring Cloud
    - Spring Cloud Alibaba
date: 2021-11-28 01:54:09
---

<center><i>Spring Cloud Alibaba å…¨ç»„ä»¶ä»å…¥é—¨åˆ°ç²¾é€š</i></center>

![](https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/9215dc9a1d37c4eb444cd3770d2ea261b48b318d/20211128020051.png)

<!-- more -->

> Spring Boot AlibabaæŠ€æœ¯æ ˆä»‹ç»ä¸å®è·µ

# SpringCloud Alibabaä»‹ç»

â€‹		`Spring Cloud Alibaba` è‡´åŠ›äºæä¾›å¾®æœåŠ¡å¼€å‘çš„ä¸€ç«™å¼è§£å†³æ–¹æ¡ˆã€‚æ­¤é¡¹ç›®åŒ…å«å¼€å‘åˆ†å¸ƒå¼åº”ç”¨å¾®æœåŠ¡çš„å¿…éœ€ç»„ä»¶ï¼Œæ–¹ä¾¿å¼€å‘è€…é€šè¿‡ `Spring Cloud` ç¼–ç¨‹æ¨¡å‹è½»æ¾ä½¿ç”¨è¿™äº›ç»„ä»¶æ¥å¼€å‘åˆ†å¸ƒå¼åº”ç”¨æœåŠ¡ã€‚
â€‹		ä¾æ‰˜ `Spring Cloud Alibaba`ï¼Œæ‚¨åªéœ€è¦æ·»åŠ ä¸€äº›æ³¨è§£å’Œå°‘é‡é…ç½®ï¼Œå°±å¯ä»¥å°† `Spring Cloud` åº”ç”¨æ¥å…¥é˜¿é‡Œå¾®æœåŠ¡è§£å†³æ–¹æ¡ˆï¼Œé€šè¿‡é˜¿é‡Œä¸­é—´ä»¶æ¥è¿…é€Ÿæ­å»ºåˆ†å¸ƒå¼åº”ç”¨ç³»ç»Ÿã€‚

## ä¸»è¦åŠŸèƒ½

- æœåŠ¡é™æµé™çº§

  é»˜è®¤æ”¯æŒ `WebServlet`ã€`WebFlux`ï¼Œ `OpenFeign`ã€`RestTemplate`ã€`Spring Cloud Gateway`ï¼Œ`Zuul`ï¼Œ`Dubbo`å’Œ`RocketMQ`é™æµé™çº§åŠŸèƒ½çš„æ¥å…¥ï¼Œå¯ä»¥åœ¨è¿è¡Œæ—¶é€šè¿‡æ§åˆ¶å°å®æ—¶ä¿®æ”¹é™æµé™çº§è§„åˆ™ï¼Œè¿˜æ”¯æŒæŸ¥çœ‹é™æµé™çº§`Metrics`ç›‘æ§ã€‚

- æœåŠ¡æ³¨å†Œä¸å‘ç°

  é€‚é… `Spring Cloud` æœåŠ¡æ³¨å†Œä¸å‘ç°æ ‡å‡†ï¼Œé»˜è®¤é›†æˆäº†`Ribbon`çš„æ”¯æŒã€‚

- åˆ†å¸ƒå¼é…ç½®ç®¡ç†

  æ”¯æŒåˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„å¤–éƒ¨åŒ–é…ç½®ï¼Œé…ç½®æ›´æ”¹æ—¶è‡ªåŠ¨åˆ·æ–°ã€‚

- æ¶ˆæ¯é©±åŠ¨èƒ½åŠ›

  åŸºäº `Spring Cloud Stream` ä¸ºå¾®æœåŠ¡åº”ç”¨æ„å»ºæ¶ˆæ¯é©±åŠ¨èƒ½åŠ›ã€‚

- åˆ†å¸ƒå¼äº‹åŠ¡

  ä½¿ç”¨ `@GlobalTransactional` æ³¨è§£ï¼Œ é«˜æ•ˆå¹¶ä¸”å¯¹ä¸šåŠ¡é›¶ä¾µå…¥åœ°è§£å†³åˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜ã€‚

- é˜¿é‡Œäº‘å¯¹è±¡å­˜å‚¨

  é˜¿é‡Œäº‘æä¾›çš„æµ·é‡ã€å®‰å…¨ã€ä½æˆæœ¬ã€é«˜å¯é çš„äº‘å­˜å‚¨æœåŠ¡ã€‚æ”¯æŒåœ¨ä»»ä½•åº”ç”¨ã€ä»»
  ä½•æ—¶é—´ã€ä»»ä½•åœ°ç‚¹å­˜å‚¨å’Œè®¿é—®ä»»æ„ç±»å‹çš„æ•°æ®ã€‚

- åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦

  æä¾›ç§’çº§ã€ç²¾å‡†ã€é«˜å¯é ã€é«˜å¯ç”¨çš„å®šæ—¶ï¼ˆåŸºäº `Cron` è¡¨è¾¾å¼ï¼‰ä»»åŠ¡è°ƒåº¦æœåŠ¡ã€‚
  åŒæ—¶æä¾›åˆ†å¸ƒå¼çš„ä»»åŠ¡æ‰§è¡Œæ¨¡å‹ï¼Œå¦‚ç½‘æ ¼ä»»åŠ¡ã€‚ç½‘æ ¼ä»»åŠ¡æ”¯æŒæµ·é‡å­ä»»åŠ¡å‡åŒ€åˆ†é…åˆ°æ‰€æœ‰
  `Workerï¼ˆschedulerx-clientï¼‰`ä¸Šæ‰§è¡Œã€‚

- é˜¿é‡Œäº‘çŸ­ä¿¡æœåŠ¡

  è¦†ç›–å…¨çƒçš„çŸ­ä¿¡æœåŠ¡ï¼Œå‹å¥½ã€é«˜æ•ˆã€æ™ºèƒ½çš„äº’è”åŒ–é€šè®¯èƒ½åŠ›ï¼Œå¸®åŠ©ä¼ä¸šè¿…é€Ÿæ­å»ºå®¢æˆ·è§¦è¾¾é€šé“ã€‚

## ç»„ä»¶

- Sentinel

  æŠŠæµé‡ä½œä¸ºåˆ‡å…¥ç‚¹ï¼Œä»æµé‡æ§åˆ¶ã€ç†”æ–­é™çº§ã€ç³»ç»Ÿè´Ÿè½½ä¿æŠ¤ç­‰å¤šä¸ªç»´åº¦ä¿æŠ¤æœåŠ¡çš„ç¨³å®šæ€§ã€‚

- Nacos

  ä¸€ä¸ªæ›´æ˜“äºæ„å»ºäº‘åŸç”Ÿåº”ç”¨çš„åŠ¨æ€æœåŠ¡å‘ç°ã€é…ç½®ç®¡ç†å’ŒæœåŠ¡ç®¡ç†å¹³å°ã€‚

- RocketMQ

  ä¸€æ¬¾å¼€æºçš„åˆ†å¸ƒå¼æ¶ˆæ¯ç³»ç»Ÿï¼ŒåŸºäºé«˜å¯ç”¨åˆ†å¸ƒå¼é›†ç¾¤æŠ€æœ¯ï¼Œæä¾›ä½å»¶æ—¶çš„ã€é«˜å¯é çš„æ¶ˆæ¯å‘å¸ƒä¸è®¢é˜…æœåŠ¡ã€‚

- Dubbo

  `Apache Dubbo` æ˜¯ä¸€æ¬¾é«˜æ€§èƒ½ `Java RPC` æ¡†æ¶ã€‚

- Seata

  é˜¿é‡Œå·´å·´å¼€æºäº§å“ï¼Œä¸€ä¸ªæ˜“äºä½¿ç”¨çš„é«˜æ€§èƒ½å¾®æœåŠ¡åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆã€‚

- Sentinel

  é˜¿é‡Œå¼€æºçš„ä¸€å¥—ç”¨äºæœåŠ¡å®¹é”™çš„ç»¼åˆæ€§è§£å†³æ–¹æ¡ˆã€‚å®ƒä»¥æµé‡ä¸ºåˆ‡å…¥ç‚¹, ä»æµé‡æ§åˆ¶ã€ç†”æ–­é™çº§ã€ç³»ç»Ÿè´Ÿè½½ä¿æŠ¤ç­‰å¤šä¸ªç»´åº¦æ¥ä¿æŠ¤æœåŠ¡çš„ç¨³å®šæ€§ã€‚

- Spring Cloud Gateway

  Spring Cloud Gatewayæ˜¯Springå…¬å¸åŸºäºSpring 5.0ï¼ŒSpring Boot 2.0 å’Œ Project Reactor ç­‰æŠ€æœ¯å¼€å‘çš„ç½‘å…³ï¼Œå®ƒæ—¨åœ¨ä¸ºå¾®æœåŠ¡æ¶æ„æä¾›ä¸€ç§ç®€å•æœ‰æ•ˆçš„ç»Ÿä¸€çš„ API è·¯ç”±ç®¡ç†æ–¹å¼ã€‚

- Spring Cloud Sleuth

  â€‹      ä¸»è¦åŠŸèƒ½å°±æ˜¯åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­æä¾›è¿½è¸ªè§£å†³æ–¹æ¡ˆã€‚

- RocketMQ

  Rocketmqæ˜¯ä¸€æ¬¾åˆ†å¸ƒå¼ï¼Œé˜Ÿåˆ—æ¨¡å‹çš„æ¶ˆæ¯ä¸­é—´ä»¶ï¼Œç”±é˜¿é‡Œå·´å·´ç ”å‘ï¼Œå€Ÿé‰´å‚è€ƒäº†JMSè§„èŒƒçš„MQå®ç°ï¼Œæ›´å‚è€ƒäº†ä¼˜ç§€çš„å¼€æºæ¶ˆæ¯ä¸­é—´ä»¶KAFKAï¼Œå¹¶ä¸”ç»“åˆé˜¿é‡Œå®é™…ä¸šåŠ¡éœ€æ±‚åœ¨å¤©çŒ«åŒåä¸€çš„åœºæ™¯ï¼Œå®ç°ä¸šåŠ¡å‰Šå³°

# Spring Cloud Alibabaå…¨ç»„ä»¶æ¡ˆä¾‹

> Tipsï¼šä¸‹é¢çš„å®è·µï¼Œæ˜¯æˆ‘åœ¨é»‘é©¬å®˜ç½‘æ‰¾çš„è§†é¢‘ä¸­çš„å®è·µï¼Œä½¿ç”¨çš„æ˜¯ç”¨æˆ·-å•†å“-è®¢å•æœåŠ¡çš„æ¡ˆä¾‹ã€‚ä¸ªäººè§‰å¾—è¿™ç§ç»“åˆæ¡ˆä¾‹è®²è§£æ˜¯å¾ˆå¥½çš„æ–¹æ³•ã€‚

## ä»£ç è·å–

Githubåœ°å€ï¼šğŸ‘‰[https://github.com/imxushuai/springcloud-alibaba](https://github.com/imxushuai/springcloud-alibaba)ğŸ‘ˆ

## ç¯å¢ƒæ­å»º

### æŠ€æœ¯é€‰å‹

JDKï¼š1.8

Mavenï¼š3.3.9åŠä»¥ä¸Š

æ•°æ®åº“ï¼šMySQL 5.7

Spring Cloud Alibabaï¼š2.1.0.RELEASEï¼ˆå¯¹æ ‡Spring Cloudçš„Gç‰ˆï¼‰

> å°½é‡ä¿å­˜ç‰ˆæœ¬ä¸€è‡´ï¼Œå¯ä»¥é¿å…ä¸€äº›é—®é¢˜ã€‚

### æ¡ˆä¾‹æ¨¡å—

| æ¨¡å—å                      | æè¿°                           | ç«¯å£å· |
| --------------------------- | ------------------------------ | ------ |
| springcloud-alibaba         | çˆ¶å·¥ç¨‹                         |        |
| springcloud-alibaba-common  | å…¬å…±æ¨¡å—ï¼Œå­˜æ”¾å®ä½“ç±»å’Œå·¥å…·ç±»ç­‰ |        |
| springcloud-alibaba-user    | ç”¨æˆ·å¾®æœåŠ¡                     | 807x   |
| springcloud-alibaba-product | å•†å“å¾®æœåŠ¡                     | 808x   |
| springcloud-alibaba-order   | è®¢å•å¾®æœåŠ¡                     | 809x   |

## åˆ›å»ºçˆ¶å·¥ç¨‹

> é¦–å…ˆï¼Œåˆ›å»ºä¸€ä¸ªmavené¡¹ç›®

### pom.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <groupId>org.example</groupId>
    <artifactId>springcloud-alibaba</artifactId>
    <packaging>pom</packaging>
    <version>1.0-SNAPSHOT</version>
    <modules>
        <module>springcloud-alibaba-common</module>
        <module>springcloud-alibaba-user</module>
        <module>springcloud-alibaba-product</module>
        <module>springcloud-alibaba-order</module>
    </modules>

    <parent>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-parent</artifactId>
        <version>2.1.3.RELEASE</version>
    </parent>

    <properties>
        <java.version>1.8</java.version>
        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
        <project.reporting.outputEncoding>UTF8</project.reporting.outputEncoding>
        <spring-cloud.version>Greenwich.RELEASE</spring-cloud.version>
        <spring-cloud-alibaba.version>2.1.0.RELEASE</spring-cloud-alibaba.version>
    </properties>

    <dependencyManagement>
        <dependencies>
            <dependency>
                <groupId>org.springframework.cloud</groupId>
                <artifactId>spring-cloud-dependencies</artifactId>
                <version>${spring-cloud.version}</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
            <dependency>
                <groupId>com.alibaba.cloud</groupId>
                <artifactId>spring-cloud-alibaba-dependencies</artifactId>
                <version>${spring-cloud-alibaba.version}</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
        </dependencies>
    </dependencyManagement>


</project>
```

## åˆ›å»ºå…¬å…±æ¨¡å—

> åˆ›å»ºä¸€ä¸ªmavené¡¹ç›®

### pom.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <artifactId>springcloud-alibaba</artifactId>
        <groupId>org.example</groupId>
        <version>1.0-SNAPSHOT</version>
    </parent>
    <modelVersion>4.0.0</modelVersion>

    <artifactId>springcloud-alibaba-common</artifactId>

    <dependencies>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-jpa</artifactId>
        </dependency>
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
        </dependency>
        <dependency>
            <groupId>com.alibaba</groupId>
            <artifactId>fastjson</artifactId>
            <version>1.2.56</version>
        </dependency>
        <dependency>
            <groupId>mysql</groupId>
            <artifactId>mysql-connector-java</artifactId>
            <version>5.1.6</version>
        </dependency>
    </dependencies>


</project>
```

### ç¼–å†™å®ä½“ç±»

1. Userï¼ˆç”¨æˆ·å®ä½“ç±»ï¼‰

   ```java
   package com.springcloud.alibaba.common.entity;
   
   import lombok.Data;
   
   import javax.persistence.Entity;
   import javax.persistence.GeneratedValue;
   import javax.persistence.GenerationType;
   import javax.persistence.Id;
   
   @Data
   @Entity(name = "shop_user")
   public class User {
   
       @Id
       @GeneratedValue(strategy = GenerationType.IDENTITY)
       private Integer uid;
   
       private String username;
   
       private String password;
   
       private String telephone;
   
   }
   ```

2. Productï¼ˆå•†å“å®ä½“ç±»ï¼‰

   ```java
   package com.springcloud.alibaba.common.entity;
   
   import lombok.Data;
   
   import javax.persistence.Entity;
   import javax.persistence.GeneratedValue;
   import javax.persistence.GenerationType;
   import javax.persistence.Id;
   
   @Data
   @Entity(name = "shop_product")
   public class Product {
   
       @Id
       @GeneratedValue(strategy = GenerationType.IDENTITY)
       private Integer pid;
   
       /**
        * å•†å“åç§°
        */
       private String pname;
   
       /**
        * å•†å“ä»·æ ¼
        */
       private Double pprice;
   
       /**
        * å•†å“åº“å­˜
        */
       private Integer stock;
   
   }
   ```

3. Orderï¼ˆè®¢å•å®ä½“ç±»ï¼‰

   ```java
   package com.springcloud.alibaba.common.entity;
   
   import lombok.Data;
   
   import javax.persistence.Entity;
   import javax.persistence.GeneratedValue;
   import javax.persistence.GenerationType;
   import javax.persistence.Id;
   
   @Data
   @Entity(name = "shop_order")
   public class Order {
   
       @Id
       @GeneratedValue(strategy = GenerationType.IDENTITY)
       private Long oid;
   
       /**
        * ç”¨æˆ·id
        */
       private Integer uid;
   
       /**
        * ç”¨æˆ·å
        */
       private String username;
   
       /**
        * å•†å“id
        */
       private Integer pid;
   
       /**
        * å•†å“åç§°
        */
       private String pname;
   
       /**
        * å•†å“å•ä»·
        */
       private Double pprice;
   
       /**
        * è´­ä¹°æ•°é‡
        */
       private Integer number;
   
   
   }
   ```

## åˆ›å»ºç”¨æˆ·å¾®æœåŠ¡

> åˆ›å»ºä¸€ä¸ªmavené¡¹ç›®

### pom.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <artifactId>springcloud-alibaba</artifactId>
        <groupId>org.example</groupId>
        <version>1.0-SNAPSHOT</version>
    </parent>
    <modelVersion>4.0.0</modelVersion>

    <artifactId>springcloud-alibaba-user</artifactId>

    <dependencies>
        <dependency>
            <groupId>org.example</groupId>
            <artifactId>springcloud-alibaba-common</artifactId>
            <version>1.0-SNAPSHOT</version>
        </dependency>
    </dependencies>

</project>
```

### ç¼–å†™Spring Bootå¯åŠ¨ç±»

```java
package com.springcloud.alibaba.user;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.boot.autoconfigure.domain.EntityScan;

@SpringBootApplication
@EntityScan("com.springcloud.alibaba.common.entity")
public class UserApplication {
    public static void main(String[] args) {
        SpringApplication.run(UserApplication.class, args);
    }
}
```

### ç¼–å†™application.ymlé…ç½®æ–‡ä»¶

```yml
server:
  port: 8071
spring:
  application:
    name: service-user
  datasource:
    driver-class-name: com.mysql.jdbc.Driver
    url: jdbc:mysql:///shop?serverTimezone=UTC&useUnicode=true&characterEncoding=utf-8&useSSL=true
    username: root
    password: root
  jpa:
    properties:
      hibernate:
        hbm2ddl:
          auto: update
        dialect: org.hibernate.dialect.MySQL5InnoDBDialect
```

## åˆ›å»ºå•†å“å¾®æœåŠ¡

> åˆ›å»ºä¸€ä¸ªmavené¡¹ç›®

### pom.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <artifactId>springcloud-alibaba</artifactId>
        <groupId>org.example</groupId>
        <version>1.0-SNAPSHOT</version>
    </parent>
    <modelVersion>4.0.0</modelVersion>

    <artifactId>springcloud-alibaba-product</artifactId>


    <dependencies>
        <dependency>
            <groupId>org.example</groupId>
            <artifactId>springcloud-alibaba-common</artifactId>
            <version>1.0-SNAPSHOT</version>
        </dependency>

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
    </dependencies>
</project>
```

### ç¼–å†™Spring Bootå¯åŠ¨ç±»

```java
package com.springcloud.alibaba.product;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.boot.autoconfigure.domain.EntityScan;

@SpringBootApplication
@EntityScan("com.springcloud.alibaba.common.entity")
public class ProductApplication {
    public static void main(String[] args) {
        SpringApplication.run(ProductApplication.class, args);
    }
}
```

### ç¼–å†™application.ymlé…ç½®æ–‡ä»¶

```yml
server:
  port: 8081
spring:
  application:
    name: service-product
  datasource:
    driver-class-name: com.mysql.jdbc.Driver
    url: jdbc:mysql:///shop?serverTimezone=UTC&useUnicode=true&characterEncoding=utf-8&useSSL=true
    username: root
    password: root
  jpa:
    properties:
      hibernate:
        hbm2ddl:
          auto: update
        dialect: org.hibernate.dialect.MySQL5InnoDBDialect
```

### åŸºç¡€ä»£ç ç¼–å†™

1. dao

   ```java
   package com.springcloud.alibaba.product.repository;
   
   import com.springcloud.alibaba.common.entity.Product;
   import org.springframework.data.jpa.repository.JpaRepository;
   
   public interface ProductRepository extends JpaRepository<Product, Integer> {
   }
   ```

2. service

   ```java
   package com.springcloud.alibaba.product.service;
   
   import com.springcloud.alibaba.common.entity.Product;
   import com.springcloud.alibaba.product.repository.ProductRepository;
   import org.springframework.beans.factory.annotation.Autowired;
   import org.springframework.stereotype.Service;
   
   @Service
   public class ProductService {
   
       @Autowired
       private ProductRepository productRepository;
   
       public Product findByPid(Integer pid) {
           return productRepository.findById(pid).orElse(null);
       }
   }
   ```

3. controller

   ```java
   package com.springcloud.alibaba.product.controller;
   
   import com.alibaba.fastjson.JSON;
   import com.springcloud.alibaba.common.entity.Product;
   import com.springcloud.alibaba.product.service.ProductService;
   import lombok.extern.slf4j.Slf4j;
   import org.springframework.beans.factory.annotation.Autowired;
   import org.springframework.web.bind.annotation.GetMapping;
   import org.springframework.web.bind.annotation.PathVariable;
   import org.springframework.web.bind.annotation.RestController;
   
   @Slf4j
   @RestController
   public class ProductController {
   
       @Autowired
       private ProductService productService;
   
       @GetMapping("product/{pid}")
       public Product product(@PathVariable Integer pid) {
           Product product = productService.findByPid(pid);
           log.info(">> æŸ¥è¯¢åˆ°å•†å“: {}", JSON.toJSONString(product));
           return product;
       }
   
   
   }
   ```

### æ•°æ®æ’å…¥

> æ•°æ®åº“éœ€è¦æå‰å»ºå¥½ï¼Œå¯åŠ¨é¡¹ç›®åï¼Œ`JPA`ä¼šè‡ªåŠ¨å»ºè¡¨

è¿è¡Œä¸‹æ–¹`SQL`è¯­å¥

```sql
INSERT INTO shop_product VALUE(NULL,'å°ç±³','1000','5000');
INSERT INTO shop_product VALUE(NULL,'åä¸º','2000','5000');
INSERT INTO shop_product VALUE(NULL,'è‹¹æœ','3000','5000');
INSERT INTO shop_product VALUE(NULL,'OPPO','4000','5000');
```

### æµ‹è¯•API

ä½¿ç”¨æµè§ˆå™¨æˆ–è€…`PostMan`è°ƒç”¨ï¼š`http://localhost:8081/product/1`

![](https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/524ea5f8113803ae3ef5f2dd3e451bfe458b8ec2/20201027173305.png)

## åˆ›å»ºè®¢å•å¾®æœåŠ¡

> åˆ›å»ºä¸€ä¸ªmavené¡¹ç›®

### pom.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <artifactId>springcloud-alibaba</artifactId>
        <groupId>org.example</groupId>
        <version>1.0-SNAPSHOT</version>
    </parent>
    <modelVersion>4.0.0</modelVersion>

    <artifactId>springcloud-alibaba-order</artifactId>

    <dependencies>
        <dependency>
            <groupId>org.example</groupId>
            <artifactId>springcloud-alibaba-common</artifactId>
            <version>1.0-SNAPSHOT</version>
        </dependency>

        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-web</artifactId>
        </dependency>
    </dependencies>

</project>
```

### ç¼–å†™Spring Bootå¯åŠ¨ç±»

```java
package com.springcloud.alibaba.order;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.boot.autoconfigure.domain.EntityScan;
import org.springframework.context.annotation.Bean;
import org.springframework.web.client.RestTemplate;

@SpringBootApplication
@EntityScan("com.springcloud.alibaba.common.entity")
public class OrderApplication {
    public static void main(String[] args) {
        SpringApplication.run(OrderApplication.class, args);
    }

    @Bean
    public RestTemplate getRestTemplate() {
        return new RestTemplate();
    }
}
```

### ç¼–å†™application.ymlé…ç½®æ–‡ä»¶

```yaml
server:
  port: 8091
spring:
  application:
    name: service-order
  datasource:
    driver-class-name: com.mysql.jdbc.Driver
    url: jdbc:mysql:///shop?serverTimezone=UTC&useUnicode=true&characterEncoding=utf-8&useSSL=true
    username: root
    password: root
  jpa:
    properties:
      hibernate:
        hbm2ddl:
          auto: update
        dialect: org.hibernate.dialect.MySQL5InnoDBDialect
```

### åŸºç¡€ä»£ç ç¼–å†™

1. dao

   ```java
   package com.springcloud.alibaba.order.repository;
   
   import com.springcloud.alibaba.common.entity.Order;
   import org.springframework.data.jpa.repository.JpaRepository;
   
   public interface OrderRepository extends JpaRepository<Order, Integer> {
   }
   ```

2. service

   ```java
   package com.springcloud.alibaba.order.service;
   
   import com.springcloud.alibaba.common.entity.Order;
   import com.springcloud.alibaba.order.repository.OrderRepository;
   import org.springframework.beans.factory.annotation.Autowired;
   import org.springframework.stereotype.Service;
   
   import java.util.List;
   
   @Service
   public class OrderService {
   
       @Autowired
       private OrderRepository orderRepository;
   
       public List<Order> findAll() {
           return orderRepository.findAll();
       }
   
       public void save(Order order) {
           orderRepository.save(order);
       }
   }
   ```

3. controller

   ```java
   package com.springcloud.alibaba.order.controller;
   
   import com.alibaba.fastjson.JSON;
   import com.springcloud.alibaba.common.entity.Order;
   import com.springcloud.alibaba.common.entity.Product;
   import com.springcloud.alibaba.order.service.OrderService;
   import lombok.extern.slf4j.Slf4j;
   import org.springframework.beans.factory.annotation.Autowired;
   import org.springframework.web.bind.annotation.GetMapping;
   import org.springframework.web.bind.annotation.PathVariable;
   import org.springframework.web.bind.annotation.RestController;
   import org.springframework.web.client.RestTemplate;
   
   import java.util.List;
   
   @Slf4j
   @RestController
   public class OrderController {
   
       @Autowired
       private OrderService orderService;
   
       @Autowired
       private RestTemplate restTemplate;
   
       @GetMapping("order")
       public List<Order> orderList() {
           return orderService.findAll();
       }
   
       //å‡†å¤‡ä¹°1ä»¶å•†å“
       @GetMapping("/order/prod/{pid}")
       public Order order(@PathVariable("pid") Integer pid) {
           log.info(">> å®¢æˆ·ä¸‹å•ï¼Œè¿™æ—¶å€™è¦è°ƒç”¨å•†å“å¾®æœåŠ¡æŸ¥è¯¢å•†å“ä¿¡æ¯");
           //é€šè¿‡restTemplateè°ƒç”¨å•†å“å¾®æœåŠ¡
           Product product = restTemplate.getForObject("http://localhost:8081/product/" + pid, Product.class);
   
           if (product != null) {
               log.info(">> å•†å“ä¿¡æ¯,æŸ¥è¯¢ç»“æœ: {}", JSON.toJSONString(product));
               Order order = new Order();
               order.setUid(1);
               order.setUsername("æµ‹è¯•ç”¨æˆ·");
               order.setPid(product.getPid());
               order.setPname(product.getPname());
               order.setPprice(product.getPprice());
               order.setNumber(1);
               orderService.save(order);
   
               return order;
           }
   
           throw new RuntimeException("è´­ä¹°å¤±è´¥!");
       }
   
   }
   ```

### æµ‹è¯•API

ä½¿ç”¨æµè§ˆå™¨æˆ–è€…`PostMan`è°ƒç”¨ï¼š`http://localhost:8091/order/prod/1`

![](https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/e9b05fe3ff38131ead77a8964fbb5c81f863bd36/20201027181649.png)

# Spring Cloud Alibabaå®è·µ

## æœåŠ¡æ²»ç†ï¼ˆNacos Discoveryï¼‰

### ä»€ä¹ˆæ˜¯æœåŠ¡æ²»ç†

æœåŠ¡æ²»ç†æ˜¯å¾®æœåŠ¡æ¶æ„ä¸­æœ€æ ¸å¿ƒæœ€åŸºæœ¬çš„æ¨¡å—ã€‚ç”¨äºå®ç°å„ä¸ªå¾®æœåŠ¡çš„è‡ªåŠ¨åŒ–æ³¨å†Œä¸å‘ç°ã€‚

- **æœåŠ¡æ³¨å†Œï¼š**åœ¨æœåŠ¡æ²»ç†æ¡†æ¶ä¸­ï¼Œéƒ½ä¼šæ„å»ºä¸€ä¸ªæ³¨å†Œä¸­å¿ƒï¼Œæ¯ä¸ªæœåŠ¡å•å…ƒå‘æ³¨å†Œä¸­å¿ƒç™»è®°è‡ªå·±æä¾›æœ
  åŠ¡çš„è¯¦ç»†ä¿¡æ¯ã€‚å¹¶åœ¨æ³¨å†Œä¸­å¿ƒå½¢æˆä¸€å¼ æœåŠ¡çš„æ¸…å•ï¼ŒæœåŠ¡æ³¨å†Œä¸­å¿ƒéœ€è¦ä»¥å¿ƒè·³çš„æ–¹å¼å»ç›‘æµ‹æ¸…å•ä¸­
  çš„æœåŠ¡æ˜¯å¦å¯ç”¨ï¼Œå¦‚æœä¸å¯ç”¨ï¼Œéœ€è¦åœ¨æœåŠ¡æ¸…å•ä¸­å‰”é™¤ä¸å¯ç”¨çš„æœåŠ¡ã€‚
- **æœåŠ¡å‘ç°ï¼š**æœåŠ¡è°ƒç”¨æ–¹å‘æœåŠ¡æ³¨å†Œä¸­å¿ƒå’¨è¯¢æœåŠ¡ï¼Œå¹¶è·å–æ‰€æœ‰æœåŠ¡çš„å®ä¾‹æ¸…å•ï¼Œå®ç°å¯¹å…·ä½“æœåŠ¡å®
  ä¾‹çš„è®¿é—®ã€‚

![](https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/a50de8ca8de9e184a123008ce8ca8a439573530a/20201028223445.png)

é€šè¿‡ä¸Šé¢çš„è°ƒç”¨å›¾ä¼šå‘ç°ï¼Œé™¤äº†å¾®æœåŠ¡ï¼Œè¿˜æœ‰ä¸€ä¸ªç»„ä»¶æ˜¯æœåŠ¡æ³¨å†Œä¸­å¿ƒï¼Œå®ƒæ˜¯å¾®æœåŠ¡æ¶æ„éå¸¸é‡è¦çš„ä¸€ä¸ªç»„ä»¶ï¼Œåœ¨å¾®æœåŠ¡æ¶æ„é‡Œä¸»è¦èµ·åˆ°äº†åè°ƒè€…çš„ä¸€ä¸ªä½œç”¨ã€‚æ³¨å†Œä¸­å¿ƒä¸€èˆ¬åŒ…å«å¦‚ä¸‹å‡ ä¸ªåŠŸèƒ½ï¼š
1. æœåŠ¡å‘ç°ï¼š

  æœåŠ¡æ³¨å†Œï¼šä¿å­˜æœåŠ¡æä¾›è€…å’ŒæœåŠ¡è°ƒç”¨è€…çš„ä¿¡æ¯
  æœåŠ¡è®¢é˜…ï¼šæœåŠ¡è°ƒç”¨è€…è®¢é˜…æœåŠ¡æä¾›è€…çš„ä¿¡æ¯ï¼Œæ³¨å†Œä¸­å¿ƒå‘è®¢é˜…è€…æ¨é€æä¾›è€…çš„ä¿¡æ¯

2. æœåŠ¡é…ç½®ï¼š

  é…ç½®è®¢é˜…ï¼šæœåŠ¡æä¾›è€…å’ŒæœåŠ¡è°ƒç”¨è€…è®¢é˜…å¾®æœåŠ¡ç›¸å…³çš„é…ç½®
  é…ç½®ä¸‹å‘ï¼šä¸»åŠ¨å°†é…ç½®æ¨é€ç»™æœåŠ¡æä¾›è€…å’ŒæœåŠ¡è°ƒç”¨è€…

3. æœåŠ¡å¥åº·æ£€æµ‹

  æ£€æµ‹æœåŠ¡æä¾›è€…çš„å¥åº·æƒ…å†µï¼Œå¦‚æœå‘ç°å¼‚å¸¸ï¼Œæ‰§è¡ŒæœåŠ¡å‰”é™¤

### å¸¸è§çš„æ³¨å†Œä¸­å¿ƒ

- **Zookeeper**

  `zookeeper`æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼æœåŠ¡æ¡†æ¶ï¼Œæ˜¯`Apache Hadoop`çš„ä¸€ä¸ªå­é¡¹ç›®ï¼Œå®ƒä¸»è¦æ˜¯ç”¨æ¥è§£å†³åˆ†å¸ƒå¼åº”ç”¨ä¸­ç»å¸¸é‡åˆ°çš„ä¸€äº›æ•°æ®ç®¡ç†é—®é¢˜ï¼Œå¦‚ï¼šç»Ÿä¸€å‘½åæœåŠ¡ã€çŠ¶æ€åŒæ­¥æœåŠ¡ã€é›†ç¾¤ç®¡ç†ã€åˆ†å¸ƒå¼åº”ç”¨é…ç½®é¡¹çš„ç®¡ç†ç­‰ã€‚

- **Eureka**

  `Eureka`æ˜¯`Springcloud Netflix`ä¸­çš„é‡è¦ç»„ä»¶ï¼Œä¸»è¦ä½œç”¨å°±æ˜¯åšæœåŠ¡æ³¨å†Œå’Œå‘ç°ã€‚ä½†æ˜¯ç°åœ¨å·²ç»é—­
  æº

- **Consul**

  `Consul`æ˜¯åŸºäº`GO`è¯­è¨€å¼€å‘çš„å¼€æºå·¥å…·ï¼Œä¸»è¦é¢å‘åˆ†å¸ƒå¼ï¼ŒæœåŠ¡åŒ–çš„ç³»ç»Ÿæä¾›æœåŠ¡æ³¨å†Œã€æœåŠ¡å‘ç°å’Œé…ç½®ç®¡ç†çš„åŠŸèƒ½ã€‚`Consul`çš„åŠŸèƒ½éƒ½å¾ˆå®ç”¨ï¼Œå…¶ä¸­åŒ…æ‹¬ï¼šæœåŠ¡æ³¨å†Œ/å‘ç°ã€å¥åº·æ£€æŸ¥ã€Key/Valueå­˜å‚¨ã€å¤šæ•°æ®ä¸­å¿ƒå’Œåˆ†å¸ƒå¼ä¸€è‡´æ€§ä¿è¯ç­‰ç‰¹æ€§ã€‚`Consul`æœ¬èº«åªæ˜¯ä¸€ä¸ªäºŒè¿›åˆ¶çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œæ‰€ä»¥å®‰è£…å’Œéƒ¨ç½²éƒ½éå¸¸ç®€å•ï¼Œåªéœ€è¦ä»å®˜ç½‘ä¸‹è½½åï¼Œåœ¨æ‰§è¡Œå¯¹åº”çš„å¯åŠ¨è„šæœ¬å³å¯ã€‚

- **Nacos**

  `Nacos`æ˜¯ä¸€ä¸ªæ›´æ˜“äºæ„å»ºäº‘åŸç”Ÿåº”ç”¨çš„åŠ¨æ€æœåŠ¡å‘ç°ã€é…ç½®ç®¡ç†å’ŒæœåŠ¡ç®¡ç†å¹³å°ã€‚å®ƒæ˜¯`SpringCloud Alibaba`ç»„ä»¶ä¹‹ä¸€ï¼Œè´Ÿè´£æœåŠ¡æ³¨å†Œå‘ç°å’ŒæœåŠ¡é…ç½®ï¼Œå¯ä»¥è¿™æ ·è®¤ä¸ºæ³¨å†Œä¸­å¿ƒ + é…ç½®ä¸­å¿ƒã€‚

## Nacos

[Nacoså®˜ç½‘](https://nacos.io/zh-cn/)

### Nacoså®‰è£…

1. é¢„å¤‡ç¯å¢ƒå‡†å¤‡

   Nacos ä¾èµ– [Java](https://docs.oracle.com/cd/E19182-01/820-7851/inst_cli_jdk_javahome_t/) ç¯å¢ƒæ¥è¿è¡Œã€‚å¦‚æœæ‚¨æ˜¯ä»ä»£ç å¼€å§‹æ„å»ºå¹¶è¿è¡ŒNacosï¼Œè¿˜éœ€è¦ä¸ºæ­¤é…ç½® [Maven](https://maven.apache.org/index.html)ç¯å¢ƒï¼Œè¯·ç¡®ä¿æ˜¯åœ¨ä»¥ä¸‹ç‰ˆæœ¬ç¯å¢ƒä¸­å®‰è£…ä½¿ç”¨:

   1. 64 bit OSï¼Œæ”¯æŒ Linux/Unix/Mac/Windowsï¼Œæ¨èé€‰ç”¨ Linux/Unix/Macã€‚
   2. 64 bit JDK 1.8+ï¼›[ä¸‹è½½](http://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html) & [é…ç½®](https://docs.oracle.com/cd/E19182-01/820-7851/inst_cli_jdk_javahome_t/)ã€‚
   3. Maven 3.2.x+ï¼›[ä¸‹è½½](https://maven.apache.org/download.cgi) & [é…ç½®](https://maven.apache.org/settings.html)ã€‚

2. ä¸‹è½½æœ€æ–°çš„ç¨³å®šç‰ˆæœ¬

   ä»è¯¥åœ°å€[ä¸‹è½½åœ°å€](https://github.com/alibaba/nacos/releases)ä¸‹è½½æœ€æ–°çš„ç¨³å®šç‰ˆæœ¬ï¼Œæˆ‘è¿™é‡Œä½¿ç”¨çš„æ˜¯æœ€æ–°çš„ç¨³å®šç‰ˆï¼š1.3.2

3. è§£å‹ä¸‹è½½å¥½çš„å‹ç¼©åŒ…

4. å¯åŠ¨Nacos

   - Linux

     ```shell
     cd nacos/bin # è¿›å…¥nacosä¸‹çš„binç›®å½•
     ./startup.sh -m standalone # ä»¥å•æœºæ¨¡å¼å¯åŠ¨
     ```

   - Windows

     ```shell
     cd nacos/bin
     ./startup.cmd -m standalone
     ```

5. è®¿é—®ç½‘é¡µæ§åˆ¶å°

   è®¿é—®ï¼š[http://your-host:8848/nacos](http://localhost:8848/nacos)

   å¯ä»¥ç›´æ¥ç™»å½•ï¼Œè´¦å·å¯†ç ï¼šnacos/nacos

   ![](https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/b2b61f263f7de3040b606dfc7c925451a269fdce/20201028231144.png)

### æ³¨å†Œå•†å“å’Œè®¢å•å¾®æœåŠ¡åˆ°Nacos

æ³¨å†Œå•†å“ä»¥åŠè®¢å•å¾®æœåŠ¡åˆ°Nacosæ“ä½œç›¸åŒï¼Œå¦‚ä¸‹ï¼š

1. åœ¨å•†å“ä»¥åŠè®¢å•å¾®æœåŠ¡ä¸­åŠ å…¥`Nacos-client`ä¾èµ–

   ```xml
           <dependency>
               <groupId>com.alibaba.cloud</groupId>
               <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
           </dependency>
   ```

2. åœ¨å•†å“ä»¥åŠè®¢å•å¾®æœåŠ¡çš„å¯åŠ¨ç±»ä¸Šæ·»åŠ `@EnableDiscoveryClient`æ³¨è§£

3. åœ¨å•†å“ä»¥åŠè®¢å•å¾®æœåŠ¡çš„`application.yml`é…ç½®æ–‡ä»¶ä¸­é…ç½®`Nacos`çš„åœ°å€

   ```yaml
   spring:
     cloud:
       nacos:
         discovery:
           server-addr: 192.168.149.101:8848
   ```

4. ä¿®æ”¹`OrderController`ä»£ç é€»è¾‘ï¼Œä½¿ç”¨`DiscoveryClient`è·å–æœåŠ¡å®ä¾‹å¹¶ä»ä¸­è·å–æœåŠ¡IPåœ°å€å’Œç«¯å£å·è¿›è¡Œè¿œç¨‹è°ƒç”¨

   ```java
   //å‡†å¤‡ä¹°1ä»¶å•†å“
       @GetMapping("/order/prod/{pid}")
       public Order order(@PathVariable("pid") Integer pid) {
           log.info(">> å®¢æˆ·ä¸‹å•ï¼Œè¿™æ—¶å€™è¦è°ƒç”¨å•†å“å¾®æœåŠ¡æŸ¥è¯¢å•†å“ä¿¡æ¯");
   
           List<ServiceInstance> instances = discoveryClient.getInstances("service-product");
           if (instances != null && instances.size() > 0) {
               ServiceInstance serviceInstance = instances.get(0);
   
               //é€šè¿‡restTemplateè°ƒç”¨å•†å“å¾®æœåŠ¡
               Product product = restTemplate.getForObject(
                       "http://" + serviceInstance.getHost() + ":" + serviceInstance.getPort() + "/product/" + pid, Product.class);
   
               if (product != null) {
                   log.info(">> å•†å“ä¿¡æ¯,æŸ¥è¯¢ç»“æœ: {}", JSON.toJSONString(product));
                   Order order = new Order();
                   order.setUid(1);
                   order.setUsername("æµ‹è¯•ç”¨æˆ·");
                   order.setPid(product.getPid());
                   order.setPname(product.getPname());
                   order.setPprice(product.getPprice());
                   order.setNumber(1);
                   orderService.save(order);
   
                   return order;
               }
           }
   
           throw new RuntimeException("è´­ä¹°å¤±è´¥!");
       }
   ```

5. å¯åŠ¨è®¢å•å’Œå•†å“å¾®æœåŠ¡

   æŸ¥çœ‹`Nacos`æœåŠ¡åˆ—è¡¨

   ![](https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/d144e2802fcf87ecb6c51d058184bee2fabaa810/20201028234522.png)

6. **è°ƒç”¨è´­ä¹°å•†å“API**

   æˆåŠŸè°ƒç”¨è´­ä¹°å•†å“API

## è´Ÿè½½å‡è¡¡

### ä»€ä¹ˆæ˜¯è´Ÿè½½å‡è¡¡

è´Ÿè½½å‡è¡¡å°±æ˜¯å°†è´Ÿè½½ï¼ˆå·¥ä½œä»»åŠ¡ï¼Œè®¿é—®è¯·æ±‚ï¼‰è¿›è¡Œåˆ†æ‘Šåˆ°å¤šä¸ªæ“ä½œå•å…ƒï¼ˆæœåŠ¡å™¨,ç»„ä»¶ï¼‰ä¸Šè¿›è¡Œæ‰§è¡Œã€‚

æ ¹æ®è´Ÿè½½å‡è¡¡å‘ç”Ÿä½ç½®çš„ä¸åŒ,ä¸€èˆ¬åˆ†ä¸º**æœåŠ¡ç«¯è´Ÿè½½å‡è¡¡**å’Œ**å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡**ã€‚

æœåŠ¡ç«¯è´Ÿè½½å‡è¡¡æŒ‡çš„æ˜¯å‘ç”Ÿåœ¨æœåŠ¡æä¾›è€…ä¸€æ–¹,æ¯”å¦‚å¸¸è§çš„`nginx`è´Ÿè½½å‡è¡¡

è€Œå®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡æŒ‡çš„æ˜¯å‘ç”Ÿåœ¨æœåŠ¡è¯·æ±‚çš„ä¸€æ–¹ï¼Œä¹Ÿå°±æ˜¯åœ¨å‘é€è¯·æ±‚ä¹‹å‰å·²ç»é€‰å¥½äº†ç”±å“ªä¸ªå®ä¾‹å¤„ç†è¯·æ±‚ã€‚

![](https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/29b9288ac7ae1cdbf26980d754e11f2833c28a9d/20201028235442.png)

### Ribbonç»„ä»¶

ä½¿ç”¨`Ribbon`ç»„ä»¶å®Œæˆè´Ÿè½½å‡è¡¡è°ƒç”¨

1. åœ¨`RestTemplate`çš„`JavaBean`é…ç½®æ–¹æ³•ä¸ŠåŠ å…¥`@LoadBalanced`æ³¨è§£

   ```java
   	@Bean
       @LoadBalanced
       public RestTemplate getRestTemplate() {
           return new RestTemplate();
       }
   ```

2. ä¿®æ”¹ä»£ç ï¼Œä½¿ç”¨`RestTemplate`ä»¥åŠæœåŠ¡åç›´æ¥è°ƒç”¨API

   ```java
   //å‡†å¤‡ä¹°1ä»¶å•†å“
       @GetMapping("/order/prod/{pid}")
       public Order order(@PathVariable("pid") Integer pid) {
           log.info(">> å®¢æˆ·ä¸‹å•ï¼Œè¿™æ—¶å€™è¦è°ƒç”¨å•†å“å¾®æœåŠ¡æŸ¥è¯¢å•†å“ä¿¡æ¯");
           
           //é€šè¿‡restTemplateè°ƒç”¨å•†å“å¾®æœåŠ¡
           Product product = restTemplate.getForObject(
                   "http://product-service/product/" + pid, Product.class);
   
           if (product != null) {
               log.info(">> å•†å“ä¿¡æ¯,æŸ¥è¯¢ç»“æœ: {}", JSON.toJSONString(product));
               Order order = new Order();
               order.setUid(1);
               order.setUsername("æµ‹è¯•ç”¨æˆ·");
               order.setPid(product.getPid());
               order.setPname(product.getPname());
               order.setPprice(product.getPprice());
               order.setNumber(1);
               orderService.save(order);
   
               return order;
           }
   
           throw new RuntimeException("è´­ä¹°å¤±è´¥!");
       }
   ```

3. å¯åŠ¨å¤šä¸ª`Product`æœåŠ¡

4. è°ƒç”¨è´­ä¹°å•†å“API

### Ribbonæ”¯æŒçš„è´Ÿè½½å‡è¡¡ç­–ç•¥

`Ribbon`é»˜è®¤é‡‡ç”¨çš„æ˜¯è½®è¯¢

| ç­–ç•¥å                    | æè¿°                                                         | å®ç°è¯´æ˜                                                     |
| ------------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| BestAvailableRule         | é€‰æ‹©ä¸€ä¸ªæœ€å°çš„å¹¶å‘è¯·æ±‚çš„server                               | é€ä¸ªè€ƒå¯ŸServerï¼Œå¦‚æœServerè¢«trippedäº†ï¼Œåˆ™å¿½ç•¥ï¼Œåœ¨é€‰æ‹©å…¶ä¸­ActiveRequestsCountæœ€å°çš„server |
| AvailabilityFilteringRule | è¿‡æ»¤æ‰é‚£äº›å› ä¸ºä¸€ç›´è¿æ¥å¤±è´¥çš„è¢«æ ‡è®°ä¸ºcircuit trippedçš„åç«¯serverï¼Œå¹¶è¿‡æ»¤æ‰é‚£äº›é«˜å¹¶å‘çš„çš„åç«¯serverï¼ˆactiveconnections è¶…è¿‡é…ç½®çš„é˜ˆå€¼ï¼‰ | ä½¿ç”¨ä¸€ä¸ªAvailabilityPredicateæ¥åŒ…å«è¿‡æ»¤serverçš„é€»è¾‘ï¼Œå…¶å®å°±å°±æ˜¯æ£€æŸ¥statusé‡Œè®°å½•çš„å„ä¸ªserverçš„è¿è¡ŒçŠ¶æ€ |
| WeightedResponseTimeRule  | æ ¹æ®ç›¸åº”æ—¶é—´åˆ†é…ä¸€ä¸ªweightï¼Œç›¸åº”æ—¶é—´è¶Šé•¿ï¼Œweightè¶Šå°ï¼Œè¢«é€‰ä¸­çš„å¯èƒ½æ€§è¶Šä½ | ä¸€ä¸ªåå°çº¿ç¨‹å®šæœŸçš„ä»statusé‡Œé¢è¯»å–è¯„ä»·å“åº”æ—¶é—´ï¼Œä¸ºæ¯ä¸ªserverè®¡ç®—ä¸€ä¸ªweightã€‚Weightçš„è®¡ç®—ä¹Ÿæ¯”è¾ƒç®€å•responsetime å‡å»æ¯ä¸ªserverè‡ªå·±å¹³å‡çš„responsetimeæ˜¯serverçš„æƒé‡ã€‚å½“åˆšå¼€å§‹è¿è¡Œï¼Œæ²¡æœ‰å½¢æˆstatasæ—¶ï¼Œä½¿ç”¨roubineç­–ç•¥é€‰æ‹©server |
| RetryRule                 | å¯¹é€‰å®šçš„è´Ÿè½½å‡è¡¡ç­–ç•¥æœºä¸Šé‡è¯•æœºåˆ¶                             | åœ¨ä¸€ä¸ªé…ç½®æ—¶é—´æ®µå†…å½“é€‰æ‹©serverä¸æˆåŠŸï¼Œåˆ™ä¸€ç›´å°è¯•ä½¿ç”¨subRuleçš„æ–¹å¼é€‰æ‹©ä¸€ä¸ªå¯ç”¨çš„server |
| RoundRobinRule            | è½®è¯¢æ–¹å¼è½®è¯¢é€‰æ‹©server                                       | è½®è¯¢indexï¼Œé€‰æ‹©indexå¯¹åº”ä½ç½®çš„server                         |
| RandomRule                | éšæœºé€‰æ‹©ä¸€ä¸ªserver                                           | åœ¨indexä¸Šéšæœºï¼Œé€‰æ‹©indexå¯¹åº”ä½ç½®çš„server                     |
| ZoneAvoidanceRule         | å¤åˆåˆ¤æ–­serveræ‰€åœ¨åŒºåŸŸçš„æ€§èƒ½å’Œserverçš„å¯ç”¨æ€§é€‰æ‹©server       | ä½¿ç”¨ZoneAvoidancePredicateå’ŒAvailabilityPredicateæ¥åˆ¤æ–­æ˜¯å¦é€‰æ‹©æŸä¸ªserverï¼Œå‰ä¸€ä¸ªåˆ¤æ–­åˆ¤å®šä¸€ä¸ªzoneçš„è¿è¡Œæ€§èƒ½æ˜¯å¦å¯ç”¨ï¼Œå‰”é™¤ä¸å¯ç”¨çš„zoneï¼ˆçš„æ‰€æœ‰serverï¼‰ï¼ŒAvailabilityPredicateç”¨äºè¿‡æ»¤æ‰è¿æ¥æ•°è¿‡å¤šçš„Server |

é€šè¿‡å¦‚ä¸‹é…ç½®å¯ä»¥è¿›è¡Œå‡è¡¡è´Ÿè½½ç­–ç•¥çš„é…ç½®

```yaml
service-product: # è°ƒç”¨çš„æä¾›è€…çš„åç§°
  ribbon:
    NFLoadBalancerRuleClassName: com.netflix.loadbalancer.RandomRule
```

## FeignæœåŠ¡è°ƒç”¨

### ä»€ä¹ˆæ˜¯Feign

`Feign`æ˜¯`Spring Cloud`æä¾›çš„ä¸€ä¸ªå£°æ˜å¼çš„ä¼ªHttpå®¢æˆ·ç«¯ï¼Œ å®ƒä½¿å¾—è°ƒç”¨è¿œç¨‹æœåŠ¡å°±åƒè°ƒç”¨æœ¬åœ°æœåŠ¡ä¸€æ ·ç®€å•ï¼Œ åªéœ€è¦åˆ›å»ºä¸€ä¸ªæ¥å£å¹¶æ·»åŠ ä¸€ä¸ªæ³¨è§£å³å¯ã€‚

`Nacos`å¾ˆå¥½çš„å…¼å®¹äº†`Feign`ï¼Œ `Feign`é»˜è®¤é›†æˆäº†`Ribbon`ï¼Œ æ‰€ä»¥åœ¨`Nacos`ä¸‹ä½¿ç”¨`Fegin`é»˜è®¤å°±å®ç°äº†è´Ÿè½½å‡è¡¡çš„æ•ˆæœã€‚

### åŸºäºFeignå®ç°æœåŠ¡è°ƒç”¨

1. åŠ å…¥`Feign`ä¾èµ–

   ```xml
           <!--feginç»„ä»¶-->
           <dependency>
               <groupId>org.springframework.cloud</groupId>
               <artifactId>spring-cloud-starter-openfeign</artifactId>
           </dependency>
   ```

2. åœ¨è®¢å•å¾®æœåŠ¡çš„å¯åŠ¨ç±»åŠ ä¸Š`@EnableFeignClients`æ³¨è§£

3. ç¼–å†™`FeignClient`

   ```java
   package com.springcloud.alibaba.order.client;
   
   import com.springcloud.alibaba.common.entity.Product;
   import org.springframework.cloud.openfeign.FeignClient;
   import org.springframework.web.bind.annotation.GetMapping;
   import org.springframework.web.bind.annotation.PathVariable;
   
   @FeignClient("service-product")
   public interface ProductClient {
   
       @GetMapping("product/{pid}")
       Product findById(@PathVariable Integer pid);
   
   }
   ```

4. ä¿®æ”¹è´­ä¹°å•†å“é€»è¾‘ï¼Œè°ƒç”¨ç¼–å†™çš„FeignClientä¸­çš„æ–¹æ³•

   ```java
       @Autowired
       private ProductClient productClient;
   	//å‡†å¤‡ä¹°1ä»¶å•†å“
       @GetMapping("/order/prod/{pid}")
       public Order order(@PathVariable("pid") Integer pid) {
           log.info(">> å®¢æˆ·ä¸‹å•ï¼Œè¿™æ—¶å€™è¦è°ƒç”¨å•†å“å¾®æœåŠ¡æŸ¥è¯¢å•†å“ä¿¡æ¯");
           //é€šè¿‡Feignå®¢æˆ·ç«¯è°ƒç”¨
           Product product = productClient.findById(pid);
   
           if (product != null) {
               log.info(">> å•†å“ä¿¡æ¯,æŸ¥è¯¢ç»“æœ: {}", JSON.toJSONString(product));
               Order order = new Order();
               order.setUid(1);
               order.setUsername("æµ‹è¯•ç”¨æˆ·");
               order.setPid(product.getPid());
               order.setPname(product.getPname());
               order.setPprice(product.getPprice());
               order.setNumber(1);
               orderService.save(order);
   
               return order;
           }
   
           throw new RuntimeException("è´­ä¹°å¤±è´¥!");
       }
   ```

5. æµ‹è¯•è´­ä¹°å•†å“API

## æœåŠ¡å®¹é”™ï¼ˆSentinelï¼‰

### æœåŠ¡é›ªå´©

â€‹		åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­,ç”±äºç½‘ç»œåŸå› æˆ–è‡ªèº«çš„åŸå› ,æœåŠ¡ä¸€èˆ¬æ— æ³•ä¿è¯ 100% å¯ç”¨ã€‚å¦‚æœä¸€ä¸ªæœåŠ¡å‡ºç°äº†é—®é¢˜ï¼Œè°ƒç”¨è¿™ä¸ªæœåŠ¡å°±ä¼šå‡ºç°çº¿ç¨‹é˜»å¡çš„æƒ…å†µï¼Œæ­¤æ—¶è‹¥æœ‰å¤§é‡çš„è¯·æ±‚æ¶Œå…¥ï¼Œå°±ä¼šå‡ºç°å¤šæ¡çº¿ç¨‹é˜»å¡ç­‰å¾…ï¼Œè¿›è€Œå¯¼è‡´æœåŠ¡ç˜«ç—ªã€‚ 

â€‹		ç”±äºæœåŠ¡ä¸æœåŠ¡ä¹‹é—´çš„ä¾èµ–æ€§ï¼Œæ•…éšœä¼šä¼ æ’­ï¼Œä¼šå¯¹æ•´ä¸ªå¾®æœåŠ¡ç³»ç»Ÿé€ æˆç¾éš¾æ€§çš„ä¸¥é‡åæœï¼Œè¿™å°±æ˜¯æœåŠ¡æ•…éšœçš„ â€œé›ªå´©æ•ˆåº”â€ã€‚

![æœåŠ¡é›ªå´©](https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/956f8cedcf1da7c84f5ea8bcc4143402929ac358/20201102231726.png)

â€‹		é›ªå´©å‘ç”Ÿçš„åŸå› å¤šç§å¤šæ ·ï¼Œæœ‰ä¸åˆç†çš„å®¹é‡è®¾è®¡ï¼Œæˆ–è€…æ˜¯é«˜å¹¶å‘ä¸‹æŸä¸€ä¸ªæ–¹æ³•å“åº”å˜æ…¢ï¼Œäº¦æˆ–æ˜¯æŸå°æœºå™¨çš„èµ„æºè€—å°½ã€‚æˆ‘ä»¬æ— æ³•å®Œå…¨æœç»é›ªå´©æºå¤´çš„å‘ç”Ÿï¼Œåªæœ‰åšå¥½è¶³å¤Ÿçš„å®¹é”™ï¼Œä¿è¯åœ¨ä¸€ä¸ªæœåŠ¡å‘ç”Ÿé—®é¢˜ï¼Œä¸ä¼šå½±å“åˆ°å…¶å®ƒæœåŠ¡çš„æ­£å¸¸è¿è¡Œã€‚ä¹Ÿå°±æ˜¯ï¼‚é›ªè½è€Œä¸é›ªå´©ï¼‚ã€‚

### å¸¸è§çš„å®¹é”™æ–¹æ¡ˆ

å¸¸è§çš„å®¹é”™æ€è·¯æœ‰éš”ç¦»ã€è¶…æ—¶ã€é™æµã€ç†”æ–­ã€é™çº§

- éš”ç¦»

  å®ƒæ˜¯æŒ‡å°†ç³»ç»ŸæŒ‰ç…§ä¸€å®šçš„åŸåˆ™åˆ’åˆ†ä¸ºè‹¥å¹²ä¸ªæœåŠ¡æ¨¡å—ï¼Œå„ä¸ªæ¨¡å—ä¹‹é—´ç›¸å¯¹ç‹¬ç«‹ï¼Œæ— å¼ºä¾èµ–ã€‚å½“æœ‰æ•…éšœå‘ç”Ÿæ—¶ï¼Œèƒ½å°†é—®é¢˜å’Œå½±å“éš”ç¦»åœ¨æŸä¸ªæ¨¡å—å†…éƒ¨ï¼Œè€Œä¸æ‰©æ•£é£é™©ï¼Œä¸æ³¢åŠå…¶å®ƒæ¨¡å—ï¼Œä¸å½±å“æ•´ä½“çš„ç³»ç»ŸæœåŠ¡ã€‚å¸¸è§çš„éš”ç¦»æ–¹å¼æœ‰ï¼šçº¿ç¨‹æ± éš”ç¦»å’Œä¿¡å·é‡éš”ç¦»ã€‚

  ![](https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/d3b3ec28f0ff749039c4e705e9b1dfdb26400bfc/20201102231926.png)

- è¶…æ—¶

  åœ¨ä¸Šæ¸¸æœåŠ¡è°ƒç”¨ä¸‹æ¸¸æœåŠ¡çš„æ—¶å€™ï¼Œè®¾ç½®ä¸€ä¸ªæœ€å¤§å“åº”æ—¶é—´ï¼Œå¦‚æœè¶…è¿‡è¿™ä¸ªæ—¶é—´ï¼Œä¸‹æ¸¸æœªä½œå‡ºååº”ï¼Œå°±æ–­å¼€è¯·æ±‚ï¼Œé‡Šæ”¾æ‰çº¿ç¨‹ã€‚

  ![](https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/2e568e9e2cbc7d6daa20808ddc18704515f8fa5b/20201102232420.png)

- é™æµ

  é™æµå°±æ˜¯é™åˆ¶ç³»ç»Ÿçš„è¾“å…¥å’Œè¾“å‡ºæµé‡å·²è¾¾åˆ°ä¿æŠ¤ç³»ç»Ÿçš„ç›®çš„ã€‚ä¸ºäº†ä¿è¯ç³»ç»Ÿçš„ç¨³å›ºè¿è¡Œ,ä¸€æ—¦è¾¾åˆ°çš„éœ€è¦é™åˆ¶çš„é˜ˆå€¼,å°±éœ€è¦é™åˆ¶æµé‡å¹¶é‡‡å–å°‘é‡æªæ–½ä»¥å®Œæˆé™åˆ¶æµé‡çš„ç›®çš„ã€‚

  ![](https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/acc8eecd1b0d6831c9bf8696069b7f84b44e0620/20201102233151.png)

- ç†”æ–­

  åœ¨äº’è”ç½‘ç³»ç»Ÿä¸­ï¼Œå½“ä¸‹æ¸¸æœåŠ¡å› è®¿é—®å‹åŠ›è¿‡å¤§è€Œå“åº”å˜æ…¢æˆ–å¤±è´¥ï¼Œä¸Šæ¸¸æœåŠ¡ä¸ºäº†ä¿æŠ¤ç³»ç»Ÿæ•´ä½“çš„å¯ç”¨æ€§ï¼Œå¯ä»¥æš‚æ—¶åˆ‡æ–­å¯¹ä¸‹æ¸¸æœåŠ¡çš„è°ƒç”¨ã€‚è¿™ç§ç‰ºç‰²å±€éƒ¨ï¼Œä¿å…¨æ•´ä½“çš„æªæ–½å°±å«åšç†”æ–­ã€‚

  ![](https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/173dbd4767e965ca3b240757588647b927d89576/20201102233415.png)

- é™çº§

  é™çº§å…¶å®å°±æ˜¯ä¸ºæœåŠ¡æä¾›ä¸€ä¸ªæ‰˜åº•æ–¹æ¡ˆï¼Œä¸€æ—¦æœåŠ¡æ— æ³•æ­£å¸¸è°ƒç”¨ï¼Œå°±ä½¿ç”¨æ‰˜åº•æ–¹æ¡ˆã€‚

  ![](https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/4c09132bc87f4168139cf90d348504f10394a77c/20201102233627.png)

### å¸¸ç”¨çš„å®¹é”™ç»„ä»¶

- Hystrix

  `Hystrix`æ˜¯ç”±`Netflix`å¼€æºçš„ä¸€ä¸ªå»¶è¿Ÿå’Œå®¹é”™åº“ï¼Œç”¨äºéš”ç¦»è®¿é—®è¿œç¨‹ç³»ç»Ÿã€æœåŠ¡æˆ–è€…ç¬¬ä¸‰æ–¹åº“ï¼Œé˜²æ­¢çº§è”å¤±è´¥ï¼Œä»è€Œæå‡ç³»ç»Ÿçš„å¯ç”¨æ€§ä¸å®¹é”™æ€§ã€‚

- Resilience4J

  `Resilicence4J`ä¸€æ¬¾éå¸¸è½»é‡ã€ç®€å•ï¼Œå¹¶ä¸”æ–‡æ¡£éå¸¸æ¸…æ™°ã€ä¸°å¯Œçš„ç†”æ–­å·¥å…·ï¼Œè¿™ä¹Ÿæ˜¯`Hystrix`å®˜æ–¹æ¨èçš„æ›¿ä»£äº§å“ã€‚ä¸ä»…å¦‚æ­¤ï¼Œ`Resilicence4j`è¿˜åŸç”Ÿæ”¯æŒ`Spring Boot 1.x/2.x`ï¼Œè€Œä¸”ç›‘æ§ä¹Ÿæ”¯æŒå’Œ`prometheus`ç­‰å¤šæ¬¾ä¸»æµäº§å“è¿›è¡Œæ•´åˆã€‚

- Sentinel

  `Sentinel`æ˜¯é˜¿é‡Œå·´å·´å¼€æºçš„ä¸€æ¬¾æ–­è·¯å™¨å®ç°ï¼Œæœ¬èº«åœ¨é˜¿é‡Œå†…éƒ¨å·²ç»è¢«å¤§è§„æ¨¡é‡‡ç”¨ï¼Œéå¸¸ç¨³å®šã€‚

ä¸‰ä¸ªç»„ä»¶çš„å¯¹æ¯”è¡¨ï¼š

|                    | Sentinel                                                   | Hystrix                | Resilience4J                     |
| ------------------ | ---------------------------------------------------------- | ---------------------- | -------------------------------- |
| **éš”ç¦»ç­–ç•¥**       | ä¿¡å·é‡éš”ç¦»ï¼ˆå¹¶å‘çº¿ç¨‹æ•°é™æµï¼‰                               | çº¿ç¨‹æ± éš”ç¦»/ä¿¡å·é‡éš”ç¦»  | ä¿¡å·é‡éš”ç¦»                       |
| **ç†”æ–­é™çº§ç­–ç•¥**   | åŸºäºå“åº”æ—¶é—´ã€å¼‚å¸¸æ¯”ç‡ã€å¼‚å¸¸æ•°                             | åŸºäºå¼‚å¸¸æ¯”ç‡           | åŸºäºå¼‚å¸¸æ¯”ç‡ã€å“åº”æ—¶é—´           |
| **å®æ—¶ç»Ÿè®¡å®ç°**   | æ»‘åŠ¨çª—å£ï¼ˆLeapArrayï¼‰                                      | æ»‘åŠ¨çª—å£ï¼ˆåŸºäºRxJavaï¼‰ | Ring Bit Buffer                  |
| **åŠ¨æ€è§„åˆ™é…ç½®**   | æ”¯æŒå¤šç§æ•°æ®æº                                             | æ”¯æŒå¤šç§æ•°æ®æº         | æœ‰é™æ”¯æŒ                         |
| **æ‰©å±•æ€§**         | å¤šä¸ªæ‰©å±•ç‚¹                                                 | æ’ä»¶çš„å½¢å¼             | æ¥å£çš„å½¢å¼                       |
| **åŸºäºæ³¨è§£çš„æ”¯æŒ** | æ”¯æŒ                                                       | æ”¯æŒ                   | æ”¯æŒ                             |
| **é™æµ**           | åŸºäº QPSï¼Œæ”¯æŒåŸºäºè°ƒç”¨å…³ç³»çš„é™æµ                           | æœ‰é™çš„æ”¯æŒ             | Rate Limiter                     |
| **æµé‡æ•´å½¢**       | æ”¯æŒé¢„çƒ­æ¨¡å¼ã€åŒ€é€Ÿå™¨æ¨¡å¼ã€é¢„çƒ­æ’é˜Ÿæ¨¡å¼                     | ä¸æ”¯æŒ                 | ç®€å•çš„ Rate Limiteræ¨¡å¼          |
| **ç³»ç»Ÿè‡ªé€‚åº”ä¿æŠ¤** | æ”¯æŒ                                                       | ä¸æ”¯æŒ                 | ä¸æ”¯æŒ                           |
| **æ§åˆ¶å°**         | æä¾›å¼€ç®±å³ç”¨çš„æ§åˆ¶å°ï¼Œå¯é…ç½®è§„åˆ™ã€æŸ¥çœ‹ç§’çº§ç›‘æ§ã€æœºå™¨å‘ç°ç­‰ | ç®€å•çš„ç›‘æ§æŸ¥çœ‹         | ä¸æä¾›æ§åˆ¶å°ï¼Œå¯å¯¹æ¥å…¶å®ƒç›‘æ§ç³»ç»Ÿ |

### ä»€ä¹ˆæ˜¯Sentinel

â€‹		`Sentinel `(åˆ†å¸ƒå¼ç³»ç»Ÿçš„æµé‡é˜²å«å…µ) æ˜¯é˜¿é‡Œå¼€æºçš„ä¸€å¥—ç”¨äºæœåŠ¡å®¹é”™çš„ç»¼åˆæ€§è§£å†³æ–¹æ¡ˆã€‚å®ƒä»¥æµé‡ä¸ºåˆ‡å…¥ç‚¹, ä»æµé‡æ§åˆ¶ã€ç†”æ–­é™çº§ã€ç³»ç»Ÿè´Ÿè½½ä¿æŠ¤ç­‰å¤šä¸ªç»´åº¦æ¥ä¿æŠ¤æœåŠ¡çš„ç¨³å®šæ€§ã€‚

**Sentinel å…·æœ‰ä»¥ä¸‹ç‰¹å¾:**

- **ä¸°å¯Œçš„åº”ç”¨åœºæ™¯**ï¼š`Sentinel`æ‰¿æ¥äº†é˜¿é‡Œå·´å·´è¿‘ 10 å¹´çš„åŒåä¸€å¤§ä¿ƒæµé‡çš„æ ¸å¿ƒåœºæ™¯, ä¾‹å¦‚ç§’æ€ï¼ˆå³çªå‘æµé‡æ§åˆ¶åœ¨ç³»ç»Ÿå®¹é‡å¯ä»¥æ‰¿å—çš„èŒƒå›´ï¼‰ã€æ¶ˆæ¯å‰Šå³°å¡«è°·ã€é›†ç¾¤æµé‡æ§åˆ¶ã€å®æ—¶ç†”æ–­ä¸‹æ¸¸ä¸å¯ç”¨åº”ç”¨ç­‰ã€‚
- **å®Œå¤‡çš„å®æ—¶ç›‘æ§**ï¼š`Sentinel`æä¾›äº†å®æ—¶çš„ç›‘æ§åŠŸèƒ½ã€‚é€šè¿‡æ§åˆ¶å°å¯ä»¥çœ‹åˆ°æ¥å…¥åº”ç”¨çš„å•å°æœºå™¨ç§’çº§æ•°æ®, ç”šè‡³ 500 å°ä»¥ä¸‹è§„æ¨¡çš„é›†ç¾¤çš„æ±‡æ€»è¿è¡Œæƒ…å†µã€‚
- **å¹¿æ³›çš„å¼€æºç”Ÿæ€**ï¼š`Sentinel`æä¾›å¼€ç®±å³ç”¨çš„ä¸å…¶å®ƒå¼€æºæ¡†æ¶/åº“çš„æ•´åˆæ¨¡å—, ä¾‹å¦‚ä¸`SpringCloud`ã€`Dubbo`ã€`gRPC`çš„æ•´åˆã€‚åªéœ€è¦å¼•å…¥ç›¸åº”çš„ä¾èµ–å¹¶è¿›è¡Œç®€å•çš„é…ç½®å³å¯å¿«é€Ÿåœ°æ¥å…¥`Sentinel`ã€‚
- **å®Œå–„çš„ SPI æ‰©å±•ç‚¹**ï¼š`Sentinel`æä¾›ç®€å•æ˜“ç”¨ã€å®Œå–„çš„`SPI`æ‰©å±•æ¥å£ã€‚æ‚¨å¯ä»¥é€šè¿‡å®ç°æ‰©å±•æ¥å£æ¥å¿«é€Ÿåœ°å®šåˆ¶é€»è¾‘ã€‚ä¾‹å¦‚å®šåˆ¶è§„åˆ™ç®¡ç†ã€é€‚é…åŠ¨æ€æ•°æ®æºç­‰ã€‚

**Sentinel åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†:**

- **æ ¸å¿ƒåº“**ï¼ˆJava å®¢æˆ·ç«¯ï¼‰ä¸ä¾èµ–ä»»ä½•æ¡†æ¶/åº“,èƒ½å¤Ÿè¿è¡Œäºæ‰€æœ‰ Java è¿è¡Œæ—¶ç¯å¢ƒï¼ŒåŒæ—¶å¯¹`Dubbo`æˆ–è€…`Spring Cloud`ç­‰æ¡†æ¶ä¹Ÿæœ‰è¾ƒå¥½çš„æ”¯æŒã€‚
- **æ§åˆ¶å°**ï¼ˆDashboardï¼‰åŸºäº`Spring Boot`å¼€å‘ï¼Œæ‰“åŒ…åå¯ä»¥ç›´æ¥è¿è¡Œï¼Œä¸éœ€è¦é¢å¤–çš„`Tomcat`ç­‰åº”ç”¨å®¹å™¨ã€‚

### è¿è¡ŒSentinel

`Sentinel`æä¾›ä¸€ä¸ªè½»é‡çº§çš„æ§åˆ¶å°, å®ƒæä¾›æœºå™¨å‘ç°ã€å•æœºèµ„æºå®æ—¶ç›‘æ§ä»¥åŠè§„åˆ™ç®¡ç†ç­‰åŠŸèƒ½ã€‚

æœ€æ–°çš„æ­£å¼ç‰ˆä¸‹è½½ï¼š[https://github.com/alibaba/Sentinel/releases](https://github.com/alibaba/Sentinel/releases)

ç›´æ¥ä¸‹è½½jaråŒ…å³å¯ã€‚

> æˆ‘è¿™é‡Œç”±äºæƒ³ä¿®æ”¹å¯åŠ¨çš„é…ç½®ï¼Œåˆä¸æƒ³ä½¿ç”¨å‚æ•°ï¼Œæ‰€ä»¥æŠŠjaråŒ…é‡Œé¢çš„é…ç½®æ–‡ä»¶æ‰’å‡ºæ¥äº†ï¼Œä¿®æ”¹äº†ä¸€äº›é…ç½®ï¼Œç„¶åæŠŠé…ç½®æ–‡ä»¶å’ŒjaråŒ…æ”¾åœ¨åŒçº§ç›®å½•ç›´æ¥ä½¿ç”¨`java -jar`å¯åŠ¨äº†ï¼ŒSpring bootå¯åŠ¨çš„æ—¶å€™ï¼ŒåŠ è½½é…ç½®æ–‡ä»¶æ˜¯æœ‰ä¼˜å…ˆçº§çš„ï¼ˆæƒ³äº†è§£çš„å“¥ä»¬å„¿ï¼Œå¯ä»¥è‡ªè¡Œç™¾åº¦å“ˆï¼‰ï¼Œä½†å®é™…ç”Ÿäº§ç¯å¢ƒéœ€é¿å…é…ç½®æ–‡ä»¶ä¼˜å…ˆçº§ï¼Œé˜²æ­¢ä¸å¿…è¦çš„é”™è¯¯ã€‚

å¯åŠ¨å®Œæ¯•åï¼Œè®¿é—®: `localhost:18080`

![](https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/fda8ff7e07c03f905bcbd4fee6a3445d7030fe10/20201104163002.png)

> æˆ‘è¿™é‡Œæ˜¯ä¿®æ”¹è¿‡server.portçš„ï¼Œé»˜è®¤æ˜¯8080ã€‚é»˜è®¤çš„ç”¨æˆ·å¯†ç æ˜¯`sentinel/sentinel`

### å¾®æœåŠ¡é›†æˆSentinel

ç›´æ¥å¼•å…¥`sentinel`çš„`starter`ä¾èµ–å³å¯ã€‚

ç„¶åé€šè¿‡é…ç½®`sentinel`çš„è§„åˆ™å®ç°æœåŠ¡å®¹é”™çš„å„ç§ç­–ç•¥ã€‚

```yaml
        <dependency>
            <groupId>com.alibaba.cloud</groupId>
            <artifactId>spring-cloud-starter-alibaba-sentinel</artifactId>
        </dependency>
```

ä¿®æ”¹`application.yml`ï¼ŒåŠ å…¥ä¸€ä¸‹é…ç½®

```yaml
spring:
  cloud:
    sentinel:
      transport:
        # ä¸æ§åˆ¶å°äº¤æµçš„ç«¯å£, é»˜è®¤ 8719
        port: 8719
        # web æ§åˆ¶å°åœ°å€
        dashboard: localhost:18080
```

### æµ‹è¯•Sentinel

> æ–°å¢ä¸€ä¸ªé™æµçš„è§„åˆ™ï¼Œæµ‹è¯•Sentinel

1. ç™»å½•`Sentinel`æ§åˆ¶å°

2. ç‚¹å‡»å³ä¾§çš„å¾®æœåŠ¡åç§°ï¼Œå¦‚æœæ²¡æœ‰ï¼Œéœ€è¦ä»»æ„è°ƒç”¨ä¸€ä¸ªæ¥å£ï¼ŒSentinelå°±ä¼šåŠ è½½åˆ°è¯¥å¾®æœåŠ¡

3. é€‰æ‹© â€œæµæ§è§„åˆ™â€ -> "æ–°å¢æµæ§è§„åˆ™"ï¼Œå¼¹å‡ºè¾“å…¥æ¡†ï¼Œè¾“å…¥è¦é™æµçš„APIä»¥åŠç›¸å…³å‚æ•°ï¼Œå¦‚å›¾

   ![](https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/e506ff01ae2c385d97ee546a9969903ef442c24a/20201104163930.png)

   > è¿™é‡Œæˆ‘è®¾ç½®äº†`/sentinel/message1`è¿™ä¸ªAPIï¼Œæ¯ç§’åªå…è®¸ä¸€ä¸ªè¯·æ±‚è®¿é—®æˆåŠŸï¼Œè‹¥è¶…è¿‡ä¸€ä¸ªè¯·æ±‚ï¼Œåˆ™å¿«é€Ÿè¿”å›å¤±è´¥ã€‚

4. æµ‹è¯•æ•ˆæœ

   ![](https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/087b9ecf7ad303cbf05e26a3f03b267609696e97/20201104164302.png)

   > å¿«é€Ÿåˆ·æ–°ï¼Œåˆ™ä¼šæ˜¾ç¤ºå›¾ä¸Šçš„æ•ˆæœã€‚

### Sentinelçš„æ¦‚å¿µ

åŸºæœ¬æ¦‚å¿µ

- **èµ„æº**

  èµ„æºå°±æ˜¯`Sentinel`è¦ä¿æŠ¤çš„ä¸œè¥¿ã€‚å®ƒå¯ä»¥æ˜¯Javaåº”ç”¨ç¨‹åºä¸­çš„ä»»ä½•å†…å®¹ï¼Œå¯ä»¥æ˜¯ä¸€ä¸ªæœåŠ¡ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªæ–¹æ³•ï¼Œç”šè‡³å¯ä»¥æ˜¯ä¸€æ®µä»£ç ã€‚
  
- **è§„åˆ™**

  è§„åˆ™å°±æ˜¯ç”¨æ¥å®šä¹‰å¦‚ä½•ä¿æŠ¤èµ„æºã€‚ä½œç”¨åœ¨èµ„æºä¹‹ä¸Šï¼Œå®šä¹‰ä»¥ä»€ä¹ˆæ ·çš„æ–¹å¼æ¥ä¿æŠ¤èµ„æºï¼Œä¸»è¦åŒ…æ‹¬æµé‡æ§åˆ¶è§„åˆ™ã€ç†”æ–­é™çº§è§„åˆ™ä»¥åŠç³»ç»Ÿä¿æŠ¤è§„åˆ™

é‡è¦åŠŸèƒ½

`Sentinel`çš„ä¸»è¦åŠŸèƒ½å°±æ˜¯è£ä½œï¼Œä¸»è¦ä½“ç°ï¼š

- æµé‡æ§åˆ¶

  æµé‡æ§åˆ¶åœ¨ç½‘ç»œä¼ è¾“ä¸­æ˜¯ä¸€ä¸ªå¸¸ç”¨çš„æ¦‚å¿µï¼Œå®ƒç”¨äºè°ƒæ•´ç½‘ç»œåŒ…çš„æ•°æ®ã€‚ä»»æ„æ—¶é—´åˆ°æ¥çš„è¯·æ±‚å¾€å¾€æ˜¯éšå³ä¸å¯æ§çš„ï¼Œè€Œç³»ç»Ÿçš„å¤„ç†èƒ½åŠ›æ˜¯æœ‰é™çš„ã€‚æˆ‘ä»¬éœ€è¦æ ¹æ®ç³»ç»Ÿçš„å¤„ç†èƒ½åŠ›å¯¹æµé‡è¿›è¡Œæ§åˆ¶ã€‚`Sentinel`ä½œä¸ºä¸€ä¸ªè°ƒé…å™¨ï¼Œå¯ä»¥æ ¹æ®éœ€è¦æŠŠéšæœºçš„è¯·æ±‚è°ƒæ•´æˆå¯æ§çš„ã€‚

- ç†”æ–­é™çº§

  å½“æ£€æµ‹åˆ°è°ƒç”¨é“¾è·¯ä¸­æŸä¸ªèµ„æºå‡ºç°ä¸ç¨³å®šçš„è¡¨ç°ï¼Œä¾‹å¦‚è¯·æ±‚å“åº”æ—¶é—´è¿‡é•¿æˆ–å¼‚å¸¸è¯·æ±‚æ¯”ä¾‹å‡é«˜çš„æ—¶å€™ï¼Œåˆ™å¯¹è¿™ä¸ªèµ„æºçš„è°ƒç”¨è¿›è¡Œé™åˆ¶ï¼Œè®©è¯·æ±‚å¿«é€Ÿå¤±è´¥ï¼Œé¿å…å½±å“åˆ°å…¶å®ƒèµ„æºè€Œå¯¼è‡´é›ªå´©ã€‚

  `Sentinel`å¯¹è¿™ä¸ªé—®é¢˜é‡‡å–äº†ä¸¤ç§æ‰‹æ®µï¼š

  - é€šè¿‡å¹¶å‘çº¿ç¨‹æ•°è¿›è¡Œé™åˆ¶

    `Sentinel`é€šè¿‡é™åˆ¶èµ„æºå¹¶å‘çº¿ç¨‹æ•°é‡ï¼Œæ¥å‡å°‘ä¸ç¨³å®šèµ„æºå¯¹å…¶å®ƒèµ„æºçš„å½±å“ã€‚å½“æŸä¸ªèµ„æºå‡ºç°ä¸ç¨³å®šçš„æƒ…å†µä¸‹ï¼Œä¾‹å¦‚å“åº”æ—¶é—´è¿‡é•¿ï¼Œå¯¹èµ„æºçš„ç›´æ¥å½±å“å°±æ˜¯ä¼šé€ æˆçº¿ç¨‹æ•°çš„é€æ­¥å †ç§¯ã€‚å½“çº¿ç¨‹æ•°åœ¨ç‰¹å®šèµ„æºä¸Šå †ç§¯åˆ°ä¸€å®šçš„æ•°é‡ä¹‹åï¼Œå¯¹è¯¥èµ„æºçš„æ–°è¯·æ±‚å°±ä¼šè¢«æ‹’ç»ã€‚å †ç§¯çš„çº¿ç¨‹å®Œæˆä»»åŠ¡åæ‰å¼€å§‹ç»§ç»­æ¥å—æ–°çš„è¯·æ±‚ã€‚

  - é€šè¿‡å“åº”æ—¶é—´å¯¹èµ„æºè¿›è¡Œé™çº§

    é™¤äº†å¯¹å¹¶å‘çº¿ç¨‹æ•°è¿›è¡Œæ§åˆ¶ä»¥å¤–ã€‚`Sentinel`è¿˜å¯ä»¥é€šè¿‡å“åº”æ—¶é—´æ¥å¿«é€Ÿé™çº§ä¸ç¨³å®šçš„èµ„æºã€‚å½“ä¾èµ–çš„èµ„æºå‡ºç°å“åº”æ—¶é—´è¿‡é•¿åï¼Œæ‰€æœ‰å¯¹è¯¥èµ„æºçš„è®¿é—®éƒ½ä¼šè¢«æ‹’ç»ï¼Œç›´åˆ°è¿‡äº†æŒ‡å®šçš„æ—¶é—´çª—å£ä¹‹åæ‰é‡æ–°æ¢å¤ã€‚

  > `Sentinel` å’Œ `Hystrix` çš„åŒºåˆ«
  >
  >   ä¸¤è€…çš„åŸåˆ™æ˜¯ä¸€è‡´çš„, éƒ½æ˜¯å½“ä¸€ä¸ªèµ„æºå‡ºç°é—®é¢˜æ—¶, è®©å…¶å¿«é€Ÿå¤±è´¥, ä¸è¦æ³¢åŠåˆ°å…¶å®ƒæœåŠ¡ã€‚ä½†æ˜¯åœ¨é™åˆ¶çš„æ‰‹æ®µä¸Š, ç¡®é‡‡å–äº†å®Œå…¨ä¸ä¸€æ ·çš„æ–¹æ³•
  >
  >   `Hystrix`é‡‡ç”¨çš„æ˜¯çº¿ç¨‹æ± éš”ç¦»çš„æ–¹å¼, ä¼˜ç‚¹æ˜¯åšåˆ°äº†èµ„æºä¹‹é—´çš„éš”ç¦», ç¼ºç‚¹æ˜¯å¢åŠ äº†çº¿ç¨‹ åˆ‡æ¢çš„æˆæœ¬ã€‚
  >
  >   `Sentinel`é‡‡ç”¨çš„æ˜¯é€šè¿‡å¹¶å‘çº¿ç¨‹çš„æ•°é‡å’Œå“åº”æ—¶é—´æ¥å¯¹èµ„æºåšé™åˆ¶ã€‚

- ç³»ç»Ÿè´Ÿè½½ä¿æŠ¤

  `Sentinel` åŒæ—¶æä¾›ç³»ç»Ÿç»´åº¦çš„è‡ªé€‚åº”ä¿æŠ¤èƒ½åŠ›ã€‚å½“ç³»ç»Ÿè´Ÿè½½è¾ƒé«˜çš„æ—¶å€™ï¼Œå¦‚æœè¿˜æŒç»­è®© è¯·æ±‚è¿›å…¥å¯èƒ½ä¼šå¯¼è‡´ç³»ç»Ÿå´©æºƒï¼Œæ— æ³•å“åº”ã€‚åœ¨é›†ç¾¤ç¯å¢ƒä¸‹ï¼Œä¼šæŠŠæœ¬åº”è¿™å°æœºå™¨æ‰¿è½½çš„æµé‡è½¬å‘åˆ°å…¶ å®ƒçš„æœºå™¨ä¸Šå»ã€‚å¦‚æœè¿™ä¸ªæ—¶å€™å…¶å®ƒçš„æœºå™¨ä¹Ÿå¤„åœ¨ä¸€ä¸ªè¾¹ç¼˜çŠ¶æ€çš„æ—¶å€™ï¼Œ`Sentinel` æä¾›äº†å¯¹åº”çš„ä¿æŠ¤æœºåˆ¶ï¼Œè®©ç³»ç»Ÿçš„å…¥å£æµé‡å’Œç³»ç»Ÿçš„è´Ÿè½½è¾¾åˆ°ä¸€ä¸ªå¹³è¡¡ï¼Œä¿è¯ç³»ç»Ÿåœ¨èƒ½åŠ›èŒƒå›´ä¹‹å†…å¤„ç†æœ€å¤šçš„è¯· æ±‚ã€‚

### Sentinelæµæ§

#### æµæ§è§„åˆ™

æµé‡æ§åˆ¶ï¼Œå…¶åŸç†æ˜¯ç›‘æ§åº”ç”¨æµé‡çš„QPS(æ¯ç§’æŸ¥è¯¢ç‡) æˆ–å¹¶å‘çº¿ç¨‹æ•°ç­‰æŒ‡æ ‡ï¼Œå½“è¾¾åˆ°æŒ‡å®šçš„é˜ˆå€¼æ—¶æµé‡è¿›è¡Œæ§åˆ¶ï¼Œä»¥é¿å…è¢«ç¬æ—¶çš„æµé‡é«˜å³°å†²å®ï¼Œä»è€Œä¿éšœåº”ç”¨çš„é«˜å¯ç”¨æ€§ã€‚

æ‰¾åˆ°è¦è®¾ç½®æµæ§è§„åˆ™çš„æ¥å£åœ°å€ï¼Œç‚¹å‡»æµæ§æŒ‰é’®ï¼Œæ‰“å¼€å¦‚ä¸‹å›¾çš„è®¾ç½®ç•Œé¢ï¼š

![](https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/5931bc5a536d0dc2d03e7863e798a8de1cf3f058/20210515221502.png)

1. èµ„æºåï¼šå”¯ä¸€åç§°ï¼Œé»˜è®¤æ˜¯è¯·æ±‚è·¯å¾„ï¼Œå¯è‡ªå®šä¹‰
2. é’ˆå¯¹æ¥æºï¼Œé»˜è®¤defaultï¼Œä¸åŒºåˆ†æ¥æº
3. é˜ˆå€¼ç±»å‹/å•æœºé˜ˆå€¼
   - QPSï¼šå½“å‰æ¥å£çš„æ¯ç§’è¯·æ±‚ä¸Šé™æ•°é‡ï¼Œè¾¾åˆ°è®¾ç½®çš„æ•°é‡æ—¶åˆ™è¿›è¡Œé™æµ
   - çº¿ç¨‹æ•°ï¼šå½“å‰æ¥å£çš„çº¿ç¨‹æ•°è¾¾åˆ°é˜ˆå€¼æ—¶åˆ™è¿›è¡Œé™æµ
4. æ˜¯å¦é›†ç¾¤ï¼šæ˜¯å¦ä¸ºé›†ç¾¤ç¯å¢ƒ

ä»¥ä¸Šæ˜¯åŸºæœ¬çš„è®¾ç½®ï¼Œè¿˜æœ‰æµæ§æ¨¡å¼å’Œæµæ§æ•ˆæœï¼Œä¸‹é¢è¯¦ç»†è®²è§£

#### æµæ§æ¨¡å¼

1. ç›´æ¥æµæ§æ¨¡å¼

   ç›´æ¥æµæ§æ¨¡å¼æ˜¯æœ€ç®€å•çš„æ¨¡å¼ï¼Œå½“æŒ‡å®šçš„æ¥å£è¾¾åˆ°é™æµæ¡ä»¶æ—¶å¼€å¯é™æµã€‚ä¸Šé¢æ¡ˆä¾‹ä½¿ç”¨çš„å°±æ˜¯ç›´æ¥æµæ§æ¨¡å¼ã€‚

2. å…³è”æµæ§æ¨¡å¼

   å…³è”æµæ§æ¨¡å¼æŒ‡çš„æ˜¯ï¼Œå½“æŒ‡å®šæ¥å£å…³è”çš„æ¥å£è¾¾åˆ°é™æµæ¡ä»¶æ—¶ï¼Œå¼€å¯å¯¹æŒ‡å®šæ¥å£å¼€å¯é™æµã€‚é€‰æ‹©å…³è”æµæ§æ¨¡å¼æ—¶ï¼Œä¼šå¤šä¸€ä¸ªè¾“å…¥æ¡†ï¼Œè®©ä½ è¾“å…¥å…³è”èµ„æºåï¼Œå½“è¾“å…¥çš„å…³è”èµ„æºåè¾¾åˆ°é˜ˆå€¼æ—¶å°±ä¼šè¿›è¡Œé™æµ

3. é“¾è·¯æµæ§æ¨¡å¼

   é“¾è·¯æµæ§æ¨¡å¼æŒ‡çš„æ˜¯ï¼Œå½“ä»æŸä¸ªæ¥å£è¿‡æ¥çš„èµ„æºè¾¾åˆ°é™æµæ¡ä»¶æ—¶ï¼Œå¼€å¯é™æµã€‚å®ƒçš„åŠŸèƒ½æœ‰ç‚¹ç±»ä¼¼äºé’ˆå¯¹æ¥æºé…ç½®é¡¹ï¼ŒåŒºåˆ«åœ¨äºï¼š**é’ˆå¯¹æ¥æºæ˜¯é’ˆå¯¹ä¸Šçº§å¾®æœåŠ¡ï¼Œè€Œé“¾è·¯æµæ§æ˜¯é’ˆå¯¹ä¸Šçº§æ¥å£ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒçš„ç²’åº¦æ›´ç»†**ã€‚

#### æµæ§æ•ˆæœ

1. å¿«é€Ÿå¤±è´¥ï¼ˆé»˜è®¤ï¼‰

   ç›´æ¥å¤±è´¥ï¼ŒæŠ›å‡ºå¼‚å¸¸ã€‚

2. Warm Up

   å®ƒä»å¼€å§‹é˜ˆå€¼åˆ°æœ€å¤§QPSé˜ˆå€¼ä¼šæœ‰ä¸€ä¸ªç¼“å†²é˜¶æ®µï¼Œä¸€å¼€å§‹çš„é˜ˆå€¼æ˜¯æœ€å¤§QPSé˜ˆå€¼çš„1/3ï¼Œç„¶åæ…¢æ…¢å¢é•¿ï¼Œç›´åˆ°æœ€å¤§é˜ˆå€¼ï¼Œé€‚ç”¨äºå°†çªç„¶å¢å¤§çš„æµé‡è½¬æ¢ä¸ºç¼“æ­¥å¢é•¿çš„åœºæ™¯ã€‚

3. æ’é˜Ÿç­‰å¾…

   è®©è¯·æ±‚ä»¥å‡åŒ€çš„é€Ÿåº¦é€šè¿‡ï¼Œå•æœºé˜ˆå€¼ä¸ºæ¯ç§’é€šè¿‡æ•°é‡ï¼Œå…¶ä½™çš„æ’é˜Ÿç­‰å¾…ï¼› å®ƒè¿˜ä¼šè®©è®¾ç½®ä¸€ä¸ªè¶…æ—¶æ—¶é—´ï¼Œå½“è¯·æ±‚è¶…è¿‡è¶…æ—¶é—´æ—¶é—´è¿˜æœªå¤„ç†ï¼Œåˆ™ä¼šè¢«ä¸¢å¼ƒã€‚

### Sentinelé™çº§

é™çº§è§„åˆ™å°±æ˜¯è®¾ç½®å½“æ»¡è¶³ä»€ä¹ˆæ¡ä»¶çš„æ—¶å€™ï¼Œå¯¹æœåŠ¡è¿›è¡Œé™çº§ã€‚Sentinelæä¾›äº†ä¸‰ä¸ªè¡¡é‡æ¡ä»¶ï¼š

#### é™çº§è§„åˆ™

1. å¹³å‡å“åº”æ—¶é—´

   å½“èµ„æºçš„å¹³å‡å“åº”æ—¶é—´è¶…è¿‡é˜ˆå€¼ï¼ˆä»¥ ms ä¸ºå•ä½ï¼‰ä¹‹åï¼Œèµ„æºè¿›å…¥å‡†é™çº§çŠ¶æ€ã€‚å¦‚æœæ¥ä¸‹æ¥ 1s å†…æŒç»­è¿›å…¥ 5 ä¸ªè¯·æ±‚ï¼Œå®ƒä»¬çš„ RTéƒ½æŒç»­è¶…è¿‡è¿™ä¸ªé˜ˆå€¼ï¼Œé‚£ä¹ˆåœ¨æ¥ä¸‹çš„æ—¶é—´çª—å£ï¼ˆä»¥ s ä¸ºå•ä½ï¼‰ä¹‹å†…ï¼Œå°±ä¼šå¯¹è¿™ä¸ªæ–¹æ³•è¿›è¡ŒæœåŠ¡é™çº§ã€‚

2. å¼‚å¸¸æ¯”ä¾‹

   å½“èµ„æºçš„æ¯ç§’å¼‚å¸¸æ€»æ•°å é€šè¿‡é‡çš„æ¯”å€¼è¶…è¿‡é˜ˆå€¼ä¹‹åï¼Œèµ„æºè¿›å…¥é™çº§çŠ¶æ€ï¼Œå³åœ¨æ¥ä¸‹çš„æ—¶é—´çª—å£ï¼ˆä»¥ s ä¸ºå•ä½ï¼‰ä¹‹å†…ï¼Œå¯¹è¿™ä¸ªæ–¹æ³•çš„è°ƒç”¨éƒ½ä¼šè‡ªåŠ¨åœ°è¿”å›ã€‚å¼‚å¸¸æ¯”ç‡çš„é˜ˆå€¼èŒƒå›´æ˜¯ [0.0,1.0]ã€‚

### Sentinelçƒ­ç‚¹

çƒ­ç‚¹å‚æ•°æµæ§è§„åˆ™æ˜¯ä¸€ç§æ›´ç»†ç²’åº¦çš„æµæ§è§„åˆ™, å®ƒå…è®¸å°†è§„åˆ™å…·ä½“åˆ°å‚æ•°ä¸Šã€‚

#### çƒ­ç‚¹è§„åˆ™

ç›´æ¥ä¸Šç¤ºä¾‹

1. ç¼–å†™ç”¨äºè®¾ç½®çƒ­ç‚¹è§„åˆ™çš„æ¥å£

   ```java
       @GetMapping("message3")
       @SentinelResource("message3")// å¿…é¡»æ·»åŠ è¯¥æ³¨è§£, å¦åˆ™çƒ­ç‚¹è§„åˆ™ä¸ä¼šç”Ÿæ•ˆ
       public String message3(String name, Integer age) {
           return "Message 3. name = " + name + ",age = " + age;
       }
   ```

2. çƒ­ç‚¹è§„åˆ™è®¾ç½®å¦‚ä¸‹

   ![](https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/5a23a5e42f5a41300ebce1ded8ccece7702dfb8c/QQ%E5%9B%BE%E7%89%8720210515223326.png)

   é¢„æœŸè¾¾åˆ°çš„é™æµæ•ˆæœï¼Œå½“è®¿é—®message3æ¥å£æ—¶ï¼Œå¦‚æœnameå‚æ•°ä¸ä¸ºç©ºï¼Œåˆ™æ¯ç§’è®¿é—®æ•°è¶…è¿‡1ï¼Œå°±ä¼šé™æµã€‚è€Œåªä¼ ageå‚æ•°çš„æ—¶å€™ï¼ŒAPIè®¿é—®ä¸ä¼šè¢«é™åˆ¶

3. é«˜çº§é€‰é¡¹è®¾ç½®

   å¯ä»¥åœ¨é«˜çº§é€‰é¡¹ä¸­è®¾ç½®å…·ä½“çš„å‚æ•°çš„å€¼çš„é˜ˆå€¼ï¼Œæ¯”å¦‚ï¼šè®¾ç½®name=imxushuaiæ—¶ï¼Œé˜ˆå€¼è®¾ç½®åˆ°1000ã€‚è¿™æ ·å°±å¯ä»¥è¾¾åˆ°å¯¹å…·ä½“çš„å‚æ•°å€¼çš„é™æµ

### Sentinelæˆæƒ

å¾ˆå¤šæ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦æ ¹æ®è°ƒç”¨æ¥æºæ¥åˆ¤æ–­è¯¥æ¬¡è¯·æ±‚æ˜¯å¦å…è®¸æ”¾è¡Œï¼Œè¿™æ—¶å€™å¯ä»¥ä½¿ç”¨ Sentinel çš„æ¥æºè®¿é—®æ§åˆ¶çš„åŠŸèƒ½ã€‚æ¥æºè®¿é—®æ§åˆ¶æ ¹æ®èµ„æºçš„è¯·æ±‚æ¥æºï¼ˆoriginï¼‰é™åˆ¶èµ„æºæ˜¯å¦é€šè¿‡ã€‚

![](https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/15760cc28b7326641c359feb2f7dd18e65a15426/QQ%E5%9B%BE%E7%89%8720210515224322.png)

è®¾ç½®æŒ‡å®šçš„æµæ§åº”ç”¨ä»¥åŠæˆæƒçš„ç±»å‹ï¼Œå…¶ä¸­æˆæƒç±»å‹ä¸ºç™½åå•/é»‘åå•ï¼Œç›¸ä¿¡æˆæƒç±»å‹æ—¶å¾ˆå¥½ç†è§£çš„ï¼Œä½†æ˜¯ä»€ä¹ˆæ˜¯æµæ§åº”ç”¨å‘¢ã€‚

`Sentinel`æä¾›äº†æ¥å£æ¥è®©æˆ‘ä»¬è‡ªå®šä¹‰æˆæƒçš„è§„åˆ™ï¼Œéå¸¸çš„çµæ´»ï¼Œç›´æ¥ä¸Šä»£ç ç¤ºä¾‹

```java
package com.springcloud.alibaba.order.config;

import com.alibaba.csp.sentinel.adapter.servlet.callback.RequestOriginParser;

import javax.servlet.http.HttpServletRequest;

/**
 * è‡ªå®šä¹‰æµæ§è§„åˆ™
 */
public class RequestOriginParserDefinition implements RequestOriginParser {
    @Override
    public String parseOrigin(HttpServletRequest request) {
        String serviceName = request.getHeader("serviceName");
        return serviceName;
    }
}
```

å¦‚ä»£ç ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä»è¯·æ±‚ä¸­è·å–ä»»æ„çš„å‚æ•°ä½œä¸ºæ¥è¿›è¡Œè‡ªå®šä¹‰åˆ¤æ–­ï¼Œè¾¾åˆ°æˆ‘ä»¬æƒ³è¦çš„æ•ˆæœï¼Œä¸Šæ–¹ç»™å‡ºçš„ä»£ç ä¸­ï¼Œåªæ˜¯ç®€å•çš„ä»headerä¸­è·å–äº†åä¸º`serviceName`çš„å‚æ•°ç›´æ¥è¿”å›ï¼Œè¿™ä¸ªè¿”å›å€¼å¦‚æœå’Œæˆ‘ä»¬è®¾ç½®çš„æµæ§åº”ç”¨çš„å€¼ä¸€è‡´åˆ™ä¼šè§¦å‘æˆ‘ä»¬çš„æˆæƒè§„åˆ™ï¼Œä»è€Œè¾¾åˆ°é™æµçš„æ•ˆæœã€‚

### Sentinelç³»ç»Ÿè§„åˆ™

ç³»ç»Ÿä¿æŠ¤è§„åˆ™æ˜¯ä»åº”ç”¨çº§åˆ«çš„å…¥å£æµé‡è¿›è¡Œæ§åˆ¶ï¼Œä»å•å°æœºå™¨çš„æ€»ä½“ Loadã€RTã€å…¥å£ QPS ã€CPUä½¿ç”¨ç‡å’Œçº¿ç¨‹æ•°äº”ä¸ªç»´åº¦ç›‘æ§åº”ç”¨æ•°æ®ï¼Œè®©ç³»ç»Ÿå°½å¯èƒ½è·‘åœ¨æœ€å¤§ååé‡çš„åŒæ—¶ä¿è¯ç³»ç»Ÿæ•´ä½“çš„ç¨³å®šæ€§ã€‚

1. **Loadï¼ˆä»…å¯¹ Linux/Unix-like æœºå™¨ç”Ÿæ•ˆï¼‰**ï¼šå½“ç³»ç»Ÿ load1 è¶…è¿‡é˜ˆå€¼ï¼Œä¸”ç³»ç»Ÿå½“å‰çš„å¹¶å‘çº¿ç¨‹æ•°è¶…è¿‡ç³»ç»Ÿå®¹é‡æ—¶æ‰ä¼šè§¦å‘ç³»ç»Ÿä¿æŠ¤ã€‚ç³»ç»Ÿå®¹é‡ç”±ç³»ç»Ÿçš„ maxQps * minRt è®¡ç®—å¾—å‡ºã€‚è®¾å®šå‚è€ƒå€¼ä¸€èˆ¬æ˜¯ CPU cores * 2.5ã€‚
2. **RT**ï¼šå½“å•å°æœºå™¨ä¸Šæ‰€æœ‰å…¥å£æµé‡çš„å¹³å‡ RT è¾¾åˆ°é˜ˆå€¼å³è§¦å‘ç³»ç»Ÿä¿æŠ¤ï¼Œå•ä½æ˜¯æ¯«ç§’ã€‚
3. **çº¿ç¨‹æ•°**ï¼šå½“å•å°æœºå™¨ä¸Šæ‰€æœ‰å…¥å£æµé‡çš„å¹¶å‘çº¿ç¨‹æ•°è¾¾åˆ°é˜ˆå€¼å³è§¦å‘ç³»ç»Ÿä¿æŠ¤ã€‚
4. **å…¥å£ QPS**ï¼šå½“å•å°æœºå™¨ä¸Šæ‰€æœ‰å…¥å£æµé‡çš„ QPS è¾¾åˆ°é˜ˆå€¼å³è§¦å‘ç³»ç»Ÿä¿æŠ¤ã€‚
5. **CPUä½¿ç”¨ç‡**ï¼šå½“å•å°æœºå™¨ä¸Šæ‰€æœ‰å…¥å£æµé‡çš„ CPUä½¿ç”¨ç‡è¾¾åˆ°é˜ˆå€¼å³è§¦å‘ç³»ç»Ÿä¿æŠ¤ã€‚

### è‡ªå®šä¹‰å¼‚å¸¸è¿”å›

åœ¨ä¸Šé¢çš„æµ‹è¯•ä¸­ï¼Œæˆ‘ä»¬ä¼šå‘ç°ï¼Œå½“é™æµåçš„è¿”å›æƒ…å†µç›´æ¥è·³è½¬åˆ°äº†ä¸€ä¸ªé”™è¯¯é¡µé¢ï¼Œåœ¨çœŸå®çš„åœºæ™¯ä¸­ï¼Œå…¶å®æˆ‘ä»¬æ˜¯éœ€è¦è¿”å›ç‰¹å®šçš„æ•°æ®çš„ï¼Œè¿™å°±éœ€è¦æˆ‘ä»¬è¿›è¡Œå¼‚å¸¸çš„è‡ªå®šä¹‰è¿”å›äº†ã€‚

Sentinelæä¾›äº†å„ç§å¼‚å¸¸çš„æ¥å£ï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©éœ€è¦è‡ªå®šä¹‰çš„å¼‚å¸¸ç±»å‹è¿›è¡Œè‡ªå®šä¹‰ï¼Œå¼‚å¸¸ç±»å‹å¦‚ä¸‹ï¼š

- å¼‚å¸¸æ¥å£ï¼š`BlockException`

  åŒ…å«äº†æ‰€æœ‰çš„Sentinelé™æµå¼‚å¸¸ï¼Œå³ç»Ÿä¸€è®¾ç½®æ‰€æœ‰çš„é™æµå¼‚å¸¸è¿”å›

- æµæ§å¼‚å¸¸ï¼š`FlowException`

- é™çº§å¼‚å¸¸ï¼š`DegradeException`

- å‚æ•°é™æµå¼‚å¸¸ï¼š`ParamFlowException`

- æˆæƒå¼‚å¸¸ï¼š`AuthorityException`

- ç³»ç»Ÿè´Ÿè½½å¼‚å¸¸ï¼š`SystemBlockException`

æœ‰äº†è¿™äº›ç±»å‹ï¼Œæˆ‘ä»¬æ—¢å¯ä»¥ä½¿ç”¨Spring bootçš„ç»Ÿä¸€å¼‚å¸¸å¤„ç†ï¼Œå»å•ç‹¬å¤„ç†ä»¥ä¸Šçš„å¼‚å¸¸ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨Sentinelæä¾›çš„æ¥å£ç±»è¿›è¡Œå¼‚å¸¸å¤„ç†ï¼Œä¸‹æ–¹æˆ‘ç»™å‡ºä¸€ä¸ªä½¿ç”¨Sentinelæä¾›çš„æ¥å£ç±»çš„æ–¹å¼å¤„ç†ç»Ÿä¸€å¼‚å¸¸è¿”å›çš„ä»£ç ç¤ºä¾‹

ä»£ç ç¤ºä¾‹ï¼š

```java
package com.springcloud.alibaba.order.config;

import com.alibaba.csp.sentinel.adapter.servlet.callback.UrlBlockHandler;
import com.alibaba.csp.sentinel.slots.block.BlockException;
import com.alibaba.fastjson.JSONObject;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;

/**
 * è‡ªå®šä¹‰é™æµå¼‚å¸¸è¿”å›
 */
public class ExceptionHandlerConfig implements UrlBlockHandler {
    @Override
    public void blocked(HttpServletRequest request, HttpServletResponse response, BlockException e) throws IOException {
        response.setContentType("application/json;charset=utf-8");
        JSONObject result = new JSONObject();
        result.put("message", "å½“å‰æœåŠ¡å™¨å¿™, è¯·ç¨åå†è¯•!");

        response.getWriter().write(result.toJSONString());
    }
}
```

### @SentinelResourceæ³¨è§£

`@SentinelResource`çš„å‚æ•°è®¾ç½®å¾ˆå¤šï¼Œæˆ‘ç›´æ¥è´´å‡ºæºç ç±»ä»¥åŠå¯¹åº”çš„å«ä¹‰å’Œè§£é‡Š

> æˆ‘ç›´æ¥è´´å‡ºçš„æ˜¯`@SentinelResource`çš„æºç ï¼Œå¦‚æœçœ‹ä¸æ‡‚æ³¨è§£ç±»ä¸­çš„è¯­æ³•å¯ä»¥å¿½ç•¥ä»£ç ï¼Œåªçœ‹æ³¨é‡Šã€‚

```java
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
@Inherited
public @interface SentinelResource {

    /**
     * èµ„æºåç§°
     */
    String value() default "";

    /**
     * entryç±»å‹ï¼Œæ ‡è®°æµé‡çš„æ–¹å‘ï¼Œå–å€¼IN/OUTï¼Œé»˜è®¤æ˜¯OUT
     */
    EntryType entryType() default EntryType.OUT;

    /**
     * èµ„æºç±»å‹
     * Sentinelæä¾›çš„å¸¸é‡ç±»ï¼šResourceTypeConstants
     * COMMON = 0;
     * COMMON_WEB = 1;
     * COMMON_RPC = 2;
     * COMMON_API_GATEWAY = 3;
     * COMMON_DB_SQL = 4;
     */
    int resourceType() default 0;

    /**
     * å¤„ç†BlockExceptionçš„å‡½æ•°åç§°,å‡½æ•°è¦æ±‚ï¼š
     * 1. å¿…é¡»æ˜¯ public
     * 2.è¿”å›ç±»å‹ å‚æ•°ä¸åŸæ–¹æ³•ä¸€è‡´
     * 3. é»˜è®¤éœ€å’ŒåŸæ–¹æ³•åœ¨åŒä¸€ä¸ªç±»ä¸­ã€‚è‹¥å¸Œæœ›ä½¿ç”¨å…¶ä»–ç±»çš„å‡½æ•°ï¼Œå¯é…ç½®
     * blockHandlerClass ï¼Œå¹¶æŒ‡å®šblockHandlerClassé‡Œé¢çš„æ–¹æ³•ã€‚
     */
    String blockHandler() default "";

    /**
     * å­˜æ”¾blockHandlerçš„ç±»,å¯¹åº”çš„å¤„ç†å‡½æ•°å¿…é¡»staticä¿®é¥°ã€‚
     */
    Class<?>[] blockHandlerClass() default {};

    /**
     * ç”¨äºåœ¨æŠ›å‡ºå¼‚å¸¸çš„æ—¶å€™æä¾›fallbackå¤„ç†é€»è¾‘ã€‚fallbackå‡½æ•°å¯ä»¥é’ˆå¯¹æ‰€
     * æœ‰ç±»å‹çš„å¼‚å¸¸ï¼ˆé™¤äº† exceptionsToIgnore é‡Œé¢æ’é™¤æ‰çš„å¼‚å¸¸ç±»å‹ï¼‰è¿›
     * è¡Œå¤„ç†ã€‚å‡½æ•°è¦æ±‚ï¼š
     * 1. è¿”å›ç±»å‹ä¸åŸæ–¹æ³•ä¸€è‡´
     * 2. å‚æ•°ç±»å‹éœ€è¦å’ŒåŸæ–¹æ³•ç›¸åŒ¹é…
     * 3. é»˜è®¤éœ€å’ŒåŸæ–¹æ³•åœ¨åŒä¸€ä¸ªç±»ä¸­ã€‚è‹¥å¸Œæœ›ä½¿ç”¨å…¶ä»–ç±»çš„å‡½æ•°ï¼Œå¯é…ç½®
     * fallbackClassï¼Œå¹¶æŒ‡å®šfallbackClassé‡Œé¢çš„æ–¹æ³•ã€‚
     */
    String fallback() default "";

    /**
     * ç”¨äºé€šç”¨çš„ fallback é€»è¾‘ã€‚é»˜è®¤fallbackå‡½æ•°å¯ä»¥é’ˆå¯¹æ‰€æœ‰ç±»å‹çš„å¼‚å¸¸è¿›
     * è¡Œå¤„ç†ã€‚è‹¥åŒæ—¶é…ç½®äº† fallback å’Œ defaultFallbackï¼Œä»¥fallbackä¸ºå‡†ã€‚å‡½
     * æ•°è¦æ±‚ï¼š
     * 1. è¿”å›ç±»å‹ä¸åŸæ–¹æ³•ä¸€è‡´
     * 2. æ–¹æ³•å‚æ•°åˆ—è¡¨ä¸ºç©ºï¼Œæˆ–è€…æœ‰ä¸€ä¸ª Throwable ç±»å‹çš„å‚æ•°ã€‚
     * 3. é»˜è®¤éœ€è¦å’ŒåŸæ–¹æ³•åœ¨åŒä¸€ä¸ªç±»ä¸­ã€‚è‹¥å¸Œæœ›ä½¿ç”¨å…¶ä»–ç±»çš„å‡½æ•°ï¼Œå¯é…ç½®
     * fallbackClassï¼Œå¹¶æŒ‡å®š fallbackClass é‡Œé¢çš„æ–¹æ³•ã€‚
     */
    String defaultFallback() default "";

    /**
     * å­˜æ”¾fallbackçš„ç±»ã€‚å¯¹åº”çš„å¤„ç†å‡½æ•°å¿…é¡»staticä¿®é¥°ã€‚
     */
    Class<?>[] fallbackClass() default {};

    /**
     * éœ€è¦traceçš„å¼‚å¸¸
     */
    Class<? extends Throwable>[] exceptionsToTrace() default {Throwable.class};
    
    /**
     * æŒ‡å®šæ’é™¤æ‰å“ªäº›å¼‚å¸¸ã€‚æ’é™¤çš„å¼‚å¸¸ä¸ä¼šè®¡å…¥å¼‚å¸¸ç»Ÿè®¡ï¼Œä¹Ÿä¸ä¼šè¿›å…¥
     * fallbacké€»è¾‘ï¼Œè€Œæ˜¯åŸæ ·æŠ›å‡ºã€‚
     */
    Class<? extends Throwable>[] exceptionsToIgnore() default {};
}
```

åœ¨`@SentinelResource`æ³¨è§£ä¸­æˆ‘ä»¬å¯ä»¥å®šä¹‰å½“å‘ç°é™æµæ—¶è¿›å…¥çš„æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æ–¹æ³•è‡ªå®šä¹‰æˆ‘ä»¬è‡ªå·±çš„ä¸šåŠ¡é€»è¾‘ï¼Œä»è€Œè¾¾åˆ°æˆ‘ä»¬æƒ³è¦çš„æ•ˆæœã€‚

### Sentinelè§„åˆ™æŒä¹…åŒ–

è¿™ä¸ªå°±ä¸åšè¯¦ç»†ä»‹ç»äº†ï¼Œä¸»è¦å°±æ˜¯æŒ‡å¦‚ä½•å°†å­˜åœ¨`Sentinel`é‡Œçš„è§„åˆ™æŒä¹…åŒ–åˆ°ç¡¬ç›˜ï¼Œé¿å…æ¯æ¬¡é‡å¯`Sentinel`åä¹‹å‰çš„è®¾ç½®çš„é™æµè§„åˆ™å°±ä¸åœ¨äº†ï¼Œä¸éœ€è¦ç‰¹åˆ«è®°ï¼Œåˆ°æ—¶å€™ç™¾åº¦å°±è¡Œã€‚ï¼ˆæ¯•ç«Ÿæˆ‘ä¸ä¼šçš„ç™¾åº¦éƒ½ä¼š ~ï¼‰

### Feignæ•´åˆSentinel

1. å¼•å…¥ä¾èµ–

   ```xml
           <dependency>
               <groupId>com.alibaba.cloud</groupId>
               <artifactId>spring-cloud-starter-alibaba-sentinel</artifactId>
           </dependency>
   ```

2. ç¼–å†™é…ç½®æ–‡ä»¶ï¼Œæ‰“å¼€`Feign`å¯¹`Sentinel`çš„æ”¯æŒ

   ```yaml
   feign:
     sentinel:
       # å¼€å¯sentinelæ”¯æŒ
       enabled: true
   ```

3. ç¼–å†™å®¹é”™ç±»

   ```java
   package com.springcloud.alibaba.order.client.fallback;
   
   import com.springcloud.alibaba.common.entity.Product;
   import com.springcloud.alibaba.order.client.ProductClient;
   import org.springframework.stereotype.Component;
   
   /**
    * product serviceå®¹é”™ç±»
    */
   @Component
   public class ProductClientFallback implements ProductClient {
       @Override
       public Product findById(Integer pid) {
           // å…·ä½“çš„å®¹é”™ä¸šåŠ¡é€»è¾‘, æˆ‘è¿™é‡Œç›´æ¥è¿”å›ç©ºçš„å•†å“å¯¹è±¡
           return new Product();
       }
   }
   ```

4. ä¿®æ”¹FiegnClientæŒ‡å®šèµ·å®¹é”™ç±»

   ```java
   package com.springcloud.alibaba.order.client;
   
   import com.springcloud.alibaba.common.entity.Product;
   import com.springcloud.alibaba.order.client.fallback.ProductClientFallback;
   import org.springframework.cloud.openfeign.FeignClient;
   import org.springframework.web.bind.annotation.GetMapping;
   import org.springframework.web.bind.annotation.PathVariable;
   
   @FeignClient(value = "service-product", fallback = ProductClientFallback.class)
   public interface ProductClient {
   
       @GetMapping("product/{pid}")
       Product findById(@PathVariable Integer pid);
   
   }
   ```

ä»¥ä¸Šå°±æ˜¯`Sentinel`çš„åŸºæœ¬ç”¨æ³•äº†ã€‚

## æœåŠ¡ç½‘å…³ï¼ˆGatewayï¼‰

åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œä¸€ä¸ªç³»ç»Ÿä¼šè¢«æ‹†åˆ†ä¸ºå¾ˆå¤šä¸ªå¾®æœåŠ¡ã€‚é‚£ä¹ˆä½œä¸ºå®¢æˆ·ç«¯è¦å¦‚ä½•å»è°ƒç”¨è¿™ä¹ˆå¤šçš„å¾®æœåŠ¡å‘¢ï¼Ÿå¦‚æœæ²¡æœ‰ç½‘å…³çš„å­˜åœ¨ï¼Œæˆ‘ä»¬åªèƒ½åœ¨å®¢æˆ·ç«¯è®°å½•æ¯ä¸ªå¾®æœåŠ¡çš„åœ°å€ï¼Œç„¶ååˆ†åˆ«å»è°ƒç”¨ã€‚

è¿™æ ·çš„æ¶æ„ï¼Œä¼šå­˜åœ¨ç€è¯¸å¤šçš„é—®é¢˜ï¼š

- å®¢æˆ·ç«¯å¤šæ¬¡è¯·æ±‚ä¸åŒçš„å¾®æœåŠ¡ï¼Œå¢åŠ å®¢æˆ·ç«¯ä»£ç æˆ–é…ç½®ç¼–å†™çš„å¤æ‚æ€§
- è®¤è¯å¤æ‚ï¼Œæ¯ä¸ªæœåŠ¡éƒ½éœ€è¦ç‹¬ç«‹è®¤è¯ã€‚
- å­˜åœ¨è·¨åŸŸè¯·æ±‚ï¼Œåœ¨ä¸€å®šåœºæ™¯ä¸‹å¤„ç†ç›¸å¯¹å¤æ‚ã€‚

è¿™äº›é—®é¢˜å¯ä»¥å€ŸåŠ©APIç½‘å…³æ¥è§£å†³

APIç½‘å…³ï¼Œå°±æ˜¯æŒ‡ç³»ç»Ÿçš„ç»Ÿä¸€å…¥å£ï¼Œå®ƒå°è£…äº†åº”ç”¨ç¨‹åºçš„å†…éƒ¨ç»“æ„ï¼Œä¸ºå®¢æˆ·ç«¯æä¾›ç»Ÿä¸€æœåŠ¡ï¼Œä¸€äº›ä¸ä¸šåŠ¡æœ¬èº«åŠŸèƒ½æ— å…³çš„å…¬å…±é€»è¾‘å¯ä»¥åœ¨è¿™é‡Œå®ç°ï¼Œè¯¸å¦‚è®¤è¯ã€é‰´æƒã€ç›‘æ§ã€è·¯ç”±è½¬å‘ç­‰ç­‰ã€‚

åœ¨ä¸šç•Œæ¯”è¾ƒæµè¡Œçš„ç½‘å…³ï¼Œæœ‰ä¸‹é¢è¿™äº›ï¼š

- Ngnix+lua

  ä½¿ç”¨nginxçš„åå‘ä»£ç†å’Œè´Ÿè½½å‡è¡¡å¯å®ç°å¯¹apiæœåŠ¡å™¨çš„è´Ÿè½½å‡è¡¡åŠé«˜å¯ç”¨ã€‚luaæ˜¯ä¸€ç§è„šæœ¬è¯­è¨€,å¯ä»¥æ¥ç¼–å†™ä¸€äº›ç®€å•çš„é€»è¾‘, nginxæ”¯æŒluaè„šæœ¬

- Kong

  åŸºäºNginx+Luaå¼€å‘ï¼Œæ€§èƒ½é«˜ï¼Œç¨³å®šï¼Œæœ‰å¤šä¸ªå¯ç”¨çš„æ’ä»¶(é™æµã€é‰´æƒç­‰ç­‰)å¯ä»¥å¼€ç®±å³ç”¨ã€‚ é—®é¢˜ï¼šåªæ”¯æŒHttpåè®®ï¼›äºŒæ¬¡å¼€å‘ï¼Œè‡ªç”±æ‰©å±•å›°éš¾ï¼›æä¾›ç®¡ç†APIï¼Œç¼ºä¹æ›´æ˜“ç”¨çš„ç®¡æ§ã€é…ç½®æ–¹å¼ã€‚

- Zuul

  Netflixå¼€æºçš„ç½‘å…³ï¼ŒåŠŸèƒ½ä¸°å¯Œï¼Œä½¿ç”¨JAVAå¼€å‘ï¼Œæ˜“äºäºŒæ¬¡å¼€å‘ é—®é¢˜ï¼šç¼ºä¹ç®¡æ§ï¼Œæ— æ³•åŠ¨æ€é…ç½®ï¼›ä¾èµ–ç»„ä»¶è¾ƒå¤šï¼›å¤„ç†Httpè¯·æ±‚ä¾èµ–çš„æ˜¯Webå®¹å™¨ï¼Œæ€§èƒ½ä¸å¦‚Nginx

- Spring Cloud Gateway

  Springå…¬å¸ä¸ºäº†æ›¿æ¢Zuulè€Œå¼€å‘çš„ç½‘å…³æœåŠ¡ï¼Œè¿™æ˜¯æˆ‘ä»¬è¦ä½¿ç”¨çš„ç½‘å…³ã€‚

### Gatewayç®€ä»‹

Spring Cloud Gatewayæ˜¯Springå…¬å¸åŸºäºSpring 5.0ï¼ŒSpring Boot 2.0 å’Œ Project Reactor ç­‰æŠ€æœ¯å¼€å‘çš„ç½‘å…³ï¼Œå®ƒæ—¨åœ¨ä¸ºå¾®æœåŠ¡æ¶æ„æä¾›ä¸€ç§ç®€å•æœ‰æ•ˆçš„ç»Ÿä¸€çš„ API è·¯ç”±ç®¡ç†æ–¹å¼ã€‚å®ƒçš„ç›®æ ‡æ˜¯æ›¿ä»£Netflix Zuulï¼Œå…¶ä¸ä»…æä¾›ç»Ÿä¸€çš„è·¯ç”±æ–¹å¼ï¼Œå¹¶ä¸”åŸºäº Filter é“¾çš„æ–¹å¼æä¾›äº†ç½‘å…³åŸºæœ¬çš„åŠŸèƒ½ï¼Œä¾‹å¦‚ï¼šå®‰å…¨ï¼Œç›‘æ§å’Œé™æµã€‚

ä¼˜ç‚¹ï¼š

- æ€§èƒ½å¼ºåŠ²ï¼šæ˜¯ç¬¬ä¸€ä»£ç½‘å…³Zuulçš„1.6å€
- åŠŸèƒ½å¼ºå¤§ï¼šå†…ç½®äº†å¾ˆå¤šå®ç”¨çš„åŠŸèƒ½ï¼Œä¾‹å¦‚è½¬å‘ã€ç›‘æ§ã€é™æµç­‰
- è®¾è®¡ä¼˜é›…ï¼Œå®¹æ˜“æ‰©å±•

ç¼ºç‚¹ï¼š

- å…¶å®ç°ä¾èµ–Nettyä¸WebFluxï¼Œä¸æ˜¯ä¼ ç»Ÿçš„Servletç¼–ç¨‹æ¨¡å‹ï¼Œå­¦ä¹ æˆæœ¬é«˜
- ä¸èƒ½å°†å…¶éƒ¨ç½²åœ¨Tomcatã€Jettyç­‰Servletå®¹å™¨é‡Œï¼Œåªèƒ½æ‰“æˆjaråŒ…æ‰§è¡Œ
- éœ€è¦Spring Boot 2.0åŠä»¥ä¸Šçš„ç‰ˆæœ¬ï¼Œæ‰æ”¯æŒ

### åŸºæœ¬ä½¿ç”¨

1. æ–°å»ºmavené¡¹ç›®

2. å¼•å…¥ä¾èµ–

   ```xml
   <?xml version="1.0" encoding="UTF-8"?>
   <project xmlns="http://maven.apache.org/POM/4.0.0"
            xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
            xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
       <parent>
           <artifactId>springcloud-alibaba</artifactId>
           <groupId>org.example</groupId>
           <version>1.0-SNAPSHOT</version>
       </parent>
       <modelVersion>4.0.0</modelVersion>
   
       <artifactId>springcloud-alibaba-gateway</artifactId>
   
       <dependencies>
           <dependency>
               <groupId>org.springframework.cloud</groupId>
               <artifactId>spring-cloud-starter-gateway</artifactId>
           </dependency>
           <!--nacoså®¢æˆ·ç«¯-->
           <dependency>
               <groupId>com.alibaba.cloud</groupId>
               <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
           </dependency>
       </dependencies>
   
   
   </project>
   ```

3. ç¼–å†™å¯åŠ¨ç±»

   ```java
   package com.springcloud.alibaba;
   
   import org.springframework.boot.SpringApplication;
   import org.springframework.boot.autoconfigure.SpringBootApplication;
   import org.springframework.cloud.client.discovery.EnableDiscoveryClient;
   
   @SpringBootApplication
   @EnableDiscoveryClient
   public class GatewayApplication {
   
       public static void main(String[] args) {
           SpringApplication.run(GatewayApplication.class, args);
       }
   
   }
   ```

4. ç¼–å†™é…ç½®æ–‡ä»¶

   ```yaml
   server:
     port: 7000
   spring:
     application:
       name: api-gateway
     cloud:
       nacos:
         discovery:
           server-addr: 192.168.149.101:8848
       gateway:
         routes: # è·¯ç”±æ•°ç»„[è·¯ç”± å°±æ˜¯æŒ‡å®šå½“è¯·æ±‚æ»¡è¶³ä»€ä¹ˆæ¡ä»¶çš„æ—¶å€™è½¬åˆ°å“ªä¸ªå¾®æœåŠ¡]
           # å½“å‰è·¯ç”±çš„æ ‡è¯†, è¦æ±‚å”¯ä¸€
           - id: product_route
             # è¯·æ±‚è¦è½¬å‘åˆ°çš„åœ°å€
             uri: lb://service-product
             # è·¯ç”±çš„ä¼˜å…ˆçº§,æ•°å­—è¶Šå°çº§åˆ«è¶Šé«˜
             order: 1
             # æ–­è¨€(å°±æ˜¯è·¯ç”±è½¬å‘è¦æ»¡è¶³çš„æ¡ä»¶)
             predicates:
               # å½“è¯·æ±‚è·¯å¾„æ»¡è¶³PathæŒ‡å®šçš„è§„åˆ™æ—¶,æ‰è¿›è¡Œè·¯ç”±è½¬å‘
               - Path=/product-serv/**
             # è¿‡æ»¤å™¨,è¯·æ±‚åœ¨ä¼ é€’è¿‡ç¨‹ä¸­å¯ä»¥é€šè¿‡è¿‡æ»¤å™¨å¯¹å…¶è¿›è¡Œä¸€å®šçš„ä¿®æ”¹
             filters:
               # è½¬å‘ä¹‹å‰å»æ‰1å±‚è·¯å¾„,å¦‚æœä¸º0åˆ™åŸæ ·è½¬å‘URLåˆ°å¾®æœåŠ¡
               - StripPrefix=1
           - id: order_route
             # è¯·æ±‚è¦è½¬å‘åˆ°çš„åœ°å€
             uri: lb://service-order
             # è·¯ç”±çš„ä¼˜å…ˆçº§,æ•°å­—è¶Šå°çº§åˆ«è¶Šé«˜
             order: 1
             # æ–­è¨€(å°±æ˜¯è·¯ç”±è½¬å‘è¦æ»¡è¶³çš„æ¡ä»¶)
             predicates:
               # å½“è¯·æ±‚è·¯å¾„æ»¡è¶³PathæŒ‡å®šçš„è§„åˆ™æ—¶,æ‰è¿›è¡Œè·¯ç”±è½¬å‘
               - Path=/order-serv/**
             # è¿‡æ»¤å™¨,è¯·æ±‚åœ¨ä¼ é€’è¿‡ç¨‹ä¸­å¯ä»¥é€šè¿‡è¿‡æ»¤å™¨å¯¹å…¶è¿›è¡Œä¸€å®šçš„ä¿®æ”¹
             filters:
               # è½¬å‘ä¹‹å‰å»æ‰1å±‚è·¯å¾„
               - StripPrefix=1
   ```

5. æµ‹è¯•è®¿é—®æ•ˆæœ

   ![](https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/d20af880be2dd31c724deda84931ab18349438f4/QQ%E6%88%AA%E5%9B%BE20210516150041.png)

   å¯ä»¥çœ‹åˆ°ï¼ŒæˆåŠŸä»ç½‘å…³è®¿é—®åˆ°äº†productå¾®æœåŠ¡çš„APIã€‚

### Gatewayæ ¸å¿ƒæ¶æ„

è·¯ç”±(Route) æ˜¯ gateway ä¸­æœ€åŸºæœ¬çš„ç»„ä»¶ä¹‹ä¸€ï¼Œè¡¨ç¤ºä¸€ä¸ªå…·ä½“çš„è·¯ç”±ä¿¡æ¯è½½ä½“ã€‚ä¸»è¦å®šä¹‰äº†ä¸‹é¢çš„å‡ ä¸ªä¿¡æ¯:

- **id**ï¼Œè·¯ç”±æ ‡è¯†ç¬¦ï¼ŒåŒºåˆ«äºå…¶ä»– Routeã€‚
- **uri**ï¼Œè·¯ç”±æŒ‡å‘çš„ç›®çš„åœ° uriï¼Œå³å®¢æˆ·ç«¯è¯·æ±‚æœ€ç»ˆè¢«è½¬å‘åˆ°çš„å¾®æœåŠ¡ã€‚
- **order**ï¼Œç”¨äºå¤šä¸ª Route ä¹‹é—´çš„æ’åºï¼Œæ•°å€¼è¶Šå°æ’åºè¶Šé å‰ï¼ŒåŒ¹é…ä¼˜å…ˆçº§è¶Šé«˜ã€‚
- **predicate**ï¼Œæ–­è¨€çš„ä½œç”¨æ˜¯è¿›è¡Œæ¡ä»¶åˆ¤æ–­ï¼Œåªæœ‰æ–­è¨€éƒ½è¿”å›çœŸï¼Œæ‰ä¼šçœŸæ­£çš„æ‰§è¡Œè·¯ç”±ã€‚
- **filter**ï¼Œè¿‡æ»¤å™¨ç”¨äºä¿®æ”¹è¯·æ±‚å’Œå“åº”ä¿¡æ¯ã€‚



**Gatewayçš„è¿è¡Œæµç¨‹ï¼š**

![](https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/658d625f42f903e1943102646c3e3e0b3338b950/springgateway%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B.jpg)

1. Gateway Clientå‘Gateway Serverå‘é€è¯·æ±‚
2. è¯·æ±‚é¦–å…ˆä¼šè¢«HttpWebHandlerAdapterè¿›è¡Œæå–ç»„è£…æˆç½‘å…³ä¸Šä¸‹æ–‡
3. ç„¶åç½‘å…³çš„ä¸Šä¸‹æ–‡ä¼šä¼ é€’åˆ°DispatcherHandlerï¼Œå®ƒè´Ÿè´£å°†è¯·æ±‚åˆ†å‘ç»™RoutePredicateHandlerMapping
4. RoutePredicateHandlerMappingè´Ÿè´£è·¯ç”±æŸ¥æ‰¾ï¼Œå¹¶æ ¹æ®è·¯ç”±æ–­è¨€åˆ¤æ–­è·¯ç”±æ˜¯å¦å¯ç”¨
5. å¦‚æœè¿‡æ–­è¨€æˆåŠŸï¼Œç”±FilteringWebHandleråˆ›å»ºè¿‡æ»¤å™¨é“¾å¹¶è°ƒç”¨
6. è¯·æ±‚ä¼šä¸€æ¬¡ç»è¿‡PreFilter--å¾®æœåŠ¡--PostFilterçš„æ–¹æ³•ï¼Œæœ€ç»ˆè¿”å›å“åº”

### æ–­è¨€

Predicate(æ–­è¨€, è°“è¯) ç”¨äºè¿›è¡Œæ¡ä»¶åˆ¤æ–­ï¼Œåªæœ‰æ–­è¨€éƒ½è¿”å›çœŸï¼Œæ‰ä¼šçœŸæ­£çš„æ‰§è¡Œè·¯ç”±ã€‚

æ–­è¨€å°±æ˜¯è¯´: åœ¨**ä»€ä¹ˆæ¡ä»¶**ä¸‹ï¼Œæ‰èƒ½ç»§ç»­æ‰§è¡Œ

#### å†…ç½®è·¯ç”±æ–­è¨€å·¥å‚

`SpringCloud Gateway`åŒ…æ‹¬è®¸å¤šå†…ç½®çš„æ–­è¨€å·¥å‚ï¼Œæ‰€æœ‰è¿™äº›æ–­è¨€éƒ½ä¸HTTPè¯·æ±‚çš„ä¸åŒå±æ€§åŒ¹é…ã€‚å…·ä½“å¦‚ä¸‹ï¼š

- åŸºäºDatetimeç±»å‹çš„æ–­è¨€å·¥å‚

  æ­¤ç±»å‹çš„æ–­è¨€æ ¹æ®æ—¶é—´åšåˆ¤æ–­ï¼Œä¸»è¦æœ‰ä¸‰ä¸ªï¼š

  AfterRoutePredicateFactoryï¼š æ¥æ”¶ä¸€ä¸ªæ—¥æœŸå‚æ•°ï¼Œåˆ¤æ–­è¯·æ±‚æ—¥æœŸæ˜¯å¦æ™šäºæŒ‡å®šæ—¥æœŸ

  BeforeRoutePredicateFactoryï¼š æ¥æ”¶ä¸€ä¸ªæ—¥æœŸå‚æ•°ï¼Œåˆ¤æ–­è¯·æ±‚æ—¥æœŸæ˜¯å¦æ—©äºæŒ‡å®šæ—¥æœŸ

  BetweenRoutePredicateFactoryï¼š æ¥æ”¶ä¸¤ä¸ªæ—¥æœŸå‚æ•°ï¼Œåˆ¤æ–­è¯·æ±‚æ—¥æœŸæ˜¯å¦åœ¨æŒ‡å®šæ—¶é—´æ®µå†…

  ç¤ºä¾‹ï¼š`After=2019-12-31T23:59:59.789+08:00[Asia/Shanghai]`

- åŸºäºè¿œç¨‹åœ°å€çš„æ–­è¨€å·¥å‚ RemoteAddrRoutePredicateFactoryï¼šæ¥æ”¶ä¸€ä¸ªIPåœ°å€æ®µï¼Œåˆ¤æ–­è¯·æ±‚ä¸»æœºåœ°å€æ˜¯å¦åœ¨åœ°å€æ®µä¸­

  ç¤ºä¾‹ï¼š`RemoteAddr=192.168.1.1/24`

- åŸºäºCookieçš„æ–­è¨€å·¥å‚

  CookieRoutePredicateFactoryï¼šæ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼Œcookie åå­—å’Œä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼ã€‚ åˆ¤æ–­è¯·æ±‚cookieæ˜¯å¦å…·æœ‰ç»™å®šåç§°ä¸”å€¼ä¸æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ã€‚

  ç¤ºä¾‹ï¼š`Cookie=chocolate, ch.`

- åŸºäºHeaderçš„æ–­è¨€å·¥å‚

  HeaderRoutePredicateFactoryï¼šæ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼Œæ ‡é¢˜åç§°å’Œæ­£åˆ™è¡¨è¾¾å¼ã€‚ åˆ¤æ–­è¯·æ±‚Headeræ˜¯å¦å…·æœ‰ç»™å®šåç§°ä¸”å€¼ä¸æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ã€‚

  ç¤ºä¾‹ï¼š`Header=X-Request-Id, \d+`

- åŸºäºHostçš„æ–­è¨€å·¥å‚

  HostRoutePredicateFactoryï¼šæ¥æ”¶ä¸€ä¸ªå‚æ•°ï¼Œä¸»æœºåæ¨¡å¼ã€‚åˆ¤æ–­è¯·æ±‚çš„Hostæ˜¯å¦æ»¡è¶³åŒ¹é…è§„åˆ™ã€‚

  ç¤ºä¾‹ï¼š`Host=**.testhost.org`

- åŸºäºMethodè¯·æ±‚æ–¹æ³•çš„æ–­è¨€å·¥å‚

  MethodRoutePredicateFactoryï¼šæ¥æ”¶ä¸€ä¸ªå‚æ•°ï¼Œåˆ¤æ–­è¯·æ±‚ç±»å‹æ˜¯å¦è·ŸæŒ‡å®šçš„ç±»å‹åŒ¹é…ã€‚

  ç¤ºä¾‹ï¼š`Method=GET`

- åŸºäºPathè¯·æ±‚è·¯å¾„çš„æ–­è¨€å·¥å‚

  PathRoutePredicateFactoryï¼šæ¥æ”¶ä¸€ä¸ªå‚æ•°ï¼Œåˆ¤æ–­è¯·æ±‚çš„URIéƒ¨åˆ†æ˜¯å¦æ»¡è¶³è·¯å¾„è§„åˆ™ã€‚

  ç¤ºä¾‹ï¼š`Path=/foo/{segment}`

- åŸºäºQueryè¯·æ±‚å‚æ•°çš„æ–­è¨€å·¥å‚

  QueryRoutePredicateFactory ï¼šæ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼Œè¯·æ±‚paramå’Œæ­£åˆ™è¡¨è¾¾å¼ï¼Œ åˆ¤æ–­è¯·æ±‚å‚æ•°æ˜¯å¦å…·æœ‰ç»™å®šåç§°ä¸”å€¼ä¸æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ã€‚

  ç¤ºä¾‹ï¼š`Query=baz, ba.`

- åŸºäºè·¯ç”±æƒé‡çš„æ–­è¨€å·¥å‚

  WeightRoutePredicateFactoryï¼šæ¥æ”¶ä¸€ä¸ª[ç»„å,æƒé‡], ç„¶åå¯¹äºåŒä¸€ä¸ªç»„å†…çš„è·¯ç”±æŒ‰ç…§æƒé‡è½¬å‘

  ç¤ºä¾‹:

  ```yaml
        routes:
          - id: weight_route1 
            uri: host1
            predicates:
              - Path=/product/**
              - Weight=group3, 1
          - id: weight_route2
            uri: host2
            predicates:
              - Path=/product/**
              - Weight= group3, 9
  ```

#### è‡ªå®šä¹‰è·¯ç”±æ–­è¨€å·¥å‚

1. æ–°å¢è‡ªå®šä¹‰æ–­è¨€é…ç½®

   ```yaml
   gateway:
     routes:
       - id: product_route
         uri: lb://service-product
         order: 1
         predicates:
           - Path=/product-serv/**
           # æ–°å¢çš„è‡ªå®šä¹‰æ–­è¨€é…ç½®
           - Age=20,80
         filters:
           - StripPrefix=1
   ```

2. ç¼–å†™è‡ªå®šä¹‰æ–­è¨€ç±»

   ```java
   package com.springcloud.alibaba.predicates;
   
   import lombok.Data;
   import org.apache.commons.lang3.StringUtils;
   import org.springframework.cloud.gateway.handler.predicate.AbstractRoutePredicateFactory;
   import org.springframework.cloud.gateway.handler.predicate.AfterRoutePredicateFactory;
   import org.springframework.cloud.gateway.handler.predicate.BeforeRoutePredicateFactory;
   import org.springframework.stereotype.Component;
   import org.springframework.web.server.ServerWebExchange;
   
   import java.time.ZonedDateTime;
   import java.util.Arrays;
   import java.util.Collections;
   import java.util.List;
   import java.util.function.Predicate;
   
   /**
    * Ageè‡ªå®šä¹‰æ–­è¨€ç±»
    * 
    * è‡ªå®šä¹‰æ–­è¨€ç±»å‘½åè§„èŒƒï¼šé…ç½®é¡¹ + RoutePredicateFactory
    */
   @Component
   public class AgeRoutePredicateFactory extends AbstractRoutePredicateFactory<AgeRoutePredicateFactory.Config> {
   
       public AgeRoutePredicateFactory() {
           super(AgeRoutePredicateFactory.Config.class);
       }
   
       public List<String> shortcutFieldOrder() {
           return Arrays.asList("minAge", "maxAge");
       }
   
       @Override
       public Predicate<ServerWebExchange> apply(Config config) {
           return (exchange) -> {
               // è·å–è¯·æ±‚å‚æ•°age
               String ageString = exchange.getRequest().getQueryParams().getFirst("age");
               if (StringUtils.isBlank(ageString)) {
                   return false;
               }
               // åˆ¤æ–­age
               int age = Integer.parseInt(ageString);
               return age > config.minAge && age < config.maxAge;
           };
       }
   
       @Data
       static class Config {
           private int minAge;
           private int maxAge;
       }
   }
   ```

3. æµ‹è¯•ä¼šå‘ç°ï¼Œå½“ä¸ä¼ Ageå‚æ•°æˆ–è€…Ageçš„å‚æ•°å€¼ä¸åœ¨20-80ä¹‹é—´æ—¶ï¼Œå°±ä¼šç›´æ¥è·³è½¬åˆ°é”™è¯¯é¡µé¢ã€‚åä¹‹åˆ™æ­£å¸¸è¿”å›æ•°æ®

### è¿‡æ»¤å™¨

åœ¨Gatewayä¸­, Filterçš„ç”Ÿå‘½å‘¨æœŸåªæœ‰ä¸¤ä¸ªï¼š`Pre` å’Œ `Post`

- **Pre**

  è¿™ç§è¿‡æ»¤å™¨åœ¨è¯·æ±‚è¢«è·¯ç”±ä¹‹å‰è°ƒç”¨ã€‚æˆ‘ä»¬å¯åˆ©ç”¨è¿™ç§è¿‡æ»¤å™¨å®ç°èº«ä»½éªŒè¯ã€åœ¨é›†ç¾¤ä¸­é€‰æ‹©è¯·æ±‚çš„å¾®æœåŠ¡ã€è®°å½•è°ƒè¯•ä¿¡æ¯ç­‰ã€‚

- `Post`

  è¿™ç§è¿‡æ»¤å™¨åœ¨è·¯ç”±åˆ°å¾®æœåŠ¡ä»¥åæ‰§è¡Œã€‚è¿™ç§è¿‡æ»¤å™¨å¯ç”¨æ¥ä¸ºå“åº”æ·»åŠ æ ‡å‡†çš„HTTP Headerã€æ”¶é›†ç»Ÿè®¡ä¿¡æ¯å’ŒæŒ‡æ ‡ã€å°†å“åº”ä»å¾®æœåŠ¡å‘é€ç»™å®¢æˆ·ç«¯ç­‰ã€‚

Gateway çš„Filterä»ä½œç”¨èŒƒå›´å¯åˆ†ä¸ºä¸¤ç§: `GatewayFilter`ä¸`GlobalFilter`ã€‚

- **GatewayFilter**

  åº”ç”¨åˆ°å•ä¸ªè·¯ç”±æˆ–è€…ä¸€ä¸ªåˆ†ç»„çš„è·¯ç”±ä¸Šã€‚

- **GlobalFilter**

  åº”ç”¨åˆ°æ‰€æœ‰çš„è·¯ç”±ä¸Šã€‚

#### å±€éƒ¨è¿‡æ»¤å™¨

- Spring Gatewayå†…ç½®å…·å¤‡è¿‡æ»¤å™¨

   åœ¨SpringCloud Gatewayä¸­å†…ç½®äº†å¾ˆå¤šä¸åŒç±»å‹çš„ç½‘å…³è·¯ç”±è¿‡æ»¤å™¨ã€‚å…·ä½“å¦‚ä¸‹ï¼š

   | è¿‡æ»¤å™¨å·¥å‚ç±»                | ä½œç”¨                                                         | å‚æ•°                                                         |
   | --------------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
   | AddRequestHeader            | ä¸ºåŸå§‹è¯·æ±‚æ·»åŠ Header                                         | Headerçš„åç§°åŠå€¼                                             |
   | AddRequestParameter         | ä¸ºåŸå§‹è¯·æ±‚æ·»åŠ è¯·æ±‚å‚æ•°                                       | å‚æ•°åç§°åŠå€¼                                                 |
   | AddResponseHeader           | ä¸ºåŸå§‹å“åº”æ·»åŠ Header                                         | Headerçš„åç§°åŠå€¼                                             |
   | DedupeResponseHeader        | å‰”é™¤å“åº”å¤´ä¸­é‡å¤çš„å€¼                                         | éœ€è¦å»é‡çš„Headeråç§°åŠå»é‡ç­–ç•¥                               |
   | Hystrix                     | ä¸ºè·¯ç”±å¼•å…¥Hystrixçš„æ–­è·¯å™¨ä¿æŠ¤                                | HystrixCommandçš„åç§°                                         |
   | FallbackHeaders             | ä¸ºfallbackUriçš„è¯·æ±‚å¤´ä¸­æ·»åŠ å…·ä½“çš„å¼‚å¸¸ä¿¡æ¯                    | Headerçš„åç§°                                                 |
   | PrefixPath                  | ä¸ºåŸå§‹è¯·æ±‚è·¯å¾„æ·»åŠ å‰ç¼€                                       | å‰ç¼€è·¯å¾„                                                     |
   | PreserveHostHeader          | ä¸ºè¯·æ±‚æ·»åŠ ä¸€ä¸ªpreserveHostHeader=trueçš„å±æ€§ï¼Œè·¯ç”±è¿‡æ»¤å™¨ä¼šæ£€æŸ¥è¯¥å±æ€§ä»¥å†³å®šæ˜¯å¦è¦å‘é€åŸå§‹çš„Host | æ—                                                            |
   | RequestRateLimiter          | ç”¨äºå¯¹è¯·æ±‚é™æµï¼Œé™æµç®—æ³•ä¸ºä»¤ç‰Œæ¡¶                             | keyResolverã€rateLimiterã€statusCodeã€denyEmptyKeyã€emptyKeyStatus |
   | RedirectTo                  | å°†åŸå§‹è¯·æ±‚é‡å®šå‘åˆ°æŒ‡å®šçš„URL                                  | httpçŠ¶æ€ç åŠé‡å®šå‘çš„url                                      |
   | RemoveHopByHopHeadersFilter | ä¸ºåŸå§‹è¯·æ±‚åˆ é™¤IETFç»„ç»‡è§„å®šçš„ä¸€ç³»åˆ—Header                     | é»˜è®¤å°±ä¼šå¯ç”¨ï¼Œå¯ä»¥é€šè¿‡é…ç½®æŒ‡å®šä»…åˆ é™¤å“ªäº›Header               |
   | RemoveRequestHeader         | ä¸ºåŸå§‹è¯·æ±‚åˆ é™¤æŸä¸ªHeader                                     | Headeråç§°                                                   |
   | RemoveResponseHeader        | ä¸ºåŸå§‹å“åº”åˆ é™¤æŸä¸ªHeader                                     | Headeråç§°                                                   |
   | RewritePath                 | é‡å†™åŸå§‹çš„è¯·æ±‚è·¯å¾„                                           | åŸå§‹è·¯å¾„æ­£åˆ™è¡¨è¾¾å¼ä»¥åŠé‡å†™åè·¯å¾„çš„æ­£åˆ™è¡¨è¾¾å¼                 |
   | RewriteResponseHeader       | é‡å†™åŸå§‹å“åº”ä¸­çš„æŸä¸ªHeader                                   | Headeråç§°ï¼Œå€¼çš„æ­£åˆ™è¡¨è¾¾å¼ï¼Œé‡å†™åçš„å€¼                       |
   | SaveSession                 | åœ¨è½¬å‘è¯·æ±‚ä¹‹å‰ï¼Œå¼ºåˆ¶æ‰§è¡ŒWebSession::saveæ“ä½œ                 | æ—                                                            |
   | secureHeaders               | ä¸ºåŸå§‹å“åº”æ·»åŠ ä¸€ç³»åˆ—èµ·å®‰å…¨ä½œç”¨çš„å“åº”å¤´                       | æ— ï¼Œæ”¯æŒä¿®æ”¹è¿™äº›å®‰å…¨å“åº”å¤´çš„å€¼                               |
   | SetPath                     | ä¿®æ”¹åŸå§‹çš„è¯·æ±‚è·¯å¾„                                           | ä¿®æ”¹åçš„è·¯å¾„                                                 |
   | SetResponseHeader           | ä¿®æ”¹åŸå§‹å“åº”ä¸­æŸä¸ªHeaderçš„å€¼                                 | Headeråç§°ï¼Œä¿®æ”¹åçš„å€¼                                       |
   | SetStatus                   | ä¿®æ”¹åŸå§‹å“åº”çš„çŠ¶æ€ç                                          | HTTP çŠ¶æ€ç ï¼Œå¯ä»¥æ˜¯æ•°å­—ï¼Œä¹Ÿå¯ä»¥æ˜¯å­—ç¬¦ä¸²                      |
   | StripPrefix                 | ç”¨äºæˆªæ–­åŸå§‹è¯·æ±‚çš„è·¯å¾„                                       | ä½¿ç”¨æ•°å­—è¡¨ç¤ºè¦æˆªæ–­çš„è·¯å¾„çš„æ•°é‡                               |
   | Retry                       | é’ˆå¯¹ä¸åŒçš„å“åº”è¿›è¡Œé‡è¯•                                       | retriesã€statusesã€methodsã€series                           |
   | RequestSize                 | è®¾ç½®å…è®¸æ¥æ”¶æœ€å¤§è¯·æ±‚åŒ…çš„å¤§å°ã€‚å¦‚æœè¯·æ±‚åŒ…å¤§å°è¶…è¿‡è®¾ç½®çš„<å€¼ï¼Œåˆ™è¿”å› 413 Payload TooLarge | è¯·æ±‚åŒ…å¤§å°ï¼Œå•ä½ä¸ºå­—èŠ‚ï¼Œé»˜è®¤å€¼ä¸º5M                           |
   | ModifyRequestBody           | åœ¨è½¬å‘è¯·æ±‚ä¹‹å‰ä¿®æ”¹åŸå§‹è¯·æ±‚ä½“å†…å®¹                             | ä¿®æ”¹åçš„è¯·æ±‚ä½“å†…å®¹                                           |
   | ModifyResponseBody          | ä¿®æ”¹åŸå§‹å“åº”ä½“çš„å†…å®¹                                         | ä¿®æ”¹åçš„å“åº”ä½“å†…å®¹                                           |

   å…·ä½“ä½¿ç”¨ï¼Œå»ºè®®ç™¾åº¦ã€‚

- è‡ªå®šä¹‰å…·å¤‡è¿‡æ»¤å™¨

   è‡ªå®šä¹‰è¿‡æ»¤å™¨çš„æ–¹å¼å’Œè‡ªå®šä¹‰æ–­è¨€å·¥å‚ç±»æ–¹æ³•ç±»ä¼¼

   1. æ–°å¢è‡ªå®šä¹‰è¿‡æ»¤å™¨é…ç½®

      ```yaml
      gateway:
        routes:
          - id: product_route
            uri: lb://service-product
            order: 1
            predicates:
              - Path=/product-serv/**
            filters:
              - StripPrefix=1
              # æ–°å¢è‡ªå®šä¹‰è¿‡æ»¤å™¨é…ç½®
              - Log=true,false
      ```

   2. ç¼–å†™è‡ªå®šä¹‰è¿‡æ»¤å™¨ç±»

      ```java
      package com.springcloud.alibaba.filter;
      
      import lombok.Data;
      import lombok.extern.slf4j.Slf4j;
      import org.springframework.cloud.gateway.filter.GatewayFilter;
      import org.springframework.cloud.gateway.filter.factory.AbstractGatewayFilterFactory;
      import org.springframework.stereotype.Component;
      
      import java.util.Arrays;
      import java.util.List;
      
      /**
       * è‡ªå®šä¹‰å±€éƒ¨è¿‡æ»¤å™¨
       *
       * è¿‡æ»¤å™¨å‘½åè§„åˆ™ï¼šé…ç½®é¡¹ + GatewayFilterFactory
       */
      @Slf4j
      @Component
      public class LogGatewayFilterFactory extends AbstractGatewayFilterFactory<LogGatewayFilterFactory.Config> {
      
          @Override
          public List<String> shortcutFieldOrder() {
              return Arrays.asList("consoleLog", "cacheLog");
          }
      
          @Override
          public GatewayFilter apply(Config config) {
              return (exchange, chain) -> {
                  if (config.consoleLog) {
                      log.info("å¼€å¯ConsoleLog....");
                  }
                  if (config.cacheLog) {
                      log.info("å¼€å¯CacheLog....");
                  }
      
                  return chain.filter(exchange);
              };
          }
      
      
          @Data
          public static class Config {
              private boolean consoleLog;
              private boolean cacheLog;
          }
      }
      ```

   3. æµ‹è¯•

      æ³¨æ„è§‚å¯Ÿæ§åˆ¶å°æ‰“å°çš„æ—¥å¿—ã€‚

#### å…¨å±€è¿‡æ»¤å™¨

   å…¨å±€è¿‡æ»¤å™¨ä½œç”¨äºæ‰€æœ‰è·¯ç”±, æ— éœ€é…ç½®ã€‚é€šè¿‡å…¨å±€è¿‡æ»¤å™¨å¯ä»¥å®ç°å¯¹æƒé™çš„ç»Ÿä¸€æ ¡éªŒï¼Œå®‰å…¨æ€§éªŒè¯ç­‰åŠŸèƒ½ã€‚

   - Spring Gatewayå†…ç½®å…¨å±€è¿‡æ»¤å™¨

     ![](https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/f880f2329a9107b7831be2284887d3ab49181128/springgateway%E5%86%85%E7%BD%AE%E5%85%A8%E5%B1%80%E8%BF%87%E6%BB%A4%E5%99%A8.jpg)

   - è‡ªå®šä¹‰å…¨å±€è¿‡æ»¤å™¨

     å†…ç½®çš„è¿‡æ»¤å™¨å·²ç»å¯ä»¥å®Œæˆå¤§éƒ¨åˆ†çš„åŠŸèƒ½ï¼Œä½†æ˜¯å¯¹äºä¼ä¸šå¼€å‘çš„ä¸€äº›ä¸šåŠ¡åŠŸèƒ½å¤„ç†ï¼Œè¿˜æ˜¯éœ€è¦æˆ‘ä»¬è‡ªå·±ç¼–å†™è¿‡æ»¤å™¨æ¥å®ç°çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¸€èµ·é€šè¿‡ä»£ç çš„å½¢å¼è‡ªå®šä¹‰ä¸€ä¸ªè¿‡æ»¤å™¨ï¼Œå»å®Œæˆç»Ÿä¸€çš„æƒé™æ ¡éªŒã€‚

     å¼€å‘ä¸­çš„é‰´æƒé€»è¾‘ï¼š

     - å½“å®¢æˆ·ç«¯ç¬¬ä¸€æ¬¡è¯·æ±‚æœåŠ¡æ—¶ï¼ŒæœåŠ¡ç«¯å¯¹ç”¨æˆ·è¿›è¡Œä¿¡æ¯è®¤è¯ï¼ˆç™»å½•ï¼‰
     - è®¤è¯é€šè¿‡ï¼Œå°†ç”¨æˆ·ä¿¡æ¯è¿›è¡ŒåŠ å¯†å½¢æˆtokenï¼Œè¿”å›ç»™å®¢æˆ·ç«¯ï¼Œä½œä¸ºç™»å½•å‡­è¯
     - ä»¥åæ¯æ¬¡è¯·æ±‚ï¼Œå®¢æˆ·ç«¯éƒ½æºå¸¦è®¤è¯çš„token
     - æœåŠ¡ç«¯å¯¹tokenè¿›è¡Œè§£å¯†ï¼Œåˆ¤æ–­æ˜¯å¦æœ‰æ•ˆ

     ![](https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/77b77644b65f204d7d72ad093d2343bcddcbdd7f/springcloudalibaba%E9%89%B4%E6%9D%83%E6%B5%81%E7%A8%8B%E7%A4%BA%E4%BE%8B.jpg)

     æˆ‘ä»¬è‡ªå®šä¹‰ä¸€ä¸ªè¿‡æ»¤å™¨æ¥å®Œæˆç±»ä¼¼æ“ä½œ

     å…¨å±€è¿‡æ»¤å™¨æ¯”å±€éƒ¨è¿‡æ»¤å™¨è¯ç®€å•ä¸€äº›ï¼Œç›´æ¥å®šä¹‰è¿‡æ»¤å™¨ç±»å°±OK

     ```java
     package com.springcloud.alibaba.filter;
     
     import lombok.extern.slf4j.Slf4j;
     import org.apache.commons.lang3.StringUtils;
     import org.springframework.cloud.gateway.filter.GatewayFilterChain;
     import org.springframework.cloud.gateway.filter.GlobalFilter;
     import org.springframework.core.Ordered;
     import org.springframework.http.HttpStatus;
     import org.springframework.stereotype.Component;
     import org.springframework.web.server.ServerWebExchange;
     import reactor.core.publisher.Mono;
     
     @Slf4j
     @Component
     public class AuthGlobalFilterFactory implements GlobalFilter, Ordered {
         /**
          * è‡ªå®šä¹‰çš„è¿‡æ»¤å™¨ä¸šåŠ¡é€»è¾‘
          */
         @Override
         public Mono<Void> filter(ServerWebExchange exchange, GatewayFilterChain chain) {
             String token = exchange.getRequest().getQueryParams().getFirst("token");
             if (StringUtils.isBlank(token)) {// é‰´æƒå¤±è´¥
                 log.error("éæ³•ç”¨æˆ·....");
                 exchange.getResponse().setStatusCode(HttpStatus.UNAUTHORIZED);
     
                 return exchange.getResponse().setComplete();
             }
             // é‰´æƒæˆåŠŸ, æ‰§è¡Œä¸€ç³»åˆ—ä¸šåŠ¡....
             return chain.filter(exchange);
         }
     
         /**
          * è¿‡æ»¤å™¨çš„ä¼˜å…ˆçº§, å€¼è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜
          *
          * @return orderValue
          */
         @Override
         public int getOrder() {
             return 0;
         }
     }
     ```

### ç½‘å…³é™æµ

ç½‘å…³æ˜¯æ‰€æœ‰è¯·æ±‚çš„å…¬å…±å…¥å£ï¼Œæ‰€ä»¥å¯ä»¥åœ¨ç½‘å…³è¿›è¡Œé™æµï¼Œè€Œä¸”é™æµçš„æ–¹å¼ä¹Ÿå¾ˆå¤šï¼Œæˆ‘ä»¬æœ¬æ¬¡é‡‡ç”¨å‰é¢å­¦è¿‡çš„Sentinelç»„ä»¶æ¥å®ç°ç½‘å…³çš„é™æµã€‚Sentinelæ”¯æŒå¯¹SpringCloud Gatewayã€Zuulç­‰ä¸»æµç½‘å…³è¿›è¡Œé™æµã€‚

![](https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/2ce17b106c7d3fdc0fffe05c53b86bfc94c93afa/sentinel%E7%BD%91%E5%85%B3%E9%99%90%E6%B5%81.jpg)

ä»1.6.0ç‰ˆæœ¬å¼€å§‹ï¼ŒSentinelæä¾›äº†SpringCloud Gatewayçš„é€‚é…æ¨¡å—ï¼Œå¯ä»¥æä¾›ä¸¤ç§èµ„æºç»´åº¦çš„é™æµï¼š

- **routeç»´åº¦**ï¼šå³åœ¨Springé…ç½®æ–‡ä»¶ä¸­é…ç½®çš„è·¯ç”±æ¡ç›®ï¼Œèµ„æºåä¸ºå¯¹åº”çš„routeId
- **è‡ªå®šä¹‰APIç»´åº¦**ï¼šç”¨æˆ·å¯ä»¥åˆ©ç”¨Sentinelæä¾›çš„APIæ¥è‡ªå®šä¹‰ä¸€äº›APIåˆ†ç»„

#### Routeç»´åº¦é™æµ

1. å¼•å…¥ä¾èµ–

   ```xml
   <dependency>
       <groupId>com.alibaba.csp</groupId>
       <artifactId>sentinel-spring-cloud-gateway-adapter</artifactId>
   </dependency>
   ```

2. ç¼–å†™é…ç½®ç±»

   åŸºäºSentinel çš„Gatewayé™æµæ˜¯é€šè¿‡å…¶æä¾›çš„Filteræ¥å®Œæˆçš„ï¼Œä½¿ç”¨æ—¶åªéœ€æ³¨å…¥å¯¹åº”çš„SentinelGatewayFilterå®ä¾‹ä»¥åŠ SentinelGatewayBlockExceptionHandler å®ä¾‹å³å¯ã€‚

   ```java
   package com.springcloud.alibaba.config;
   
   import com.alibaba.csp.sentinel.adapter.gateway.common.rule.GatewayFlowRule;
   import com.alibaba.csp.sentinel.adapter.gateway.common.rule.GatewayRuleManager;
   import com.alibaba.csp.sentinel.adapter.gateway.sc.SentinelGatewayFilter;
   import com.alibaba.csp.sentinel.adapter.gateway.sc.callback.BlockRequestHandler;
   import com.alibaba.csp.sentinel.adapter.gateway.sc.callback.GatewayCallbackManager;
   import com.alibaba.csp.sentinel.adapter.gateway.sc.exception.SentinelGatewayBlockExceptionHandler;
   import lombok.extern.slf4j.Slf4j;
   import org.springframework.beans.factory.ObjectProvider;
   import org.springframework.cloud.gateway.filter.GlobalFilter;
   import org.springframework.context.annotation.Bean;
   import org.springframework.context.annotation.Configuration;
   import org.springframework.core.Ordered;
   import org.springframework.core.annotation.Order;
   import org.springframework.http.HttpStatus;
   import org.springframework.http.MediaType;
   import org.springframework.http.codec.ServerCodecConfigurer;
   import org.springframework.web.reactive.function.BodyInserters;
   import org.springframework.web.reactive.function.server.ServerResponse;
   import org.springframework.web.reactive.result.view.ViewResolver;
   
   import javax.annotation.PostConstruct;
   import java.util.*;
   
   @Slf4j
   @Configuration
   public class GatewayRouteFilterConfiguration {
   
       private final List<ViewResolver> viewResolvers;
   
       private final ServerCodecConfigurer serverCodecConfigurer;
   
       public GatewayRouteFilterConfiguration(ObjectProvider<List<ViewResolver>> viewResolversProvider, ServerCodecConfigurer serverCodecConfigurer) {
           this.viewResolvers = viewResolversProvider.getIfAvailable(Collections::emptyList);
           this.serverCodecConfigurer = serverCodecConfigurer;
       }
   
       /**
        * åˆå§‹åŒ–é™æµè¿‡æ»¤å™¨
        */
       @Bean
       @Order(Ordered.HIGHEST_PRECEDENCE)// æœ€é«˜ä¼˜å…ˆçº§
       public GlobalFilter sentinelGatewayFilter() {
           return new SentinelGatewayFilter();
       }
   
       /**
        * é…ç½®é™æµçš„å¼‚å¸¸å¤„ç†å™¨
        */
       @Bean
       @Order(Ordered.HIGHEST_PRECEDENCE)// æœ€é«˜ä¼˜å…ˆçº§
       public SentinelGatewayBlockExceptionHandler sentinelGatewayBlockExceptionHandler() {
           return new SentinelGatewayBlockExceptionHandler(viewResolvers, serverCodecConfigurer);
       }
   
       /**
        * åˆå§‹åŒ–é™æµè§„åˆ™
        */
       @PostConstruct
       public void initGatewayRules() {
           Set<GatewayFlowRule> rules = new HashSet<>();
           rules.add(
                   new GatewayFlowRule("product_route") //èµ„æºåç§°,å¯¹åº”è·¯ç”±id
                           .setCount(1) // é™æµé˜ˆå€¼
                           .setIntervalSec(1) // ç»Ÿè®¡æ—¶é—´çª—å£ï¼Œå•ä½æ˜¯ç§’ï¼Œé»˜è®¤æ˜¯ 1 ç§’
                   );
           GatewayRuleManager.loadRules(rules);
       }
   
   
       /**
        * è‡ªå®šä¹‰é™æµå¼‚å¸¸é¡µé¢
        */
       @PostConstruct
       public void initBlockHandlers() {
           BlockRequestHandler blockRequestHandler = (serverWebExchange, throwable) -> {
               Map<String, Object> map = new HashMap<>();
               map.put("code", 0);
               map.put("message", "æ¥å£è¢«é™æµäº†");
               return ServerResponse.status(HttpStatus.OK).
                       contentType(MediaType.APPLICATION_JSON_UTF8).
                       body(BodyInserters.fromObject(map));
           };
           GatewayCallbackManager.setBlockHandler(blockRequestHandler);
       }
   
   }
   ```

3. æµ‹è¯•

   å¤šæ¬¡åˆ·æ–°ç•Œé¢ï¼Œå¯ä»¥çœ‹åˆ°è¢«é™æµçš„è¿”å›å€¼

   ![](https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/9c2158f088ff43d290d8904512f571d293302daf/QQ%E5%9B%BE%E7%89%8720210516224551.png)

#### APIç»´åº¦é™æµ

è‡ªå®šä¹‰APIåˆ†ç»„æ˜¯ä¸€ç§æ›´ç»†ç²’åº¦çš„é™æµè§„åˆ™å®šä¹‰

```java
package com.springcloud.alibaba.config;

import com.alibaba.csp.sentinel.adapter.gateway.common.SentinelGatewayConstants;
import com.alibaba.csp.sentinel.adapter.gateway.common.api.ApiDefinition;
import com.alibaba.csp.sentinel.adapter.gateway.common.api.ApiPathPredicateItem;
import com.alibaba.csp.sentinel.adapter.gateway.common.api.ApiPredicateItem;
import com.alibaba.csp.sentinel.adapter.gateway.common.api.GatewayApiDefinitionManager;
import com.alibaba.csp.sentinel.adapter.gateway.common.rule.GatewayFlowRule;
import com.alibaba.csp.sentinel.adapter.gateway.common.rule.GatewayRuleManager;
import com.alibaba.csp.sentinel.adapter.gateway.sc.SentinelGatewayFilter;
import com.alibaba.csp.sentinel.adapter.gateway.sc.callback.BlockRequestHandler;
import com.alibaba.csp.sentinel.adapter.gateway.sc.callback.GatewayCallbackManager;
import com.alibaba.csp.sentinel.adapter.gateway.sc.exception.SentinelGatewayBlockExceptionHandler;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.ObjectProvider;
import org.springframework.cloud.gateway.filter.GlobalFilter;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.core.Ordered;
import org.springframework.core.annotation.Order;
import org.springframework.http.HttpStatus;
import org.springframework.http.MediaType;
import org.springframework.http.codec.ServerCodecConfigurer;
import org.springframework.web.reactive.function.BodyInserters;
import org.springframework.web.reactive.function.server.ServerResponse;
import org.springframework.web.reactive.result.view.ViewResolver;

import javax.annotation.PostConstruct;
import java.util.*;

@Slf4j
@Configuration
public class GatewayApiFilterConfiguration {

    private final List<ViewResolver> viewResolvers;

    private final ServerCodecConfigurer serverCodecConfigurer;

    public GatewayApiFilterConfiguration(ObjectProvider<List<ViewResolver>> viewResolversProvider, ServerCodecConfigurer serverCodecConfigurer) {
        this.viewResolvers = viewResolversProvider.getIfAvailable(Collections::emptyList);
        this.serverCodecConfigurer = serverCodecConfigurer;
    }

    /**
     * åˆå§‹åŒ–é™æµè¿‡æ»¤å™¨
     */
    @Bean
    @Order(Ordered.HIGHEST_PRECEDENCE)// æœ€é«˜ä¼˜å…ˆçº§
    public GlobalFilter sentinelGatewayFilter() {
        return new SentinelGatewayFilter();
    }

    /**
     * é…ç½®é™æµçš„å¼‚å¸¸å¤„ç†å™¨
     */
    @Bean
    @Order(Ordered.HIGHEST_PRECEDENCE)// æœ€é«˜ä¼˜å…ˆçº§
    public SentinelGatewayBlockExceptionHandler sentinelGatewayBlockExceptionHandler() {
        return new SentinelGatewayBlockExceptionHandler(viewResolvers, serverCodecConfigurer);
    }

    /**
     * åˆå§‹åŒ–é™æµè§„åˆ™
     */
    @PostConstruct
    public void initGatewayRules() {
        Set<GatewayFlowRule> rules = new HashSet<>();
        rules.add(new GatewayFlowRule("product_api1").setCount(1).setIntervalSec(1));
        rules.add(new GatewayFlowRule("product_api2").setCount(1).setIntervalSec(1));
        GatewayRuleManager.loadRules(rules);
    }

    /**
     * å®šä¹‰éœ€è¦API
     */
    @PostConstruct
    private void initCustomizedApis() {
        Set<ApiDefinition> definitions = new HashSet<>();

        // æ–°å¢æ–­è¨€é¡¹1
        HashSet<ApiPredicateItem> apiPredicateItems1 = new HashSet<>();
        ApiPathPredicateItem apiPathPredicateItem1 = new ApiPathPredicateItem()
                .setPattern("/product-serv/product/api1/**")
                .setMatchStrategy(SentinelGatewayConstants.URL_MATCH_STRATEGY_PREFIX);
        apiPredicateItems1.add(apiPathPredicateItem1);
        ApiDefinition api1 = new ApiDefinition("product_api1").setPredicateItems(apiPredicateItems1);

        // æ–°å¢æ–­è¨€é¡¹2
        HashSet<ApiPredicateItem> apiPredicateItems2 = new HashSet<>();
        ApiPathPredicateItem apiPathPredicateItem2 = new ApiPathPredicateItem()
                .setPattern("/product-serv/product/api2/**")
                .setMatchStrategy(SentinelGatewayConstants.URL_MATCH_STRATEGY_PREFIX);
        apiPredicateItems1.add(apiPathPredicateItem2);
        ApiDefinition api2 = new ApiDefinition("product_api2")
                .setPredicateItems(apiPredicateItems2);

        // æ·»åŠ åˆ°APIå®šä¹‰åˆ—è¡¨ä¸­
        definitions.add(api1);
        definitions.add(api2);

        // å°†APIåˆ—è¡¨åŠ è½½åˆ°gatewayä¸­
        GatewayApiDefinitionManager.loadApiDefinitions(definitions);
    }


    /**
     * è‡ªå®šä¹‰é™æµå¼‚å¸¸é¡µé¢
     */
    @PostConstruct
    public void initBlockHandlers() {
        BlockRequestHandler blockRequestHandler = (serverWebExchange, throwable) -> {
            Map<String, Object> map = new HashMap<>();
            map.put("code", 0);
            map.put("message", "æ¥å£è¢«é™æµäº†");
            return ServerResponse.status(HttpStatus.OK).
                    contentType(MediaType.APPLICATION_JSON_UTF8).
                    body(BodyInserters.fromObject(map));
        };
        GatewayCallbackManager.setBlockHandler(blockRequestHandler);
    }

}
```

åœ¨`ProductController`ä¸­æ–°å¢æ¥å£

```java
    @GetMapping("product/api1/{string}")
    public JSONObject productApi1(@PathVariable String string) {
        JSONObject result = new JSONObject();
        result.put("message", "call product api1, param = " + string);
        return result;
    }

    @GetMapping("product/api2/{string}")
    public JSONObject productApi2(@PathVariable String string) {
        JSONObject result = new JSONObject();
        result.put("message", "call product api2, param = " + string);
        return result;
    }
```



æµ‹è¯•é™æµæ•ˆæœ

- æ­£å¸¸çš„è¿”å›

![](https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/9120e4f86148a50e641ad4860285ef8fdb20ea2a/QQ%E6%88%AA%E5%9B%BE20210516225937.png)

- å¿«é€Ÿåˆ·æ–°ï¼Œé™æµè¿”å›

  ![](https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/0f34b6279efecf422a65bc7c4edbe8f6983bde27/QQ%E6%88%AA%E5%9B%BE20210516230013.png)

## é“¾è·¯è¿½è¸ªï¼ˆSleuth + Zipkinï¼‰

### é“¾è·¯è¿½è¸ªç®€ä»‹

â€‹        åœ¨å¤§å‹ç³»ç»Ÿçš„å¾®æœåŠ¡åŒ–æ„å»ºä¸­ï¼Œä¸€ä¸ªç³»ç»Ÿè¢«æ‹†åˆ†æˆäº†è®¸å¤šæ¨¡å—ã€‚è¿™äº›æ¨¡å—è´Ÿè´£ä¸åŒçš„åŠŸèƒ½ï¼Œç»„åˆæˆç³»ç»Ÿï¼Œæœ€ç»ˆå¯ä»¥æä¾›ä¸°å¯Œçš„åŠŸèƒ½ã€‚åœ¨è¿™ç§æ¶æ„ä¸­ï¼Œä¸€æ¬¡è¯·æ±‚å¾€å¾€éœ€è¦æ¶‰åŠåˆ°å¤šä¸ªæœåŠ¡ã€‚äº’è”ç½‘åº”ç”¨æ„å»ºåœ¨ä¸åŒçš„è½¯ä»¶æ¨¡å—é›†ä¸Šï¼Œè¿™äº›è½¯ä»¶æ¨¡å—ï¼Œæœ‰å¯èƒ½æ˜¯ç”±ä¸åŒçš„å›¢é˜Ÿå¼€å‘ã€å¯èƒ½ä½¿ç”¨ä¸åŒçš„ç¼–ç¨‹è¯­è¨€æ¥å®ç°ã€æœ‰å¯èƒ½å¸ƒåœ¨äº†å‡ åƒå°æœåŠ¡å™¨ï¼Œæ¨ªè·¨å¤šä¸ªä¸åŒçš„æ•°æ®ä¸­å¿ƒï¼Œä¹Ÿå°±æ„å‘³ç€è¿™ç§æ¶æ„å½¢å¼ä¹Ÿä¼šå­˜åœ¨ä¸€äº›é—®é¢˜ï¼š

- å¦‚ä½•å¿«é€Ÿå‘ç°é—®é¢˜ï¼Ÿ
- å¦‚ä½•åˆ¤æ–­æ•…éšœå½±å“èŒƒå›´ï¼Ÿ
- å¦‚ä½•æ¢³ç†æœåŠ¡ä¾èµ–ä»¥åŠä¾èµ–çš„åˆç†æ€§ï¼Ÿ
- å¦‚ä½•åˆ†æé“¾è·¯æ€§èƒ½é—®é¢˜ä»¥åŠå®æ—¶å®¹é‡è§„åˆ’ï¼Ÿ

![](https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/7e416c3514f46c56e1b6cb924c3ddec1c0d3810a/springcloudalibaba%E9%93%BE%E8%B7%AF%E8%BF%BD%E8%B8%AA.jpg)

â€‹        åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ªï¼ˆDistributed Tracingï¼‰ï¼Œå°±æ˜¯å°†ä¸€æ¬¡åˆ†å¸ƒå¼è¯·æ±‚è¿˜åŸæˆè°ƒç”¨é“¾è·¯ï¼Œè¿›è¡Œæ—¥å¿—è®°å½•ï¼Œæ€§èƒ½ç›‘æ§å¹¶å°†ä¸€æ¬¡åˆ†å¸ƒå¼è¯·æ±‚çš„è°ƒç”¨æƒ…å†µé›†ä¸­å±•ç¤ºã€‚æ¯”å¦‚å„ä¸ªæœåŠ¡èŠ‚ç‚¹ä¸Šçš„è€—æ—¶ã€è¯·æ±‚å…·ä½“åˆ°è¾¾å“ªå°æœºå™¨ä¸Šã€æ¯ä¸ªæœåŠ¡èŠ‚ç‚¹çš„è¯·æ±‚çŠ¶æ€ç­‰ç­‰ã€‚

å¸¸è§çš„é“¾è·¯è¿½è¸ªæŠ€æœ¯æœ‰ä¸‹é¢è¿™äº›ï¼š

- **cat**

  ç”±å¤§ä¼—ç‚¹è¯„å¼€æºï¼ŒåŸºäºJavaå¼€å‘çš„å®æ—¶åº”ç”¨ç›‘æ§å¹³å°ï¼ŒåŒ…æ‹¬å®æ—¶åº”ç”¨ç›‘æ§ï¼Œä¸šåŠ¡ç›‘æ§ ã€‚ é›†æˆæ–¹æ¡ˆæ˜¯é€šè¿‡ä»£ç åŸ‹ç‚¹çš„æ–¹å¼æ¥å®ç°ç›‘æ§ï¼Œæ¯”å¦‚ï¼š æ‹¦æˆªå™¨ï¼Œè¿‡æ»¤å™¨ç­‰ã€‚ å¯¹ä»£ç çš„ä¾µå…¥æ€§å¾ˆå¤§ï¼Œé›†æˆæˆæœ¬è¾ƒé«˜ã€‚é£é™©è¾ƒå¤§ã€‚

- **zipkin**

  ç”±`Twitter`å…¬å¸å¼€æºï¼Œå¼€æ”¾æºä»£ç åˆ†å¸ƒå¼çš„è·Ÿè¸ªç³»ç»Ÿï¼Œç”¨äºæ”¶é›†æœåŠ¡çš„å®šæ—¶æ•°æ®ï¼Œä»¥è§£å†³å¾®æœåŠ¡æ¶æ„ä¸­çš„å»¶è¿Ÿé—®é¢˜ï¼ŒåŒ…æ‹¬ï¼šæ•°æ®çš„æ”¶é›†ã€å­˜å‚¨ã€æŸ¥æ‰¾å’Œå±•ç°ã€‚è¯¥äº§å“ç»“åˆ`spring-cloud-sleuth`ä½¿ç”¨è¾ƒä¸ºç®€å•ï¼Œ é›†æˆå¾ˆæ–¹ä¾¿ï¼Œ ä½†æ˜¯åŠŸèƒ½è¾ƒç®€å•ã€‚

- **pinpoint**

  `Pinpoint`æ˜¯åŸºäºå­—èŠ‚ç æ³¨å…¥çš„è°ƒç”¨é“¾åˆ†æï¼Œä»¥åŠåº”ç”¨ç›‘æ§åˆ†æå·¥å…·ã€‚ç‰¹ç‚¹æ˜¯æ”¯æŒå¤šç§æ’ä»¶ï¼ŒUIåŠŸèƒ½å¼ºå¤§ï¼Œæ¥å…¥ç«¯æ— ä»£ç ä¾µå…¥ã€‚

- **skywalking**

  `SkyWalking`æ˜¯æœ¬åœŸå¼€æºçš„åŸºäºå­—èŠ‚ç æ³¨å…¥çš„è°ƒç”¨é“¾åˆ†æï¼Œä»¥åŠåº”ç”¨ç›‘æ§åˆ†æå·¥å…·ã€‚ç‰¹ç‚¹æ˜¯æ”¯æŒå¤šç§æ’ä»¶ï¼ŒUIåŠŸèƒ½è¾ƒå¼ºï¼Œæ¥å…¥ç«¯æ— ä»£ç ä¾µå…¥ã€‚ç›®å‰å·²åŠ å…¥`Apache`å­µåŒ–å™¨ã€‚

- **Sleuth**

  `SpringCloud`æä¾›çš„åˆ†å¸ƒå¼ç³»ç»Ÿä¸­é“¾è·¯è¿½è¸ªè§£å†³æ–¹æ¡ˆï¼Œä¸€èˆ¬ç»“åˆ`zipkin`ä¸€èµ·ä½¿ç”¨ï¼Œ`Seluth`åšé“¾è·¯è¿½è¸ªï¼Œ`zipkin`åšé“¾è·¯æƒ…å†µçš„å¯è§†åŒ–å±•ç¤ºã€‚

### Sleuthç®€ä»‹

â€‹        `Spring Cloud Sleuth`ä¸»è¦åŠŸèƒ½å°±æ˜¯åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­æä¾›è¿½è¸ªè§£å†³æ–¹æ¡ˆã€‚å®ƒå¤§é‡å€Ÿç”¨äº†`Google Dapper`çš„è®¾è®¡ï¼Œ å…ˆæ¥äº†è§£ä¸€ä¸‹`Sleuth`ä¸­çš„æœ¯è¯­å’Œç›¸å…³æ¦‚å¿µã€‚

- Trace

  ç”±ä¸€ç»„`Trace Id`ç›¸åŒçš„`Span`ä¸²è”å½¢æˆä¸€ä¸ªæ ‘çŠ¶ç»“æ„ã€‚ä¸ºäº†å®ç°è¯·æ±‚è·Ÿè¸ªï¼Œå½“è¯·æ±‚åˆ°è¾¾åˆ†å¸ƒå¼ç³»ç»Ÿçš„å…¥å£ç«¯ç‚¹æ—¶ï¼Œåªéœ€è¦æœåŠ¡è·Ÿè¸ªæ¡†æ¶ä¸ºè¯¥è¯·æ±‚åˆ›å»ºä¸€ä¸ªå”¯ä¸€çš„æ ‡è¯†ï¼ˆå³`Trace Id`ï¼‰ï¼ŒåŒæ—¶åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿå†…éƒ¨æµè½¬çš„æ—¶å€™ï¼Œæ¡†æ¶å§‹ç»ˆä¿æŒä¼ é€’è¯¥å”¯ä¸€å€¼ï¼Œç›´åˆ°æ•´ä¸ªè¯·æ±‚çš„è¿”å›ã€‚é‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨è¯¥å”¯ä¸€æ ‡è¯†å°†æ‰€æœ‰çš„è¯·æ±‚ä¸²è”èµ·æ¥ï¼Œå½¢æˆä¸€æ¡å®Œæ•´çš„è¯·æ±‚é“¾è·¯ã€‚

- Span

  ä»£è¡¨äº†ä¸€ç»„åŸºæœ¬çš„å·¥ä½œå•å…ƒã€‚ä¸ºäº†ç»Ÿè®¡å„å¤„ç†å•å…ƒçš„å»¶è¿Ÿï¼Œå½“è¯·æ±‚åˆ°è¾¾å„ä¸ªæœåŠ¡ç»„ä»¶çš„æ—¶å€™ï¼Œä¹Ÿé€šè¿‡ä¸€ä¸ªå”¯ä¸€æ ‡è¯†ï¼ˆ`Span Id`ï¼‰æ¥æ ‡è®°å®ƒçš„å¼€å§‹ã€å…·ä½“è¿‡ç¨‹å’Œç»“æŸã€‚é€šè¿‡`Span Id`çš„å¼€å§‹å’Œç»“æŸæ—¶é—´æˆ³ï¼Œå°±èƒ½ç»Ÿè®¡è¯¥`span`çš„è°ƒç”¨æ—¶é—´ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥è·å–å¦‚äº‹ä»¶çš„åç§°ã€‚è¯·æ±‚ä¿¡æ¯ç­‰å…ƒæ•°æ®ã€‚

- Annotation

  ç”¨å®ƒè®°å½•ä¸€æ®µæ—¶é—´å†…çš„äº‹ä»¶ï¼Œå†…éƒ¨ä½¿ç”¨çš„é‡è¦æ³¨é‡Šï¼š

  csï¼ˆClient Sendï¼‰å®¢æˆ·ç«¯å‘å‡ºè¯·æ±‚ï¼Œå¼€å§‹ä¸€ä¸ªè¯·æ±‚çš„ç”Ÿå‘½

  srï¼ˆServer Receivedï¼‰æœåŠ¡ç«¯æ¥å—åˆ°è¯·æ±‚å¼€å§‹è¿›è¡Œå¤„ç†ï¼Œ srï¼cs = ç½‘ç»œå»¶è¿Ÿï¼ˆæœåŠ¡è°ƒç”¨çš„æ—¶é—´ï¼‰

  ssï¼ˆServer Sendï¼‰æœåŠ¡ç«¯å¤„ç†å®Œæ¯•å‡†å¤‡å‘é€åˆ°å®¢æˆ·ç«¯ï¼Œss - sr = æœåŠ¡å™¨ä¸Šçš„è¯·æ±‚å¤„ç†æ—¶é—´

  crï¼ˆClient Reveivedï¼‰å®¢æˆ·ç«¯æ¥å—åˆ°æœåŠ¡ç«¯çš„å“åº”ï¼Œè¯·æ±‚ç»“æŸã€‚ cr - sr = è¯·æ±‚çš„æ€»æ—¶é—´

![](https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/16f7931e9adb7da5623507e9c891b1b72ee194fa/springcloudalibabasleuth%E6%9E%B6%E6%9E%84.jpg)

### SleuthåŸºæœ¬ä½¿ç”¨

1. å¼•å…¥ä¾èµ–

   åœ¨çˆ¶å·¥ç¨‹çš„pomæ–‡ä»¶ä¸­å¼•å…¥ä¾èµ–

   ```xml
   <!--é“¾è·¯è¿½è¸ª Sleuth-->
   <dependency>
       <groupId>org.springframework.cloud</groupId>
       <artifactId>spring-cloud-starter-sleuth</artifactId>
   </dependency>
   ```

2. é‡å¯æ‰€æœ‰å¾®æœåŠ¡ï¼Œè°ƒç”¨APIåï¼Œè§‚å¯Ÿæ§åˆ¶å°ï¼Œå°±å¯ä»¥çœ‹åˆ°`Sleuth`çš„æ—¥å¿—æ‰“å°

   



æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶å¹¶ä¸æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„æ–¹æ³•ï¼Œå½“å¾®æœåŠ¡è¶Šæ¥è¶Šå¤šæ—¥å¿—æ–‡ä»¶ä¹Ÿä¼šè¶Šæ¥è¶Šå¤šï¼Œé€šè¿‡`Zipkin`å¯ä»¥å°†æ—¥å¿—èšåˆï¼Œå¹¶è¿›è¡Œå¯è§†åŒ–å±•ç¤ºå’Œå…¨æ–‡æ£€ç´¢ã€‚

### Zipkinä»‹ç»

`Zipkin` æ˜¯ `Twitter` çš„ä¸€ä¸ªå¼€æºé¡¹ç›®ï¼Œå®ƒåŸºäº`Google Dapper`å®ç°ï¼Œå®ƒè‡´åŠ›äºæ”¶é›†æœåŠ¡çš„å®šæ—¶æ•°æ®ï¼Œä»¥è§£å†³å¾®æœåŠ¡æ¶æ„ä¸­çš„å»¶è¿Ÿé—®é¢˜ï¼ŒåŒ…æ‹¬æ•°æ®çš„æ”¶é›†ã€å­˜å‚¨ã€æŸ¥æ‰¾å’Œå±•ç°ã€‚

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®ƒæ¥æ”¶é›†å„ä¸ªæœåŠ¡å™¨ä¸Šè¯·æ±‚é“¾è·¯çš„è·Ÿè¸ªæ•°æ®ï¼Œå¹¶é€šè¿‡å®ƒæä¾›çš„`REST API`æ¥å£æ¥è¾…åŠ©æˆ‘ä»¬æŸ¥è¯¢è·Ÿè¸ªæ•°æ®ä»¥å®ç°å¯¹åˆ†å¸ƒå¼ç³»ç»Ÿçš„ç›‘æ§ç¨‹åºï¼Œä»è€ŒåŠæ—¶åœ°å‘ç°ç³»ç»Ÿä¸­å‡ºç°çš„å»¶è¿Ÿå‡é«˜é—®é¢˜å¹¶æ‰¾å‡ºç³»ç»Ÿæ€§èƒ½ç“¶é¢ˆçš„æ ¹æºã€‚

é™¤äº†é¢å‘å¼€å‘çš„ `API` æ¥å£ä¹‹å¤–ï¼Œå®ƒä¹Ÿæä¾›äº†æ–¹ä¾¿çš„`UIç»„ä»¶`æ¥å¸®åŠ©æˆ‘ä»¬ç›´è§‚çš„æœç´¢è·Ÿè¸ªä¿¡æ¯å’Œåˆ†æè¯·æ±‚é“¾è·¯æ˜ç»†ï¼Œæ¯”å¦‚ï¼šå¯ä»¥æŸ¥è¯¢æŸæ®µæ—¶é—´å†…å„ç”¨æˆ·è¯·æ±‚çš„å¤„ç†æ—¶é—´ç­‰ã€‚

`Zipkin` æä¾›äº†å¯æ’æ‹”æ•°æ®å­˜å‚¨æ–¹å¼ï¼š`In-Memory`ã€`MySql`ã€`Cassandra` ä»¥åŠ `Elasticsearch`ã€‚

![](https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/a8ad9a193ae9267640df889ad4eb2a368be87869/springcloudalibaba_zipkin%E5%9F%BA%E7%A1%80%E6%9E%B6%E6%9E%84.jpg)



ä¸Šå›¾æ˜¯ `Zipkin` çš„åŸºç¡€æ¶æ„ï¼Œå®ƒä¸»è¦ç”± 4 ä¸ªæ ¸å¿ƒç»„ä»¶æ„æˆï¼š

- **Collector**ï¼šæ”¶é›†å™¨ç»„ä»¶ï¼Œå®ƒä¸»è¦ç”¨äºå¤„ç†ä»å¤–éƒ¨ç³»ç»Ÿå‘é€è¿‡æ¥çš„è·Ÿè¸ªä¿¡æ¯ï¼Œå°†è¿™äº›ä¿¡æ¯è½¬æ¢ä¸º`Zipkin`å†…éƒ¨å¤„ç†çš„ `Span` æ ¼å¼ï¼Œä»¥æ”¯æŒåç»­çš„å­˜å‚¨ã€åˆ†æã€å±•ç¤ºç­‰åŠŸèƒ½ã€‚
- **Storage**ï¼šå­˜å‚¨ç»„ä»¶ï¼Œå®ƒä¸»è¦å¯¹å¤„ç†æ”¶é›†å™¨æ¥æ”¶åˆ°çš„è·Ÿè¸ªä¿¡æ¯ï¼Œé»˜è®¤ä¼šå°†è¿™äº›ä¿¡æ¯å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä¿®æ”¹æ­¤å­˜å‚¨ç­–ç•¥ï¼Œé€šè¿‡ä½¿ç”¨å…¶ä»–å­˜å‚¨ç»„ä»¶å°†è·Ÿè¸ªä¿¡æ¯å­˜å‚¨åˆ°æ•°æ®åº“ä¸­ã€‚
- **RESTful API**ï¼š`API`ç»„ä»¶ï¼Œå®ƒä¸»è¦ç”¨æ¥æä¾›å¤–éƒ¨è®¿é—®æ¥å£ã€‚æ¯”å¦‚ç»™å®¢æˆ·ç«¯å±•ç¤ºè·Ÿè¸ªä¿¡æ¯ï¼Œæˆ–æ˜¯å¤–æ¥ç³»ç»Ÿè®¿é—®ä»¥å®ç°ç›‘æ§ç­‰ã€‚
- **Web UI**ï¼šUIç»„ä»¶ï¼Œ åŸºäº`API`ç»„ä»¶å®ç°çš„ä¸Šå±‚åº”ç”¨ã€‚é€šè¿‡UIç»„ä»¶ç”¨æˆ·å¯ä»¥æ–¹ä¾¿è€Œæœ‰ç›´è§‚åœ°æŸ¥è¯¢å’Œåˆ†æè·Ÿè¸ªä¿¡æ¯ã€‚

`Zipkin`åˆ†ä¸ºä¸¤ç«¯ï¼Œä¸€ä¸ªæ˜¯ `Zipkin`æœåŠ¡ç«¯ï¼Œä¸€ä¸ªæ˜¯ `Zipkin`å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯ä¹Ÿå°±æ˜¯å¾®æœåŠ¡çš„åº”ç”¨ã€‚ å®¢æˆ·ç«¯ä¼šé…ç½®æœåŠ¡ç«¯çš„ URL åœ°å€ï¼Œä¸€æ—¦å‘ç”ŸæœåŠ¡é—´çš„è°ƒç”¨çš„æ—¶å€™ï¼Œä¼šè¢«é…ç½®åœ¨å¾®æœåŠ¡é‡Œé¢çš„ `Sleuth` çš„ç›‘å¬å™¨ç›‘å¬ï¼Œå¹¶ç”Ÿæˆç›¸åº”çš„ `Trace` å’Œ `Span` ä¿¡æ¯å‘é€ç»™æœåŠ¡ç«¯ã€‚

### Zipkinå®‰è£…

1. ä¸‹è½½ZipKinçš„jaråŒ…ï¼Œè®¿é—®ï¼š[https://search.maven.org/remote_content?g=io.zipkin.java&a=zipkin-server&v=LATEST&c=exec](https://search.maven.org/remote_content?g=io.zipkin.java&a=zipkin-server&v=LATEST&c=exec)ï¼Œä¼šè‡ªåŠ¨å¼€å§‹ä¸‹è½½ã€‚
2. è¿è¡ŒjaråŒ…ï¼Œ`java -jar zipkin-server-2.12.9-exec.jar`
3. è®¿é—®UIç•Œé¢ï¼š`http://host:9411`ï¼Œé»˜è®¤ç«¯å£ä¸º`9411`

### Zipkiné›†æˆ

1. å¼•å…¥ä¾èµ–,ï¼Œåœ¨çˆ¶å·¥ç¨‹åŠ å…¥ä¸‹åˆ—ä¾èµ–

   ```xml
   <!--zipkiné›†æˆ-->
   <dependency>
       <groupId>org.springframework.cloud</groupId>
       <artifactId>spring-cloud-starter-zipkin</artifactId>
   </dependency>
   ```

2. åœ¨æ¯ä¸ªå¾®æœåŠ¡åŠ å…¥ä¸‹åˆ—é…ç½®

   ```yaml
   spring:   
     zipkin:
       base-url: http://192.168.149.101:9411/
       discoveryClientEnabled: false #è®©nacosæŠŠå®ƒå½“æˆä¸€ä¸ªURLï¼Œè€Œä¸è¦å½“åšæœåŠ¡å
     sleuth:
       sampler:
         probability: 1.0 #é‡‡æ ·çš„ç™¾åˆ†æ¯”
   ```

3. æµ‹è¯•ï¼Œè®¿é—®URLï¼š`http://localhost:7000/order-serv/order/prod/1`ï¼Œç„¶åè§‚å¯Ÿzipkinçš„UIç•Œé¢

   æ³¨æ„ï¼šå…³é—­ä¹‹å‰gatewayæµ‹è¯•æ—¶åŠ å…¥çš„tokenè¿‡æ»¤å™¨

   ![](https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/05f775a4e867daff98d4b86fc77aac8427747574/20211125230029.png)

4. å¯ä»¥ç‚¹å‡»ä¸‹æ–¹çš„è¯·æ±‚ï¼ŒæŸ¥çœ‹æ›´è¯¦ç»†çš„è°ƒç”¨æƒ…å†µï¼Œé‡Œé¢ä¼šç»™å‡ºAPIé€”ç»çš„å¾®æœåŠ¡çš„è€—æ—¶æƒ…å†µï¼Œä¾¿äºè§‚å¯Ÿé—®é¢˜æ‰€åœ¨å¾®æœåŠ¡ã€‚

### ZipKinæ•°æ®æŒä¹…åŒ–

> é»˜è®¤æƒ…å†µä¸‹ï¼ŒZipKinå°†é“¾è·¯æ•°æ®ä¿å­˜åœ¨å†…å­˜ä¸­çš„ï¼Œä¸€æ—¦ZipKiné‡å¯åï¼Œä¹‹å‰æ”¶é›†çš„é“¾è·¯æ•°æ®å°†å…¨éƒ¨å¤±æ•ˆï¼Œè¿™æ—¶æˆ‘ä»¬å°±éœ€è¦ç”¨åˆ°ZipKinçš„é“¾è·¯æ•°æ®æŒä¹…åŒ–äº†ã€‚
>
> è¿™é‡Œä»…ä»‹ç»å°†æ•°æ®æŒä¹…åŒ–åˆ°mysqlæ•°æ®åº“ä¸­

1. æ‰§è¡Œzipkinå®˜æ–¹æä¾›çš„è§è¡¨è¯­å¥ï¼Œåˆ›å»ºæ•°æ®åº“è¡¨

   æ³¨æ„ï¼šéœ€è¦æå‰åˆ›å»ºæ•°æ®åº“ï¼Œæˆ‘è¿™é‡Œåˆ›å»ºçš„æ•°æ®åº“åç§°ä¸ºï¼šzipkin

   ```sql
   CREATE TABLE IF NOT EXISTS zipkin_spans (
     `trace_id_high` BIGINT NOT NULL DEFAULT 0 COMMENT 'If non zero, this means the trace uses 128 bit traceIds instead of 64 bit',
     `trace_id` BIGINT NOT NULL,
     `id` BIGINT NOT NULL,
     `name` VARCHAR(255) NOT NULL,
     `parent_id` BIGINT,
     `debug` BIT(1),
     `start_ts` BIGINT COMMENT 'Span.timestamp(): epoch micros used for endTs query and to implement TTL',
     `duration` BIGINT COMMENT 'Span.duration(): micros used for minDuration and maxDuration query'
   ) ENGINE=InnoDB ROW_FORMAT=COMPRESSED CHARACTER SET=utf8 COLLATE utf8_general_ci;
   
   ALTER TABLE zipkin_spans ADD UNIQUE KEY(`trace_id_high`, `trace_id`, `id`) COMMENT 'ignore insert on duplicate';
   ALTER TABLE zipkin_spans ADD INDEX(`trace_id_high`, `trace_id`, `id`) COMMENT 'for joining with zipkin_annotations';
   ALTER TABLE zipkin_spans ADD INDEX(`trace_id_high`, `trace_id`) COMMENT 'for getTracesByIds';
   ALTER TABLE zipkin_spans ADD INDEX(`name`) COMMENT 'for getTraces and getSpanNames';
   ALTER TABLE zipkin_spans ADD INDEX(`start_ts`) COMMENT 'for getTraces ordering and range';
   
   CREATE TABLE IF NOT EXISTS zipkin_annotations (
     `trace_id_high` BIGINT NOT NULL DEFAULT 0 COMMENT 'If non zero, this means the trace uses 128 bit traceIds instead of 64 bit',
     `trace_id` BIGINT NOT NULL COMMENT 'coincides with zipkin_spans.trace_id',
     `span_id` BIGINT NOT NULL COMMENT 'coincides with zipkin_spans.id',
     `a_key` VARCHAR(255) NOT NULL COMMENT 'BinaryAnnotation.key or Annotation.value if type == -1',
     `a_value` BLOB COMMENT 'BinaryAnnotation.value(), which must be smaller than 64KB',
     `a_type` INT NOT NULL COMMENT 'BinaryAnnotation.type() or -1 if Annotation',
     `a_timestamp` BIGINT COMMENT 'Used to implement TTL; Annotation.timestamp or zipkin_spans.timestamp',
     `endpoint_ipv4` INT COMMENT 'Null when Binary/Annotation.endpoint is null',
     `endpoint_ipv6` BINARY(16) COMMENT 'Null when Binary/Annotation.endpoint is null, or no IPv6 address',
     `endpoint_port` SMALLINT COMMENT 'Null when Binary/Annotation.endpoint is null',
     `endpoint_service_name` VARCHAR(255) COMMENT 'Null when Binary/Annotation.endpoint is null'
   ) ENGINE=InnoDB ROW_FORMAT=COMPRESSED CHARACTER SET=utf8 COLLATE utf8_general_ci;
   
   ALTER TABLE zipkin_annotations ADD UNIQUE KEY(`trace_id_high`, `trace_id`, `span_id`, `a_key`, `a_timestamp`) COMMENT 'Ignore insert on duplicate';
   ALTER TABLE zipkin_annotations ADD INDEX(`trace_id_high`, `trace_id`, `span_id`) COMMENT 'for joining with zipkin_spans';
   ALTER TABLE zipkin_annotations ADD INDEX(`trace_id_high`, `trace_id`) COMMENT 'for getTraces/ByIds';
   ALTER TABLE zipkin_annotations ADD INDEX(`endpoint_service_name`) COMMENT 'for getTraces and getServiceNames';
   ALTER TABLE zipkin_annotations ADD INDEX(`a_type`) COMMENT 'for getTraces and autocomplete values';
   ALTER TABLE zipkin_annotations ADD INDEX(`a_key`) COMMENT 'for getTraces and autocomplete values';
   ALTER TABLE zipkin_annotations ADD INDEX(`trace_id`, `span_id`, `a_key`) COMMENT 'for dependencies job';
   
   CREATE TABLE IF NOT EXISTS zipkin_dependencies (
     `day` DATE NOT NULL,
     `parent` VARCHAR(255) NOT NULL,
     `child` VARCHAR(255) NOT NULL,
     `call_count` BIGINT,
     `error_count` BIGINT
   ) ENGINE=InnoDB ROW_FORMAT=COMPRESSED CHARACTER SET=utf8 COLLATE utf8_general_ci;
   
   ALTER TABLE zipkin_dependencies ADD UNIQUE KEY(`day`, `parent`, `child`);
   ```

2. ä¿®æ”¹zipkin jaråŒ…çš„å¯åŠ¨å‚æ•°

    ```shell
    # å¯åŠ¨zipkin
    java -jar zipkin-server-2.12.9-exec.jar --STORAGE_TYPE=mysql --MYSQL_HOST=192.168.149.1 --MYSQL_TCP_PORT=3306 --MYSQL_DB=zipkin --MYSQL_USER=root --MYSQL_PASS=123456
    ```

3. å†æ¬¡è®¿é—®APIï¼š`http://localhost:7000/order-serv/order/prod/1`å¹¶è§‚å¯Ÿæ•°æ®åº“çš„å˜åŒ–ï¼Œä¼šå‘ç°é“¾è·¯æ•°æ®å·²ç»å­˜å…¥äº†mysqlä¸­



## æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆRocketMQï¼‰

> è€å®è¯´ï¼Œæ¶ˆæ¯é˜Ÿåˆ—å·²ç»æ˜¯ä¸ªè€ç”Ÿå¸¸è°ˆçš„åˆ†å¸ƒå¼ç»„ä»¶äº†ï¼Œæˆ‘ä¹‹å‰ä¹Ÿæœ‰å†™è¿‡å¾ˆè¯¦ç»†çš„æ¶ˆæ¯é˜Ÿåˆ—æ–‡ç« ï¼Œåªæ˜¯ç”¨çš„æ¶ˆæ¯é˜Ÿåˆ—äº§å“ä¸åŒè€Œå·²ã€‚
>
> æ‰€ä»¥æ¶ˆæ¯é˜Ÿåˆ—çš„åŸºç¡€æ¦‚å¿µå°±ä¸åœ¨è¿™é‡Œåšä»‹ç»äº†ã€‚
>
> è¯¦æƒ…å¯è§ï¼š 
>
> [RabbitMQè¯¦è§£](https://www.imxushuai.com/2019/04/01/rabbitmq%E8%AF%A6%E8%A7%A3/)

### RocketMQå®‰è£…

1. ä¸‹è½½RocketMqï¼Œç›´æ¥è®¿é—®å®˜æ–¹ç½‘ç«™ï¼š[https://rocketmq.apache.org](https://rocketmq.apache.org/)ï¼Œé¦–é¡µä¸Šå°±å¯ä»¥ä¸‹è½½åˆ°æœ€æ–°çš„æ­£å¼ç‰ˆæœ¬ï¼Œç›´æ¥ä¸‹è½½å³å¯

   æ³¨æ„ï¼šå®‰è£…çš„æ—¶å€™ä¸‹è½½`Binary`åŒ…å°±å¯ä»¥äº†ã€‚

   ![](https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/3a909a72fec50054e38f68b2729d0a168939ee85/20211125234005.png)

2. ä¸Šä¼ ä¸‹è½½çš„å®‰è£…åŒ…åˆ°æœåŠ¡å™¨å¹¶å‡†å¤‡å®‰è£…ç¯å¢ƒï¼Œç”±äºrocketMQæ˜¯åŸºäºjavaè¯­è¨€å¼€å‘çš„ï¼Œæ‰€ä»¥éœ€è¦æå‰åœ¨æœåŠ¡å™¨å®‰è£…å¥½JDK

   æˆ‘è¿™ç”¨çš„4.9.2ï¼Œå®‰è£…çš„JDK 1.8

3. è§£å‹ä¸Šä¼ åˆ°æœåŠ¡å™¨çš„å®‰è£…åŒ…

   ```shell
   # ä½¿ç”¨unzipè§£å‹ï¼Œè‹¥æç¤º command not foundï¼Œåˆ™éœ€è¦å®‰è£…unzip
   unzip 
   
   # å®‰è£…unzipçš„å‘½ä»¤
   #yum install -y unzip
   ```

4. å¯åŠ¨NameServer

   ```shell
   nohup ./bin/mqnamesrv &
   ```

5. ï¼ˆå¯é€‰æ“ä½œï¼‰ä¿®æ”¹brokerå’ŒserveræœåŠ¡å¯åŠ¨å‚æ•°

   ç”±äºrocketMQé»˜è®¤çš„JVMå‚æ•°è®¾ç½®çš„å†…å­˜å ç”¨æ¯”è¾ƒé«˜ï¼Œæ‰€ä»¥å¯ä»¥è§†æƒ…å†µä¿®æ”¹JVMå‚æ•°è°ƒæ•´å†…å­˜å ç”¨

   ```shell
   # ä¿®æ”¹runserver.shï¼Œä¿®æ”¹JVMå‚æ•°
   vim runserver.sh
   # ä¿®æ”¹runbroker.shï¼Œä¿®æ”¹JVMå‚æ•°
   vim runbroker.sh
   # JAVA_OPT="${JAVA_OPT} -server -Xms8g -Xmx8g -Xmn4g"
   # ä¿®æ”¹ä¸ºJAVA_OPT="${JAVA_OPT} -server -Xms256m -Xmx256m -Xmn128m"
   
   # è‹¥vimæç¤º command not fountï¼Œåˆ™éœ€è¦å®‰è£…vimæˆ–è€…ä½¿ç”¨vi
   # yum install -y vim
   ```

6. å¯åŠ¨broker

   ```shell
   nohup ./bin/mqbroker -n localhost:9876 &
   ```

7. å…³é—­å‘½ä»¤

   ```shell
   # å…³é—­broker
   ./bin/mqshutdown broker
   # å…³é—­namesrv
   ./bin/mqshutdown namesrv
   ```

### RocketMQæ§åˆ¶å°å®‰è£…

1. ä¸‹è½½å®‰è£…åŒ…ï¼Œè®¿é—®ï¼š[https://github.com/apache/rocketmq-externals/tags](https://github.com/apache/rocketmq-externals/tags)ï¼Œä¸‹è½½å¯¹åº”ç³»ç»Ÿçš„å®‰è£…åŒ…

2. å°†ä¸‹è½½çš„æºç åŒ…æ‰“åŒ…æˆå¯æ‰§è¡ŒjaråŒ…

   ```shell
   # è‹¥æ²¡æœ‰MVNç¯å¢ƒè¿˜éœ€è¦å®‰è£…mavenç¯å¢ƒ
   # æ‰“åŒ…å‰ï¼Œéœ€è¦ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œè®¾ç½®å…¶rocketMQçš„nameServeråœ°å€
   
   # æ‰“åŒ…
   mvn clean package -Dmaven.test.skip=true
   ```

3. æ‰“åŒ…å®Œæˆåï¼Œå°†targetä¸­çš„å¯æ‰§è¡ŒjaråŒ…è¿è¡Œ

   ```shell
   java -jar rocketmq-console-ng-1.0.0.jar
   ```

4. è®¿é—®ï¼šhttp://192.168.149.101:8080ï¼Œå…·ä½“IPç«¯å£ä»¥å®é™…å®‰è£…é…ç½®æƒ…å†µä¸ºå‡†

### æ¡ˆä¾‹

**æ¶ˆæ¯ç”Ÿäº§è€…: è®¢å•å¾®æœåŠ¡**

1. åœ¨è®¢å•å¾®æœåŠ¡ä¸­æ·»åŠ `RocketMQ`ä¾èµ–ä»¥åŠ`spring boot rocket starter`

   ```xml
   <!--rocketmq-->
   <dependency>
   	<groupId>org.apache.rocketmq</groupId>
   	<artifactId>rocketmq-spring-boot-starter</artifactId>
   	<version>2.0.2</version>
   </dependency>
   <dependency>
   <groupId>org.apache.rocketmq</groupId>
   	<artifactId>rocketmq-client</artifactId>
   	<version>4.4.0</version>
   </dependency>
   ```

2. ä¿®æ”¹é…ç½®æ–‡ä»¶

   ```yaml
   rocketmq:
     name-server: 192.168.149.101:9876 #rocketMQæœåŠ¡çš„åœ°å€
     producer:
       group: shop-order # ç”Ÿäº§è€…ç»„
   ```

3. ä¿®æ”¹ä¸‹å•çš„é€»è¾‘

   ```java
       @Autowired
       private RocketMQTemplate rocketMQTemplate;
       //å‡†å¤‡ä¹°1ä»¶å•†å“
       @GetMapping("/order/prod/{pid}")
       public Order order(@PathVariable("pid") Integer pid) {
           log.info(">> å®¢æˆ·ä¸‹å•ï¼Œè¿™æ—¶å€™è¦è°ƒç”¨å•†å“å¾®æœåŠ¡æŸ¥è¯¢å•†å“ä¿¡æ¯");
           // é€šè¿‡Feignå®¢æˆ·ç«¯è°ƒç”¨
           Product product = productClient.findById(pid);
   
           if (product != null) {
               log.info(">> å•†å“ä¿¡æ¯,æŸ¥è¯¢ç»“æœ: {}", JSON.toJSONString(product));
               Order order = new Order();
               order.setUid(1);
               order.setUsername("æµ‹è¯•ç”¨æˆ·");
               order.setPid(product.getPid());
               order.setPname(product.getPname());
               order.setPprice(product.getPprice());
               order.setNumber(1);
               orderService.save(order);
   
               // ä¸‹å•å®Œæˆ, å‘é€æ¶ˆæ¯åˆ°ç”¨æˆ·å¾®æœåŠ¡
               rocketMQTemplate.convertAndSend("order-topic", order);
   
               return order;
           }
   
           throw new RuntimeException("è´­ä¹°å¤±è´¥!");
       }
   ```

   ä¸‹å•å®Œæˆåï¼Œå‘é€è®¢å•æ¶ˆæ¯åˆ°`RocketMQ`

**æ¶ˆæ¯æ¶ˆè´¹è€…: ç”¨æˆ·å¾®æœåŠ¡**

1. åœ¨ç”¨æˆ·å¾®æœåŠ¡ä¸­æ·»åŠ `RocketMQ`ä¾èµ–ä»¥åŠ`spring boot rocket starter`

   ```xml
   <!--nacoså®¢æˆ·ç«¯-->
   <dependency>
       <groupId>com.alibaba.cloud</groupId>
       <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
   </dependency>
   <!--rocketmq-->
   <dependency>
       <groupId>org.apache.rocketmq</groupId>
       <artifactId>rocketmq-spring-boot-starter</artifactId>
       <version>2.0.2</version>
   </dependency>
   <dependency>
       <groupId>org.apache.rocketmq</groupId>
       <artifactId>rocketmq-client</artifactId>
       <version>4.4.0</version>
   </dependency>
   ```

2. ä¿®æ”¹ä¸»ç±»ï¼ŒåŠ å…¥`@@EnableDiscoveryClient`æ³¨è§£

3. ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼ŒåŠ å…¥`nacos`ä¸`RocketMQ`ç›¸å…³é…ç½®

   ```yaml
   spring: 
     cloud:
       nacos:
         discovery:
           server-addr: 192.168.149.101:8848  
   rocketmq:
     name-server: 192.168.149.101:9876 #rocketMQæœåŠ¡çš„åœ°å€
     producer:
       group: shop-order # ç”Ÿäº§è€…ç»„
   ```

4. ç¼–å†™æ¶ˆæ¯æ¶ˆè´¹è€…ç±»

   ```java
   package com.springcloud.alibaba.user.service;
   
   import com.alibaba.fastjson.JSON;
   import com.springcloud.alibaba.common.entity.Order;
   import lombok.extern.slf4j.Slf4j;
   import org.apache.rocketmq.spring.annotation.RocketMQMessageListener;
   import org.apache.rocketmq.spring.core.RocketMQListener;
   import org.springframework.stereotype.Service;
   
   @Slf4j
   @Service
   @RocketMQMessageListener(consumerGroup = "shop-user", topic = "order-topic")
   public class SmsService implements RocketMQListener<Order> {
       @Override
       public void onMessage(Order order) {
           log.info("æ”¶åˆ°è®¢å•æ¶ˆæ¯: {}", JSON.toJSONString(order));
       }
   }
   ```

5. å¯åŠ¨è®¢å•ï¼Œäº§å“ï¼Œç”¨æˆ·å¾®æœåŠ¡ï¼Œè°ƒç”¨ä¸‹å•APIå¹¶è§‚å¯Ÿæ¶ˆæ¯æ¶ˆè´¹è¿‡ç¨‹



## é…ç½®ä¸­å¿ƒï¼ˆNacos Configï¼‰

å¾®æœåŠ¡æ¶æ„ä¸‹å…³äºé…ç½®æ–‡ä»¶çš„ä¸€äº›é—®é¢˜ï¼š
1. é…ç½®æ–‡ä»¶ç›¸å¯¹åˆ†æ•£ã€‚åœ¨ä¸€ä¸ªå¾®æœåŠ¡æ¶æ„ä¸‹ï¼Œé…ç½®æ–‡ä»¶ä¼šéšç€å¾®æœåŠ¡çš„å¢å¤šå˜çš„è¶Šæ¥è¶Šå¤šï¼Œè€Œä¸”åˆ†æ•£åœ¨å„ä¸ªå¾®æœåŠ¡ä¸­ï¼Œä¸å¥½ç»Ÿä¸€é…ç½®å’Œç®¡ç†ã€‚
2. é…ç½®æ–‡ä»¶æ— æ³•åŒºåˆ†ç¯å¢ƒã€‚å¾®æœåŠ¡é¡¹ç›®å¯èƒ½ä¼šæœ‰å¤šä¸ªç¯å¢ƒï¼Œä¾‹å¦‚ï¼šæµ‹è¯•ç¯å¢ƒã€é¢„å‘å¸ƒç¯å¢ƒã€ç”Ÿäº§ç¯å¢ƒã€‚æ¯ä¸€ä¸ªç¯å¢ƒæ‰€ä½¿ç”¨çš„é…ç½®ç†è®ºä¸Šéƒ½æ˜¯ä¸åŒçš„ï¼Œä¸€æ—¦éœ€è¦ä¿®æ”¹ï¼Œå°±éœ€è¦æˆ‘ä»¬å»å„ä¸ªå¾®æœåŠ¡ä¸‹æ‰‹åŠ¨ç»´æŠ¤ï¼Œè¿™æ¯”è¾ƒå›°éš¾ã€‚
3. é…ç½®æ–‡ä»¶æ— æ³•å®æ—¶æ›´æ–°ã€‚æˆ‘ä»¬ä¿®æ”¹äº†é…ç½®æ–‡ä»¶ä¹‹åï¼Œå¿…é¡»é‡æ–°å¯åŠ¨å¾®æœåŠ¡æ‰èƒ½ä½¿é…ç½®ç”Ÿæ•ˆï¼Œè¿™å¯¹ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„é¡¹ç›®æ¥è¯´æ˜¯éå¸¸ä¸å‹å¥½çš„ã€‚åŸºäºä¸Šé¢è¿™äº›é—®é¢˜ï¼Œæˆ‘ä»¬å°±éœ€è¦é…ç½®ä¸­å¿ƒçš„åŠ å…¥æ¥è§£å†³è¿™äº›é—®é¢˜ã€‚

é…ç½®ä¸­å¿ƒçš„æ€è·¯æ˜¯ï¼š

- é¦–å…ˆæŠŠé¡¹ç›®ä¸­å„ç§é…ç½®å…¨éƒ¨éƒ½æ”¾åˆ°ä¸€ä¸ªé›†ä¸­çš„åœ°æ–¹è¿›è¡Œç»Ÿä¸€ç®¡ç†ï¼Œå¹¶æä¾›ä¸€å¥—æ ‡å‡†çš„æ¥å£ã€‚
- å½“å„ä¸ªæœåŠ¡éœ€è¦è·å–é…ç½®çš„æ—¶å€™ï¼Œå°±æ¥é…ç½®ä¸­å¿ƒçš„æ¥å£æ‹‰å–è‡ªå·±çš„é…ç½®ã€‚
- å½“é…ç½®ä¸­å¿ƒä¸­çš„å„ç§å‚æ•°æœ‰æ›´æ–°çš„æ—¶å€™ï¼Œä¹Ÿèƒ½é€šçŸ¥åˆ°å„ä¸ªæœåŠ¡å®æ—¶çš„è¿‡æ¥åŒæ­¥æœ€æ–°çš„ä¿¡æ¯ï¼Œä½¿ä¹‹åŠ¨æ€æ›´æ–°ã€‚ 

### åŸºæœ¬ä½¿ç”¨

1. å®‰è£…Nacos

2. å¼•å…¥Nacos Configä¾èµ–

   ```xml
   <dependency>
       <groupId>com.alibaba.cloud</groupId>
       <artifactId>spring-cloud-starter-alibaba-nacos-config</artifactId>
   </dependency>
   ```

3. æ·»åŠ `bootstrap.conf`çš„é…ç½®æ–‡ä»¶

   ```yaml
   spring:
     application:
       name: service-order
     cloud:
       nacos:
         config:
           server-addr: 192.168.149.101:8848 #nacosä¸­å¿ƒåœ°å€
           file-extension: yaml # é…ç½®æ–‡ä»¶æ ¼å¼
     profiles:
       active: dev # ç¯å¢ƒæ ‡è¯†
   ```

4. å¤åˆ¶åŸæœ‰çš„é…ç½®æ–‡ä»¶åœ¨nacosä¸­åˆ›å»ºå¯¹åº”çš„é…ç½®æ–‡ä»¶ï¼Œdata idä¸ºï¼š`service-order-dev.yaml`

   ![](https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/573e7f71035581f3186869c87beedc871feba0ff/20211127185343.png)

5. ä¿®æ”¹åŸæœ‰çš„é…ç½®æ–‡ä»¶çš„åå­—ä¸º: `application.yml.bak`ï¼Œç„¶åå¯åŠ¨åº”ç”¨å¹¶è§‚å¯Ÿèƒ½å¦æˆåŠŸè¿è¡Œ

### åŠ¨æ€æ›´æ–°é…ç½®

> å®ç°äº†é…ç½®çš„è¿œç¨‹å­˜æ”¾ï¼Œä½†æ˜¯æ­¤æ—¶å¦‚æœä¿®æ”¹äº†é…ç½®ï¼Œæˆ‘ä»¬çš„ç¨‹åºæ˜¯æ— æ³•è¯»å–åˆ°çš„ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦å¼€å¯é…ç½®çš„åŠ¨æ€åˆ·æ–°åŠŸèƒ½ã€‚

1. åœ¨nacosçš„é…ç½®æ–‡ä»¶ä¸­æ·»åŠ è‡ªå®šä¹‰çš„é…ç½®é¡¹ï¼Œç”¨äºæµ‹è¯•é…ç½®åŠ¨æ€åˆ·æ–°

   ```yaml
   app:
     customer: test
   ```

2. ç¼–å†™controllerç±»ï¼Œæ–¹ä¾¿æµ‹è¯•æ›´æ–°é…ç½®åæŸ¥çœ‹æ˜¯å¦åŠ¨æ€åˆ·æ–°äº†æœ¬åœ°é…ç½®

   ```java
   package com.springcloud.alibaba.order.controller;
   
   import org.springframework.beans.factory.annotation.Value;
   import org.springframework.web.bind.annotation.GetMapping;
   import org.springframework.web.bind.annotation.RestController;
   
   @RestController
   @RefreshScope
   public class TestConfigRefreshController {
       
       @Value("${app.customer}")
       private String CUSTOMER;
       
       @GetMapping("getCustomerConfig")
       public String getCustomerConfig() {
           return CUSTOMER;
       }
   }
   ```

   > æ³¨æ„ï¼š
   >
   > - åˆ·æ–°é…ç½®çš„å…³é”®åœ¨äº: `@RefreshScope`æ³¨è§£ã€‚å¦‚æœæ²¡æœ‰æ­¤æ³¨è§£ï¼Œå°†ä¸ä¼šè‡ªåŠ¨åˆ·æ–°é…ç½®ã€‚
   > - åªæœ‰è‡ªå®šä¹‰çš„é…ç½®é¡¹éœ€è¦æ‰‹åŠ¨åŠ å…¥`@RefreshScope`æ‰èƒ½åº”ç”¨è‡ªåŠ¨åˆ·æ–°é…ç½®ï¼Œç±»ä¼¼æ•°æ®åº“é…ç½®ç­‰ï¼Œæ— éœ€é…ç½®æ³¨è§£ä¼šè‡ªåŠ¨åˆ·æ–°é…ç½®ã€‚

3. å¯åŠ¨å¾®æœåŠ¡ï¼Œå…ˆè°ƒç”¨æŸ¥çœ‹CUSTOMERçš„å€¼ï¼Œç„¶åä¿®æ”¹nacosä¸­çš„å€¼å†æ¬¡æŸ¥çœ‹ã€‚è§‚å¯Ÿæ˜¯å¦åŠ¨æ€åˆ·æ–°ã€‚

### é…ç½®å…±äº«

> â€‹		åœ¨æ—¥å¸¸çš„å¼€å‘ä¸­åŸºæœ¬ä¸ŠåŒæ ·çš„ä¸€æ®µé…ç½®ï¼Œå¯èƒ½åœ¨å¾ˆå¤šå¾®æœåŠ¡ä¸­æˆ–è€…åŒä¸ªå¾®æœåŠ¡ä¸­çš„ä¸åŒç¯å¢ƒä¸­ç”¨åˆ°ï¼Œè¿™ä¸ªæ—¶å€™å¦‚æœè¿™ä¸€æ®µé…ç½®åœ¨æ¯ä¸ªé…ç½®æ–‡ä»¶ä¸­éƒ½å†™ä¸€éï¼Œå½“é…ç½®éœ€è¦å˜æ›´æ—¶ï¼Œå°±å¿…é¡»æ¯ä¸ªé…ç½®æ–‡ä»¶éƒ½æ”¹ä¸€éï¼Œè¿™æ˜¯éå¸¸çš„éº»çƒ¦çš„ã€‚æ‰€ä»¥æ˜¯å¦æœ‰åŠæ³•å°†åŒä¸€æ®µé…ç½®åœ¨ä¸€ä¸ªåœ°æ–¹å†™å¥½ï¼Œå…¶ä»–é…ç½®æ–‡ä»¶éƒ½å»å¼•ç”¨è¿™ä¸ªé…ç½®æ–‡ä»¶å‘¢ï¼Ÿ

1. åœ¨Nacosçš„é…ç½®ä¸­å¿ƒä¸­æ–°å»ºä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œå‘½åä»»æ„å¹¶å°†å…¬å…±çš„é…ç½®ä¿¡æ¯æ”¾å…¥è¯¥é…ç½®æ–‡ä»¶

2. ä¿®æ”¹è¦å¼•å…¥è¯¥å…¬å…±é…ç½®æ–‡ä»¶çš„`bootstrap.yml`

   ```yaml
   spring:
     application:
       name: service-order
     cloud:
       nacos:
         config:
           server-addr: 192.168.149.101:8848 #nacosä¸­å¿ƒåœ°å€
           file-extension: yaml # é…ç½®æ–‡ä»¶æ ¼å¼
           #æŒ‡å®šå…±äº«é…ç½®ï¼Œä¸”æ”¯æŒåŠ¨æ€åˆ·æ–°
           ext-config:
             - data-id: datasource.yaml
               group: DEFAULT_GROUP
               refresh: true
             - data-id: common.yaml
               group: DEFAULT_GROUP
               refresh: true
     profiles:
       active: dev # ç¯å¢ƒæ ‡è¯†
   ```

3. å¯åŠ¨å¹¶è§‚å¯Ÿæ˜¯å¦æŒ‰ç…§è®¾ç½®çš„é…ç½®å¯åŠ¨äº†å¾®æœåŠ¡

## åˆ†å¸ƒå¼äº‹åŠ¡ï¼ˆSeataï¼‰

> åˆ†å¸ƒå¼çš„åŸºç¡€ç†è®ºå°±ä¸åœ¨è¿™é‡Œåšä»‹ç»äº†ã€‚
>
> æƒ³äº†è§£çš„å¯ä»¥çœ‹ä¸‹æˆ‘çš„è¿™ç¯‡æ–‡ç« ï¼š[åˆ†å¸ƒå¼äº‹åŠ¡](https://www.imxushuai.com/2020/07/01/34.%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF%E7%AC%94%E8%AE%B0%E5%8D%81%E4%BA%94%EF%BC%9A%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1-%E5%AE%8C%E7%BB%93/#%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1)

### å®‰è£…Seata

1. ä¸‹è½½seataï¼Œè®¿é—®ï¼š[https://github.com/seata/seata/releases](https://github.com/seata/seata/releases)ï¼Œä¸‹è½½å¯¹åº”ç³»ç»Ÿçš„å®‰è£…åŒ…

   æˆ‘è¿™é‡Œç”¨çš„ç‰ˆæœ¬ä¸ºï¼šseata 0.9.0

2. è§£å‹ç¼©å®‰è£…åŒ…

3. é…ç½®seata

   - ä¿®æ”¹registry.conf

     ```conf
     registry {
       # file ã€nacos ã€eurekaã€redisã€zkã€consulã€etcd3ã€sofa
       type = "nacos"
     
       nacos {
         serverAddr = "192.168.149.101"
         namespace = ""
         cluster = "default"
       }
     }
     
     config {
       # fileã€nacos ã€apolloã€zkã€consulã€etcd3
       type = "nacos"
     
       nacos {
         serverAddr = "192.168.149.101"
         namespace = ""
       }
     }
     ```

   - åœ¨å®‰è£…ç›®å½•åˆ›å»ºnacos-config.txtå¹¶ç²˜è´´ä¸‹æ–¹å†…å®¹

     ```tex
     transport.type=TCP
     transport.server=NIO
     transport.heartbeat=true
     transport.thread-factory.boss-thread-prefix=NettyBoss
     transport.thread-factory.worker-thread-prefix=NettyServerNIOWorker
     transport.thread-factory.server-executor-thread-prefix=NettyServerBizHandler
     transport.thread-factory.share-boss-worker=false
     transport.thread-factory.client-selector-thread-prefix=NettyClientSelector
     transport.thread-factory.client-selector-thread-size=1
     transport.thread-factory.client-worker-thread-prefix=NettyClientWorkerThread
     transport.thread-factory.boss-thread-size=1
     transport.thread-factory.worker-thread-size=8
     transport.shutdown.wait=3
     service.vgroup_mapping.service-order=default
     service.vgroup_mapping.service-product=default
     service.enableDegrade=false
     service.disable=false
     service.max.commit.retry.timeout=-1
     service.max.rollback.retry.timeout=-1
     client.async.commit.buffer.limit=10000
     client.lock.retry.internal=10
     client.lock.retry.times=30
     client.lock.retry.policy.branch-rollback-on-conflict=true
     client.table.meta.check.enable=true
     client.report.retry.count=5
     client.tm.commit.retry.count=1
     client.tm.rollback.retry.count=1
     store.mode=file
     store.file.dir=file_store/data
     store.file.max-branch-session-size=16384
     store.file.max-global-session-size=512
     store.file.file-write-buffer-cache-size=16384
     store.file.flush-disk-mode=async
     store.file.session.reload.read_size=100
     store.db.datasource=dbcp
     store.db.db-type=mysql
     store.db.driver-class-name=com.mysql.jdbc.Driver
     store.db.url=jdbc:mysql://127.0.0.1:3306/seata?useUnicode=true
     store.db.user=root
     store.db.password=123456
     store.db.min-conn=1
     store.db.max-conn=3
     store.db.global.table=global_table
     store.db.branch.table=branch_table
     store.db.query-limit=100
     store.db.lock-table=lock_table
     recovery.committing-retry-period=1000
     recovery.asyn-committing-retry-period=1000
     recovery.rollbacking-retry-period=1000
     recovery.timeout-retry-period=1000
     transaction.undo.data.validation=true
     transaction.undo.log.serialization=jackson
     transaction.undo.log.save.days=7
     transaction.undo.log.delete.period=86400000
     transaction.undo.log.table=undo_log
     transport.serialization=seata
     transport.compressor=none
     metrics.enabled=false
     metrics.registry-type=compact
     metrics.exporter-list=prometheus
     metrics.exporter-prometheus-port=9898
     support.spring.datasource.autoproxy=false
     ```

     éœ€è¦ä¿®æ”¹çš„ç‚¹ï¼š

     - æ·»åŠ äº‹åŠ¡ç»„ï¼Œå’Œå¾…ä¼šä»£ç ä¸­é…ç½®çš„åç§°æœ‰å…³ï¼Œéœ€è¦å’Œorder-serviceå’Œproduct-serviceä¸€è‡´

       service.vgroup_mapping.service-order=default
       service.vgroup_mapping.service-product=default

4. åœ¨ä¸šåŠ¡æ•°æ®åº“ä¸­åˆ›å»ºæ•°æ®è¡¨

   ```sql
   CREATE TABLE IF NOT EXISTS `undo_log`
   (
       `branch_id`     BIGINT       NOT NULL COMMENT 'branch transaction id',
       `xid`           VARCHAR(128) NOT NULL COMMENT 'global transaction id',
       `context`       VARCHAR(128) NOT NULL COMMENT 'undo_log context,such as serialization',
       `rollback_info` LONGBLOB     NOT NULL COMMENT 'rollback info',
       `log_status`    INT(11)      NOT NULL COMMENT '0:normal status,1:defense status',
       `log_created`   DATETIME(6)  NOT NULL COMMENT 'create datetime',
       `log_modified`  DATETIME(6)  NOT NULL COMMENT 'modify datetime',
       UNIQUE KEY `ux_undo_log` (`xid`, `branch_id`)
       ) ENGINE = INNODB
       AUTO_INCREMENT = 1
       DEFAULT CHARSET = utf8 COMMENT ='AT transaction mode undo table';
   ```
   
5. æ‰§è¡Œè„šæœ¬å°†`seata`çš„é…ç½®å¯¼å…¥`nacos`ä¸­

   ```shell
   # å‘½ä»¤è§£æï¼š-h -p æŒ‡å®šnacosçš„ç«¯å£åœ°å€ï¼›-g æŒ‡å®šé…ç½®çš„åˆ†ç»„ï¼Œæ³¨æ„ï¼Œæ˜¯é…ç½®çš„åˆ†ç»„ï¼›-t æŒ‡å®šå‘½åç©ºé—´idï¼› -u -wæŒ‡å®šnacosçš„ç”¨æˆ·åå’Œå¯†ç ï¼ŒåŒæ ·ï¼Œè¿™é‡Œå¼€å¯äº†nacosæ³¨å†Œå’Œé…ç½®è®¤è¯çš„æ‰éœ€è¦æŒ‡å®šã€‚
   # sh nacos-config.sh -h localhost -p 8848 -g SEATA_GROUP -t 0af6e97b-a684-4647-b696-7c6d42aecce7 -u nacos -w nacos
   
   # æˆ‘è¿™é‡Œå°±å…¨éƒ¨ä½¿ç”¨é»˜è®¤çš„é…ç½®ï¼Œé»˜è®¤ä¼šå°†seataé…ç½®å…¨éƒ¨å¯¼å…¥åˆ°publicå·¥ä½œç©ºé—´ä¸­
   # æ³¨æ„ï¼Œå¦‚æœæ˜¯åœ¨windosç¯å¢ƒä¸­éœ€è¦ç”¨èƒ½å¤Ÿè¿è¡Œshå‘½ä»¤çš„å®¢æˆ·ç«¯ï¼Œæ¯”å¦‚ï¼šgit bash
   ./nacos-config.sh 192.168.149.101
   ```

6. å¯åŠ¨`seata`

   ```shell
   # windows, åœ¨binç›®å½•ä¸­æ‰§è¡Œ
   seata-server.bat -p 9000 -m file
   # linux, åœ¨binç›®å½•ä¸­æ‰§è¡Œ
   ./seata-server.sh -p 9000 -m file
   
   ## å¯ä»¥ä½¿ç”¨ -p æŒ‡å®šseataè¿è¡Œçš„ç«¯å£
   ```

7. å¯ä»¥åœ¨`nacos`çš„æœåŠ¡åˆ—è¡¨ä¸­çœ‹åˆ°`serverAddr`çš„æœåŠ¡ï¼Œè¯´æ˜å¯åŠ¨æˆåŠŸ

### å¾®æœåŠ¡é…ç½®Seata

1. å¼•å…¥ä¾èµ–ï¼Œ`order-service`ä¸`product-service`ä¸­éƒ½éœ€è¦å¼•å…¥

   ```xml
   <dependency>
       <groupId>com.alibaba.cloud</groupId>
       <artifactId>spring-cloud-starter-alibaba-seata</artifactId>
   </dependency>
   ```

2. é…ç½®`seata`ï¼Œ`order-service`ä¸`product-service`ä¸­éƒ½éœ€è¦é…ç½®

   - order-serviceçš„bootstrap.yml

     ```yaml
     spring:
       cloud:
         alibaba:
           seata:
             tx-service-group: service-order  #è¦ä¸é…ç½®æ–‡ä»¶ä¸­çš„vgroupMappingä¸€è‡´
     ```

   - product-serviceçš„bootstrap.yml

     ```yaml
     spring:
       cloud:
         alibaba:
           seata:
             tx-service-group: service-product  #è¦ä¸é…ç½®æ–‡ä»¶ä¸­çš„vgroupMappingä¸€è‡´
     ```

3. é…ç½®ä»£ç†æ•°æ®æº

   Seata æ˜¯é€šè¿‡ä»£ç†æ•°æ®æºå®ç°äº‹åŠ¡åˆ†æ”¯çš„ï¼Œæ‰€ä»¥éœ€è¦é…ç½® io.seata.rm.datasource.DataSourceProxy çš„Beanï¼Œä¸”æ˜¯ @Primaryé»˜è®¤çš„æ•°æ®æºï¼Œå¦åˆ™äº‹åŠ¡ä¸ä¼šå›æ»šï¼Œæ— æ³•å®ç°åˆ†å¸ƒå¼äº‹åŠ¡ã€‚

   `order-service`å’Œ`product-service`éƒ½éœ€è¦é…ç½®

   ```java
   package com.springcloud.alibaba.order.config;
   
   import com.alibaba.druid.pool.DruidDataSource;
   import io.seata.rm.datasource.DataSourceProxy;
   import org.springframework.boot.context.properties.ConfigurationProperties;
   import org.springframework.context.annotation.Bean;
   import org.springframework.context.annotation.Configuration;
   import org.springframework.context.annotation.Primary;
   
   @Configuration
   public class DataSourceProxyConfig {
       @Bean
       @ConfigurationProperties(prefix = "spring.datasource")
       public DruidDataSource druidDataSource() {
           return new DruidDataSource();
       }
   
       @Primary
       @Bean
       public DataSourceProxy dataSource(DruidDataSource druidDataSource) {
           return new DataSourceProxy(druidDataSource);
       }
   }
   ```

4. å¤åˆ¶`registry.conf`æ–‡ä»¶åˆ°`order-service`å’Œ`product-service`çš„resourcesç›®å½•ä¸­

5. é…ç½®å®Œæˆ

### æ”¹é€ ä¸‹å•é€»è¾‘

1. åœ¨`product-service`ä¸­çš„æ–°å¢APIç”¨äºæ‰£å‡åº“å­˜

   - productServiceï¼Œæ–°å¢æ–¹æ³•

     ```java
     public void reduceInventory(Integer pid, int num) {
         Product product = this.findByPid(pid);
     
         // å‘ç”Ÿå¼‚å¸¸
         int i = 1/0;
     
         product.setStock(product.getStock() - num);
         productRepository.save(product);
     }
     ```

   - productControllerï¼Œæ–°å¢API

     ```java
     @GetMapping("product/reduceInventory")
     public void reduceInventory(@RequestParam Integer pid, @RequestParam int num) {
         productService.reduceInventory(pid, num);
     }
     ```

2. åœ¨`order-service`ä¸­çš„`ProductClient`æ–°å¢API

   ```java
   @GetMapping("product/reduceInventory")
   public void reduceInventory(@RequestParam Integer pid, @RequestParam int num);
   ```

3. `order-service`ä¸­çš„`OrderService`æ–°å¢æ–¹æ³•

   ```java
       @Autowired
       private ProductClient productClient;
       @Autowired
       private RocketMQTemplate rocketMQTemplate;
   
       @GlobalTransactional
       public Order createOrder(Integer pid) {
           log.info(">> å®¢æˆ·ä¸‹å•ï¼Œè¿™æ—¶å€™è¦è°ƒç”¨å•†å“å¾®æœåŠ¡æŸ¥è¯¢å•†å“ä¿¡æ¯");
           // é€šè¿‡Feignå®¢æˆ·ç«¯è°ƒç”¨
           Product product = productClient.findById(pid);
   
           if (product != null) {
               log.info(">> å•†å“ä¿¡æ¯,æŸ¥è¯¢ç»“æœ: {}", JSON.toJSONString(product));
               Order order = new Order();
               order.setUid(1);
               order.setUsername("æµ‹è¯•ç”¨æˆ·");
               order.setPid(product.getPid());
               order.setPname(product.getPname());
               order.setPprice(product.getPprice());
               order.setNumber(1);
               this.save(order);
   
               // å‡å°‘åº“å­˜
               productClient.reduceInventory(pid, order.getNumber());
   
               // ä¸‹å•å®Œæˆ, å‘é€æ¶ˆæ¯åˆ°ç”¨æˆ·å¾®æœåŠ¡
               rocketMQTemplate.convertAndSend("order-topic", order);
   
               return order;
           }
           return null;
       }
   ```

   åœ¨æ–¹æ³•ä¸ŠåŠ ä¸Š`@GlobalTransactional`åï¼Œåˆ†å¸ƒå¼äº‹åŠ¡å°±ä¼šç”Ÿæ•ˆï¼Œæµ‹è¯•æ—¶ï¼Œå¯ä»¥å…ˆä½¿ç”¨æ™®é€šçš„`@Transactional`æ³¨è§£å¯¹æ¯”äº‹åŠ¡æ˜¯å¦ç”Ÿæ•ˆã€‚

4. ä¿®æ”¹`order-service`ä¸­çš„`OrderController`çš„ä¸‹å•API

   ```java
       //å‡†å¤‡ä¹°1ä»¶å•†å“
       @GetMapping("/order/prod/{pid}")
       public Order order(@PathVariable("pid") Integer pid) {
           return orderService.createOrder(pid);
       }
   ```

5. è°ƒç”¨ä¸‹å•APIè§‚å¯Ÿåˆ†å¸ƒå¼äº‹åŠ¡ç”Ÿæ•ˆæƒ…å†µ

# ç»“è¯­

## æ€»ç»“

â€‹		`Spring Cloud Alibaba`åœ¨å›½å†…çš„ä½¿ç”¨ç‡è¿˜ç®—ä¸é”™ï¼Œå»å¹´ä¹Ÿç”¨`Spring Cloud Alibaba`å®Œæˆäº†å®æˆ˜ä½¿ç”¨ï¼Œç”¨åœ¨äº† å››å·é˜²æ±›äº‘å¹³å°ï¼ˆçœçº§é¡¹ç›®ï¼‰ä¸Šï¼Œæ€»ä½“æ¥è¯´`Spring Cloud Alibaba`è¿˜æ˜¯æ¯”è¾ƒå¥½ç”¨çš„ï¼ŒæŠ€æœ¯æ ˆä¹Ÿæ…¢æ…¢å˜å¾—è¶Šæ¥è¶Šæˆç†Ÿï¼Œç¤¾åŒºä¹Ÿæ¯”è¾ƒæ´»è·ƒã€‚

## æ„Ÿè¨€

â€‹		æœ€è¿‘çš„ä¸€å¹´ï¼Œå¯¹æ¯”ä¹‹å‰æ„Ÿè§‰è‡ªå·±æœ‰ç‚¹æ‡ˆæ€ äº†ã€‚ä¸»è¦æ˜¯å·¥ä½œä¸Šæ¯”è¾ƒå¿™ï¼Œä¼‘æ¯æ—¶é—´æœ‰ç‚¹ç–²äºå­¦ä¹ äº†ï¼Œå¯¼è‡´è¿™ç¯‡æ–‡ç« å®Œç»“æ¨è¿Ÿäº†å·®ä¸å¤šåŠå¹´ã€‚å¸Œæœ›å°ä¼™ä¼´ä»¬åˆ«åƒæˆ‘è¿™æ ·ï¼ŒåŠ æ²¹åŠªåŠ›çš„å­¦ä¹ ï¼Œæ—©æ—¥å®ç°ç»æµè‡ªç”±ã€‚å†²å†²å†²ï¼ï¼ï¼