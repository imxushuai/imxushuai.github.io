---
title: å­¦æˆåœ¨çº¿ç¬”è®°äº”ï¼šé¡µé¢å‘å¸ƒåŠè¯¾ç¨‹ç®¡ç†
tags:
  - å­¦æˆåœ¨çº¿
categories:
  - å­¦æˆåœ¨çº¿é¡¹ç›®
  - é»‘é©¬å­¦æˆåœ¨çº¿
  - åœ¨çº¿æ•™è‚²é¡¹ç›®
  - å®æˆ˜å­¦æˆåœ¨çº¿
  - å­¦æˆåœ¨çº¿ç¬”è®°  
date: 2020-06-10 23:41:43
---

<center><i>é¡µé¢å‘å¸ƒåŠè¯¾ç¨‹ç®¡ç†</i></center>

![](https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/master/b4e62a1134e59b327d8472906482aaae.jpg)


<!-- more -->

# é¡µé¢å‘å¸ƒ

## æŠ€æœ¯æ–¹æ¡ˆ

æœ¬é¡¹ç›®ä½¿ç”¨MQå®ç°é¡µé¢å‘å¸ƒçš„æŠ€æœ¯æ–¹æ¡ˆå¦‚ä¸‹ï¼š

![](https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/master/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF%E9%A1%B5%E9%9D%A2%E5%8F%91%E5%B8%83%E6%8A%80%E6%9C%AF%E6%96%B9%E6%A1%88.jpg)

æŠ€æœ¯æ–¹æ¡ˆè¯´æ˜ï¼š

1. å¹³å°åŒ…æ‹¬å¤šä¸ªç«™ç‚¹ï¼Œé¡µé¢å½’å±ä¸åŒçš„ç«™ç‚¹ã€‚
2. å‘å¸ƒä¸€ä¸ªé¡µé¢åº”å°†è¯¥é¡µé¢å‘å¸ƒåˆ°æ‰€å±ç«™ç‚¹çš„æœåŠ¡å™¨ä¸Šã€‚
3. æ¯ä¸ªç«™ç‚¹æœåŠ¡éƒ¨ç½²cms clientç¨‹åºï¼Œå¹¶ä¸äº¤æ¢æœºç»‘å®šï¼Œç»‘å®šæ—¶æŒ‡å®šç«™ç‚¹Idä¸ºroutingKeyã€‚æŒ‡å®šç«™ç‚¹idä¸ºroutingKeyå°±å¯ä»¥å®ç°cms clientåªèƒ½æ¥æ”¶åˆ°æ‰€å±ç«™ç‚¹çš„é¡µé¢å‘å¸ƒæ¶ˆæ¯ã€‚
4. é¡µé¢å‘å¸ƒç¨‹åºå‘MQå‘å¸ƒæ¶ˆæ¯æ—¶æŒ‡å®šé¡µé¢æ‰€å±ç«™ç‚¹Idä¸ºroutingKeyï¼Œå°†è¯¥é¡µé¢å‘å¸ƒåˆ°å®ƒæ‰€åœ¨æœåŠ¡å™¨ä¸Šçš„cms clientã€‚



é¡µé¢å‘å¸ƒæµç¨‹å›¾å¦‚ä¸‹ï¼š

![](https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/master/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF%E9%A1%B5%E9%9D%A2%E5%8F%91%E5%B8%83%E6%B5%81%E7%A8%8B%E5%9B%BE.jpg)

1. å‰ç«¯è¯·æ±‚cmsæ‰§è¡Œé¡µé¢å‘å¸ƒã€‚
2. cmsæ‰§è¡Œé™æ€åŒ–ç¨‹åºç”Ÿæˆhtmlæ–‡ä»¶ã€‚
3. cmså°†htmlæ–‡ä»¶å­˜å‚¨åˆ°GridFSä¸­ã€‚
4. cmså‘MQå‘é€é¡µé¢å‘å¸ƒæ¶ˆæ¯ã€‚
5. MQå°†é¡µé¢å‘å¸ƒæ¶ˆæ¯é€šçŸ¥ç»™Cms Clientã€‚
6. Cms Clientä»GridFSä¸­ä¸‹è½½htmlæ–‡ä»¶ã€‚
7. Cms Clientå°†htmlä¿å­˜åˆ°æ‰€åœ¨æœåŠ¡å™¨æŒ‡å®šç›®å½•ã€‚

## é¡µé¢å‘å¸ƒæ¶ˆè´¹æ–¹

### éœ€æ±‚

åŠŸèƒ½åˆ†æï¼š
åˆ›å»º`Cms Client`å·¥ç¨‹ä½œä¸ºé¡µé¢å‘å¸ƒæ¶ˆè´¹æ–¹ï¼Œå°†`Cms Client`éƒ¨ç½²åœ¨å¤šä¸ªæœåŠ¡å™¨ä¸Šï¼Œå®ƒè´Ÿè´£æ¥æ”¶åˆ°é¡µé¢å‘å¸ƒçš„æ¶ˆæ¯åä»`GridFS`ä¸­ä¸‹è½½æ–‡ä»¶åœ¨æœ¬åœ°ä¿å­˜ã€‚

éœ€æ±‚å¦‚ä¸‹ï¼š

1. å°†cms Clientéƒ¨ç½²åœ¨æœåŠ¡å™¨ï¼Œé…ç½®é˜Ÿåˆ—åç§°å’Œç«™ç‚¹IDã€‚
2. cms Clientè¿æ¥RabbitMQå¹¶ç›‘å¬å„è‡ªçš„â€œé¡µé¢å‘å¸ƒé˜Ÿåˆ—â€ã€‚
3. cms Clientæ¥æ”¶é¡µé¢å‘å¸ƒé˜Ÿåˆ—çš„æ¶ˆæ¯ã€‚
4. æ ¹æ®æ¶ˆæ¯ä¸­çš„é¡µé¢idä»mongodbæ•°æ®åº“ä¸‹è½½é¡µé¢åˆ°æœ¬åœ°ã€‚

### å·¥ç¨‹æ­å»ºçœç•¥

### pom.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <artifactId>xc-framework-parent</artifactId>
        <groupId>com.xuecheng</groupId>
        <version>1.0-SNAPSHOT</version>
        <relativePath>../xc-framework-parent/pom.xml</relativePath>
    </parent>
    <modelVersion>4.0.0</modelVersion>

    <artifactId>xc-service-manage-cms-client</artifactId>
    <dependencies>
        <dependency>
            <groupId>com.xuecheng</groupId>
            <artifactId>xc-framework-model</artifactId>
            <version>1.0-SNAPSHOT</version>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-test</artifactId>
            <scope>test</scope>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-amqp</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-mongodb</artifactId>
        </dependency>
        <dependency>
            <groupId>org.apache.commons</groupId>
            <artifactId>commons-io</artifactId>
        </dependency>
        <dependency>
            <groupId>com.alibaba</groupId>
            <artifactId>fastjson</artifactId>
        </dependency>
    </dependencies>
</project>
```

### é…ç½®æ–‡ä»¶

```yaml
server:
  port: 31000
spring:
  application:
    name: xc-service-manage-cms-client
  data:
    mongodb:
      database: xc_cms
      host: 127.0.0.1
      port: 27017
  rabbitmq:
    host: 127.0.0.1
    port: 5672
    username: xcEdu
    password: 123456
    virtualHost: /
xuecheng:
  mq:
    # cmså®¢æˆ·ç«¯ç›‘æ§çš„é˜Ÿåˆ—åç§°ï¼ˆä¸åŒçš„å®¢æˆ·ç«¯ç›‘æ§çš„é˜Ÿåˆ—ä¸èƒ½é‡å¤ï¼‰
    queue: queue_cms_postpage_01
    # æ­¤routingKeyä¸ºé—¨æˆ·ç«™ç‚¹ID
    routingKey: 5a751fab6abb5044e0d19ea1

```

### å¯åŠ¨ç±»

```java
package com.xuecheng.cms_manage_client;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.boot.autoconfigure.domain.EntityScan;
import org.springframework.context.annotation.ComponentScan;

@SpringBootApplication
@EntityScan(basePackages = "com.xuecheng.framework.domain.cms")
@ComponentScan(basePackages = "com.xuecheng.framework")
@ComponentScan(basePackages = "com.xuecheng.cms_manage_client")
public class ManageCmsClientApplication {
    public static void main(String[] args) {
        SpringApplication.run(ManageCmsClientApplication.class, args);
    }
}
```

### RabbitmqConfigï¼ˆé…ç½®ç±»ï¼‰

```java
package com.xuecheng.cms_manage_client.config;

import org.springframework.amqp.core.*;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

@Configuration
public class RabbitmqConfig {
    //é˜Ÿåˆ—beançš„åç§°
    public static final String QUEUE_CMS_POSTPAGE = "queue_cms_postpage";
    //äº¤æ¢æœºçš„åç§°
    public static final String EX_ROUTING_CMS_POSTPAGE = "ex_routing_cms_postpage";
    //é˜Ÿåˆ—çš„åç§°
    @Value("${xuecheng.mq.queue}")
    public String queue_cms_postpage_name;
    //routingKey å³ç«™ç‚¹Id
    @Value("${xuecheng.mq.routingKey}")
    public String routingKey;

    /**
     * äº¤æ¢æœºé…ç½®ä½¿ç”¨directç±»å‹
     *
     * @return the exchange
     */
    @Bean(EX_ROUTING_CMS_POSTPAGE)
    public Exchange EXCHANGE_TOPICS_INFORM() {
        return ExchangeBuilder.directExchange(EX_ROUTING_CMS_POSTPAGE).durable(true).build();
    }

    //å£°æ˜é˜Ÿåˆ—
    @Bean(QUEUE_CMS_POSTPAGE)
    public Queue QUEUE_CMS_POSTPAGE() {
        Queue queue = new Queue(queue_cms_postpage_name);
        return queue;
    }

    /**
     * ç»‘å®šé˜Ÿåˆ—åˆ°äº¤æ¢æœº
     *
     * @param queue    the queue
     * @param exchange the exchange
     * @return the binding
     */
    @Bean
    public Binding BINDING_QUEUE_INFORM_SMS(@Qualifier(QUEUE_CMS_POSTPAGE) Queue queue,
                                            @Qualifier(EX_ROUTING_CMS_POSTPAGE) Exchange exchange) {
        return BindingBuilder.bind(queue).to(exchange).with(routingKey).noargs();
    }

}
```

### Dao

æ•°æ®è®¿é—®ä»£ç å‚è€ƒ`xc-service-manage-cms`ä¸­çš„`dao`ï¼Œç›´æ¥å¤åˆ¶å³å¯

### PageService

```java
package com.xuecheng.cms_manage_client.service;

import com.mongodb.client.gridfs.GridFSBucket;
import com.mongodb.client.gridfs.GridFSDownloadStream;
import com.mongodb.client.gridfs.model.GridFSFile;
import com.xuecheng.cms_manage_client.dao.CmsPageRepository;
import com.xuecheng.cms_manage_client.dao.CmsSiteRepository;
import com.xuecheng.framework.domain.cms.CmsPage;
import com.xuecheng.framework.domain.cms.response.CmsCode;
import com.xuecheng.framework.exception.ExceptionCast;
import com.xuecheng.framework.service.BaseService;
import lombok.extern.slf4j.Slf4j;
import org.apache.commons.io.IOUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.mongodb.core.query.Criteria;
import org.springframework.data.mongodb.core.query.Query;
import org.springframework.data.mongodb.gridfs.GridFsResource;
import org.springframework.data.mongodb.gridfs.GridFsTemplate;
import org.springframework.stereotype.Service;

import java.io.*;
import java.util.Optional;

@Slf4j
@Service
public class PageService extends BaseService {

    @Autowired
    private GridFSBucket gridFSBucket;

    @Autowired
    private GridFsTemplate gridFsTemplate;

    @Autowired
    private CmsPageRepository cmsPageRepository;

    @Autowired
    private CmsSiteRepository cmsSiteRepository;

    /**
     * ä¿å­˜æŒ‡å®šé¡µé¢IDçš„htmlåˆ°æœåŠ¡å™¨
     *
     * @param pageId é¡µé¢ID
     */
    public void savePageToServerPath(String pageId) {
        CmsPage cmsPage = null;
        // æŸ¥è¯¢CmsPage
        Optional<CmsPage> optionalCmsPage = cmsPageRepository.findById(pageId);
        if (!optionalCmsPage.isPresent()) {
            ExceptionCast.cast(CmsCode.CMS_EDITPAGE_NOTEXISTS);
        }
        cmsPage = optionalCmsPage.get();

        // ä¸‹è½½æ–‡ä»¶
        InputStream inputStream = downloadFileFromMongoDB(cmsPage.getHtmlFileId());
        if (inputStream == null) {
            log.error("[é¡µé¢å‘å¸ƒæ¶ˆè´¹æ–¹] ä¸‹è½½é¡µé¢å¤±è´¥, æµå¯¹è±¡ä¸ºnull, fileId = [{}]", cmsPage.getHtmlFileId());
            return ;
        }

        // å†™å…¥æ–‡ä»¶
        FileOutputStream fileOutputStream = null;

        try {
            fileOutputStream = new FileOutputStream(new File(cmsPage.getPagePhysicalPath() + cmsPage.getPageName()));
            IOUtils.copy(inputStream, fileOutputStream);
        } catch (FileNotFoundException e) {
            log.error("[é¡µé¢å‘å¸ƒæ¶ˆè´¹æ–¹] æ–‡ä»¶æœªæ‰¾åˆ°, æ–‡ä»¶è·¯å¾„ = [{}]", cmsPage.getPagePhysicalPath() + cmsPage.getPageName());
        } catch (IOException e) {
            log.error("[é¡µé¢å‘å¸ƒæ¶ˆè´¹æ–¹] å°†æ–‡ä»¶å†™å…¥æœåŠ¡å™¨å¤±è´¥, æ–‡ä»¶è·¯å¾„ = [{}]", cmsPage.getPagePhysicalPath() + cmsPage.getPageName());
        } finally {
            try {
                if (fileOutputStream != null) {
                    fileOutputStream.close();
                }
                inputStream.close();
            } catch (IOException e) {
                log.error("[é¡µé¢å‘å¸ƒæ¶ˆè´¹æ–¹] æµå¯¹è±¡å…³é—­å¤±è´¥, é”™è¯¯ä¿¡æ¯ = ", e);
            }

        }
    }

    /**
     * ä¸‹è½½æ–‡ä»¶
     *
     * @param fileId æ–‡ä»¶ID
     * @return æ–‡ä»¶å†…å®¹
     */
    private InputStream downloadFileFromMongoDB(String fileId) {
        GridFSFile gridFSFile = gridFsTemplate.findOne(Query.query(Criteria.where("_id").is(fileId)));
        if (gridFSFile == null) {
            ExceptionCast.cast(CmsCode.CMS_GENERATEHTML_TEMPLATEISNULL);
        }
        //æ‰“å¼€ä¸‹è½½æµå¯¹è±¡
        GridFSDownloadStream gridFSDownloadStream = gridFSBucket.openDownloadStream(gridFSFile.getObjectId());
        //åˆ›å»ºgridFsResource
        GridFsResource gridFsResource = new GridFsResource(gridFSFile,gridFSDownloadStream);
        //è·å–æµä¸­çš„æ•°æ®
        try {
            return gridFsResource.getInputStream();
        } catch (IOException ignored) { }
        return null;
    }

}
```

**æ³¨æ„ï¼š**æˆ‘ä½¿ç”¨çš„è¿™ä¸€ç‰ˆæœ¬çš„æ•°æ®åº“ä¸­`cms_site`ä¸­æ²¡æœ‰ç‰©ç†è·¯å¾„è¿™ä¸€å­—æ®µï¼Œä½†æ˜¯åœ¨`cms_page`ä¸­çš„ç‰©ç†å­—æ®µä½¿ç”¨çš„æ˜¯ç»å¯¹è·¯å¾„ï¼Œæ‰€ä»¥æˆ‘è¿™é‡Œç›´æ¥ä½¿ç”¨çš„`cms_page`ä¸­çš„ç‰©ç†è·¯å¾„ã€‚

### ConsumerPostPage

ç¼–å†™é¡µé¢å‘å¸ƒæ¶ˆè´¹æ–¹ä»£ç 

```java
package com.xuecheng.cms_manage_client.mq;

import com.alibaba.fastjson.JSON;
import com.xuecheng.cms_manage_client.dao.CmsPageRepository;
import com.xuecheng.cms_manage_client.service.PageService;
import lombok.extern.slf4j.Slf4j;
import org.apache.commons.lang3.StringUtils;
import org.springframework.amqp.rabbit.annotation.RabbitListener;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import java.util.Map;

@Slf4j
@Component
public class ConsumerPostPage {

    @Autowired
    private CmsPageRepository cmsPageRepository;

    @Autowired
    private PageService pageService;

    @RabbitListener(queues = {"${xuecheng.mq.queue}"})
    public void postPage(String msg) {
        // è§£ææ¶ˆæ¯
        Map map = JSON.parseObject(msg, Map.class);
        log.info("[é¡µé¢å‘å¸ƒæ¶ˆè´¹æ–¹] æ”¶åˆ°æ¶ˆæ¯, æ¶ˆæ¯å†…å®¹ä¸º: [{}]", map.toString());

        // è·å–pageId
        String pageId = (String) map.get("pageId");
        if (StringUtils.isBlank(pageId)) {
            log.error("[é¡µé¢å‘å¸ƒæ¶ˆè´¹æ–¹] æ”¶åˆ°çš„pageIdä¸ºç©º");
            return ;
        }
        // ä¸‹è½½é¡µé¢åˆ°æœåŠ¡å™¨
        pageService.savePageToServerPath(pageId);
    }

}
```

## é¡µé¢å‘å¸ƒç”Ÿäº§æ–¹

### éœ€æ±‚

ç®¡ç†å‘˜é€šè¿‡cmsç³»ç»Ÿå‘å¸ƒâ€œé¡µé¢å‘å¸ƒâ€çš„æ¶ˆè´¹ï¼Œcmsç³»ç»Ÿä½œä¸ºé¡µé¢å‘å¸ƒçš„ç”Ÿäº§æ–¹ã€‚

éœ€æ±‚å¦‚ä¸‹ï¼š

1. ç®¡ç†å‘˜è¿›å…¥ç®¡ç†ç•Œé¢ç‚¹å‡»â€œé¡µé¢å‘å¸ƒâ€ï¼Œå‰ç«¯è¯·æ±‚cmsé¡µé¢å‘å¸ƒæ¥å£ã€‚
2. cmsé¡µé¢å‘å¸ƒæ¥å£æ‰§è¡Œé¡µé¢é™æ€åŒ–ï¼Œå¹¶å°†é™æ€åŒ–é¡µé¢å­˜å‚¨è‡³GridFSä¸­ã€‚
3. é™æ€åŒ–æˆåŠŸåï¼Œå‘æ¶ˆæ¯é˜Ÿåˆ—å‘é€é¡µé¢å‘å¸ƒçš„æ¶ˆæ¯ã€‚
   - è·å–é¡µé¢çš„ä¿¡æ¯åŠé¡µé¢æ‰€å±ç«™ç‚¹IDã€‚
   - è®¾ç½®æ¶ˆæ¯å†…å®¹ä¸ºé¡µé¢IDã€‚ï¼ˆé‡‡ç”¨jsonæ ¼å¼ï¼Œæ–¹ä¾¿æ—¥åæ‰©å±•ï¼‰
   - å‘é€æ¶ˆæ¯ç»™ex_cms_postpageäº¤æ¢æœºï¼Œå¹¶å°†ç«™ç‚¹IDä½œä¸ºroutingKeyã€‚

### RabbitMQé…ç½®

åœ¨`xc-service-manage-cms`å·¥ç¨‹ä¸­ï¼Œè¿›è¡Œä¸‹åˆ—é…ç½®ï¼š

1. å¼•å…¥ä¾èµ–ï¼ˆè‹¥æ²¡æœ‰å¼•å…¥amqpçš„ä¾èµ–ï¼Œåˆ™éœ€è¦å¼•å…¥ï¼‰

   ```xml
   <dependency>
       <groupId>org.springframework.boot</groupId>
       <artifactId>spring-boot-starter-amqp</artifactId>
   </dependency>
   ```

2. application.ymlä¸­æ–°å¢Rabbitmqç›¸å…³é…ç½®

   ```yaml
   spring:
     rabbitmq:
       host: 127.0.0.1
       port: 5672
       # æ­¤è´¦å·æ˜¯æˆ‘è‡ªè¡Œåˆ›å»ºçš„ï¼Œä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨é»˜è®¤è´¦å·ï¼šguest
       username: xcEdu
       password: 123456
       virtualHost: /
   ```

3. RabbitMQé…ç½®ç±»

   ```java
   package com.xuecheng.manage_cms.config;
   
   import org.springframework.amqp.core.Exchange;
   import org.springframework.amqp.core.ExchangeBuilder;
   import org.springframework.context.annotation.Bean;
   import org.springframework.context.annotation.Configuration;
   
   @Configuration
   public class RabbitmqConfig {
   
       //äº¤æ¢æœºçš„åç§°
       public static final String EX_ROUTING_CMS_POSTPAGE = "ex_routing_cms_postpage";
   
       /**
        * äº¤æ¢æœºé…ç½®ä½¿ç”¨directç±»å‹
        *
        * @return the exchange
        */
       @Bean(EX_ROUTING_CMS_POSTPAGE)
       public Exchange EXCHANGE_TOPICS_INFORM() {
           return ExchangeBuilder.directExchange(EX_ROUTING_CMS_POSTPAGE).durable(true).build();
       }
   
   }
   ```

### CmsPageControllerApi

åœ¨`CmsPageControllerApi`ä¸­æ–°å¢æ¥å£å®šä¹‰

```java
    @ApiOperation("é¡µé¢å‘å¸ƒ")
    ResponseResult postPage(String pageId);
```

### CmsPageController

```java
    /**
     * é¡µé¢å‘å¸ƒ
     *
     * @param pageId é¡µé¢ID
     */
    @Override
    @GetMapping("post/{pageId}")
    public ResponseResult postPage(@PathVariable String pageId) {
        return cmsPageService.postPage(pageId);
    }
```

### CmsPageService

```java
    @Autowired
    private RabbitTemplate rabbitTemplate;

    /**
     * é¡µé¢å‘å¸ƒ
     *
     * @param pageId é¡µé¢ID
     */
    @Transactional
    public CmsPageResult postPage(String pageId) {
        // æ‰§è¡Œé™æ€åŒ–
        String htmlContent = genHtml(pageId);
        isNullOrEmpty(htmlContent, CmsCode.CMS_GENERATEHTML_HTMLISNULL);

        // ä¿å­˜é¡µé¢
        CmsPage cmsPage = saveHtml(pageId, htmlContent);
        
        // å‘é€æ¶ˆæ¯åˆ°MQ
        sendMessage(cmsPage.getPageId());
    }

    /**
     * å‘é€æ¶ˆæ¯åˆ°MQ
     * 
     * @param pageId é¡µé¢ID
     */
    private void sendMessage(String pageId) {
        // æŸ¥è¯¢CmsPage
        CmsPage cmsPage = findByPageId(pageId);
        isNullOrEmpty(cmsPage, CmsCode.CMS_EDITPAGE_NOTEXISTS);
        
        // æ„é€ æ¶ˆæ¯
        JSONObject message = new JSONObject();
        message.put("pageId", pageId);

        // å‘é€æ¶ˆæ¯
        rabbitTemplate.convertAndSend(RabbitmqConfig.EX_ROUTING_CMS_POSTPAGE, cmsPage.getSiteId(), message.toJSONString());
    }

    /**
     * ä¿å­˜é™æ€é¡µé¢
     *
     * @param pageId      é¡µé¢ID
     * @param htmlContent é¡µé¢å†…å®¹
     */
    private CmsPage saveHtml(String pageId, String htmlContent) {
        // æŸ¥è¯¢CmsPage
        CmsPage cmsPage = findByPageId(pageId);
        isNullOrEmpty(cmsPage, CmsCode.CMS_EDITPAGE_NOTEXISTS);

        // åˆ é™¤åŸæœ‰htmlæ–‡ä»¶
        String htmlFileId = cmsPage.getHtmlFileId();
        if(StringUtils.isNotEmpty(htmlFileId)){
            gridFsTemplate.delete(Query.query(Criteria.where("_id").is(htmlFileId)));
        }
        
        // ä¿å­˜ç”Ÿæˆçš„html
        InputStream inputStream = IOUtils.toInputStream(htmlContent);
        ObjectId objectId = gridFsTemplate.store(inputStream, cmsPage.getPageName());

        // ä¿å­˜æ–‡ä»¶IDåˆ°CmsPage
        cmsPage.setHtmlFileId(objectId.toString());
        return cmsPageRepository.save(cmsPage);
    }
```

### å‰ç«¯

ç”¨æˆ·æ“ä½œæµç¨‹ï¼š

- ç”¨æˆ·è¿›å…¥cmsé¡µé¢åˆ—è¡¨ã€‚
- ç‚¹å‡»â€œå‘å¸ƒâ€è¯·æ±‚æœåŠ¡ç«¯æ¥å£ï¼Œå‘å¸ƒé¡µé¢ã€‚
- æç¤ºâ€œå‘å¸ƒæˆåŠŸâ€ï¼Œæˆ–å‘å¸ƒå¤±è´¥ã€‚

ä»£ç å®ç°å¦‚ä¸‹

1. `cms.js`ä¸­æ–°å¢æ¥å£å®šä¹‰

   ```javascript
   /**
    * é¡µé¢å‘å¸ƒ
    */
   export const postPage = (pageId) => { 
       return http.requestQuickGet(apiUrl + '/cms/page/post/'+ pageId)
   }
   ```

2. åœ¨`page_list.vue`ä¸­æ–°å¢`å‘å¸ƒ`æŒ‰é’®ï¼Œä¸`é¡µé¢é¢„è§ˆ`æŒ‰é’®ç±»ä¼¼

   ```vue
   <el-button
       size="small"
       type="text"
       @click="postPage(scope.$index, scope.row)">å‘å¸ƒ
   </el-button>
   ```

3. åœ¨`page_list.vue`çš„æ–¹æ³•åŒºä¸­ï¼Œæ–°å¢`postPage`æ–¹æ³•ï¼Œç”¨äºè°ƒç”¨é¡µé¢å‘å¸ƒæ¥å£

   ```javascript
   postPage:function(index, data) {
       this.$confirm('ç¡®è®¤å‘å¸ƒæ­¤é¡µé¢?', 'æç¤º', {
           confirmButtonText: 'ç¡®å®š',
           cancelButtonText: 'å–æ¶ˆ',
           type: 'warning'
       }).then(() => {
           // é¡µé¢å‘å¸ƒ
           cmsApi.postPage(data.pageId).then(res => {
               // æç¤ºæ¶ˆæ¯
               this.$message({
                   showClose: true,
                   message: res.message,
                   type: 'success'
               })
           })
       })
   }
   ```

## æµ‹è¯•

1. è®¾ç½®é¡µé¢ä¿¡æ¯

   ![](https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/master/20190915182359.png)

2. ç‚¹å‡»å‘å¸ƒ

3. æŸ¥çœ‹æ˜¯å¦ç”Ÿæˆæ–‡ä»¶

   ![](https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/master/20190915182537.png)

   OKï¼Œæ–‡ä»¶æˆåŠŸå‘å¸ƒå¹¶ä¿å­˜ã€‚

# è¯¾ç¨‹ç®¡ç†

## å¾®æœåŠ¡å·¥ç¨‹å¯¼å…¥ï¼ˆçœç•¥ï¼‰

## å‰ç«¯å·¥ç¨‹å¯¼å…¥æ’å‘

æˆ‘è¿™é‡Œå¯¼å…¥å‰ç«¯å·¥ç¨‹åï¼Œè¿è¡ŒæŠ¥é”™ï¼ï¼ï¼

é”™è¯¯ä¿¡æ¯ï¼š

```error
Node Sass does not yet support your current environment: Windows 64-bit with Unsupported runtime (64)
```

ï¼Ÿï¼Ÿï¼Ÿwhat f**k

ç„¶åæˆ‘å»`node-sass`çš„githubçœ‹äº†ä¸‹ï¼Œå¥½åƒä¹Ÿæœ‰è›®å¤šäººé‡åˆ°ç±»ä¼¼é—®é¢˜çš„ã€‚

https://github.com/microsoft/PartsUnlimited/issues/134

è§£å†³æ–¹æ³•ï¼š

1. ä½¿ç”¨`npm update`æ›´æ–°ç‰ˆæœ¬ï¼Œéœ€è¦æ³¨æ„ä»`npm v2.6.1` å¼€å§‹ï¼Œ`npm update`åªæ›´æ–°é¡¶å±‚æ¨¡å—ï¼Œè€Œä¸æ›´æ–°ä¾èµ–çš„æ¨¡å—ï¼Œä»¥å‰ç‰ˆæœ¬æ˜¯é€’å½’æ›´æ–°çš„ã€‚å¦‚æœæƒ³å–åˆ°è€ç‰ˆæœ¬çš„æ•ˆæœï¼Œè¦ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤

   ```shell
   npm --depth 9999 update
   ```

2. é‡æ–°buildä¸€ä¸‹`node-sass`

   ```shell
   npm rebuild node-sass
   ```

**ç„¶åå°±å¯ä»¥ç›´æ¥ï¼šnpm run dev**

æˆåŠŸè¿è¡Œã€‚

## è¯¾ç¨‹ç®¡ç†å®ç°

### åˆ†æ

1. è¯¾ç¨‹åˆ—è¡¨æŸ¥è¯¢ï¼Œè¯¥åŠŸèƒ½å‰ç«¯åŸºæœ¬ä¸Šæ²¡ä»€ä¹ˆéœ€è¦ä¿®æ”¹çš„åœ°æ–¹äº†ï¼Œç›´æ¥å†™åç«¯çš„åˆ†é¡µæŸ¥è¯¢æ¥å£å³å¯ã€‚
2. è¯¾ç¨‹çš„æ–°å¢å’Œç¼–è¾‘ï¼ˆé‡ç‚¹ï¼‰ï¼Œå‰ç«¯å·²ç»å¸®æˆ‘æŠŠè¯¾ç¨‹ä¸­çš„**è¯¾ç¨‹åˆ†ç±»**ï¼Œ**é€‚ç”¨ç­‰çº§**ä»¥åŠ**å­¦ä¹ æ¨¡å¼**çš„æŸ¥è¯¢è°ƒç”¨ç»™æˆ‘å†™å¥½äº†ï¼Œæˆ‘ä»¬åªéœ€è¦å®Œæˆå“åº”æ¥å£çš„ç¼–å†™ã€‚
   - è¯¾ç¨‹åˆ†ç±»çš„æŸ¥è¯¢æ¯”è¾ƒç®€å•ï¼Œåœ¨è¯¾ç¨‹å¾®æœåŠ¡ä¸­`Category`è¡¨ä¸­å°±èƒ½å¤Ÿå–åˆ°æ•°æ®ï¼Œç»“æœåªéœ€è¦å°è£…åœ¨`CategoryNode`ä¸­å³å¯ã€‚éƒ½æ˜¯å·²ç»å†™å¥½çš„å®ä½“ç±»ã€‚
   - é€‚ç”¨ç­‰çº§å’Œå­¦ä¹ æ¨¡å¼æŸ¥è¯¢ï¼Œéƒ½åœ¨`mongodb`æ•°æ®åº“ä¸­ï¼Œä¹Ÿå°±æ˜¯ä¹‹å‰çš„CMSç›¸å…³çš„æ•°æ®åº“ä¸­ï¼Œæˆ‘ä»¬éœ€è¦åœ¨CMSå¾®æœåŠ¡ä¸­æ–°å¢æ•°æ®å­—å…¸æ•°æ®çš„æŸ¥è¯¢ï¼Œå®ä½“ç±»åˆ†åˆ«æ˜¯ï¼š`SysDictionary`å’Œ`SysDictionaryValue`
   - ç¼–è¾‘çš„æ—¶å€™ï¼Œè¿˜éœ€è¦æ•°æ®çš„å›æ˜¾ï¼Œè¿™å°±éœ€è¦å®ŒæˆæŸ¥è¯¢ã€‚

### æ•°æ®å­—å…¸æŸ¥è¯¢å®ç°

1. DictionaryController

   ```java
   package com.xuecheng.system.controller;
   
   import com.xuecheng.framework.domain.system.SysDictionary;
   import com.xuecheng.framework.model.response.CommonCode;
   import com.xuecheng.framework.web.BaseController;
   import com.xuecheng.system.service.DictionaryService;
   import org.springframework.beans.factory.annotation.Autowired;
   import org.springframework.web.bind.annotation.GetMapping;
   import org.springframework.web.bind.annotation.PathVariable;
   import org.springframework.web.bind.annotation.RequestMapping;
   import org.springframework.web.bind.annotation.RestController;
   
   @RestController
   @RequestMapping("sys/dictionary")
   public class DictionaryController extends BaseController {
   
       @Autowired
       private DictionaryService dictionaryService;
   
       /**
        * æŒ‰typeè·å–æ•°æ®å­—æ®µå€¼
        *
        * @param type æ•°æ®ç±»å‹
        * @return SysDictionary
        */
       @GetMapping("get/{type}")
       public SysDictionary getDictionaryByType(@PathVariable String type) {
           SysDictionary sysDictionary = dictionaryService.findByType(type);
           isNullOrEmpty(sysDictionary, CommonCode.PARAMS_ERROR);
           return sysDictionary;
       }
   
   }
   ```

2. DictionaryService

   ```java
   package com.xuecheng.system.service;
   
   import com.xuecheng.framework.domain.system.SysDictionary;
   import com.xuecheng.framework.service.BaseService;
   import com.xuecheng.manage_cms.dao.DictionaryRepository;
   import lombok.extern.slf4j.Slf4j;
   import org.springframework.beans.factory.annotation.Autowired;
   import org.springframework.stereotype.Service;
   
   @Slf4j
   @Service
   public class DictionaryService extends BaseService {
   
       @Autowired
       private DictionaryRepository dictionaryRepository;
   
       /**
        * æŒ‰typeè·å–æ•°æ®å­—æ®µå€¼
        *
        * @param type æ•°æ®ç±»å‹
        * @return SysDictionary
        */
       public SysDictionary findByType(String type) {
           return dictionaryRepository.findByDType(type);
       }
   }
   ```

3. DictionaryRepository

   ```java
   package com.xuecheng.manage_cms.dao;
   
   import com.xuecheng.framework.domain.system.SysDictionary;
   import org.springframework.data.mongodb.repository.MongoRepository;
   
   public interface DictionaryRepository extends MongoRepository<SysDictionary, String> {
   
       SysDictionary findByDType(String type);
   
   }
   ```

**æ³¨æ„ï¼š**

å› ä¸ºå‰ç«¯å·²ç»å†™å¥½äº†æ¥å£è°ƒç”¨è€Œä¸”è°ƒç”¨çš„ç«¯å£å·æ˜¯cmså¾®æœåŠ¡å¯¹åº”ç«¯å£å·ï¼Œæ‰€ä»¥å¦‚æœä¸æƒ³ä¿®æ”¹å‰ç«¯çš„è°ƒç”¨ç«¯å£çš„è¯ï¼Œå»ºè®®ç›´æ¥å°†æ•°æ®å­—å…¸æŸ¥è¯¢çš„ä»£ç å†™åœ¨cmså¾®æœåŠ¡ä¸­ã€‚

### è¯¾ç¨‹ç®¡ç†å®ç°

1. CourseController

   ```java
   package com.xuecheng.manage_course.controller;
   
   import com.xuecheng.api.course.CourseBaseControllerApi;
   import com.xuecheng.framework.domain.course.CourseBase;
   import com.xuecheng.framework.domain.course.request.CourseListRequest;
   import com.xuecheng.framework.domain.course.response.AddCourseResult;
   import com.xuecheng.framework.domain.course.response.CourseBaseResult;
   import com.xuecheng.framework.domain.course.response.CourseCode;
   import com.xuecheng.framework.model.response.CommonCode;
   import com.xuecheng.framework.model.response.QueryResponseResult;
   import com.xuecheng.framework.web.BaseController;
   import com.xuecheng.manage_course.service.CourseBaseService;
   import org.springframework.beans.factory.annotation.Autowired;
   import org.springframework.web.bind.annotation.*;
   
   @RestController
   @RequestMapping("course/coursebase")
   public class CourseBaseController extends BaseController implements CourseBaseControllerApi {
   
       @Autowired
       private CourseBaseService courseBaseService;
   
   
       @Override
       @GetMapping("list/{page}/{size}")
       public QueryResponseResult findList(@PathVariable int page,
                                           @PathVariable int size,
                                           CourseListRequest queryPageRequest) {
           return courseBaseService.findList(page, size, queryPageRequest);
       }
   
       /**
        * æ–°å¢è¯¾ç¨‹åŸºæœ¬ä¿¡æ¯
        *
        * @param courseBase è¯¾ç¨‹åŸºæœ¬ä¿¡æ¯
        */
       @Override
       @PostMapping("add")
       public AddCourseResult addCourse(@RequestBody CourseBase courseBase) {
           isNullOrEmpty(courseBase, CommonCode.PARAMS_ERROR);
           CourseBase add = courseBaseService.add(courseBase);
           isNullOrEmpty(add, CommonCode.SERVER_ERROR);
           return new AddCourseResult(CommonCode.SUCCESS, add.getId());
       }
   
       /**
        * ç¼–è¾‘è¯¾ç¨‹åŸºæœ¬ä¿¡æ¯
        *
        * @param courseBase è¯¾ç¨‹åŸºæœ¬ä¿¡æ¯
        */
       @Override
       @PutMapping("edit")
       public AddCourseResult editCourse(@RequestBody CourseBase courseBase) {
           isNullOrEmpty(courseBase, CommonCode.PARAMS_ERROR);
           courseBaseService.edit(courseBase);
           return null;
       }
   
       /**
        * æŒ‰è¯¾ç¨‹IDæŸ¥è¯¢è¯¾ç¨‹åŸºæœ¬ä¿¡æ¯
        *
        * @param courseId
        */
       @Override
       @GetMapping("{courseId}")
       public CourseBaseResult findById(@PathVariable String courseId) {
           isNullOrEmpty(courseId, CommonCode.PARAMS_ERROR);
           CourseBase courseBase = courseBaseService.findById(courseId);
           isNullOrEmpty(courseBase, CourseCode.COURSE_NOT_EXIST);
           return CourseBaseResult.SUCCESS(courseBase);
       }
   }
   ```

2. CourseBaseService

   ```java
   package com.xuecheng.manage_course.service;
   
   import com.xuecheng.framework.domain.course.CourseBase;
   import com.xuecheng.framework.domain.course.request.CourseListRequest;
   import com.xuecheng.framework.domain.course.response.CourseCode;
   import com.xuecheng.framework.model.response.CommonCode;
   import com.xuecheng.framework.model.response.QueryResponseResult;
   import com.xuecheng.framework.model.response.QueryResult;
   import com.xuecheng.framework.service.BaseService;
   import com.xuecheng.manage_course.dao.CourseBaseRepository;
   import lombok.extern.slf4j.Slf4j;
   import org.apache.commons.lang3.StringUtils;
   import org.springframework.beans.factory.annotation.Autowired;
   import org.springframework.data.domain.Example;
   import org.springframework.data.domain.Page;
   import org.springframework.data.domain.PageRequest;
   import org.springframework.stereotype.Service;
   
   @Slf4j
   @Service
   public class CourseBaseService extends BaseService {
   
       @Autowired
       private CourseBaseRepository courseBaseRepository;
   
       /**
        * æ–°å¢è¯¾ç¨‹åŸºæœ¬ä¿¡æ¯
        *
        * @param courseBase è¯¾ç¨‹åŸºæœ¬ä¿¡æ¯
        * @return CourseBase
        */
       public CourseBase add(CourseBase courseBase) {
           // æ–°å¢
           return courseBaseRepository.save(courseBase);
       }
   
       /**
        * ç¼–è¾‘è¯¾ç¨‹åŸºæœ¬ä¿¡æ¯
        *
        * @param courseBase è¯¾ç¨‹åŸºæœ¬ä¿¡æ¯
        * @return CourseBase
        */
       public CourseBase edit(CourseBase courseBase) {
           CourseBase _courseBase = findById(courseBase.getId());
           isNullOrEmpty(_courseBase, CourseCode.COURSE_NOT_EXIST);
           // æ›´æ–°
           _courseBase.setName(courseBase.getName());
           _courseBase.setMt(courseBase.getMt());
           _courseBase.setSt(courseBase.getSt());
           _courseBase.setGrade(courseBase.getGrade());
           _courseBase.setStudymodel(courseBase.getStudymodel());
           _courseBase.setDescription(courseBase.getDescription());
   
           return courseBaseRepository.save(_courseBase);
       }
   
       /**
        * æŒ‰IDæŸ¥è¯¢è¯¾ç¨‹åŸºæœ¬ä¿¡æ¯
        *
        * @param courseBaseId è¯¾ç¨‹ID
        * @return CourseBase
        */
       public CourseBase findById(String courseBaseId) {
           return courseBaseRepository.findById(courseBaseId).orElse(null);
       }
   
       /**
        * åˆ†é¡µæŸ¥è¯¢è¯¾ç¨‹åŸºæœ¬ä¿¡æ¯
        *
        * @param page             å½“å‰é¡µç 
        * @param size             æ¯é¡µè®°å½•æ•°
        * @param queryPageRequest æŸ¥è¯¢æ¡ä»¶
        * @return QueryResponseResult
        */
       public QueryResponseResult findList(int page, int size, CourseListRequest queryPageRequest) {
           if (page < 0) {
               page = 1;
           }
   
           // é¡µç ä¸‹æ ‡ä»0å¼€å§‹
           page = page - 1;
           CourseBase params = new CourseBase();
           if (StringUtils.isNotBlank(queryPageRequest.getCompanyId())) {
               params.setCompanyId(queryPageRequest.getCompanyId());
           }
           Example<CourseBase> courseBaseExample = Example.of(params);
   
           // åˆ†é¡µæŸ¥è¯¢
           Page<CourseBase> pageResult = courseBaseRepository.findAll(courseBaseExample, PageRequest.of(page, size));
   
           QueryResult<CourseBase> queryResult = new QueryResult<>();
           queryResult.setTotal(pageResult.getTotalElements());
           queryResult.setList(pageResult.getContent());
   
           return new QueryResponseResult(CommonCode.SUCCESS, queryResult);
       }
   }
   ```

3. CourseBaseRepository

   ```java
   package com.xuecheng.manage_course.dao;
   
   import com.xuecheng.framework.domain.course.CourseBase;
   import org.springframework.data.jpa.repository.JpaRepository;
   
   /**
    * Created by Administrator.
    */
   public interface CourseBaseRepository extends JpaRepository<CourseBase,String> {
   }
   ```

### åˆ†ç±»åˆ—è¡¨æŸ¥è¯¢

1. CategoryController

   ```java
   package com.xuecheng.manage_course.controller;
   
   import com.xuecheng.api.course.CategoryControllerApi;
   import com.xuecheng.framework.domain.course.ext.CategoryNode;
   import com.xuecheng.framework.web.BaseController;
   import com.xuecheng.manage_course.service.CategoryService;
   import org.springframework.beans.factory.annotation.Autowired;
   import org.springframework.web.bind.annotation.GetMapping;
   import org.springframework.web.bind.annotation.RequestMapping;
   import org.springframework.web.bind.annotation.RestController;
   
   @RestController
   @RequestMapping("category")
   public class CategoryController extends BaseController implements CategoryControllerApi {
   
       @Autowired
       private CategoryService categoryService;
   
       /**
        * æŸ¥è¯¢åˆ†ç±»åˆ—è¡¨
        *
        * @return CategoryNode
        */
       @Override
       @GetMapping("list")
       public CategoryNode findCategoryList() {
           return categoryService.findCategoryList();
       }
   }
   ```

2. CategoryService

   ```java
   package com.xuecheng.manage_course.service;
   
   import com.xuecheng.framework.domain.course.Category;
   import com.xuecheng.framework.domain.course.ext.CategoryNode;
   import com.xuecheng.manage_course.dao.CategoryRepository;
   import lombok.extern.slf4j.Slf4j;
   import org.springframework.beans.factory.annotation.Autowired;
   import org.springframework.stereotype.Service;
   
   import java.util.List;
   import java.util.stream.Collectors;
   
   @Slf4j
   @Service
   public class CategoryService {
   
       @Autowired
       private CategoryRepository categoryRepository;
   
       /**
        * æŸ¥è¯¢åˆ†ç±»åˆ—è¡¨
        *
        * @return CategoryNode
        */
       public CategoryNode findCategoryList() {
           CategoryNode sourceCategoryNode = buildCategoryNode(categoryRepository.findByParentid("0").get(0));
   
           // æŸ¥è¯¢ç¬¬äºŒçº§åˆ†ç±»åˆ—è¡¨
           List<Category> secondaryCategoryList = categoryRepository.findByParentid(sourceCategoryNode.getId());
           List<CategoryNode> secondaryCategoryNodeList = buildCategoryNodeList(secondaryCategoryList);
   
           sourceCategoryNode.setChildren(secondaryCategoryNodeList);
   
           return sourceCategoryNode;
       }
   
       /**
        * æ„é€ åˆ†ç±»èŠ‚ç‚¹åˆ—è¡¨
        *
        * @param categoryList
        * @return List<CategoryNode>
        */
       private List<CategoryNode> buildCategoryNodeList(List<Category> categoryList) {
           return categoryList.stream().map(secondaryCategory -> {
               CategoryNode categoryNode = buildCategoryNode(secondaryCategory);
               // æŸ¥è¯¢å­èŠ‚ç‚¹
               List<Category> children = categoryRepository.findByParentid(categoryNode.getId());
               List<CategoryNode> categoryNodes = buildCategoryNodeList(children);
               if (!categoryNodes.isEmpty()) {
                   categoryNode.setChildren(categoryNodes);
               }
   
               return categoryNode;
           }).collect(Collectors.toList());
       }
   
   
       /**
        * æ„é€ åˆ†ç±»èŠ‚ç‚¹æ•°æ®
        *
        * @param category åˆ†ç±»
        * @return CategoryNode
        */
       private CategoryNode buildCategoryNode(Category category) {
           CategoryNode categoryNode = new CategoryNode();
           categoryNode.setId(category.getId());
           categoryNode.setIsleaf(category.getIsleaf());
           categoryNode.setLabel(category.getLabel());
           categoryNode.setName(category.getName());
   
           return categoryNode;
       }
   }
   ```

3. CategoryRepository

   ```java
   package com.xuecheng.manage_course.dao;
   
   import com.xuecheng.framework.domain.course.Category;
   import org.springframework.data.repository.CrudRepository;
   
   import java.util.List;
   
   public interface CategoryRepository extends CrudRepository<Category, String> {
   
       List<Category> findByParentid(String parentId);
   }
   ```

### å‰ç«¯

å‰ç«¯åŸºæœ¬æ²¡ä»€ä¹ˆéœ€è¦æ”¹åŠ¨çš„åœ°æ–¹ï¼Œå› ä¸ºæˆ‘åœ¨è¯¾ç¨‹ç®¡ç†ä¸­ï¼Œä½¿ç”¨äº†è‡ªå·±æ–°å»ºçš„è¿”å›å¯¹è±¡`CourseBaseResult`ï¼Œæ‰€ä»¥å‰ç«¯å°±éœ€è¦æ”¹ä¸€ç‚¹ä¸œè¥¿ï¼Œè´¹åŠ›ä¸è®¨å¥½å•Šï¼Œå»ºè®®å„ä½ç›´æ¥ä½¿ç”¨`CourseBase`ä½œä¸ºæŸ¥è¯¢çš„è¿”å›å€¼ï¼

![](https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/master/20190918215026.png)

è¿˜æœ‰å°±æ˜¯å‰ç«¯ä½¿ç”¨`element-ui`ç‰ˆæœ¬ï¼Œå±å®æœ‰ç‚¹å¤ªä½äº†ï¼Œå¾ˆå¤šæ•ˆæœæ˜¯å‡ºä¸æ¥çš„ï¼Œæ‰€ä»¥æˆ‘è¿›è¡Œäº†ç‰ˆæœ¬æ›´æ¢ï¼Œæˆ‘æ›´æ¢åˆ°`2.10.1`ä¹‹åï¼Œè¯¾ç¨‹çš„æ–°å¢å’Œç¼–è¾‘é¡µçš„å¤´éƒ¨å¯¼èˆªèœå•å‡ºç°äº†æ ·å¼é”™è¯¯ï¼Œæˆ‘ä¿®æ”¹äº†ä¸€ä¸‹

![](https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/master/20190918220103.png)

ä¿®æ”¹ä¹‹å‰ï¼Œæ˜¯ç”¨`router-link`æ ‡ç­¾åŒ…è£¹çš„`el-menu-item`æ ‡ç­¾ã€‚

åŸºæœ¬å°±è¿™äº›äº†ã€‚

# è¯¾ç¨‹è®¡åˆ’

## è¯¾ç¨‹è®¡åˆ’æŸ¥è¯¢

### CoursePlanController

```java
package com.xuecheng.manage_course.controller;

import com.xuecheng.api.course.CoursePlanControllerApi;
import com.xuecheng.framework.domain.course.ext.TeachplanNode;
import com.xuecheng.manage_course.service.CoursePlanService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
@RequestMapping("course/teachplan")
public class CoursePlanController implements CoursePlanControllerApi {

    @Autowired
    private CoursePlanService coursePlanService;

    /**
     * æŸ¥è¯¢æŒ‡å®šè¯¾ç¨‹çš„è¯¾ç¨‹ID
     *
     * @param courseId è¯¾ç¨‹ID
     * @return TeachPlanNode
     */
    @Override
    @GetMapping("list/{courseId}")
    public TeachplanNode findList(@PathVariable String courseId) {
        return coursePlanService.findList(courseId);
    }
}
```

### CoursePlanService

```java
package com.xuecheng.manage_course.service;

import com.xuecheng.framework.domain.course.ext.TeachplanNode;
import com.xuecheng.framework.service.BaseService;
import com.xuecheng.manage_course.dao.CoursePlanMapper;
import com.xuecheng.manage_course.dao.CoursePlanRepository;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

/**
 * è¯¾ç¨‹è®¡åˆ’Service
 */
@Slf4j
@Service
public class CoursePlanService extends BaseService {

    @Autowired
    private CoursePlanRepository coursePlanRepository;

    @Autowired
    private CoursePlanMapper coursePlanMapper;


    /**
     * æŸ¥è¯¢æŒ‡å®šè¯¾ç¨‹çš„è¯¾ç¨‹ID
     *
     * @param courseId è¯¾ç¨‹ID
     * @return TeachPlanNode
     */
    public TeachplanNode findList(String courseId) {
        return coursePlanMapper.findList(courseId);
    }
}
```

### CoursePlanMapper

```java
package com.xuecheng.manage_course.dao;

import com.xuecheng.framework.domain.course.ext.TeachplanNode;
import org.apache.ibatis.annotations.Mapper;

@Mapper
public interface CoursePlanMapper {

    /**
     * æŸ¥è¯¢è¯¾ç¨‹è®¡åˆ’åˆ—è¡¨
     *
     * param courseId è¯¾ç¨‹ID
     * @return TeachplanNode
     */
    TeachplanNode findList(String courseId);

}
```

### TeachplanMapper.xml

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.xuecheng.manage_course.dao.CoursePlanMapper">

    <resultMap id="teachplanMap" type="com.xuecheng.framework.domain.course.ext.TeachplanNode">
        <id column="one_id" property="id" />
        <result column="one_name" property="pname" />
        <collection property="children" ofType="com.xuecheng.framework.domain.course.ext.TeachplanNode">
            <id column="two_id" property="id" />
            <result column="two_name" property="pname" />
            <collection property="children" ofType="com.xuecheng.framework.domain.course.ext.TeachplanNode">
                <id column="three_id" property="id" />
                <result column="three_name" property="pname" />
            </collection>
        </collection>
    </resultMap>


    <select id="findList" parameterType="java.lang.String"
            resultMap="teachplanMap">
        SELECT
            a.id one_id,
            a.pname one_name,
            b.id two_id,
            b.pname two_name,
            c.id three_id,
            c.pname three_name
        FROM
            teachplan a LEFT JOIN teachplan b
            ON a.id = b.parentid
            LEFT JOIN teachplan c
            ON b.id = c.parentid
        WHERE a.parentid = '0'
            <if test="_parameter!=null and _parameter!=''">
                and a.courseid=#{courseId}
            </if>

        ORDER BY a.orderby,
            b.orderby,
            c.orderby
    </select>

</mapper>
```

### æµ‹è¯•

![](https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/master/20190921230012.png)

### æ’å‘

è°ƒç”¨`mapper`æ–¹æ³•çš„æ—¶å€™æŠ¥é”™ï¼š

```text
Invalid bound statement (not found): com.xuecheng.manage_course.dao.CoursePlanMapper.findList
```

åŸå› æ˜¯`mybatis`æ²¡æœ‰æ­£ç¡®çš„åŠ è½½åˆ°`mapper.xml`æ–‡ä»¶ï¼Œåœ¨`application.yml`ä¸­åŠ å…¥ä¸‹æ–¹é…ç½®

```yaml
mybatis:
  mapper-locations: classpath:com/xuecheng/manage_course/dao/*Mapper.xml
```

## æ·»åŠ è¯¾ç¨‹è®¡åˆ’

### CoursePlanController

```java
    /**
     * æ–°å¢è¯¾ç¨‹è®¡åˆ’
     *
     * @param teachplan è¯¾ç¨‹è®¡åˆ’
     * @return ResponseResult
     */
    @Override
    @PostMapping("add")
    public ResponseResult add(@RequestBody Teachplan teachplan) {
        if (teachplan == null || StringUtils.isBlank(teachplan.getCourseid())) {
            return new ResponseResult(CommonCode.PARAMS_ERROR);
        }
        // æ–°å¢
        Teachplan add = coursePlanService.add(teachplan);
        isNullOrEmpty(add, CourseCode.COURSE_PLAN_ADD_ERROR);
        return ResponseResult.SUCCESS();
    }
```

### CoursePlanService

```java
    /**
     * æ–°å¢è¯¾ç¨‹è®¡åˆ’
     *
     * @param teachplan è¯¾ç¨‹è®¡åˆ’
     * @return Teachplan
     */
    public Teachplan add(Teachplan teachplan) {
        Teachplan root = getTeachplanRoot(teachplan.getCourseid());

        // è®¾ç½®çˆ¶ID
        if (StringUtils.isBlank(teachplan.getParentid())) {
            teachplan.setParentid(root.getId());
        }
        // è®¾ç½®èŠ‚ç‚¹çº§åˆ«
        if (root.getId().equals(teachplan.getParentid())) {// ç¬¬äºŒçº§åˆ«
            teachplan.setGrade("2");
        } else {// ç¬¬ä¸‰çº§åˆ«
            teachplan.setGrade("3");
        }

        return coursePlanRepository.save(teachplan);
    }

    /**
     * æŸ¥è¯¢æŒ‡å®šè¯¾ç¨‹çš„è¯¾ç¨‹è®¡åˆ’æ ¹èŠ‚ç‚¹
     *
     * @param courseId è¯¾ç¨‹è®¡åˆ’
     * @return Teachplan
     */
    public Teachplan getTeachplanRoot(String courseId) {
        // æŸ¥è¯¢è¯¾ç¨‹åŸºæœ¬ä¿¡æ¯
        Optional<CourseBase> courseBase = courseBaseRepository.findById(courseId);
        if (!courseBase.isPresent()) {
            ExceptionCast.cast(CourseCode.COURSE_NOT_EXIST);
        }

        // æŸ¥è¯¢æ ¹èŠ‚ç‚¹ä¸‹çš„æ‰€æœ‰äºŒçº§èŠ‚ç‚¹
        List<Teachplan> secondaryTeachplanList = coursePlanRepository.findByCourseidAndParentid(courseBase.get().getId(), "0");
        if (secondaryTeachplanList == null || secondaryTeachplanList.isEmpty()) {// è‹¥ä¸å­˜åœ¨æ ¹èŠ‚ç‚¹
            // åˆ›å»ºæ ¹èŠ‚ç‚¹
            Teachplan root = new Teachplan();
            root.setCourseid(courseBase.get().getId());
            root.setPname(courseBase.get().getName());
            root.setParentid("0");// æ ¹èŠ‚ç‚¹
            root.setGrade("1");// 1çº§èœå•
            root.setStatus("0");// æœªå‘å¸ƒ

            coursePlanRepository.save(root);
            return root;
        }

        return secondaryTeachplanList.get(0);
    }
```

### CoursePlanRepository

```java
package com.xuecheng.manage_course.dao;

import com.xuecheng.framework.domain.course.Teachplan;
import org.springframework.data.repository.CrudRepository;

import java.util.List;

public interface CoursePlanRepository extends CrudRepository<Teachplan, String> {

    /**
     * æŸ¥è¯¢è¯¾ç¨‹æŒ‡å®šçˆ¶IDçš„æ‰€æœ‰èŠ‚ç‚¹åˆ—è¡¨
     *
     * @param courseId è¯¾ç¨‹ID
     * @param parentId çˆ¶ID
     * @return List<Teachplan>
     */
    List<Teachplan> findByCourseidAndParentid(String courseId, String parentId);
}
```

### å‰ç«¯

ä¿®æ”¹ä¿å­˜æˆåŠŸåï¼Œå…³é—­è¡¨å•è¾“å…¥çª—å£ï¼Œä¿®æ”¹`course_pan.vue`ä¸­çš„`addTeachplan`æ–¹æ³•

```javascript
addTeachplan(){
    //æ ¡éªŒè¡¨å•
    this.$refs.teachplanForm.validate((valid) => {
        if (valid) {
            //è°ƒç”¨apiæ–¹æ³•
            //å°†è¯¾ç¨‹idè®¾ç½®åˆ°teachplanActive
            this.teachplanActive.courseid = this.courseid
            courseApi.addTeachplan(this.teachplanActive).then(res=>{
                if(res.success){
                    this.$message({
                        showClose: true,
                        message: res.message,
                        type: 'success'
                    })
                    //å…³é—­è¯¾ç¨‹è®¡åˆ’ä¿¡æ¯å½•å…¥çª—å£
                    this.teachplayFormVisible = false
                    //åˆ·æ–°æ ‘
                    this.findTeachplan()
                }else{
                    this.$message.error(res.message)
                }
            })
        }
    })
}
```

## ç¼–è¾‘/åˆ é™¤è¯¾ç¨‹è®¡åˆ’

### åç«¯

1. CoursePlanController

   ```java
       /**
        * ç¼–è¾‘è¯¾ç¨‹è®¡åˆ’
        *
        * @param teachplan è¯¾ç¨‹è®¡åˆ’
        * @return ResponseResult
        */
       @Override
       @PutMapping("edit")
       public ResponseResult edit(@RequestBody Teachplan teachplan) {
           if (teachplan == null
                   || StringUtils.isBlank(teachplan.getCourseid())
                   || StringUtils.isBlank(teachplan.getId())) {
               return new ResponseResult(CommonCode.PARAMS_ERROR);
           }
           // ç¼–è¾‘
           Teachplan edit = coursePlanService.edit(teachplan);
           isNullOrEmpty(edit, CourseCode.COURSE_PLAN_ADD_ERROR);
           return ResponseResult.SUCCESS();
       }
   
       /**
        * åˆ é™¤è¯¾ç¨‹è®¡åˆ’
        *
        * @param teachplanId è¯¾ç¨‹è®¡åˆ’ID
        * @return ResponseResult
        */
       @Override
       @DeleteMapping("{teachplanId}")
       public ResponseResult delete(@PathVariable String teachplanId) {
           coursePlanService.deleteById(teachplanId);
           return ResponseResult.SUCCESS();
       }
   ```

2. CoursePlanService

   ```java
       /**
        * ç¼–è¾‘è¯¾ç¨‹è®¡åˆ’
        *
        * @param teachplan è¯¾ç¨‹è®¡åˆ’
        * @return Teachplan
        */
       public Teachplan edit(Teachplan teachplan) {
           Optional<Teachplan> optionalTeachplan = coursePlanRepository.findById(teachplan.getId());
           if (!optionalTeachplan.isPresent()) {
               ExceptionCast.cast(CourseCode.COURSE_NOT_EXIST);
           }
           Teachplan _teachplan = optionalTeachplan.get();
           _teachplan.setGrade(teachplan.getGrade());
           _teachplan.setPname(teachplan.getPname());
           _teachplan.setCourseid(teachplan.getCourseid());
           _teachplan.setDescription(teachplan.getDescription());
           _teachplan.setOrderby(teachplan.getOrderby());
           _teachplan.setStatus(teachplan.getStatus());
           _teachplan.setTimelength(teachplan.getTimelength());
   
           Teachplan root = getTeachplanRoot(teachplan.getCourseid());
   
           // è®¾ç½®çˆ¶ID
           if (StringUtils.isBlank(teachplan.getParentid())) {
               _teachplan.setParentid(root.getId());
           }
   
           return coursePlanRepository.save(_teachplan);
       }
   
   	/**
        * æŸ¥è¯¢æŒ‡å®šIDçš„è¯¾ç¨‹è®¡åˆ’
        *
        * @param teachplanId è¯¾ç¨‹è®¡åˆ’ID
        * @return Teachplan
        */
       public Teachplan findById(String teachplanId) {
           Optional<Teachplan> optionalTeachplan = coursePlanRepository.findById(teachplanId);
           if (!optionalTeachplan.isPresent()) {
               ExceptionCast.cast(CourseCode.COURSE_NOT_EXIST);
           }
           return optionalTeachplan.get();
       }
   
       /**
        * åˆ é™¤æŒ‡å®šIDçš„è¯¾ç¨‹è®¡åˆ’
        *
        * @param teachplanId è¯¾ç¨‹è®¡åˆ’ID
        */
       public void deleteById(String teachplanId) {
           coursePlanRepository.deleteById(teachplanId);
       }
   ```

### å‰ç«¯

1. æ–°å¢APIå®šä¹‰ï¼Œä¿®æ”¹`course.js`

   ```javascript
   /*æŸ¥è¯¢è¯¾ç¨‹è®¡åˆ’*/
   export const findTeachplanById = teachplanById => {
     return http.requestQuickGet(apiUrl+'/course/teachplan/'+teachplanById)
   }
   /*ç¼–è¾‘è¯¾ç¨‹è®¡åˆ’*/
   export const editTeachplan = teachplah => {
     return http.requestPut(apiUrl+'/course/teachplan/edit',teachplah)
   }
   /*åˆ é™¤è¯¾ç¨‹è®¡åˆ’*/
   export const deleteTeachplan = teachplahId => {
     return http.requestDelete(apiUrl+'/course/teachplan/' + teachplahId)
   }
   ```

2. é¡µé¢ä¿®æ”¹ï¼Œä¿®æ”¹å†…å®¹ä¸»è¦ä¸º

   - ç‚¹å‡»ä¿®æ”¹æŒ‰é’®ï¼Œå¼¹å‡ºä¿®æ”¹æ¡†å¹¶å›æ˜¾æ•°æ®ï¼Œæäº¤APIè°ƒç”¨
   - ç‚¹å‡»åˆ é™¤æŒ‰é’®ï¼Œå¼¹å‡ºç¡®è®¤æ¡†ï¼Œç¡®è®¤åAPIè°ƒç”¨

   ```vue
   	edit(data){
           // æŸ¥è¯¢
           courseApi.findTeachplanById(data.id).then(res => {
             this.teachplanActive = res
             if (res.grade === '2') {
               this.teachplanActive.parentid = ''
             }
             this.teachplayFormVisible = true
           })
           //æ ¡éªŒè¡¨å•
           this.$refs.teachplanForm.validate((valid) => {
               if (valid) {
                   //è°ƒç”¨apiæ–¹æ³•
                 //å°†è¯¾ç¨‹idè®¾ç½®åˆ°teachplanActive
                 this.teachplanActive.courseid = this.courseid
                 courseApi.editTeachplan(this.teachplanActive).then(res=>{
                   if(res.success){
                       this.$message({
                           showClose: true,
                           message: res.message,
                           type: 'success'
                       })
                       this.teachplayFormVisible = false
                       //åˆ·æ–°æ ‘
                       this.findTeachplan()
                   }else{
                     this.$message.error(res.message)
                   }
   
                 })
               }
           })
         },
         remove(node, data) {
           // æ‰§è¡Œåˆ é™¤
           this.$confirm('ç¡®è®¤åˆ é™¤è¯¥è¯¾ç¨‹è®¡åˆ’?', 'æç¤º', {
                 confirmButtonText: 'ç¡®å®š',
                 cancelButtonText: 'å–æ¶ˆ',
                 type: 'warning'
             }).then(() => {
                 // åˆ é™¤
                 courseApi.deleteTeachplan(data.id).then(res => {
                   // æç¤ºæ¶ˆæ¯
                   this.$message({
                     showClose: true,
                     message: res.message,
                     type: 'success'
                   })
   				//åˆ·æ–°æ ‘
                   this.findTeachplan()
                 })
                 
             })
   
         }
   ```

   **æ³¨æ„ï¼š**

   ç”±äºæ–°å¢å’Œç¼–è¾‘ç”¨çš„åŒä¸€ä¸ªè¡¨å•æŒ‰é’®ï¼Œæ‰€ä»¥è¦åšåˆ¤æ–­ï¼Œè‹¥IDä¸ºç©ºæ—¶è°ƒç”¨æ–°å¢ï¼Œå¦åˆ™è°ƒç”¨ç¼–è¾‘

   ```javascript
   // å°†æŒ‰é’®è°ƒç”¨æ”¹ä¸ºsaveæ–¹æ³•
   <el-button type="primary" v-on:click="save">æäº¤</el-button>
   
   save() {
       if (this.teachplanActive.id) {
           this.edit(this.teachplanActive)
       } else {
           this.addTeachplan()
       }
   }
   ```



> å› ä¸ºæˆ‘æ²¡çœ‹è¯¾ç¨‹ç›®å½•ï¼Œåä¸€å¤©çš„å†…å®¹å±…ç„¶æ˜¯è¯¾ç¨‹ç®¡ç†çš„å®æˆ˜ã€‚ã€‚æˆ‘åœ¨è¿™ä¸€ç¬”è®°é‡Œé¢å°±è‡ªå·±æŠŠè¯¾ç¨‹ç®¡ç†çš„å®æˆ˜ç»™åšäº†ï¼Œä½†æ˜¯ç¼ºå°‘è¯¾ç¨‹è¥é”€ç›¸å…³çš„å†…å®¹ï¼Œæˆ‘å°±ä¸åšäº†ï¼Œæ‡’å¾—åšï¼ˆæ‡’äººå°±æ˜¯æˆ‘ğŸ˜œğŸ˜œğŸ˜œï¼‰