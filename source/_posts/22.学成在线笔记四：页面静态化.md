---
title: å­¦æˆåœ¨çº¿ç¬”è®°å››ï¼šé¡µé¢é™æ€åŒ–
tags:
  - å­¦æˆåœ¨çº¿
categories:
  - å­¦æˆåœ¨çº¿é¡¹ç›®
  - é»‘é©¬å­¦æˆåœ¨çº¿
  - åœ¨çº¿æ•™è‚²é¡¹ç›®
  - å®æˆ˜å­¦æˆåœ¨çº¿
  - å­¦æˆåœ¨çº¿ç¬”è®°  
date: 2020-06-10 23:41:02
---

<center><i>é¡µé¢é™æ€åŒ–</i></center>

![](https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/master/b4e62a1134e59b327d8472906482aaae.jpg)


<!-- more -->

# é¡µé¢é™æ€åŒ–æµç¨‹

é¡µé¢é™æ€åŒ–æµç¨‹å¦‚ä¸‹å›¾ï¼š

![](https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/master/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF%E9%A1%B5%E9%9D%A2%E9%9D%99%E6%80%81%E5%8C%96%E6%B5%81%E7%A8%8B%E5%9B%BE.jpg)ã€

1. é™æ€åŒ–ç¨‹åºé¦–å…ˆè¯»å–é¡µé¢è·å–DataUrlã€‚
2. é™æ€åŒ–ç¨‹åºè¿œç¨‹è¯·æ±‚DataUrlå¾—åˆ°æ•°æ®æ¨¡å‹ã€‚
3. è·å–é¡µé¢æ¨¡æ¿ã€‚
4. æ‰§è¡Œé¡µé¢é™æ€åŒ–ã€‚

# CMSæ¨¡æ¿æ–‡ä»¶ä¸Šä¼ 

CMSé¡µé¢æ¨¡æ¿æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½å®ç°ï¼Œè¯¥åŠŸèƒ½åœ¨æ–°å¢æˆ–ç¼–è¾‘æ¨¡æ¿çš„æ—¶å€™å¯è¿›è¡Œæ¨¡æ¿æ–‡ä»¶çš„ä¸Šä¼ 

æœ€ç»ˆé¡µé¢æ•ˆæœå¦‚ä¸‹ï¼š

![](https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/master/20190913193139.png)

## åç«¯

### CmsTemplateControllerApi

æ–°å¢æ¥å£å®šä¹‰

```java
    @ApiOperation("ä¸Šä¼ æ¨¡æ¿æ–‡ä»¶")
    String uploadTemplate(MultipartFile file);

    @ApiOperation("ç§»é™¤æ¨¡æ¿æ–‡ä»¶")
    void removeTemplateFile(String templateFileId);
```

### CmsTemplateController

æ¥å£å®ç°

```java
    @Override
    @PostMapping("upload")
    public String uploadTemplate(@RequestParam("file") MultipartFile file) {
        // ä¸Šä¼ æ–‡ä»¶
        String templateFileId = cmsTemplateService.uploadTemplateFile(file);
        if (StringUtils.isBlank(templateFileId)) {
            ExceptionCast.cast(CmsCode.CMS_TEMPLATE_FILE_UPLOAD_ERROR);
        }
        return templateFileId;
    }

    @Override
    @DeleteMapping("file/remove/{templateFileId}")
    public void removeTemplateFile(@PathVariable String templateFileId) {
        cmsTemplateService.removeTemplateFile(templateFileId);
    }
```

### CmsTemplateService

å®Œæˆæ¨¡æ¿æ–‡ä»¶ä¸Šä¼ ä¸åˆ é™¤

```java
    @Autowired
    private GridFsTemplate gridFsTemplate;

    /**
     * ä¸Šä¼ æ–‡ä»¶
     *
     * @param file æ–‡ä»¶
     */
    public String uploadTemplateFile(MultipartFile file) {
        try {
            return gridFsTemplate.store(file.getInputStream(), "template").toString();
        } catch (Exception e) {
            return "";
        }
    }

    /**
     * ç§»é™¤æ–‡ä»¶
     *
     * @param templateFileId æ¨¡æ¿æ–‡ä»¶ID
     */
    public void removeTemplateFile(String templateFileId) {
        Query query = new Query(Criteria.where("_id").is(templateFileId));
        gridFsTemplate.delete(query);
    }
```

ä¿®æ”¹åˆ é™¤æ–¹æ³•çš„é€»è¾‘ï¼Œåœ¨åˆ é™¤æ¨¡æ¿ä¹‹å‰å…ˆåˆ é™¤æ¨¡æ¿æ–‡ä»¶

```java
    /**
     * åˆ é™¤æŒ‡å®šIDçš„æ¨¡æ¿
     *
     * @param templateId æ¨¡æ¿ID
     */
    public void deleteById(String templateId) {
        // åˆ é™¤æ¨¡æ¿æ–‡ä»¶
        Optional<CmsTemplate> templateOptional = cmsTemplateRepository.findById(templateId);
        if (templateOptional.isPresent()) {
            Query query = new Query(Criteria.where("_id").is(templateOptional.get().getTemplateFileId()));
            // åˆ é™¤æ–‡ä»¶
            gridFsTemplate.delete(query);
            // åˆ é™¤æ¨¡æ¿
            cmsTemplateRepository.deleteById(templateId);
        }
    }
```



## å‰ç«¯

### APIå®šä¹‰

ä¿®æ”¹`src/module/cms/api/cms.js`ï¼Œæ–°å¢APIå®šä¹‰

```javascript
/**
 * æŒ‰IDåˆ é™¤æ¨¡æ¿
 */
export const removeTemplateFileById = (templateFileId) => { 
    return http.requestDelete(apiUrl + '/cms/template/file/remove/'+ templateFileId)
}
```

### é¡µé¢å†…å®¹æ–°å¢

åœ¨`template_add.vue`ä»¥åŠ`template_edit.vue`ä¸­æ–°å¢æ–‡ä»¶ä¸Šä¼ æ¡†

```vue
            <el-form-item label="æ¨¡æ¿æ–‡ä»¶ID">
                <el-upload
                    class="upload-demo"
                    drag
                    action="http://localhost:11000/api/cms/template/upload"
                    :multiple="multiple"
                    :limit="limit"
                    :on-success="uploadOnSuccess"
                    :on-remove="onRemove">
                    <i class="el-icon-upload"></i>
                    <div class="el-upload__text">å°†æ–‡ä»¶æ‹–åˆ°æ­¤å¤„ï¼Œæˆ–<em>ç‚¹å‡»ä¸Šä¼ </em></div>
                </el-upload>
            </el-form-item>
```

### æ–°å¢æ–¹æ³•

åœ¨`template_add.vue`ä»¥åŠ`template_edit.vue`ä¸­æ–°å¢éœ€è¦è°ƒç”¨çš„æ–¹æ³•

```javascript
// æ¨¡æ¿æ–‡ä»¶ä¸Šä¼ æˆåŠŸ
uploadOnSuccess:function(response, file, fileList) {
    if (response) {
        this.cmsTemplate.templateFileId = response
        this.$message({
            showClose: true,
            message: 'æ¨¡æ¿æ–‡ä»¶ä¸Šä¼ æˆåŠŸ',
            type: 'success'
        })
    }
},
// ç§»é™¤æ¨¡æ¿æ–‡ä»¶
onRemove:function(file, fileList) {
    // è°ƒç”¨API åˆ é™¤æ–‡ä»¶
    cmsApi.removeTemplateFileById(this.cmsTemplate.templateFileId).then(res => {
        this.$message({
            showClose: true,
            message: 'åˆ é™¤æˆåŠŸ',
            type: 'success'
        })
    })
}
```



# æ•°æ®æ¨¡å‹æ¥å£å®ç°

## å®ä½“ç±»

- CmsConfig

  ```java
  package com.xuecheng.framework.domain.cms;
  
  import lombok.Data;
  import lombok.ToString;
  import org.springframework.data.annotation.Id;
  import org.springframework.data.mongodb.core.mapping.Document;
  
  import java.util.List;
  
  /**
   * Created by admin on 2018/2/6.
   */
  @Data
  @ToString
  @Document(collection = "cms_config")
  public class CmsConfig {
  
      @Id
      private String id;
      private String name;
      private List<CmsConfigModel> model;
  
  }
  ```

- CmsConfigModel

  ```java
  package com.xuecheng.framework.domain.cms;
  
  import lombok.Data;
  import lombok.ToString;
  
  import java.util.Map;
  
  /**
   * Created by admin on 2018/2/6.
   */
  @Data
  @ToString
  public class CmsConfigModel {
      private String key;
      private String name;
      private String url;
      private Map mapValue;
      private String value;
  
  }
  ```

- CmsConfigResult

  ```java
  package com.xuecheng.framework.domain.cms.response;
  
  import com.xuecheng.framework.domain.cms.CmsConfig;
  import com.xuecheng.framework.model.response.ResponseResult;
  import com.xuecheng.framework.model.response.ResultCode;
  import lombok.Data;
  
  @Data
  public class CmsConfigResult extends ResponseResult {
      CmsConfig cmsConfig;
      public CmsConfigResult(ResultCode resultCode, CmsConfig cmsConfig) {
          super(resultCode);
          this.cmsConfig = cmsConfig;
      }
  }
  ```

## CmsConfigRepository

```java
package com.xuecheng.manage_cms.dao;

import com.xuecheng.framework.domain.cms.CmsConfig;
import org.springframework.data.mongodb.repository.MongoRepository;

public interface CmsConfigRepository extends MongoRepository<CmsConfig, String> {
}
```

## CmsConfigService

```java
package com.xuecheng.manage_cms.service;

import com.xuecheng.framework.domain.cms.CmsConfig;
import com.xuecheng.manage_cms.dao.CmsConfigRepository;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

@Slf4j
@Service
public class CmsConfigService {

    @Autowired
    private CmsConfigRepository cmsConfigRepository;

    /**
     * æŒ‰IDæŸ¥è¯¢CMSé…ç½®ä¿¡æ¯
     *
     * @param id id
     */
    public CmsConfig findById(String id) {
        return cmsConfigRepository.findById(id).orElse(null);
    }

}
```

## CmsConfigController & CmsConfigControllerApi

- CmsConfigController

  ```java
  package com.xuecheng.manage_cms.controller;
  
  import com.xuecheng.api.cms.CmsConfigControllerApi;
  import com.xuecheng.framework.domain.cms.CmsConfig;
  import com.xuecheng.framework.domain.cms.response.CmsCode;
  import com.xuecheng.framework.exception.ExceptionCast;
  import com.xuecheng.manage_cms.service.CmsConfigService;
  import org.springframework.beans.factory.annotation.Autowired;
  import org.springframework.web.bind.annotation.GetMapping;
  import org.springframework.web.bind.annotation.PathVariable;
  import org.springframework.web.bind.annotation.RequestMapping;
  import org.springframework.web.bind.annotation.RestController;
  
  @RestController
  @RequestMapping("cms/config")
  public class CmsConfigController implements CmsConfigControllerApi {
  
      @Autowired
      private CmsConfigService cmsConfigService;
  
  
      @Override
      @GetMapping("{id}")
      public CmsConfig getModel(@PathVariable String id) {
          CmsConfig cmsConfig = cmsConfigService.findById(id);
          if (cmsConfig == null) {
              ExceptionCast.cast(CmsCode.CMS_GENERATEHTML_DATAURLISNULL);
          }
          return cmsConfig;
      }
  }
  ```
  
- CmsConfigControllerApi

  ```java
  package com.xuecheng.api.cms;
  
  import com.xuecheng.framework.domain.cms.CmsConfig;
  import io.swagger.annotations.Api;
  import io.swagger.annotations.ApiOperation;
  
  @Api(value = "cmsé…ç½®ç®¡ç†æ¥å£", description = "cmsé…ç½®ç®¡ç†æ¥å£ï¼Œæä¾›æ•°æ®æ¨¡å‹çš„ç®¡ç†ã€æŸ¥è¯¢æ¥å£")
  public interface CmsConfigControllerApi {
  
      @ApiOperation("æ ¹æ®idæŸ¥è¯¢CMSé…ç½®ä¿¡æ¯")
      CmsConfig getModel(String id);
  
  }
  ```

# é™æ€åŒ–å®ç°

## CmsPageService

ç¼–å†™é™æ€é¡µé¢ç”Ÿæˆæ–¹æ³•

```java
    /**
     * æ ¹æ®é¡µé¢IDç”Ÿæˆhtml
     * æµç¨‹ï¼š
     * 1ã€é™æ€åŒ–ç¨‹åºè·å–é¡µé¢çš„DataUrl
     * 2ã€é™æ€åŒ–ç¨‹åºè¿œç¨‹è¯·æ±‚DataUrlè·å–æ•°æ®æ¨¡å‹ã€‚
     * 3ã€é™æ€åŒ–ç¨‹åºè·å–é¡µé¢çš„æ¨¡æ¿ä¿¡æ¯
     * 4ã€æ‰§è¡Œé¡µé¢é™æ€åŒ–
     *
     * @param pageId é¡µé¢ID
     */
    public String genHtml(String pageId) {
        String html = null;

        // è·å–æ•°æ®æ¨¡å‹
        Map model = getModel(pageId);

        // è·å–æ¨¡æ¿ä¿¡æ¯
        String templateContent = getTemplate(pageId);

        // æ‰§è¡Œé™æ€åŒ–
        try {
            // é…ç½®ç±»
            Configuration configuration = new Configuration(Configuration.getVersion());

            // æ¨¡æ¿åŠ è½½å™¨
            StringTemplateLoader templateLoader = new StringTemplateLoader();
            templateLoader.putTemplate("template", templateContent);

            // é…ç½®
            configuration.setTemplateLoader(templateLoader);

            // è·å–æ¨¡æ¿
            Template template = configuration.getTemplate("template");

            // é™æ€åŒ–
            html = FreeMarkerTemplateUtils.processTemplateIntoString(template, model);

        } catch (IOException e) {
            // è·å–æ¨¡æ¿å¤±è´¥
            ExceptionCast.cast(CmsCode.CMS_GENERATEHTML_TEMPLATEISNULL);
        } catch (TemplateException e) {
            // é™æ€åŒ–å¤±è´¥
            ExceptionCast.cast(CmsCode.CMS_GENERATEHTML_SAVEHTMLERROR);
        }
        return html;
    }

    /**
     * è·å–æ¨¡æ¿å†…å®¹
     *
     * @param pageId é¡µé¢ID
     * @return æ¨¡æ¿å†…å®¹
     */
    private String getTemplate(String pageId) {
        // æŸ¥è¯¢é¡µé¢ä¿¡æ¯
        CmsPage cmsPage = this.findByPageId(pageId);
        isNullOrEmpty(cmsPage, CmsCode.CMS_EDITPAGE_NOTEXISTS);
        isNullOrEmpty(cmsPage.getTemplateId(), CmsCode.CMS_EDITPAGE_NOTEXISTS);

        // æŸ¥è¯¢æ¨¡æ¿æ•°æ®
        CmsTemplate cmsTemplate = cmsTemplateService.findByTemplateId(cmsPage.getTemplateId());
        isNullOrEmpty(cmsTemplate, CmsCode.CMS_GENERATEHTML_TEMPLATEISNULL);
        // æŸ¥è¯¢æ¨¡æ¿æ–‡ä»¶ä¿¡æ¯
        isNullOrEmpty(cmsTemplate.getTemplateFileId(), CmsCode.CMS_GENERATEHTML_TEMPLATEISNULL);
        // ä¸‹è½½æ–‡ä»¶
        String fileContent = downloadFileFromMongoDB(cmsTemplate.getTemplateFileId());
        isNullOrEmpty(fileContent, CmsCode.CMS_GENERATEHTML_TEMPLATEISNULL);

        return fileContent;
    }

    /**
     * ä¸‹è½½æ–‡ä»¶
     *
     * @param fileId æ–‡ä»¶ID
     * @return æ–‡ä»¶å†…å®¹
     */
    private String downloadFileFromMongoDB(String fileId) {
        GridFSFile gridFSFile = gridFsTemplate.findOne(Query.query(Criteria.where("_id").is(fileId)));
        if (gridFSFile == null) {
            ExceptionCast.cast(CmsCode.CMS_GENERATEHTML_TEMPLATEISNULL);
        }
        //æ‰“å¼€ä¸‹è½½æµå¯¹è±¡
        GridFSDownloadStream gridFSDownloadStream = gridFSBucket.openDownloadStream(gridFSFile.getObjectId());
        //åˆ›å»ºgridFsResource
        GridFsResource gridFsResource = new GridFsResource(gridFSFile,gridFSDownloadStream);
        //è·å–æµä¸­çš„æ•°æ®
        String content = null;
        try {
            content = IOUtils.toString(gridFsResource.getInputStream(), "utf-8");
        } catch (IOException ignored) { }
        return content;
    }

    /**
     * æ ¹æ®pageIdè·å–æ¨¡å‹æ•°æ®
     *
     * @param pageId é¡µé¢ID
     * @return æ¨¡å‹æ•°æ®
     */
    private Map getModel(String pageId) {
        // æŸ¥è¯¢é¡µé¢ä¿¡æ¯
        CmsPage cmsPage = this.findByPageId(pageId);
        if (cmsPage == null) {
            ExceptionCast.cast(CmsCode.CMS_EDITPAGE_NOTEXISTS);
        }
        if (StringUtils.isBlank(cmsPage.getDataUrl())) {
            ExceptionCast.cast(CmsCode.CMS_GENERATEHTML_DATAURLISNULL);
        }
        // è·å–æ¨¡å‹æ•°æ®
        ResponseEntity<Map> forEntity = restTemplate.getForEntity(cmsPage.getDataUrl(), Map.class);
        if (forEntity.getBody() == null) {
            ExceptionCast.cast(CmsCode.CMS_GENERATEHTML_DATAISNULL);
        }
        return forEntity.getBody();
    }
```

## æ•ˆæœæµ‹è¯•

1. ç¼–å†™æ¨¡æ¿æ–‡ä»¶

   ```html
   <!DOCTYPE html>
   <html lang="en">
   <head>
       <meta charset="UTF-8">
       <title>Title</title>
       <link rel="stylesheet" href="http://www.xuecheng.com/plugins/normalize-css/normalize.css" />
       <link rel="stylesheet" href="http://www.xuecheng.com/plugins/bootstrap/dist/css/bootstrap.css" />
       <link rel="stylesheet" href="http://www.xuecheng.com/css/page-learing-index.css" />
       <link rel="stylesheet" href="http://www.xuecheng.com/css/page-header.css" />
   </head>
   <body>
   <div class="banner-roll">
       <div class="banner-item">
           <#if model??>
               <#list model as item>
                   <div class="item" style="background-image: url(${item.value});"></div>
               </#list>
           </#if>
       </div>
       <div class="indicators"></div>
   </div>
   <script type="text/javascript" src="http://www.xuecheng.com/plugins/jquery/dist/jquery.js"></script>
   <script type="text/javascript" src="http://www.xuecheng.com/plugins/bootstrap/dist/js/bootstrap.js"></script>
   <script type="text/javascript">
       var tg = $('.banner-item .item');
       var num = 0;
       for (i = 0; i < tg.length; i++) {
           $('.indicators').append('<span></span>');
           $('.indicators').find('span').eq(num).addClass('active');
       }
   
       function roll() {
           tg.eq(num).animate({
               'opacity': '1',
               'z-index': num
           }, 1000).siblings().animate({
               'opacity': '0',
               'z-index': 0
           }, 1000);
           $('.indicators').find('span').eq(num).addClass('active').siblings().removeClass('active');
           if (num >= tg.length - 1) {
               num = 0;
           } else {
               num++;
           }
       }
       $('.indicators').find('span').click(function() {
           num = $(this).index();
           roll();
       });
       var timer = setInterval(roll, 3000);
       $('.banner-item').mouseover(function() {
           clearInterval(timer)
       });
       $('.banner-item').mouseout(function() {
           timer = setInterval(roll, 3000)
       });
   </script>
   </body>
   </html>
   ```

2. ä¸Šä¼ æ¨¡æ¿æ–‡ä»¶åˆ°æ–‡ä»¶ç³»ç»Ÿä¸­ï¼Œæˆ‘åœ¨æœ€å¼€å§‹å·²ç»å®ç°äº†æ¨¡æ¿æ–‡ä»¶çš„ä¸Šä¼ ï¼Œæ‰€ä»¥æˆ‘è¿™é‡Œåªéœ€è¦æ–°å¢ä¸€ä¸ªæ¨¡æ¿ã€‚

   ![](https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/master/20190914195032.png)

3. æ–°å»ºé¡µé¢å¹¶ä½¿ç”¨è¯¥æ¨¡æ¿

   ![](https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/master/20190914195225.png)

4. ç¼–å†™æµ‹è¯•æ–¹æ³•

   ```java
       @Test
       public void testGenHtml() {
           // æ­¤IDéœ€è¦åˆ°æ•°æ®åº“ä¸­æŸ¥çœ‹
           String pageId = "5d7b85025f315734a084d61e";
           // ç”Ÿæˆhtml
           String s = cmsPageService.genHtml(pageId);
           System.out.println(s);
       }
   ```

5. è¿è¡Œ

   ![](https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/master/20190914195333.png)

   åªæˆªå–äº†éƒ¨åˆ†ï¼Œå¤§è‡´æ•ˆæœå·®ä¸å¤šï¼Œæˆ‘å°±ä¸è´´ä»é¡µé¢è®¿é—®çš„æ•ˆæœäº†ï¼Œå› ä¸ºè¿™ä¸ªå›¾ç‰‡é“¾æ¥æ˜¯`fastDFS`ä¸­çš„é“¾æ¥~ ğŸ˜…ğŸ˜…ğŸ˜…ğŸ˜…ã€‚

# é¡µé¢é¢„è§ˆ

## éœ€æ±‚åˆ†æ

é¡µé¢åœ¨å‘å¸ƒå‰å¢åŠ é¡µé¢é¢„è§ˆçš„æ­¥éª¤ï¼Œæ–¹ä¾¿ç”¨æˆ·æ£€æŸ¥é¡µé¢å†…å®¹æ˜¯å¦æ­£ç¡®ã€‚é¡µé¢é¢„è§ˆçš„æµç¨‹å¦‚ä¸‹ï¼š

![](https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/master/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF%E9%9D%99%E6%80%81%E9%A1%B5%E9%9D%A2%E9%A2%84%E8%A7%88%E6%B5%81%E7%A8%8B%E5%9B%BE.jpg)

1. ç”¨æˆ·è¿›å…¥cmså‰ç«¯ï¼Œç‚¹å‡»â€œé¡µé¢é¢„è§ˆâ€åœ¨æµè§ˆå™¨è¯·æ±‚cmsé¡µé¢é¢„è§ˆé“¾æ¥ã€‚
2. cmsæ ¹æ®é¡µé¢idæŸ¥è¯¢DataUrlå¹¶è¿œç¨‹è¯·æ±‚DataUrlè·å–æ•°æ®æ¨¡å‹ã€‚
3. cmsæ ¹æ®é¡µé¢idæŸ¥è¯¢é¡µé¢æ¨¡æ¿å†…å®¹ã€‚
4. cmsæ‰§è¡Œé¡µé¢é™æ€åŒ–ã€‚
5. cmså°†é™æ€åŒ–å†…å®¹å“åº”ç»™æµè§ˆå™¨ã€‚
6. åœ¨æµè§ˆå™¨å±•ç¤ºé¡µé¢å†…å®¹ï¼Œå®ç°é¡µé¢é¢„è§ˆçš„åŠŸèƒ½ã€‚

## åç«¯

### å¼•å…¥ä¾èµ–

```xml
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-freemarker</artifactId>
</dependency>
```

### é…ç½®Freemarker

```yaml
spring:
  freemarker:
    # å…³é—­ç¼“å­˜
    cache: false
    settings:
      # æ¨¡æ¿æ›´æ–°æ—¶é—´ï¼Œæ­£å¼ç¯å¢ƒå¯ä»¥è®¾ç½®è¾ƒå¤§
      template_update_delay: 0
```

### CmsPagePreviewController

```java
package com.xuecheng.manage_cms.controller;

import com.xuecheng.framework.domain.cms.response.CmsCode;
import com.xuecheng.framework.web.BaseController;
import com.xuecheng.manage_cms.service.CmsPageService;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestMapping;

import javax.servlet.ServletOutputStream;
import java.io.IOException;
import java.nio.charset.StandardCharsets;

@Slf4j
@Controller
public class CmsPagePreviewController extends BaseController {

    @Autowired
    private CmsPageService cmsPageService;

    /**
     * CMSé¡µé¢é¢„è§ˆ
     *
     * @param pageId é¢„è§ˆçš„é¡µé¢ID
     */
    @RequestMapping("cms/preview/{pageId}")
    public void preview(@PathVariable String pageId) {
        // è·å–é¡µé¢å†…å®¹
        String htmlContent = cmsPageService.genHtml(pageId);
        isNullOrEmpty(htmlContent, CmsCode.CMS_GENERATEHTML_HTMLISNULL);
        // è¾“å‡ºåˆ°é¡µé¢è¿”å›
        try {
            ServletOutputStream outputStream = response.getOutputStream();
            outputStream.write(htmlContent.getBytes(StandardCharsets.UTF_8));
        } catch (IOException e) {
            log.error("[CMSé¡µé¢é¢„è§ˆ] é¢„è§ˆé¡µé¢å¤±è´¥ï¼Œå¼‚å¸¸ä¿¡æ¯ï¼š{}", e);
        }
    }

}
```

## å‰ç«¯

### æ·»åŠ é¡µé¢é¢„è§ˆæŒ‰é’®

ä¿®æ”¹`page_list.vue`ï¼Œåœ¨æ“ä½œæ æ–°å¢`é¡µé¢é¢„è§ˆ`æŒ‰é’®

```vue
<el-button
    size="small"
    type="text"
    @click="preview(scope.$index, scope.row)">é¡µé¢é¢„è§ˆ
</el-button>
```

æ–¹æ³•åŒºæ–°å¢é¡µé¢é¢„è§ˆæ–¹æ³•

```javascript
// é¡µé¢é¢„è§ˆ
preview:function(index, data) {
    window.open("http://localhost:11000/cms/preview/" + data.pageId)
}
```

### æ³¨æ„

æˆ‘è¿™é‡Œæ²¡æœ‰æŒ‰ç…§æ•™ç¨‹ä¸Šé¢çš„è®¾ç½®`nginx`ï¼Œå› ä¸ºæˆ‘åšåˆ°è¿™é‡Œçš„æ—¶å€™æˆ‘è¿å‰ç«¯é—¨æˆ·å·¥ç¨‹éƒ½æ²¡æ­å»ºï¼ˆlazyï¼Œemmmm~ï¼‰ï¼Œæ‰€ä»¥è¿™é‡Œå°±æ²¡æœ‰ä½¿ç”¨`nginx`ç†äº†ã€‚

**ç¬¬äº”å¤©çš„å†…å®¹å…¨éƒ¨éƒ½æ˜¯RabbitMQçš„æ•™å­¦ï¼Œæ‰€æœ‰æˆ‘å°±æ²¡æœ‰æ•´ç†æˆç¬”è®°äº†ã€‚**

**ä½†æ˜¯ï¼ä½†æ˜¯ï¼ä½†æ˜¯ï¼æˆ‘æœ‰å¦å¤–ä¸¤ç¯‡æ–‡ç« ä¸“é—¨å¯¹RabbitMQåšäº†ç¬”è®°ï¼ˆçŒ®ä¸‘äº†ï¼‰**

[RabbitMQè¯¦è§£](https://www.imxushuai.com/2019/04/01/rabbitmqè¯¦è§£/)

