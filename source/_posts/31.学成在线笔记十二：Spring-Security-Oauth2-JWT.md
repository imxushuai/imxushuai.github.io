---
title: å­¦æˆåœ¨çº¿ç¬”è®°åäºŒï¼šSpring Security Oauth2 JWT
tags:
  - å­¦æˆåœ¨çº¿é¡¹ç›®
  - é»‘é©¬å­¦æˆåœ¨çº¿
  - åœ¨çº¿æ•™è‚²é¡¹ç›®
  - å®æˆ˜å­¦æˆåœ¨çº¿
  - å­¦æˆåœ¨çº¿ç¬”è®°
categories:
  - å­¦æˆåœ¨çº¿
date: 2020-06-18 23:54:03
---

<center><i>Spring Security OAuth2 ä»¥åŠ JWT ç›¸å…³</i></center>

![](https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/master/jiaoyu.jpg)

<!-- more -->

# ç”¨æˆ·è®¤è¯éœ€æ±‚åˆ†æ

## ç”¨æˆ·è®¤è¯ä¸æˆæƒ

### ä»€ä¹ˆæ˜¯ç”¨æˆ·èº«ä»½è®¤è¯ï¼Ÿ

ç”¨æˆ·èº«ä»½è®¤è¯å³ç”¨æˆ·å»è®¿é—®ç³»ç»Ÿèµ„æºæ—¶ç³»ç»Ÿè¦æ±‚éªŒè¯ç”¨æˆ·çš„èº«ä»½ä¿¡æ¯ï¼Œèº«ä»½åˆæ³•æ–¹å¯ç»§ç»­è®¿é—®ã€‚å¸¸è§çš„ç”¨æˆ·èº«ä»½è®¤è¯è¡¨ç°å½¢å¼æœ‰ï¼šç”¨æˆ·åå¯†ç ç™»å½•ï¼ŒæŒ‡çº¹æ‰“å¡ç­‰æ–¹å¼ã€‚

### ä»€ä¹ˆæ˜¯ç”¨æˆ·æˆæƒï¼Ÿ

ç”¨æˆ·è®¤è¯é€šè¿‡åå»è®¿é—®ç³»ç»Ÿçš„èµ„æºï¼Œç³»ç»Ÿä¼šåˆ¤æ–­ç”¨æˆ·æ˜¯å¦æ‹¥æœ‰è®¿é—®èµ„æºçš„æƒé™ï¼Œåªå…è®¸è®¿é—®æœ‰æƒé™çš„ç³»ç»Ÿèµ„æºï¼Œæ²¡æœ‰æƒé™çš„èµ„æºå°†æ— æ³•è®¿é—®ï¼Œè¿™ä¸ªè¿‡ç¨‹å«ç”¨æˆ·æˆæƒã€‚

## å•ç‚¹ç™»å½•éœ€æ±‚

æœ¬é¡¹ç›®åŒ…æ‹¬å¤šä¸ªå­é¡¹ç›®ï¼Œå¦‚ï¼šå­¦ä¹ ç³»ç»Ÿï¼Œæ•™å­¦ç®¡ç†ä¸­å¿ƒã€ç³»ç»Ÿç®¡ç†ä¸­å¿ƒç­‰ï¼Œä¸ºäº†æé«˜ç”¨æˆ·ä½“éªŒæ€§éœ€è¦å®ç°ç”¨æˆ·åªè®¤è¯ä¸€æ¬¡ä¾¿å¯ä»¥åœ¨å¤šä¸ªæ‹¥æœ‰è®¿é—®æƒé™çš„ç³»ç»Ÿä¸­è®¿é—®ï¼Œè¿™ä¸ªåŠŸèƒ½å«åšå•ç‚¹ç™»å½•ã€‚

å¼•ç”¨ç™¾åº¦ç™¾ç§‘ï¼šå•ç‚¹ç™»å½•ï¼ˆSingle Sign Onï¼‰ï¼Œç®€ç§°ä¸ºSSOï¼Œæ˜¯ç›®å‰æ¯”è¾ƒæµè¡Œçš„ä¼ä¸šä¸šåŠ¡æ•´åˆçš„è§£å†³æ–¹æ¡ˆä¹‹ä¸€ã€‚SSOçš„å®šä¹‰æ˜¯åœ¨å¤šä¸ªåº”ç”¨ç³»ç»Ÿä¸­ï¼Œç”¨æˆ·åªéœ€è¦ç™»å½•ä¸€æ¬¡å°±å¯ä»¥è®¿é—®æ‰€æœ‰ç›¸äº’ä¿¡ä»»çš„åº”ç”¨ç³»ç»Ÿã€‚

ä¸‹å›¾æ˜¯SSOçš„ç¤ºæ„å›¾ï¼Œç”¨æˆ·ç™»å½•å­¦æˆç½‘ä¸€æ¬¡å³å¯è®¿é—®å¤šä¸ªç³»ç»Ÿã€‚

![](https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/master/%E5%8D%95%E7%82%B9%E7%99%BB%E5%BD%95%E7%A4%BA%E6%84%8F%E5%9B%BE.jpg)

## ç¬¬ä¸‰æ–¹è®¤è¯éœ€æ±‚

ä½œä¸ºäº’è”ç½‘é¡¹ç›®éš¾å…éœ€è¦è®¿é—®å¤–éƒ¨ç³»ç»Ÿçš„èµ„æºï¼ŒåŒæ ·æœ¬ç³»ç»Ÿä¹Ÿè¦è®¿é—®ç¬¬ä¸‰æ–¹ç³»ç»Ÿçš„èµ„æºæ¥å£ï¼Œä¸€ä¸ªåœºæ™¯å¦‚ä¸‹ï¼š

ä¸€ä¸ªå¾®ä¿¡ç”¨æˆ·æ²¡æœ‰åœ¨å­¦æˆåœ¨çº¿æ³¨å†Œï¼Œæœ¬ç³»ç»Ÿå¯ä»¥é€šè¿‡è¯·æ±‚å¾®ä¿¡ç³»ç»Ÿæ¥éªŒè¯è¯¥ç”¨æˆ·çš„èº«ä»½ï¼ŒéªŒè¯é€šè¿‡åè¯¥ç”¨æˆ·ä¾¿å¯åœ¨æœ¬ç³»ç»Ÿå­¦ä¹ ï¼Œå®ƒçš„åŸºæœ¬æµç¨‹å¦‚ä¸‹ï¼š

![](https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/master/%E7%AC%AC%E4%B8%89%E6%96%B9%E8%AE%A4%E8%AF%81%E7%A4%BA%E6%84%8F%E5%9B%BE.jpg)

ä»ä¸Šå›¾å¯ä»¥çœ‹å‡ºï¼Œå¾®ä¿¡ä¸å±äºæœ¬ç³»ç»Ÿï¼Œæœ¬ç³»ç»Ÿå¹¶æ²¡æœ‰å­˜å‚¨å¾®ä¿¡ç”¨æˆ·çš„è´¦å·ã€å¯†ç ç­‰ä¿¡æ¯ï¼Œæœ¬ç³»ç»Ÿå¦‚æœè¦è·å–è¯¥ç”¨æˆ·çš„åŸºæœ¬ä¿¡æ¯åˆ™éœ€è¦é¦–å…ˆé€šè¿‡å¾®ä¿¡çš„è®¤è¯ç³»ç»Ÿï¼ˆå¾®ä¿¡è®¤è¯ï¼‰è¿›è¡Œè®¤è¯ï¼Œå¾®ä¿¡è®¤è¯é€šè¿‡åæœ¬ç³»ç»Ÿä¾¿å¯è·å–è¯¥å¾®ä¿¡ç”¨æˆ·çš„åŸºæœ¬ä¿¡æ¯ï¼Œä»è€Œåœ¨æœ¬ç³»ç»Ÿå°†è¯¥å¾®ä¿¡ç”¨æˆ·çš„å¤´åƒã€æ˜µç§°ç­‰ä¿¡æ¯æ˜¾ç¤ºå‡ºæ¥ï¼Œè¯¥ç”¨æˆ·ä¾¿ä¸ç”¨åœ¨æœ¬ç³»ç»Ÿæ³¨å†Œå´å¯ä»¥ç›´æ¥å­¦ä¹ ã€‚

ä»€ä¹ˆæ˜¯ç¬¬ä¸‰æ–¹è®¤è¯ï¼ˆè·¨å¹³å°è®¤è¯ï¼‰ï¼Ÿ

å½“éœ€è¦è®¿é—®ç¬¬ä¸‰æ–¹ç³»ç»Ÿçš„èµ„æºæ—¶éœ€è¦é¦–å…ˆé€šè¿‡ç¬¬ä¸‰æ–¹ç³»ç»Ÿçš„è®¤è¯ï¼ˆä¾‹å¦‚ï¼šå¾®ä¿¡è®¤è¯ï¼‰ï¼Œç”±ç¬¬ä¸‰æ–¹ç³»ç»Ÿå¯¹ç”¨æˆ·è®¤è¯é€šè¿‡ï¼Œå¹¶æˆæƒèµ„æºçš„è®¿é—®æƒé™ã€‚

![](https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/master/%E7%AC%AC%E4%B8%89%E6%96%B9%E8%AE%A4%E8%AF%81%E7%A4%BA%E6%84%8F%E5%9B%BE2.jpg)

# ç”¨æˆ·è®¤è¯æŠ€æœ¯æ–¹æ¡ˆ

## å•ç‚¹ç™»å½•æŠ€æœ¯æ–¹æ¡ˆ

åˆ†å¸ƒå¼ç³»ç»Ÿè¦å®ç°å•ç‚¹ç™»å½•ï¼Œé€šå¸¸å°†è®¤è¯ç³»ç»Ÿç‹¬ç«‹æŠ½å–å‡ºæ¥ï¼Œå¹¶ä¸”å°†ç”¨æˆ·èº«ä»½ä¿¡æ¯å­˜å‚¨åœ¨å•ç‹¬çš„å­˜å‚¨ä»‹è´¨ï¼Œæ¯”å¦‚ï¼šMySQLã€Redisï¼Œè€ƒè™‘æ€§èƒ½è¦æ±‚ï¼Œé€šå¸¸å­˜å‚¨åœ¨Redisä¸­ï¼Œå¦‚ä¸‹å›¾ï¼š

![](https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/master/%E5%8D%95%E7%82%B9%E7%99%BB%E9%99%86%E7%BB%93%E6%9E%84%E5%9B%BE.jpg)

å•ç‚¹ç™»å½•çš„ç‰¹ç‚¹æ˜¯ï¼š

- è®¤è¯ç³»ç»Ÿä¸ºç‹¬ç«‹çš„ç³»ç»Ÿã€‚
- å„å­ç³»ç»Ÿé€šè¿‡Httpæˆ–å…¶å®ƒåè®®ä¸è®¤è¯ç³»ç»Ÿé€šä¿¡ï¼Œå®Œæˆç”¨æˆ·è®¤è¯ã€‚
- ç”¨æˆ·èº«ä»½ä¿¡æ¯å­˜å‚¨åœ¨Redisé›†ç¾¤ã€‚

## Oauth2è®¤è¯æµç¨‹

ç¬¬ä¸‰æ–¹è®¤è¯æŠ€æœ¯æ–¹æ¡ˆæœ€ä¸»è¦æ˜¯è§£å†³è®¤è¯åè®®çš„é€šç”¨æ ‡å‡†é—®é¢˜ï¼Œå› ä¸ºè¦å®ç°è·¨ç³»ç»Ÿè®¤è¯ï¼Œå„ç³»ç»Ÿä¹‹é—´è¦éµå¾ªä¸€å®šçš„æ¥å£åè®®ã€‚

`Oauth`åè®®ä¸ºç”¨æˆ·èµ„æºçš„æˆæƒæä¾›äº†ä¸€ä¸ªå®‰å…¨çš„ã€å¼€æ”¾è€Œåˆç®€æ˜“çš„æ ‡å‡†ã€‚åŒæ—¶ï¼Œä»»ä½•ç¬¬ä¸‰æ–¹éƒ½å¯ä»¥ä½¿ç”¨`Oauth`è®¤è¯æœåŠ¡ï¼Œä»»ä½•æœåŠ¡æä¾›å•†éƒ½å¯ä»¥å®ç°è‡ªèº«çš„`Oauth`è®¤è¯æœåŠ¡ï¼Œå› è€Œ`Oauth`æ˜¯å¼€æ”¾çš„ã€‚ä¸šç•Œæä¾›äº†`Oauth`çš„å¤šå®ç°å¦‚PHPã€JavaScriptï¼ŒJavaï¼ŒRubyç­‰å„ç§è¯­è¨€å¼€å‘åŒ…ï¼Œå¤§å¤§èŠ‚çº¦äº†ç¨‹åºå‘˜çš„æ—¶é—´ï¼Œå› è€Œ`Oauth`æ˜¯ç®€æ˜“çš„ã€‚äº’ç½‘å¾ˆå¤šæœåŠ¡å¦‚Open APIï¼Œå¾ˆå¤šå¤§å…¬å¸å¦‚Googleï¼ŒYahooï¼ŒMicrosoftç­‰éƒ½æä¾›äº†`Oauth`è®¤è¯æœåŠ¡ï¼Œè¿™äº›éƒ½è¶³ä»¥è¯´æ˜`Oauth`æ ‡å‡†é€æ¸æˆä¸ºå¼€æ”¾èµ„æºæˆæƒçš„æ ‡å‡†ã€‚

é»‘é©¬ç¨‹åºå‘˜ç½‘ç«™ä½¿ç”¨å¾®ä¿¡è®¤è¯çš„è¿‡ç¨‹ï¼š

![](https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/master/%E9%BB%91%E9%A9%AC%E5%AE%98%E7%BD%91%E5%BE%AE%E4%BF%A1%E8%AE%A4%E8%AF%81%E6%B5%81%E7%A8%8B%E5%9B%BE.jpg)

1. å®¢æˆ·ç«¯è¯·æ±‚ç¬¬ä¸‰æ–¹æˆæƒã€‚
2. èµ„æºæ‹¥æœ‰è€…åŒæ„ç»™å®¢æˆ·ç«¯æˆæƒã€‚
3. å®¢æˆ·ç«¯è·å–åˆ°æˆæƒç ï¼Œè¯·æ±‚è®¤è¯æœåŠ¡å™¨ç”³è¯·ä»¤ç‰Œã€‚
4. è®¤è¯æœåŠ¡å™¨å‘å®¢æˆ·ç«¯å“åº”ä»¤ç‰Œã€‚
5. å®¢æˆ·ç«¯è¯·æ±‚èµ„æºæœåŠ¡å™¨çš„èµ„æºã€‚
6. èµ„æºæœåŠ¡å™¨è¿”å›å—ä¿æŠ¤èµ„æºã€‚



`Oauth2.0`è®¤è¯æµç¨‹å¦‚ä¸‹ï¼š

![](https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/master/Oauth2%E5%AE%98%E6%96%B9%E6%B5%81%E7%A8%8B%E7%A4%BA%E6%84%8F%E5%9B%BE.jpg)

`Oauth2`åŒ…æ‹¬ä»¥ä¸‹è§’è‰²ï¼š

- å®¢æˆ·ç«¯
  æœ¬èº«ä¸å­˜å‚¨èµ„æºï¼Œéœ€è¦é€šè¿‡èµ„æºæ‹¥æœ‰è€…çš„æˆæƒå»è¯·æ±‚èµ„æºæœåŠ¡å™¨çš„èµ„æºï¼Œæ¯”å¦‚ï¼šå­¦æˆåœ¨çº¿Androidå®¢æˆ·ç«¯ã€å­¦æˆåœ¨çº¿Webå®¢æˆ·ç«¯ï¼ˆæµè§ˆå™¨ç«¯ï¼‰ã€å¾®ä¿¡å®¢æˆ·ç«¯ç­‰ã€‚
- èµ„æºæ‹¥æœ‰è€…
  é€šå¸¸ä¸ºç”¨æˆ·ï¼Œä¹Ÿå¯ä»¥æ˜¯åº”ç”¨ç¨‹åºï¼Œå³è¯¥èµ„æºçš„æ‹¥æœ‰è€…ã€‚
- æˆæƒæœåŠ¡å™¨ï¼ˆä¹Ÿç§°è®¤è¯æœåŠ¡å™¨ï¼‰
  ç”¨æ¥å¯¹èµ„æºæ‹¥æœ‰çš„èº«ä»½è¿›è¡Œè®¤è¯ã€å¯¹è®¿é—®èµ„æºè¿›è¡Œæˆæƒã€‚å®¢æˆ·ç«¯è¦æƒ³è®¿é—®èµ„æºéœ€è¦é€šè¿‡è®¤è¯æœåŠ¡å™¨ç”±èµ„æºæ‹¥æœ‰è€…æˆæƒåæ–¹å¯è®¿é—®ã€‚
- èµ„æºæœåŠ¡å™¨
  å­˜å‚¨èµ„æºçš„æœåŠ¡å™¨ï¼Œæ¯”å¦‚ï¼Œå­¦æˆç½‘ç”¨æˆ·ç®¡ç†æœåŠ¡å™¨å­˜å‚¨äº†å­¦æˆç½‘çš„ç”¨æˆ·ä¿¡æ¯ï¼Œå­¦æˆç½‘å­¦ä¹ æœåŠ¡å™¨å­˜å‚¨äº†å­¦ç”Ÿçš„å­¦ä¹ ä¿¡æ¯ï¼Œå¾®ä¿¡çš„èµ„æºæœåŠ¡å­˜å‚¨äº†å¾®ä¿¡çš„ç”¨æˆ·ä¿¡æ¯ç­‰ã€‚å®¢æˆ·ç«¯æœ€ç»ˆè®¿é—®èµ„æºæœåŠ¡å™¨è·å–èµ„æºä¿¡æ¯ã€‚

## Spring Security Oauth2

æœ¬é¡¹ç›®é‡‡ç”¨`Spring security` + `Oauth2`å®Œæˆç”¨æˆ·è®¤è¯åŠç”¨æˆ·æˆæƒï¼Œ`Spring security` æ˜¯ä¸€ä¸ªå¼ºå¤§çš„å’Œé«˜åº¦å¯å®šåˆ¶çš„èº«ä»½éªŒè¯å’Œè®¿é—®æ§åˆ¶æ¡†æ¶ï¼Œ`Spring security` æ¡†æ¶é›†æˆäº†`Oauth2`åè®®ï¼Œä¸‹å›¾æ˜¯é¡¹ç›®è®¤è¯æ¶æ„å›¾ï¼š

![](https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/master/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF%E7%94%A8%E6%88%B7%E8%AE%A4%E8%AF%81%E7%BB%93%E6%9E%84%E5%9B%BE.jpg)

1. ç”¨æˆ·è¯·æ±‚è®¤è¯æœåŠ¡å®Œæˆè®¤è¯ã€‚
2. è®¤è¯æœåŠ¡ä¸‹å‘ç”¨æˆ·èº«ä»½ä»¤ç‰Œï¼Œæ‹¥æœ‰èº«ä»½ä»¤ç‰Œè¡¨ç¤ºèº«ä»½åˆæ³•ã€‚
3. ç”¨æˆ·æºå¸¦ä»¤ç‰Œè¯·æ±‚èµ„æºæœåŠ¡ï¼Œè¯·æ±‚èµ„æºæœåŠ¡å¿…å…ˆç»è¿‡ç½‘å…³ã€‚
4. ç½‘å…³æ ¡éªŒç”¨æˆ·èº«ä»½ä»¤ç‰Œçš„åˆæ³•ï¼Œä¸åˆæ³•è¡¨ç¤ºç”¨æˆ·æ²¡æœ‰ç™»å½•ï¼Œå¦‚æœåˆæ³•åˆ™æ”¾è¡Œç»§ç»­è®¿é—®ã€‚
5. èµ„æºæœåŠ¡è·å–ä»¤ç‰Œï¼Œæ ¹æ®ä»¤ç‰Œå®Œæˆæˆæƒã€‚
6. èµ„æºæœåŠ¡å®Œæˆæˆæƒåˆ™å“åº”èµ„æºä¿¡æ¯ã€‚



# Spring Security Oauth2åº”ç”¨

## å¯¼å…¥å·¥ç¨‹ã€å»ºè¡¨ï¼ˆçœç•¥ï¼‰

## æˆæƒç æµç¨‹

> æˆæƒç æµç¨‹è§[æµç¨‹å›¾](#Oauth2è®¤è¯æµç¨‹)

## ç”³è¯·æˆæƒç 

1. å¯åŠ¨é¡¹ç›®

2. å¯åŠ¨nginx

3. è®¿é—®è·¯å¾„

   ```http
   http://localhost:40400/auth/oauth/authorize?client_id=XcWebApp&response_type=code&scop=app&redirect_uri=http://localhost
   ```

4. è¾“å…¥è´¦å·å¯†ç ï¼Œè´¦å·ä¸ºï¼š`client_id`ï¼Œå¯†ç ä¸ºï¼š`client_secret`ï¼Œä¸‹é¢ä¸ºç™»å½•æˆåŠŸåçš„ç•Œé¢ã€‚

   ![https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/83e302c5a5e3ce7cacee03d13dcc7864a5f73fd4/QQ%E6%88%AA%E5%9B%BE20200615232906.png](https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/83e302c5a5e3ce7cacee03d13dcc7864a5f73fd4/QQæˆªå›¾20200615232906.png)

5. ç‚¹å‡»`Authorize`æŒ‰é’®å®Œæˆæˆæƒå¹¶è·³è½¬åˆ°å­¦æˆåœ¨çº¿é¦–é¡µï¼Œå¯ä»¥çœ‹åˆ°`URLè·¯å¾„`åé¢å¸¦ä¸Šäº†`code`å‚æ•°ã€‚

   ![https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/a616b2a7badb31626695cc80267a7d6e9145a651/QQ%E5%9B%BE%E7%89%8720200615233432.png](https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/a616b2a7badb31626695cc80267a7d6e9145a651/QQå›¾ç‰‡20200615233432.png)

## ç”³è¯·ä»¤ç‰Œ

> æˆªå›¾çš„æ—¶å€™å¿˜äº†æ¢`POST`è¯·æ±‚

1. ä½¿ç”¨`POST`è¯·æ±‚ï¼š`http://localhost:40400/auth/oauth/token`

2. å¡«å†™è¯·æ±‚å‚æ•°

   ![https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/9f0f5b645592513182d10f7c1811d76ca6a67e1a/QQ%E6%88%AA%E5%9B%BE20200615235320.png](https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/9f0f5b645592513182d10f7c1811d76ca6a67e1a/QQæˆªå›¾20200615235320.png)

   > grant_typeï¼šæˆæƒç±»å‹ï¼Œå¡«å†™authorization_codeï¼Œè¡¨ç¤ºæˆæƒç æ¨¡å¼ã€‚
   >
   > codeï¼šæˆæƒç ï¼Œå°±æ˜¯åˆšåˆšè·å–çš„æˆæƒç ï¼Œæ³¨æ„ï¼šæˆæƒç åªä½¿ç”¨ä¸€æ¬¡å°±æ— æ•ˆäº†ï¼Œéœ€è¦é‡æ–°ç”³è¯·ã€‚
   >
   > redirect_uriï¼šç”³è¯·æˆæƒç æ—¶çš„è·³è½¬`url`ï¼Œä¸€å®šå’Œç”³è¯·æˆæƒç æ—¶ç”¨çš„`redirect_uri`ä¸€è‡´ã€‚

3. é€‰æ‹©`Authorization`æ¨¡å¼

   ![https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/f6d01d085d38e35312697c179c2f24d4ada23af5/QQ%E6%88%AA%E5%9B%BE20200615235639.png](https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/f6d01d085d38e35312697c179c2f24d4ada23af5/QQæˆªå›¾20200615235639.png)

4. ç‚¹å‡»`Send`ï¼Œå‘é€è¯·æ±‚

   ![https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/a923d61a3ffa395925d8fa93314740b4eb5446ed/QQ%E6%88%AA%E5%9B%BE20200616000138.png](https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/a923d61a3ffa395925d8fa93314740b4eb5446ed/QQæˆªå›¾20200616000138.png)

   > access_tokenï¼šè®¿é—®ä»¤ç‰Œï¼Œæºå¸¦æ­¤ä»¤ç‰Œè®¿é—®èµ„æºã€‚
   >
   > token_typeï¼šæœ‰`MAC Token`ä¸`Bearer Token`ä¸¤ç§ç±»å‹ï¼Œä¸¤ç§çš„æ ¡éªŒç®—æ³•ä¸åŒï¼Œ`RFC 6750`å»ºè®®`Oauth2`é‡‡ç”¨`Bearer Token`ã€‚
   >
   > refresh_tokenï¼šåˆ·æ–°ä»¤ç‰Œï¼Œä½¿ç”¨æ­¤ä»¤ç‰Œå¯ä»¥å»¶é•¿è®¿é—®ä»¤ç‰Œçš„è¿‡æœŸæ—¶é—´ã€‚
   >
   > expires_inï¼šè¿‡æœŸæ—¶é—´ï¼Œå•ä½ä¸ºç§’ã€‚
   >
   > scopeï¼šèŒƒå›´ï¼Œä¸å®šä¹‰çš„å®¢æˆ·ç«¯èŒƒå›´ä¸€è‡´ã€‚

## èµ„æºæœåŠ¡æˆæƒ

> å¾®æœåŠ¡å³ä¸ºèµ„æºæœåŠ¡ï¼Œå„ä¸ªå¾®æœåŠ¡ä¸­çš„`API`å°±æ˜¯è·å–å…¶èµ„æºçš„åŠæ³•ã€‚

### èµ„æºæœåŠ¡æˆæƒæµç¨‹

èµ„æºæœåŠ¡æ‹¥æœ‰è¦è®¿é—®çš„å—ä¿æŠ¤èµ„æºï¼Œå®¢æˆ·ç«¯æºå¸¦ä»¤ç‰Œè®¿é—®èµ„æºæœåŠ¡ï¼Œå¦‚æœä»¤ç‰Œåˆæ³•åˆ™å¯æˆåŠŸè®¿é—®èµ„æºæœåŠ¡ä¸­çš„èµ„æºã€‚

![https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/98a5e017d7caa09e22ca72cbf060a8cc4621bc43/%E8%B5%84%E6%BA%90%E6%9C%8D%E5%8A%A1%E6%8E%88%E6%9D%83%E6%B5%81%E7%A8%8B.jpg](https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/98a5e017d7caa09e22ca72cbf060a8cc4621bc43/èµ„æºæœåŠ¡æˆæƒæµç¨‹.jpg)

1. å®¢æˆ·ç«¯è¯·æ±‚è®¤è¯æœåŠ¡ç”³è¯·ä»¤ç‰Œ
2. è®¤è¯æœåŠ¡ç”Ÿæˆä»¤ç‰Œã€‚è®¤è¯æœåŠ¡é‡‡ç”¨éå¯¹ç§°åŠ å¯†ç®—æ³•ï¼Œä½¿ç”¨ç§é’¥ç”Ÿæˆä»¤ç‰Œã€‚
3. å®¢æˆ·ç«¯æºå¸¦ä»¤ç‰Œè®¿é—®èµ„æºæœåŠ¡ã€‚å®¢æˆ·ç«¯åœ¨`Http header` ä¸­æ·»åŠ ï¼š`Authorizationï¼šBearer` ä»¤ç‰Œã€‚
4. èµ„æºæœåŠ¡è¯·æ±‚è®¤è¯æœåŠ¡æ ¡éªŒä»¤ç‰Œçš„æœ‰æ•ˆæ€§ã€‚èµ„æºæœåŠ¡æ¥æ”¶åˆ°ä»¤ç‰Œï¼Œä½¿ç”¨å…¬é’¥æ ¡éªŒä»¤ç‰Œçš„åˆæ³•æ€§ã€‚
5. ä»¤ç‰Œæœ‰æ•ˆï¼Œèµ„æºæœåŠ¡å‘å®¢æˆ·ç«¯å“åº”èµ„æºä¿¡æ¯

### èµ„æºæœåŠ¡æˆæƒé…ç½®

1. é…ç½®å…¬é’¥

   è®¤è¯æœåŠ¡ç”Ÿæˆä»¤ç‰Œé‡‡ç”¨éå¯¹ç§°åŠ å¯†ç®—æ³•ï¼Œè®¤è¯æœåŠ¡é‡‡ç”¨ç§é’¥åŠ å¯†ç”Ÿæˆä»¤ç‰Œï¼Œå¯¹å¤–å‘èµ„æºæœåŠ¡æä¾›å…¬é’¥ï¼Œèµ„æºæœåŠ¡ä½¿ç”¨å…¬é’¥æ¥æ ¡éªŒä»¤ç‰Œçš„åˆæ³•æ€§ã€‚

   å°†å…¬é’¥æ‹·è´åˆ°`publickey.txt`æ–‡ä»¶ä¸­ï¼Œå°†æ­¤æ–‡ä»¶æ‹·è´åˆ°èµ„æºæœåŠ¡å·¥ç¨‹çš„`classpath`ä¸‹

2. å¼•å…¥ä¾èµ–

   ```xml
           <dependency>
               <groupId>org.springframework.cloud</groupId>
               <artifactId>spring-cloud-starter-oauth2</artifactId>
           </dependency>
   ```

3. ç¼–å†™é…ç½®ç±»

   ```java
   package com.xuecheng.auth.config;
   
   import org.springframework.context.annotation.Bean;
   import org.springframework.context.annotation.Configuration;
   import org.springframework.core.io.ClassPathResource;
   import org.springframework.core.io.Resource;
   import org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity;
   import org.springframework.security.config.annotation.web.builders.HttpSecurity;
   import org.springframework.security.oauth2.config.annotation.web.configuration.EnableResourceServer;
   import org.springframework.security.oauth2.config.annotation.web.configuration.ResourceServerConfigurerAdapter;
   import org.springframework.security.oauth2.provider.token.TokenStore;
   import org.springframework.security.oauth2.provider.token.store.JwtAccessTokenConverter;
   import org.springframework.security.oauth2.provider.token.store.JwtTokenStore;
   
   import java.io.BufferedReader;
   import java.io.IOException;
   import java.io.InputStreamReader;
   import java.util.stream.Collectors;
   
   @Configuration
   @EnableResourceServer
   @EnableGlobalMethodSecurity(prePostEnabled = true, securedEnabled = true)
   public class ResourceServerConfig extends ResourceServerConfigurerAdapter {
   
       //å…¬é’¥
       private static final String PUBLIC_KEY = "publickey.txt";
   
       //å®šä¹‰JwtTokenStoreï¼Œä½¿ç”¨jwtä»¤ç‰Œ
       @Bean
       public TokenStore tokenStore(JwtAccessTokenConverter jwtAccessTokenConverter) {
           return new JwtTokenStore(jwtAccessTokenConverter);
       }
   
       //å®šä¹‰JJwtAccessTokenConverterï¼Œä½¿ç”¨jwtä»¤ç‰Œ
       @Bean
       public JwtAccessTokenConverter jwtAccessTokenConverter() {
           JwtAccessTokenConverter converter = new JwtAccessTokenConverter();
           converter.setVerifierKey(getPubKey());
           return converter;
       }
   
       /**
        * è·å–éå¯¹ç§°åŠ å¯†å…¬é’¥ Key
        *
        * @return å…¬é’¥ Key
        */
       private String getPubKey() {
           Resource resource = new ClassPathResource(PUBLIC_KEY);
           try {
               InputStreamReader inputStreamReader = new
                       InputStreamReader(resource.getInputStream());
               BufferedReader br = new BufferedReader(inputStreamReader);
               return br.lines().collect(Collectors.joining("\n"));
           } catch (IOException ioe) {
               return null;
           }
       }
   
       //Httpå®‰å…¨é…ç½®ï¼Œå¯¹æ¯ä¸ªåˆ°è¾¾ç³»ç»Ÿçš„httpè¯·æ±‚é“¾æ¥è¿›è¡Œæ ¡éªŒ
       @Override
       public void configure(HttpSecurity http) throws Exception {
           //æ‰€æœ‰è¯·æ±‚å¿…é¡»è®¤è¯é€šè¿‡
           http.authorizeRequests().anyRequest().authenticated();
       }
   }
   ```

### èµ„æºæœåŠ¡æˆæƒæµ‹è¯•

1. ç›´æ¥è®¿é—®ï¼š`http://localhost:31200/course/coursepic/list/4028e58161bd3b380161bd3bcd2f0000`ï¼Œæ˜¾ç¤ºæƒé™ä¸è¶³ã€‚

   ![https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/98c826b05eb5c1173cfeab58854d242d5933cbfd/QQ%E6%88%AA%E5%9B%BE20200616233043.png](https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/98c826b05eb5c1173cfeab58854d242d5933cbfd/QQæˆªå›¾20200616233043.png)

2. è¯·æ±‚å¸¦ä¸Š`token`ï¼Œå†æ¬¡è®¿é—®ã€‚æˆåŠŸè·å–æ•°æ®

   ![https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/fb4b84677603c3e8892bf7c4ae65c14f921a441d/QQ%E6%88%AA%E5%9B%BE20200616233705.png](https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/fb4b84677603c3e8892bf7c4ae65c14f921a441d/QQæˆªå›¾20200616233705.png)

### swagger-uiæ— æ³•è®¿é—®è§£å†³

ä¿®æ”¹é…ç½®ç±»ï¼Œé…ç½®éœ€è¦æ”¾è¡Œçš„è·¯å¾„

```java
	//Httpå®‰å…¨é…ç½®ï¼Œå¯¹æ¯ä¸ªåˆ°è¾¾ç³»ç»Ÿçš„httpè¯·æ±‚é“¾æ¥è¿›è¡Œæ ¡éªŒ
    @Override
    public void configure(HttpSecurity http) throws Exception {
        //æ‰€æœ‰è¯·æ±‚å¿…é¡»è®¤è¯é€šè¿‡
        http.authorizeRequests()
                .antMatchers("/v2/apiâ€docs", "/swaggerâ€resources/configuration/ui",
                        "/swaggerâ€resources", "/swaggerâ€resources/configuration/security",
                        "/swaggerâ€ui.html", "/webjars/**").permitAll()
                .anyRequest().authenticated();

    }
```

## å¯†ç æˆæƒæ¨¡å¼

æ¯”è¾ƒç®€å•ï¼Œä¸»è¦è¯´ä¸‹æµç¨‹ã€‚

1. è¿˜æ˜¯éœ€è¦ä¼ é€’`client_id`å’Œ`client_secret`ï¼Œä½†æ˜¯`grant_type`æ˜¯`password`ï¼ŒéªŒè¯å®¢æˆ·ç«¯æ˜¯å¦æ­£ç¡®
2. è‹¥æ­£ç¡®ï¼ŒéªŒè¯è´¦å·å¯†ç æ˜¯å¦æ­£ç¡®
3. è‹¥æ­£ç¡®ï¼Œé¢å‘`token`

## æ ¡éªŒä»¤ç‰Œ

1. å‘é€è¯·æ±‚

   ```http
   GET auth/oauth/check_token?token=
   ```

2. å‚æ•°

   tokenï¼šç”³è¯·åˆ°çš„`token`

## åˆ·æ–°ä»¤ç‰Œ

1. å‘é€è¯·æ±‚

   ```http
   POST auth/oauth/token
   ```

2. å‚æ•°

   grant_typeï¼š`refresh_token`

   refresh_tokenï¼šç”³è¯·åˆ°çš„`refresh_token`

# JWT

ğŸ‘‰[JWTå‚è€ƒè¿™é‡Œ](https://www.imxushuai.com/2001/12/31/%E4%B9%90%E4%BC%98%E5%95%86%E5%9F%8E%E7%AC%94%E8%AE%B0%E5%8D%81%EF%BC%9A%E6%8E%88%E6%9D%83%E4%B8%AD%E5%BF%83/#JWT)ğŸ‘ˆ

æ„Ÿè§‰è¿™ä¸ªä»‹ç»`JWT`è¦å…¨ä¸€ç‚¹

## ç”ŸæˆRSAå¯†é’¥å¯¹

### ç”Ÿæˆç§é’¥

```shell
keytool -genkeypair -alias xckey -keyalg RSA -keypass xuecheng -keystore xc.keystore -storepass imxushuai-xuecheng
```

> keytoolå‘½ä»¤å‚æ•°ä»‹ç»ï¼š
>
> - aliasï¼šå¯†é’¥çš„åˆ«å
> - keyalgï¼šä½¿ç”¨çš„hashç®—æ³•
> - keypassï¼šå¯†é’¥çš„è®¿é—®å¯†ç 
> - keystoreï¼šå¯†é’¥åº“æ–‡ä»¶åï¼Œxc.keystoreä¿å­˜äº†ç”Ÿæˆçš„è¯ä¹¦
> - storepassï¼šå¯†é’¥åº“çš„è®¿é—®å¯†ç 
>
> æŸ¥è¯¢è¯ä¹¦ä¿¡æ¯çš„å‘½ä»¤ï¼š
>
> `keytool -list -keystore xc.keystore`

### ç”Ÿæˆå…¬é’¥

è‹¥æœªå®‰è£…`openssl`ï¼Œéœ€è¦å…ˆå®‰è£…

å®‰è£…`openssl`ï¼šhttp://slproweb.com/products/Win32OpenSSL.html

é…ç½®`openssl`çš„ç¯å¢ƒå˜é‡

```shell
keytoolÂ â€listÂ â€rfcÂ â€â€keystoreÂ xc.keystoreÂ |Â opensslÂ x509Â â€informÂ pemÂ â€pubkey
```

> PUBLIC KEYéƒ¨åˆ†å°±æ˜¯å…¬é’¥ï¼Œå¤åˆ¶å‡ºæ¥åˆå¹¶åˆ°ä¸€è¡Œ

# è®¤è¯æœåŠ¡å¼€å‘

## æµç¨‹åˆ†æ

![https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/3ab46df716ffadabc56d9305b6886421a6ee305e/%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF%E8%AE%A4%E8%AF%81%E6%9C%8D%E5%8A%A1%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95%E6%B5%81%E7%A8%8B%E5%9B%BE.jpg](https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/3ab46df716ffadabc56d9305b6886421a6ee305e/å­¦æˆåœ¨çº¿è®¤è¯æœåŠ¡ç”¨æˆ·ç™»å½•æµç¨‹å›¾.jpg)

æ‰§è¡Œæµç¨‹ï¼š

1. ç”¨æˆ·ç™»å½•ï¼Œè¯·æ±‚è®¤è¯æœåŠ¡
2. è®¤è¯æœåŠ¡è®¤è¯é€šè¿‡ï¼Œç”Ÿæˆjwtä»¤ç‰Œï¼Œå°†jwtä»¤ç‰ŒåŠç›¸å…³ä¿¡æ¯å†™å…¥Redisï¼Œå¹¶ä¸”å°†èº«ä»½ä»¤ç‰Œå†™å…¥cookie
3. ç”¨æˆ·è®¿é—®èµ„æºé¡µé¢ï¼Œå¸¦ç€cookieåˆ°ç½‘å…³
4. ç½‘å…³ä»cookieè·å–tokenï¼Œå¹¶æŸ¥è¯¢Redisæ ¡éªŒtoken,å¦‚æœtokenä¸å­˜åœ¨åˆ™æ‹’ç»è®¿é—®ï¼Œå¦åˆ™æ”¾è¡Œ
5. ç”¨æˆ·é€€å‡ºï¼Œè¯·æ±‚è®¤è¯æœåŠ¡ï¼Œæ¸…é™¤redisä¸­çš„tokenï¼Œå¹¶ä¸”åˆ é™¤cookieä¸­çš„token

ä½¿ç”¨rediså­˜å‚¨ç”¨æˆ·çš„èº«ä»½ä»¤ç‰Œæœ‰ä»¥ä¸‹ä½œç”¨ï¼š

1. å®ç°ç”¨æˆ·é€€å‡ºæ³¨é”€åŠŸèƒ½ï¼ŒæœåŠ¡ç«¯æ¸…é™¤ä»¤ç‰Œåï¼Œå³ä½¿å®¢æˆ·ç«¯è¯·æ±‚æºå¸¦tokenä¹Ÿæ˜¯æ— æ•ˆçš„ã€‚
2. ç”±äºjwtä»¤ç‰Œè¿‡é•¿ï¼Œä¸å®œå­˜å‚¨åœ¨cookieä¸­ï¼Œæ‰€ä»¥å°†jwtä»¤ç‰Œå­˜å‚¨åœ¨redisï¼Œç”±å®¢æˆ·ç«¯è¯·æ±‚æœåŠ¡ç«¯è·å–å¹¶åœ¨å®¢æˆ·ç«¯å­˜
   å‚¨ã€‚

## APIæ¥å£å®šä¹‰

```java
package com.xuecheng.api.auth;

import com.xuecheng.framework.domain.ucenter.request.LoginRequest;
import com.xuecheng.framework.domain.ucenter.response.LoginResult;
import com.xuecheng.framework.model.response.ResponseResult;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;

@Api(value = "ç”¨æˆ·è®¤è¯",description = "ç”¨æˆ·è®¤è¯æ¥å£")
public interface AuthControllerApi {
         
    @ApiOperation("ç™»å½•")
    LoginResult login(LoginRequest loginRequest);
    
    @ApiOperation("é€€å‡º")
    ResponseResult logout();
     
}
```

 ## é…ç½®è®¤è¯å®¢æˆ·ç«¯ä¿¡æ¯

```yml
auth:
  tokenValiditySeconds: 1200  #tokenå­˜å‚¨åˆ°redisçš„è¿‡æœŸæ—¶é—´
  clientId: XcWebApp
  clientSecret: XcWebApp
  cookieDomain: imxushuai.com
  cookieMaxAge: -1
```

## AuthCode

```java
package com.xuecheng.framework.domain.ucenter.response;

import com.google.common.collect.ImmutableMap;
import com.xuecheng.framework.model.response.ResultCode;
import io.swagger.annotations.ApiModelProperty;
import lombok.ToString;


/**
 * Created by admin on 2018/3/5.
 */
@ToString
public enum AuthCode implements ResultCode {
    AUTH_USERNAME_NONE(false,23001,"è¯·è¾“å…¥è´¦å·ï¼"),
    AUTH_PASSWORD_NONE(false,23002,"è¯·è¾“å…¥å¯†ç ï¼"),
    AUTH_VERIFYCODE_NONE(false,23003,"è¯·è¾“å…¥éªŒè¯ç ï¼"),
    AUTH_ACCOUNT_NOTEXISTS(false,23004,"è´¦å·ä¸å­˜åœ¨ï¼"),
    AUTH_CREDENTIAL_ERROR(false,23005,"è´¦å·æˆ–å¯†ç é”™è¯¯ï¼"),
    AUTH_LOGIN_ERROR(false,23006,"ç™»é™†è¿‡ç¨‹å‡ºç°å¼‚å¸¸è¯·å°è¯•é‡æ–°æ“ä½œï¼"),
    AUTH_LOGIN_APPLY_TOKEN_FAIL(false, 24001, "ç”³è¯·ä»¤ç‰Œå¤±è´¥"),
    AUTH_LOGIN_TOKEN_SAVE_FAIL(false, 24002, "TOKENä¿å­˜åˆ°Rediså¤±è´¥"),
    AUTH_LOGIN_AUTHSERVER_NOTFOUND(false, 24003, "æœªæ‰¾åˆ°è¿è¡Œä¸­çš„è®¤è¯æœåŠ¡å™¨");

    //æ“ä½œä»£ç 
    @ApiModelProperty(value = "æ“ä½œæ˜¯å¦æˆåŠŸ", example = "true", required = true)
    boolean success;

    //æ“ä½œä»£ç 
    @ApiModelProperty(value = "æ“ä½œä»£ç ", example = "22001", required = true)
    int code;
    //æç¤ºä¿¡æ¯
    @ApiModelProperty(value = "æ“ä½œæç¤º", example = "æ“ä½œè¿‡äºé¢‘ç¹ï¼", required = true)
    String message;
    private AuthCode(boolean success, int code, String message){
        this.success = success;
        this.code = code;
        this.message = message;
    }
    private static final ImmutableMap<Integer, AuthCode> CACHE;

    static {
        final ImmutableMap.Builder<Integer, AuthCode> builder = ImmutableMap.builder();
        for (AuthCode commonCode : values()) {
            builder.put(commonCode.code(), commonCode);
        }
        CACHE = builder.build();
    }

    @Override
    public boolean success() {
        return success;
    }

    @Override
    public int code() {
        return code;
    }

    @Override
    public String message() {
        return message;
    }
}
```

## AuthService

```java
package com.xuecheng.auth.service;

import com.alibaba.fastjson.JSON;
import com.xuecheng.framework.client.XcServiceList;
import com.xuecheng.framework.domain.ucenter.ext.AuthToken;
import com.xuecheng.framework.domain.ucenter.response.AuthCode;
import com.xuecheng.framework.exception.ExceptionCast;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.cloud.client.ServiceInstance;
import org.springframework.cloud.client.loadbalancer.LoadBalancerClient;
import org.springframework.data.redis.core.StringRedisTemplate;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpMethod;
import org.springframework.http.ResponseEntity;
import org.springframework.http.client.ClientHttpResponse;
import org.springframework.security.crypto.codec.Base64;
import org.springframework.stereotype.Service;
import org.springframework.util.LinkedMultiValueMap;
import org.springframework.util.MultiValueMap;
import org.springframework.web.client.DefaultResponseErrorHandler;
import org.springframework.web.client.RestClientException;
import org.springframework.web.client.RestTemplate;

import java.io.IOException;
import java.util.Map;
import java.util.concurrent.TimeUnit;

@Service
public class AuthService {

    private static final Logger LOGGER = LoggerFactory.getLogger(AuthService.class);

    @Value("${auth.tokenValiditySeconds}")
    int tokenValiditySeconds;

    @Autowired
    private RestTemplate restTemplate;

    @Autowired
    private LoadBalancerClient loadBalancerClient;

    @Autowired
    private StringRedisTemplate stringRedisTemplate;

    //è®¤è¯æ–¹æ³•
    public AuthToken login(String username, String password, String clientId, String clientSecret) {
        //ç”³è¯·ä»¤ç‰Œ
        AuthToken authToken = applyToken(username, password, clientId, clientSecret);
        if (authToken == null) {
            ExceptionCast.cast(AuthCode.AUTH_LOGIN_APPLY_TOKEN_FAIL);
        }
        //å°† tokenå­˜å‚¨åˆ°redis
        String access_token = authToken.getAccess_token();
        String content = JSON.toJSONString(authToken);
        boolean saveTokenResult = saveToken(access_token, content, tokenValiditySeconds);
        if (!saveTokenResult) {
            ExceptionCast.cast(AuthCode.AUTH_LOGIN_TOKEN_SAVE_FAIL);
        }
        return authToken;
    }

    //å­˜å‚¨ä»¤ç‰Œåˆ°redis
    private boolean saveToken(String access_token, String content, long ttl) {
        //ä»¤ç‰Œåç§°
        String name = "user_token:" + access_token;
        //ä¿å­˜åˆ°ä»¤ç‰Œåˆ°redis
        stringRedisTemplate.boundValueOps(name).set(content, ttl, TimeUnit.SECONDS);
        //è·å–è¿‡æœŸæ—¶é—´
        Long expire = stringRedisTemplate.getExpire(name);
        return expire > 0;
    }

    //è®¤è¯æ–¹æ³•
    private AuthToken applyToken(String username, String password, String clientId, String
            clientSecret) {
        //é€‰ä¸­è®¤è¯æœåŠ¡çš„åœ°å€
        ServiceInstance serviceInstance =
                loadBalancerClient.choose(XcServiceList.XC_SERVICE_UCENTER_AUTH);
        if (serviceInstance == null) {
            LOGGER.error("choose an auth instance fail");
            ExceptionCast.cast(AuthCode.AUTH_LOGIN_AUTHSERVER_NOTFOUND);
        }
        //è·å–ä»¤ç‰Œçš„url
        String path = serviceInstance.getUri().toString() + "/auth/oauth/token";

        //å®šä¹‰body
        MultiValueMap<String, String> formData = new LinkedMultiValueMap<>();
        //æˆæƒæ–¹å¼
        formData.add("grant_type", "password");
        //è´¦å·
        formData.add("username", username);
        //å¯†ç 
        formData.add("password", password);
        //å®šä¹‰å¤´
        MultiValueMap<String, String> header = new LinkedMultiValueMap<>();
        header.add("Authorization", httpbasic(clientId, clientSecret));
        //æŒ‡å®š restTemplateå½“é‡åˆ°400æˆ–401å“åº”æ—¶å€™ä¹Ÿä¸è¦æŠ›å‡ºå¼‚å¸¸ï¼Œä¹Ÿè¦æ­£å¸¸è¿”å›å€¼
        restTemplate.setErrorHandler(new DefaultResponseErrorHandler() {

            @Override
            public void handleError(ClientHttpResponse response) throws IOException {
                //å½“å“åº”çš„å€¼ä¸º400æˆ–401æ—¶å€™ä¹Ÿè¦æ­£å¸¸å“åº”ï¼Œä¸è¦æŠ›å‡ºå¼‚å¸¸
                if (response.getRawStatusCode() != 400 && response.getRawStatusCode() != 401) {
                    super.handleError(response);
                }
            }
        });
        Map map = null;
        try {
            //httpè¯·æ±‚spring securityçš„ç”³è¯·ä»¤ç‰Œæ¥å£
            ResponseEntity<Map> mapResponseEntity = restTemplate.exchange(path, HttpMethod.POST, new HttpEntity<MultiValueMap<String, String>>(formData, header), Map.class);
            map = mapResponseEntity.getBody();

        } catch (RestClientException e) {
            e.printStackTrace();
            LOGGER.error("request oauth_token_password error: {}", e.getMessage());
            e.printStackTrace();
            ExceptionCast.cast(AuthCode.AUTH_LOGIN_APPLY_TOKEN_FAIL);
        }

        if (map == null ||
                map.get("access_token") == null ||
                map.get("refresh_token") == null ||
                map.get("jti") == null) {//jtiæ˜¯jwtä»¤ç‰Œçš„å”¯ä¸€æ ‡è¯†ä½œä¸ºç”¨æˆ·èº«ä»½ä»¤ç‰Œ
            ExceptionCast.cast(AuthCode.AUTH_LOGIN_APPLY_TOKEN_FAIL);
        }
        AuthToken authToken = new AuthToken();
        //è®¿é—®ä»¤ç‰Œ(jwt)
        String jwt_token = (String) map.get("access_token");
        //åˆ·æ–°ä»¤ç‰Œ(jwt)
        String refresh_token = (String) map.get("refresh_token");
        //jtiï¼Œä½œä¸ºç”¨æˆ·çš„èº«ä»½æ ‡è¯†
        String access_token = (String) map.get("jti");
        authToken.setJwt_token(jwt_token);
        authToken.setAccess_token(access_token);
        authToken.setRefresh_token(refresh_token);
        return authToken;
    }

    //è·å–httpbasicè®¤è¯ä¸²
    private String httpbasic(String clientId, String clientSecret) {

        //å°†å®¢æˆ·ç«¯idå’Œå®¢æˆ·ç«¯å¯†ç æ‹¼æ¥ï¼ŒæŒ‰â€œå®¢æˆ·ç«¯id:å®¢æˆ·ç«¯å¯†ç â€
        String string = clientId + ":" + clientSecret;
        //è¿›è¡Œbase64ç¼–ç 
        byte[] encode = Base64.encode(string.getBytes());
        return "Basic " + new String(encode);
    }

}
```

## AuthController

```java
package com.xuecheng.auth.controller;

import com.xuecheng.api.auth.AuthControllerApi;
import com.xuecheng.auth.service.AuthService;
import com.xuecheng.framework.domain.ucenter.ext.AuthToken;
import com.xuecheng.framework.domain.ucenter.request.LoginRequest;
import com.xuecheng.framework.domain.ucenter.response.AuthCode;
import com.xuecheng.framework.domain.ucenter.response.LoginResult;
import com.xuecheng.framework.exception.ExceptionCast;
import com.xuecheng.framework.model.response.CommonCode;
import com.xuecheng.framework.model.response.ResponseResult;
import com.xuecheng.framework.utils.CookieUtil;
import org.apache.commons.lang3.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.context.request.RequestContextHolder;
import org.springframework.web.context.request.ServletRequestAttributes;

import javax.servlet.http.HttpServletResponse;

@RestController
public class AuthController implements AuthControllerApi {

    @Value("${auth.clientId}")
    private String clientId;

    @Value("${auth.clientSecret}")
    private String clientSecret;

    @Value("${auth.cookieDomain}")
    private String cookieDomain;

    @Value("${auth.cookieMaxAge}")
    private int cookieMaxAge;

    @Value("${auth.tokenValiditySeconds}")
    private int tokenValiditySeconds;

    @Autowired
    private AuthService authService;

    @Override
    @PostMapping("/userlogin")
    public LoginResult login(LoginRequest loginRequest) {
        //æ ¡éªŒè´¦å·æ˜¯å¦è¾“å…¥
        if (loginRequest == null || StringUtils.isEmpty(loginRequest.getUsername())) {
            ExceptionCast.cast(AuthCode.AUTH_USERNAME_NONE);
        }
        //æ ¡éªŒå¯†ç æ˜¯å¦è¾“å…¥
        if (StringUtils.isEmpty(loginRequest.getPassword())) {
            ExceptionCast.cast(AuthCode.AUTH_PASSWORD_NONE);
        }
        AuthToken authToken = authService.login(loginRequest.getUsername(),
                loginRequest.getPassword(), clientId, clientSecret);
        //å°†ä»¤ç‰Œå†™å…¥cookie
        //è®¿é—®token
        String access_token = authToken.getAccess_token();
        //å°†è®¿é—®ä»¤ç‰Œå­˜å‚¨åˆ°cookie
        saveCookie(access_token);
        return new LoginResult(CommonCode.SUCCESS, access_token);
    }


    //å°†ä»¤ç‰Œä¿å­˜åˆ°cookie
    private void saveCookie(String token) {
        HttpServletResponse response = ((ServletRequestAttributes)
                RequestContextHolder.getRequestAttributes()).getResponse();
        //æ·»åŠ cookie è®¤è¯ä»¤ç‰Œï¼Œæœ€åä¸€ä¸ªå‚æ•°è®¾ç½®ä¸ºfalseï¼Œè¡¨ç¤ºå…è®¸æµè§ˆå™¨è·å–
        CookieUtil.addCookie(response, cookieDomain, "/", "uid", token, cookieMaxAge, false);
    }

    @Override
    @PostMapping("/userlogout")
    public ResponseResult logout() {
        return null;
    }
}
```

## è®¤è¯ç›¸å…³URLæ”¾è¡Œ

ä¿®æ”¹`WebSecurityCconfig`

```java
    @Override
    public void configure(WebSecurity web) throws Exception {
        web.ignoring().antMatchers("/userlogin", "/userlogout", "/userjwt");
    }
```

## æµ‹è¯•ç™»å½•

![https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/5bc6ab8662e49b1bee9409f6b516d2be0416accb/QQ%E6%88%AA%E5%9B%BE20200618000206.png](https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/5bc6ab8662e49b1bee9409f6b516d2be0416accb/QQæˆªå›¾20200618000206.png)

## æŸ¥çœ‹redisä¸­çš„token

æˆ‘è¿™é‡Œç”¨çš„`redis-desktop-management`

![https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/4ec1ff3beb03fe2014ed080e0ea09b2774fafb9e/QQ%E6%88%AA%E5%9B%BE20200618000639.png](https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/4ec1ff3beb03fe2014ed080e0ea09b2774fafb9e/QQæˆªå›¾20200618000639.png)

## æµ‹è¯•å†™å…¥jtiåˆ°cookie

1. é…ç½®`nginx`

   ![https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/6fc3b7269fadec96f2d6e3e26d68eb39052a67fa/QQ%E6%88%AA%E5%9B%BE20200618234840.png](https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/6fc3b7269fadec96f2d6e3e26d68eb39052a67fa/QQæˆªå›¾20200618234840.png)

2. è¿è¡Œ`nginx`

3. è°ƒç”¨è¯·æ±‚ï¼ŒæŸ¥çœ‹æ˜¯å¦æ­£ç¡®ä¿å­˜`cookie `

   ![https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/6fc3b7269fadec96f2d6e3e26d68eb39052a67fa/QQ%E6%88%AA%E5%9B%BE20200618235054.png](https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/6fc3b7269fadec96f2d6e3e26d68eb39052a67fa/QQæˆªå›¾20200618235054.png)

   > æ­£ç¡®ä¿å­˜`cookie`