---
title: åæ¬¡æ–¹åç«¯ç¬”è®°å…«ï¼šç½‘å…³ã€é…ç½®ä¸­å¿ƒå’Œæ¶ˆæ¯æ€»çº¿
tags:
  - åæ¬¡æ–¹ç½‘å…³å¾®æœåŠ¡
  - åæ¬¡æ–¹é…ç½®ä¸­å¿ƒå¾®æœåŠ¡
  - æ¶ˆæ¯æ€»çº¿
categories:
  - åæ¬¡æ–¹é¡¹ç›®
abbrlink: 31977
date: 2002-01-02 00:00:08
---

<center><i>æ­å»ºå¾®æœåŠ¡ç½‘å…³ä»¥åŠä½¿ç”¨ Spring Cloud ( Config + Bus ) å®Œæˆå¾®æœåŠ¡é…ç½®ä¸­å¿ƒ</i></center>

![](https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/master/tensquare.jpg)

<!-- more -->

# å¾®æœåŠ¡ç½‘å…³

`Spring Cloud`æŠ€æœ¯æ ˆé‡‡ç”¨`Zuul`ä½œä¸ºå¾®æœåŠ¡ç½‘å…³ï¼Œåœ¨æ•´ä¸ªæ¶æ„ä¸­ï¼Œ`Zuul`æ˜¯æ‰€æœ‰å…¶ä»–å¾®æœåŠ¡çš„ç»Ÿä¸€å…¥å£ï¼Œå¯¹æ‰€æœ‰è¯·æ±‚è¿›è¡Œè·¯ç”±ã€‚

## ç®¡ç†åå°å¾®æœåŠ¡ç½‘å…³

### åå°ç½‘å…³å¾®æœåŠ¡åˆ›å»ºModuleï¼ˆçœç•¥ï¼‰

### å¼•å…¥ä¾èµ–

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <artifactId>tensquare_parent</artifactId>
        <groupId>com.tensquare</groupId>
        <version>1.0.0-SNAPSHOT</version>
    </parent>
    <modelVersion>4.0.0</modelVersion>

    <artifactId>tensquare_manager</artifactId>

    <dependencies>
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-netflix-eureka-client</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-netflix-zuul</artifactId>
        </dependency>
    </dependencies>

</project>
```

### application.yml

```yaml
server:
  port: 9011
spring:
  application:
    name: tensquareâ€manager #æŒ‡å®šæœåŠ¡å
eureka:
  instance:
    preferâ€ipâ€address: true
  client:
    service-url:
      defaultZone: http://127.0.0.1:6868/eureka/
zuul:
  routes:
    tensquareâ€gathering: #æ´»åŠ¨
      path: /gathering/**
      serviceId: tensquareâ€gathering
    tensquareâ€article: #æ–‡ç« 
      path: /article/**
      serviceId: tensquareâ€article
    tensquareâ€base: #åŸºç¡€
      path: /base/**
      serviceId: tensquareâ€base
    tensquareâ€friend: #äº¤å‹
      path: /friend/**
      serviceId: tensquareâ€friend
    tensquareâ€qa: #é—®ç­”
      path: /qa/**
      serviceId: tensquareâ€qa
    tensquareâ€recruit: #æ‹›è˜
      path: /recruit/**
      serviceId: tensquareâ€recruit
    tensquareâ€spit: #åæ§½
      path: /spit/**
      serviceId: tensquareâ€spit
    tensquareâ€user: #ç”¨æˆ·
      path: /user/**
      serviceId: tensquareâ€user
```

### å¯åŠ¨ç±»

```java
package com.tensquare.manager;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.netflix.zuul.EnableZuulProxy;

@SpringBootApplication
@EnableZuulProxy
public class ManagerApplication {
    public static void main(String[] args) {
        SpringApplication.run(ManagerApplication.class, args);
    }
}
```

## å‰å°å¾®æœåŠ¡ç½‘å…³

### å‰å°ç½‘å…³å¾®æœåŠ¡åˆ›å»ºModuleï¼ˆçœç•¥ï¼‰

### å¼•å…¥ä¾èµ–

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <artifactId>tensquare_parent</artifactId>
        <groupId>com.tensquare</groupId>
        <version>1.0.0-SNAPSHOT</version>
    </parent>
    <modelVersion>4.0.0</modelVersion>

    <artifactId>tensquare_web</artifactId>

    <dependencies>
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-netflix-eureka-client</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-starter-netflix-zuul</artifactId>
        </dependency>
    </dependencies>

</project>
```

### application.yml

```yaml
server:
  port: 9012
spring:
  application:
    name: tensquareâ€web #æŒ‡å®šæœåŠ¡å
eureka:
  instance:
    preferâ€ipâ€address: true
  client:
    service-url:
      defaultZone: http://127.0.0.1:6868/eureka/
zuul:
  routes:
    tensquareâ€gathering: #æ´»åŠ¨
      path: /gathering/**
      serviceId: tensquareâ€gathering
    tensquareâ€article: #æ–‡ç« 
      path: /article/**
      serviceId: tensquareâ€article
    tensquareâ€base: #åŸºç¡€
      path: /base/**
      serviceId: tensquareâ€base
    tensquareâ€friend: #äº¤å‹
      path: /friend/**
      serviceId: tensquareâ€friend
    tensquareâ€qa: #é—®ç­”
      path: /qa/**
      serviceId: tensquareâ€qa
    tensquareâ€recruit: #æ‹›è˜
      path: /recruit/**
      serviceId: tensquareâ€recruit
    tensquareâ€spit: #åæ§½
      path: /spit/**
      serviceId: tensquareâ€spit
    tensquareâ€user: #ç”¨æˆ·
      path: /user/**
      serviceId: tensquareâ€user
    tensquareâ€search: #ç”¨æˆ·
      path: /user/**
      serviceId: tensquareâ€search
```

### å¯åŠ¨ç±»

```java
package com.tensquare.web;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.netflix.zuul.EnableZuulProxy;

@EnableZuulProxy
@SpringBootApplication
public class WebApplication {
    public static void main(String[] args) {
        SpringApplication.run(WebApplication.class, args);
    }
}
```

## å‰å°ç½‘å…³è½¬å‘Token

ç¼–å†™`Zuul`è¿‡æ»¤å™¨å®ç°`Token`è½¬å‘

```java
package com.tensquare.web.filter;

import com.netflix.zuul.ZuulFilter;
import com.netflix.zuul.context.RequestContext;
import com.netflix.zuul.exception.ZuulException;
import org.springframework.stereotype.Component;

import javax.servlet.http.HttpServletRequest;

@Component
public class WebFilter extends ZuulFilter {

    @Override
    public String filterType() {
        return "pre";
    }

    @Override
    public int filterOrder() {
        return 0;
    }

    @Override
    public boolean shouldFilter() {
        return true;
    }

    @Override
    public Object run() throws ZuulException {
        System.out.println("zuulè¿‡æ»¤å™¨...");
        //å‘headerä¸­æ·»åŠ é‰´æƒä»¤ç‰Œ
        RequestContext requestContext = RequestContext.getCurrentContext();
        //è·å–header
        HttpServletRequest request = requestContext.getRequest();
        String authorization = request.getHeader("Authorization");
        if (authorization != null) {
            requestContext.addZuulRequestHeader("Authorization", authorization);
        }
        return null;
    }
}
```

æˆ‘çš„å¦ä¸€ç¯‡æ–‡ç« æœ‰è¯¦ç»†ä»‹ç»`Zuul`ï¼Œæ–‡ç« é“¾æ¥ï¼š[Zuulç½‘å…³è¯¦è§£](https://www.imxushuai.com/2018/12/05/spring-cloud-zuulç½‘å…³/)

## åå°ç½‘å…³è½¬å‘Token

### å¼•å…¥ä¾èµ–

```xml
<dependency>
    <groupId>com.tensquare</groupId>
    <artifactId>tensquare_common</artifactId>
    <version>${tensquare.version}</version>
</dependency>
```

### é…ç½®Jwtç›¸å…³å¸¸é‡

é…ç½®åœ¨`application.yml`å³å¯

```yaml
jwt:
  config:
    key: imxushuai
```

### é…ç½®Bean

é…ç½®åœ¨`ManagerApplication`å³å¯

```java
    @Bean
    public JwtUtil jwtUtil(){
        return new JwtUtil();
    }
```

### é…ç½®Zuulè¿‡æ»¤å™¨

```java
package com.tensquare.manager.filter;

import com.netflix.zuul.ZuulFilter;
import com.netflix.zuul.context.RequestContext;
import com.netflix.zuul.exception.ZuulException;
import io.jsonwebtoken.Claims;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;
import util.JwtUtil;

import javax.servlet.http.HttpServletRequest;

@Slf4j
@Component
public class ManagerFilter extends ZuulFilter {

    @Autowired
    private JwtUtil jwtUtil;

    @Override
    public String filterType() {
        return "pre";
    }

    @Override
    public int filterOrder() {
        return 0;
    }

    @Override
    public boolean shouldFilter() {
        return true;
    }

    @Override
    public Object run() throws ZuulException {
        RequestContext requestContext = RequestContext.getCurrentContext();
        HttpServletRequest request = requestContext.getRequest();
        if (request.getMethod().equals("OPTIONS")) {// è·³è¿‡é¢„è¯·æ±‚
            return null;
        }
        String url = request.getRequestURL().toString();
        if (url.indexOf("/admin/login") > 0) {// æ”¾è¡Œç™»å½•
            log.info("ç™»é™†é¡µé¢: [{}]", url);
            return null;
        }
        String authHeader = request.getHeader("Authorization");//è·å–å¤´ä¿¡æ¯
        if (authHeader != null && authHeader.startsWith("Bearer ")) {
            String token = authHeader.substring(7);
            Claims claims = jwtUtil.parseJWT(token);
            if (claims != null) {
                if ("admin".equals(claims.get("roles"))) {
                    requestContext.addZuulRequestHeader("Authorization", authHeader);
                    log.info("TokenéªŒè¯é€šè¿‡ï¼Œå¤´ä¿¡æ¯ [{}]", authHeader);
                    return null;
                }
            }
        }
        requestContext.setSendZuulResponse(false);//ç»ˆæ­¢è¿è¡Œ
        requestContext.setResponseStatusCode(401);//httpçŠ¶æ€ç 
        requestContext.setResponseBody("æ— æƒè®¿é—®");
        requestContext.getResponse().setContentType("text/html;charset=UTFâ€8");
        return null;
    }
}
```

# é…ç½®ä¸­å¿ƒ

## Spring Cloud Config

â€‹	åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œç”±äºæœåŠ¡æ•°é‡å·¨å¤šï¼Œä¸ºäº†æ–¹ä¾¿æœåŠ¡é…ç½®æ–‡ä»¶ç»Ÿä¸€ç®¡ç†ï¼Œå®æ—¶æ›´æ–°ï¼Œæ‰€ ä»¥éœ€è¦åˆ†å¸ƒå¼é…ç½®ä¸­å¿ƒç»„ä»¶ã€‚åœ¨`Spring Cloud`ä¸­ï¼Œæœ‰åˆ†å¸ƒå¼é…ç½®ä¸­å¿ƒç»„ä»¶`spring cloud config` ï¼Œå®ƒæ”¯æŒé…ç½®æœåŠ¡æ”¾åœ¨é…ç½®æœåŠ¡çš„å†…å­˜ä¸­ï¼ˆå³æœ¬åœ°ï¼‰ï¼Œä¹Ÿæ”¯æŒæ”¾åœ¨è¿œç¨‹Gitä»“åº“ ä¸­ã€‚åœ¨`spring cloud config `ç»„ä»¶ä¸­ï¼Œåˆ†ä¸¤ä¸ªè§’è‰²ï¼Œä¸€æ˜¯`config server`ï¼ŒäºŒæ˜¯`config client`ã€‚ 

- `Config Server`æ˜¯ä¸€ä¸ªå¯æ¨ªå‘æ‰©å±•ã€é›†ä¸­å¼çš„é…ç½®æœåŠ¡å™¨ï¼Œå®ƒç”¨äºé›†ä¸­ç®¡ç†åº”ç”¨ç¨‹åºå„ä¸ªç¯å¢ƒä¸‹çš„é…ç½®ï¼Œé»˜è®¤ä½¿ç”¨Gitå­˜å‚¨é…ç½®æ–‡ä»¶å†…å®¹ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨SVNå­˜å‚¨ï¼Œæˆ–è€…æ˜¯æœ¬åœ°æ–‡ä»¶å­˜å‚¨ã€‚ 
- Config Clientæ˜¯Config Serverçš„å®¢æˆ·ç«¯ï¼Œç”¨äºæ“ä½œå­˜å‚¨åœ¨Config Serverä¸­çš„é…ç½®å†…å®¹ã€‚å¾®æœåŠ¡åœ¨å¯åŠ¨æ—¶ä¼šè¯·æ±‚Config Serverè·å–é…ç½®æ–‡ä»¶çš„å†…å®¹ï¼Œè¯·æ±‚åˆ°åå†å¯åŠ¨å®¹å™¨ã€‚ 

## åˆ›å»ºGit Repositoryï¼ˆçœç•¥ï¼‰

åœ¨`Git`æœåŠ¡å™¨ä¸Šåˆ›å»ºç”¨äºå­˜æ”¾é…ç½®æ–‡ä»¶çš„ä»“åº“ã€‚åˆ›å»ºå¥½åï¼Œå°†æ‰€æœ‰çš„é…ç½®æ–‡ä»¶ä¸Šä¼ è‡³`Git`æœåŠ¡å™¨ã€‚

![](https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/master/20190625210531.png)

## é…ç½®ä¸­å¿ƒå¾®æœåŠ¡

### åˆ›å»ºé…ç½®ä¸­å¿ƒå¾®æœåŠ¡Moduleï¼ˆçœç•¥ï¼‰

### å¼•å…¥ä¾èµ–

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <artifactId>tensquare_parent</artifactId>
        <groupId>com.tensquare</groupId>
        <version>1.0.0-SNAPSHOT</version>
    </parent>
    <modelVersion>4.0.0</modelVersion>

    <artifactId>tensquare_config</artifactId>

    <dependencies>
        <dependency>
            <groupId>org.springframework.cloud</groupId>
            <artifactId>spring-cloud-config-server</artifactId>
        </dependency>
    </dependencies>

</project>
```

### application.yml

```yaml
spring:
  application:
    name: tensquareâ€config
  cloud:
    config:
      server:
        git:
          uri: https://github.com/imxushuai/tensquare_config.git
server:
  port: 12000
```

### å¯åŠ¨ç±»

```java
package com.tensquare.config;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.cloud.config.server.EnableConfigServer;

@EnableConfigServer
@SpringBootApplication
public class ConfigApplication {
    public static void main(String[] args) {
        SpringApplication.run(ConfigApplication.class, args);
    }
}
```

### è¿è¡Œæµ‹è¯•

![](https://imxushuai-01.coding.net/p/pic/d/pic/git/raw/master/20190625211847.png)

æˆåŠŸæ‹‰å–åˆ°é…ç½®æ–‡ä»¶ï¼

## Config Clienté…ç½®

***åœ¨éœ€è¦ä»é…ç½®ä¸­å¿ƒæ‹‰å–é…ç½®çš„å¾®æœåŠ¡ä¸­é‡å¤ä¸€ä¸‹æ“ä½œï¼š***

### å¼•å…¥ä¾èµ–

å¼•å…¥`Spring Cloud Config`ä¾èµ–

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-config</artifactId>
</dependency>
```

### æ–°å¢é…ç½®æ–‡ä»¶

åœ¨`resources`ç›®å½•ä¸­æ–°å¢é…ç½®æ–‡ä»¶ï¼š`bootstrap.yml`

```yaml
spring:
  cloud:
    config:
      # åº”ç”¨å
      name: base
      # ç¯å¢ƒ
      profile: dev
      # åˆ†æ”¯
      label: master
      # é…ç½®ä¸­å¿ƒåœ°å€
      uri: http://127.0.0.1:12000
```

> é…ç½®å®Œæ¯•åï¼Œå³å¯åˆ é™¤é…ç½®æ–‡ä»¶`application.yml`ï¼Œæµ‹è¯•æ˜¯å¦èƒ½æ­£å¸¸å¯åŠ¨ã€‚

# Spring Cloud Busæ›´æ–°é…ç½®æ–‡ä»¶

ä½¿ç”¨`Spring Cloud Bus`å®ç°å®æ—¶æ›´æ–°é…ç½®æ–‡ä»¶ï¼Œå½“`Git`åº“é…ç½®æ–‡ä»¶å‘é€å˜åŠ¨æ—¶ï¼Œçƒ­æ›´æ–°ç›¸åº”å¾®æœåŠ¡çš„é…ç½®æ–‡ä»¶ã€‚

åŸç†å‚è€ƒï¼š[ğŸ‘‰ç‚¹å‡»æˆ‘ğŸ‘ˆ](<http://blog.didispace.com/springcloud7/>)

## ä¿®æ”¹Config Serverç«¯

### å¼•å…¥ä¾èµ–

åœ¨`tensquare_config`ä¸­å¼•å…¥ä¾èµ–

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-bus</artifactId>
</dependency>
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-stream-binder-rabbit</artifactId>
</dependency>
```

### application.ymlæ–°å¢é…ç½®

æ–°å¢åçš„`application.yml`é…ç½®æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š

```yaml
spring:
  application:
    name: tensquareâ€config
  cloud:
    config:
      server:
        git:
          uri: https://github.com/imxushuai/tensquare_config.git
  rabbitmq:
    host: 192.168.136.104
server:
  port: 12000
management:
  endpoints:
    web:
      exposure:
        include: bus-refresh
```

## ä¿®æ”¹Config Clientç«¯

***åœ¨éœ€è¦ä»é…ç½®ä¸­å¿ƒæ‹‰å–é…ç½®çš„å¾®æœåŠ¡ä¸­é‡å¤ä¸€ä¸‹æ“ä½œï¼š***

### å¼•å…¥ä¾èµ–

å¼•å…¥`Spring Cloud Bus`ä¾èµ–

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-bus</artifactId>
</dependency>
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-stream-binder-rabbit</artifactId>
</dependency>
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-actuator</artifactId>
</dependency>
```

### application.ymlæ–°å¢é…ç½®

æ³¨æ„ï¼šè¿™é‡Œæ–°å¢çš„é…ç½®éœ€è¦åœ¨`Git`æœåŠ¡å™¨ä¸­çš„æ¯ä¸ªé…ç½®æ–‡ä»¶ä¸­åŠ å…¥ä¸‹é¢è¿™æ®µé…ç½®ã€‚

```yaml
spring:
  rabbitmq:
    host: 192.168.136.104
```

### çƒ­æ›´æ–°é…ç½®æ–‡ä»¶è¯´æ˜

è¿™æ ·é…ç½®æ–‡ä»¶çƒ­æ›´æ–°çš„åŸºæœ¬ä¸Šç®—æ˜¯å®Œæˆäº†ï¼Œä»¥ååœ¨æ¯ä¸€æ¬¡é…ç½®æ–‡ä»¶æœ‰æ›´æ–°çš„æ—¶å€™ï¼Œæˆ‘ä»¬åªéœ€è¦è°ƒç”¨ä¸€ä¸ªæ¥å£ï¼Œå°±å¯ä»¥å®Œæˆé…ç½®æ–‡ä»¶çš„çƒ­æ›´æ–°äº†ã€‚

æ¥å£ï¼š`http://127.0.0.1:12000/actuator/bus-refresh`

## æ›´æ–°ç§æœ‰é…ç½®é¡¹

`Spring Cloud Bus`æ›´æ–°åªä¼šæ›´æ–°æ¡†æ¶å·²æœ‰çš„é…ç½®é¡¹ï¼Œè€Œä¸ä¼šæ›´æ–°ç±»ä¼¼`Jwt`ç­‰ç”¨æˆ·è‡ªå®šä¹‰çš„é…ç½®é¡¹ã€‚

éœ€è¦æ›´æ–°è‡ªå®šä¹‰çš„é…ç½®é¡¹ï¼Œéœ€è¦åœ¨è¦æ›´æ–°é…ç½®é¡¹çš„`Bean`ä¸Šä½¿ç”¨`@RefreshScope`æ³¨è§£ï¼Œè¿™æ ·å°±å¯ä»¥å®Œæˆé…ç½®çš„æ›´æ–°ã€‚