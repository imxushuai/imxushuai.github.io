---
title: è°·ç²’å•†åŸ-åˆ†å¸ƒå¼åŸºç¡€ç¯‡_02
tags:
  - è°·ç²’å•†åŸ
  - åˆ†å¸ƒå¼åŸºç¡€ç¯‡
  - è°·ç²’å•†åŸç¬”è®°
  - è°·ç²’å•†åŸè¯¾ä»¶
categories:
  - - è°·ç²’å•†åŸ
    - åˆ†å¸ƒå¼åŸºç¡€ç¯‡
abbrlink: 59210
date: 2021-12-14 18:59:39
---

<center><i>Spring Cloud Alibaba Nacos ã€Feignè¿œç¨‹è°ƒç”¨ã€ Gateway åŸºæœ¬ä½¿ç”¨</i></center>

![](https://imxushuai-blog.oss-cn-chengdu.aliyuncs.com/gulimall_banner_base.png)

<!-- more -->

# å‰è¨€

> è°·ç²’å•†åŸåˆ†å¸ƒå¼åŸºç¡€ç¯‡ï¼Œæ¶‰åŠåˆ°å¾ˆå¤šSpring Cloud Alibabaçš„åŸºç¡€çŸ¥è¯†ï¼Œæˆ‘å°±ä¸åœ¨ç¬”è®°é‡Œè¯¦ç»†ä»‹ç»äº†ã€‚å¯ä»¥å‚è€ƒæˆ‘çš„å¦ä¸€ç¯‡æ–‡ç« ï¼Œå¯¹Spring Cloud AlibabaåŠå…¶ç›¸å…³ç»„ä»¶åšäº†éå¸¸è¯¦ç»†çš„ä»‹ç»å’Œä½¿ç”¨è¯´æ˜ã€‚
>
> ğŸ‘‰[Spring Cloud Alibaba ä»å…¥é—¨åˆ°ç²¾é€š](https://www.imxushuai.com/2021/11/28/39.spring-cloud-alibaba%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E7%B2%BE%E9%80%9A/)ğŸ‘ˆ

#  Spring Cloud Alibaba Nacos

> Spring Cloud AlibabaæœåŠ¡æ³¨å†Œä»¥åŠé…ç½®ä¸­å¿ƒï¼šNacos

## NacosæœåŠ¡

1. ä¸‹è½½Nacos

   ğŸ‘‡ä¸‹è½½é“¾æ¥ğŸ‘‡

   [nacos-server-1.1.3.zip](https://github.com/alibaba/nacos/releases/download/1.1.3/nacos-server-1.1.3.zip)

   [nacos-server-1.1.3.tar.gz](https://github.com/alibaba/nacos/releases/download/1.1.3/nacos-server-1.1.3.tar.gz)

2. è§£å‹ä¸‹è½½åˆ°çš„NacosåŒ…å¹¶æ‰§è¡Œbinç›®å½•ä¸­çš„è¿è¡Œå‘½ä»¤

3. è®¿é—®ï¼š[YourHost]:8848/nacos

4. é»˜è®¤è´¦å·å¯†ç ï¼šnacos/nacos

## é›†æˆNacosåˆ°é¡¹ç›®

> æ­¤æ­¥éª¤æ‰€æœ‰å¾®æœåŠ¡éƒ½éœ€è¦åš

1. æ–°å¢ä¾èµ–

   ```xml
   <dependency>
       <groupId>com.alibaba.cloud</groupId>
       <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
   </dependency>
   ```

2. é…ç½®æ–‡ä»¶æ–°å¢é…ç½®

   ```yaml
   spring:
     cloud:
       nacos:
         discovery:
           # nacosåœ°å€
           server-addr: 127.0.0.1:8848
     # å½“å‰åº”ç”¨åç§°
     application:
       name: gulimall-coupon
   ```

3. Spring Bootå¯åŠ¨ç±»æ–°å¢`@EnableDiscoveryClient`æ³¨è§£

4. å¯åŠ¨å¹¶è§‚å¯ŸNacosç®¡ç†ç•Œé¢ä¸­çš„æœåŠ¡åˆ—è¡¨ä¸­æ˜¯å¦æœ‰åº”ç”¨æ³¨å†Œ

# Feignå£°æ˜å¼è¿œç¨‹è°ƒç”¨

> ç¼–å†™æµ‹è¯•Feignè°ƒç”¨

1. å¼•å…¥ä¾èµ–ï¼ˆæŸ¥çœ‹æ˜¯å¦ä»¥å¼•å…¥ï¼Œä»¥å¼•å…¥ä¸éœ€è¦å†æ¬¡å¼•å…¥ï¼‰

   ```xml
   <dependency>
       <groupId>org.springframework.cloud</groupId>
       <artifactId>spring-cloud-starter-openfeign</artifactId>
   </dependency>
   ```

2. åœ¨`gulimall-coupon`æœåŠ¡ä¸­åŠ å…¥æ–°API

   åœ¨`CouponController`ä¸­æ·»åŠ API

   ```java
   @GetMapping("/member/list")
   public R list() {
       List<CouponEntity> list = new ArrayList<>();
       CouponEntity couponEntity = new CouponEntity();
       couponEntity.setCouponName("ä¼˜æƒ åˆ¸: æ»¡100å‡10");
       list.add(couponEntity);
   
       return R.ok().put("data", list);
   }
   ```

3. åœ¨`gulimall-member`ä¸­ç¼–å†™Feign Client

   ```java
   package com.imxushuai.gulimall.member.feign;
   
   import com.imxushuai.common.utils.R;
   import org.springframework.cloud.openfeign.FeignClient;
   import org.springframework.web.bind.annotation.GetMapping;
   
   @FeignClient("gulimall-coupon")
   public interface CouponFeignService {
       @GetMapping("coupon/coupon/member/list")
       public R list();
   }
   ```

4. åœ¨`gulimall-member`çš„å¯åŠ¨ç±»ä¸­ä½¿ç”¨`@EnableFeignClients`æ³¨è§£å¼€å¯å…è®¸Feign Clientè¿œç¨‹è°ƒç”¨

5. åœ¨`gulimall-member`ä¸­ç¼–å†™APIå¹¶è¿œç¨‹è°ƒç”¨`gulimall-coupon`ä¸­çš„API

   ```java
       @Autowired
       private CouponFeignService couponFeignService;
   
       @GetMapping("/coupons")
       public R test() {
           MemberEntity memberEntity = new MemberEntity();
           memberEntity.setNickname("å¼ ä¸‰");
           R list = couponFeignService.list();
   
           return R.ok().put("member", memberEntity).put("coupons", list);
       }
   ```

6. é‡å¯`gulimall-member` å’Œ`gulimall-coupon`æœåŠ¡

7. è®¿é—®APIè¿›è¡Œæµ‹è¯•

   æˆåŠŸè·å–åˆ°æ•°æ®ï¼Œè¿œç¨‹è°ƒç”¨APIæˆåŠŸ

   ![](https://imxushuai-blog.oss-cn-chengdu.aliyuncs.com/20211214203714.png)

# Nacos Config é…ç½®ä¸­å¿ƒ

> ä½¿ç”¨Spring Cloud Alibaba Nacosä½œä¸ºé…ç½®ä¸­å¿ƒã€‚
>
> é»˜è®¤Nacoså·²ç»å®‰è£…å¹¶è¿è¡Œã€‚

## ç®€å•ä½¿ç”¨

1. å¼•å…¥ä¾èµ–

   ```xml
   <dependency>
       <groupId>com.alibaba.cloud</groupId>
       <artifactId>spring-cloud-starter-alibaba-nacos-config</artifactId>
   </dependency>
   ```

2. æ·»åŠ `bootstrap.properties`é…ç½®æ–‡ä»¶

   ```properties
   spring.application.name=gulimall-coupon
   spring.cloud.nacos.config.server-addr=127.0.0.1:8848
   ```

3. åœ¨Nacosçš„é…ç½®æ–‡ä»¶ä¸­æ·»åŠ `gulimall-coupon.properties`é…ç½®æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹

   ```properties
   coupon.user.name=zhangsan
   coupon.user.age=19
   ```

4. ç¼–è¾‘æµ‹è¯•çš„API

   ```java
   	@Value("${coupon.user.name}")
       private String name;
       @Value("${coupon.user.age}")
       private Integer age;
   
       @GetMapping("test")
       public R testConfig() {
           return R.ok().put("name", name).put("age", age);
       }
   ```

5. åœ¨ä½¿ç”¨é…ç½®æ–‡ä»¶ä¸­çš„é…ç½®çš„ç±»ä¸ŠåŠ å…¥`@RefreshScope`æ³¨è§£

6. é‡å¯æœåŠ¡å¹¶è°ƒç”¨APIæµ‹è¯•ï¼Œè‹¥æˆåŠŸå†ä¿®æ”¹é…ç½®ä¸­å¿ƒçš„é…ç½®æ–‡ä»¶ä¸­çš„å€¼å†æ¬¡è°ƒç”¨æŸ¥çœ‹æ˜¯å¦å˜åŒ–

## å¤šé…ç½®æ–‡ä»¶

> å°†å·²æœ‰çš„application.ymlæ‹†åˆ†ä¸ºå¤šä¸ªé…ç½®æ–‡ä»¶ï¼Œå¦‚ï¼š
>
> coupon-other.ymlï¼šç®¡ç†couponä¸“å±é…ç½®
>
> mybatis.ymlï¼šç®¡ç†mybatisç›¸å…³é…ç½®
>
> datasource.ymlï¼šç®¡ç†æ•°æ®åº“è¿æ¥ç›¸å…³é…ç½®

åªéœ€è¦ä¿®æ”¹`bootstrap.yml`(ç”¨bootstrap.propertiesä¹Ÿè¡Œï¼Œæˆ‘ä¹ æƒ¯ä½¿ç”¨yamlæ ¼å¼)

```yaml
spring:
  application:
    name: gulimall-coupon
  cloud:
    nacos:
      config:
        server-addr: 127.0.0.1:8848
        ext-config:
          - data-id: coupon-other.yml
            group: DEFAULT_GROUP
            refresh: true
          - data-id: mybatis.yml
            group: DEFAULT_GROUP
            refresh: true
          - data-id: datasource.yml
            group: DEFAULT_GROUP
            refresh: true
```

# Spring Cloud Gateway

> Spring Cloudæä¾›çš„APIç½‘å…³ï¼šSpring Cloud Gateway

1. åˆ›å»ºModuleå­å·¥ç¨‹ï¼Œåç§°ä¸º`gulimall-gateway`

2. pom.xml

   ```xml
   <?xml version="1.0" encoding="UTF-8"?>
   <project xmlns="http://maven.apache.org/POM/4.0.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
            xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
       <modelVersion>4.0.0</modelVersion>
       <parent>
           <groupId>org.springframework.boot</groupId>
           <artifactId>spring-boot-starter-parent</artifactId>
           <version>2.1.8.RELEASE</version>
           <relativePath/> <!-- lookup parent from repository -->
       </parent>
       <groupId>com.imxushuai.gulimall</groupId>
       <artifactId>gulimall-gateway</artifactId>
       <version>0.0.1-SNAPSHOT</version>
       <name>gulimall-gateway</name>
       <description>è°·ç²’å•†åŸ-ç½‘å…³æœåŠ¡</description>
       <properties>
           <java.version>1.8</java.version>
           <spring-cloud.version>Greenwich.SR5</spring-cloud.version>
       </properties>
       <dependencies>
           <dependency>
               <groupId>com.imxushuai.gulimall</groupId>
               <artifactId>gulimall-common</artifactId>
               <version>0.0.1-SNAPSHOT</version>
           </dependency>
           <dependency>
               <groupId>org.springframework.cloud</groupId>
               <artifactId>spring-cloud-starter-gateway</artifactId>
           </dependency>
   
           <dependency>
               <groupId>org.springframework.boot</groupId>
               <artifactId>spring-boot-starter-test</artifactId>
               <scope>test</scope>
           </dependency>
       </dependencies>
       <dependencyManagement>
           <dependencies>
               <dependency>
                   <groupId>org.springframework.cloud</groupId>
                   <artifactId>spring-cloud-dependencies</artifactId>
                   <version>${spring-cloud.version}</version>
                   <type>pom</type>
                   <scope>import</scope>
               </dependency>
           </dependencies>
       </dependencyManagement>
   
       <build>
           <plugins>
               <plugin>
                   <groupId>org.springframework.boot</groupId>
                   <artifactId>spring-boot-maven-plugin</artifactId>
               </plugin>
           </plugins>
       </build>
   
   </project>
   ```

3. å¯åŠ¨ç±»

   ```jav
   package com.imxushuai.gulimall.gulimallgateway;
   
   import org.springframework.boot.SpringApplication;
   import org.springframework.boot.autoconfigure.SpringBootApplication;
   import org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration;
   import org.springframework.cloud.client.discovery.EnableDiscoveryClient;
   
   @EnableDiscoveryClient
   @SpringBootApplication(exclude = {DataSourceAutoConfiguration.class})
   public class GulimallGatewayApplication {
   
       public static void main(String[] args) {
           SpringApplication.run(GulimallGatewayApplication.class, args);
       }
   
   }
   ```

4. application.yml

   ```yaml
   spring:
     cloud:
       nacos:
         discovery:
           server-addr: 127.0.0.1:8848
     application:
       name: gulimall-gateway
   server:
     port: 88
   ```

5. bootstrap.yml

   ```yaml
   spring:
     cloud:
       nacos:
         config:
           server-addr: 127.0.0.1:8848
           # å‘½åç©ºé—´ID, æ ¹æ®å…·ä½“IDæ›¿æ¢
           namespace: cad8d252-b4a6-4634-9ef2-5e963d361395
           ext-config:
             - data-id: routing.yml
               group: DEFAULT_GROUP
               refresh: true
   ```

6. åœ¨Nacosé…ç½®ä¸­å¿ƒé…ç½®`routing.yml`

   éœ€è¦æå‰åˆ›å»ºgatewayä½¿ç”¨çš„é…ç½®ä¸­å¿ƒå‘½åç©ºé—´

   ```yaml
   spring:
     cloud:
       gateway:
         routes:
           - id: baidu_route
             uri: https://www.baidu.com
             predicates:
               - Query=url, baidu
           - id: qq_route
             uri: https://www.qq.com/
             predicates:
               - Query=url, qq
   ```

7. å¯åŠ¨å¹¶è®¿é—®æµ‹è¯•

   æµ‹è¯•åœ°å€1ï¼š[http://localhost:88/?url=baidu](http://localhost:88/?url=baidu)

   æµ‹è¯•åœ°å€2ï¼š[http://localhost:88/?url=qq](http://localhost:88/?url=qq)

# å‰ç«¯åŸºç¡€å¼€å‘ä¸å…¥é—¨

> ES6å’ŒVUEï¼Œå¤§è‡´çš„å†…å®¹æˆ‘éƒ½ä¼šï¼Œæ‰€ä»¥è¿™é‡Œå°±ä¸å†™ç¬”è®°äº†ï¼Œç”¨çš„æ—¶å€™èƒ½æœåˆ°å°±è¡Œäº†ã€‚