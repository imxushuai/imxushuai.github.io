<!-- - var pageTitle = page.title || config.subtitle || ''// ä¿®æ”¹é¦–é¡µçš„title--><!DOCTYPE html><html lang="zh-Hans"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="Spring Cloud Alibaba ä»å…¥é—¨åˆ°ç²¾é€š"><meta name="keywords" content="Spring Cloud,Spring Cloud Alibaba,Nacos,Nacos Config,Sentinel,Gateway,Sleuth,Zipkin,RocketMQ,Seata"><meta name="author" content="imxushuai"><meta name="copyright" content="imxushuai"><meta name="baidu-site-verification" content="B3htTw43Gg"><meta name="google-site-verification" content="o2KrBdxV2bs7OPjZSdarNWbV6uC2WAtFOGQEbGAZJOo"><title>Spring Cloud Alibaba ä»å…¥é—¨åˆ°ç²¾é€š | imxushuai</title><link rel="shortcut icon" href="/B.png"><link rel="stylesheet" href="/css/index.css?version=1.6.1"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.6.1"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.css"><script src="https://cdn.jsdelivr.net/npm/instantsearch.js@2.1.1/dist/instantsearch.min.js" defer></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css"><script src="https://cdn.jsdelivr.net/npm/gitalk@latest/dist/gitalk.min.js"></script><script src="https://cdn.jsdelivr.net/npm/blueimp-md5@2.10.0/js/md5.min.js"></script><script>((function(){
  var bp = document.createElement('script');
  var curProtocol = window.location.protocol.split(':')[0];
  if (curProtocol === 'https') {
  bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
}
  else {
  bp.src = 'http://push.zhanzhang.baidu.com/push.js';
}
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(bp, s);
})());

</script><script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle = window.adsbygoogle || []).push({
  google_ad_client: 'ca-pub-8123778246943935',
  enable_page_level_ads: true
});
</script><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?ee77185761e9c3e3a277dac848c66c44";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><link rel="dns-prefetch" href="https://www.google-analytics.com"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-140233731-1', 'auto');
ga('send', 'pageview');</script><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: {"appId":"0AG6VKDJB8","apiKey":"1acca465cd19291fd2e30fc0bde470b9","indexName":"search","hits":{"per_page":10},"languages":{"input_placeholder":"æœç´¢æ–‡ç« ","hits_empty":"æ‰¾ä¸åˆ°æ‚¨æŸ¥è¯¢çš„å†…å®¹:${query}","hits_stats":"æ‰¾åˆ° ${hits} æ¡ç»“æœï¼Œç”¨æ—¶ ${time} æ¯«ç§’"}},
  localSearch: undefined,
  copy: {
    success: 'å¤åˆ¶æˆåŠŸ',
    error: 'å¤åˆ¶é”™è¯¯',
    noSupport: 'æµè§ˆå™¨ä¸æ”¯æŒ'
  }
} </script></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="åˆ‡æ¢æ–‡ç« è¯¦æƒ…">åˆ‡æ¢ç«™ç‚¹æ¦‚è§ˆ</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">ç›®å½•</div><div class="sidebar-toc__progress"><span class="progress-notice">ä½ å·²ç»è¯»äº†</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#SpringCloud-Alibabaä»‹ç»"><span class="toc-number">1.</span> <span class="toc-text">SpringCloud Alibabaä»‹ç»</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ä¸»è¦åŠŸèƒ½"><span class="toc-number">1.1.</span> <span class="toc-text">ä¸»è¦åŠŸèƒ½</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ç»„ä»¶"><span class="toc-number">1.2.</span> <span class="toc-text">ç»„ä»¶</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Spring-Cloud-Alibabaå…¨ç»„ä»¶æ¡ˆä¾‹"><span class="toc-number">2.</span> <span class="toc-text">Spring Cloud Alibabaå…¨ç»„ä»¶æ¡ˆä¾‹</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ä»£ç è·å–"><span class="toc-number">2.1.</span> <span class="toc-text">ä»£ç è·å–</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ç¯å¢ƒæ­å»º"><span class="toc-number">2.2.</span> <span class="toc-text">ç¯å¢ƒæ­å»º</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#æŠ€æœ¯é€‰å‹"><span class="toc-number">2.2.1.</span> <span class="toc-text">æŠ€æœ¯é€‰å‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#æ¡ˆä¾‹æ¨¡å—"><span class="toc-number">2.2.2.</span> <span class="toc-text">æ¡ˆä¾‹æ¨¡å—</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#åˆ›å»ºçˆ¶å·¥ç¨‹"><span class="toc-number">2.3.</span> <span class="toc-text">åˆ›å»ºçˆ¶å·¥ç¨‹</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#pom-xml"><span class="toc-number">2.3.1.</span> <span class="toc-text">pom.xml</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#åˆ›å»ºå…¬å…±æ¨¡å—"><span class="toc-number">2.4.</span> <span class="toc-text">åˆ›å»ºå…¬å…±æ¨¡å—</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#pom-xml-1"><span class="toc-number">2.4.1.</span> <span class="toc-text">pom.xml</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ç¼–å†™å®ä½“ç±»"><span class="toc-number">2.4.2.</span> <span class="toc-text">ç¼–å†™å®ä½“ç±»</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#åˆ›å»ºç”¨æˆ·å¾®æœåŠ¡"><span class="toc-number">2.5.</span> <span class="toc-text">åˆ›å»ºç”¨æˆ·å¾®æœåŠ¡</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#pom-xml-2"><span class="toc-number">2.5.1.</span> <span class="toc-text">pom.xml</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ç¼–å†™Spring-Bootå¯åŠ¨ç±»"><span class="toc-number">2.5.2.</span> <span class="toc-text">ç¼–å†™Spring Bootå¯åŠ¨ç±»</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ç¼–å†™application-ymlé…ç½®æ–‡ä»¶"><span class="toc-number">2.5.3.</span> <span class="toc-text">ç¼–å†™application.ymlé…ç½®æ–‡ä»¶</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#åˆ›å»ºå•†å“å¾®æœåŠ¡"><span class="toc-number">2.6.</span> <span class="toc-text">åˆ›å»ºå•†å“å¾®æœåŠ¡</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#pom-xml-3"><span class="toc-number">2.6.1.</span> <span class="toc-text">pom.xml</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ç¼–å†™Spring-Bootå¯åŠ¨ç±»-1"><span class="toc-number">2.6.2.</span> <span class="toc-text">ç¼–å†™Spring Bootå¯åŠ¨ç±»</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ç¼–å†™application-ymlé…ç½®æ–‡ä»¶-1"><span class="toc-number">2.6.3.</span> <span class="toc-text">ç¼–å†™application.ymlé…ç½®æ–‡ä»¶</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#åŸºç¡€ä»£ç ç¼–å†™"><span class="toc-number">2.6.4.</span> <span class="toc-text">åŸºç¡€ä»£ç ç¼–å†™</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#æ•°æ®æ’å…¥"><span class="toc-number">2.6.5.</span> <span class="toc-text">æ•°æ®æ’å…¥</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#æµ‹è¯•API"><span class="toc-number">2.6.6.</span> <span class="toc-text">æµ‹è¯•API</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#åˆ›å»ºè®¢å•å¾®æœåŠ¡"><span class="toc-number">2.7.</span> <span class="toc-text">åˆ›å»ºè®¢å•å¾®æœåŠ¡</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#pom-xml-4"><span class="toc-number">2.7.1.</span> <span class="toc-text">pom.xml</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ç¼–å†™Spring-Bootå¯åŠ¨ç±»-2"><span class="toc-number">2.7.2.</span> <span class="toc-text">ç¼–å†™Spring Bootå¯åŠ¨ç±»</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ç¼–å†™application-ymlé…ç½®æ–‡ä»¶-2"><span class="toc-number">2.7.3.</span> <span class="toc-text">ç¼–å†™application.ymlé…ç½®æ–‡ä»¶</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#åŸºç¡€ä»£ç ç¼–å†™-1"><span class="toc-number">2.7.4.</span> <span class="toc-text">åŸºç¡€ä»£ç ç¼–å†™</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#æµ‹è¯•API-1"><span class="toc-number">2.7.5.</span> <span class="toc-text">æµ‹è¯•API</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Spring-Cloud-Alibabaå®è·µ"><span class="toc-number">3.</span> <span class="toc-text">Spring Cloud Alibabaå®è·µ</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#æœåŠ¡æ²»ç†ï¼ˆNacos-Discoveryï¼‰"><span class="toc-number">3.1.</span> <span class="toc-text">æœåŠ¡æ²»ç†ï¼ˆNacos Discoveryï¼‰</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ä»€ä¹ˆæ˜¯æœåŠ¡æ²»ç†"><span class="toc-number">3.1.1.</span> <span class="toc-text">ä»€ä¹ˆæ˜¯æœåŠ¡æ²»ç†</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#å¸¸è§çš„æ³¨å†Œä¸­å¿ƒ"><span class="toc-number">3.1.2.</span> <span class="toc-text">å¸¸è§çš„æ³¨å†Œä¸­å¿ƒ</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Nacos"><span class="toc-number">3.2.</span> <span class="toc-text">Nacos</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Nacoså®‰è£…"><span class="toc-number">3.2.1.</span> <span class="toc-text">Nacoså®‰è£…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#æ³¨å†Œå•†å“å’Œè®¢å•å¾®æœåŠ¡åˆ°Nacos"><span class="toc-number">3.2.2.</span> <span class="toc-text">æ³¨å†Œå•†å“å’Œè®¢å•å¾®æœåŠ¡åˆ°Nacos</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#è´Ÿè½½å‡è¡¡"><span class="toc-number">3.3.</span> <span class="toc-text">è´Ÿè½½å‡è¡¡</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ä»€ä¹ˆæ˜¯è´Ÿè½½å‡è¡¡"><span class="toc-number">3.3.1.</span> <span class="toc-text">ä»€ä¹ˆæ˜¯è´Ÿè½½å‡è¡¡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Ribbonç»„ä»¶"><span class="toc-number">3.3.2.</span> <span class="toc-text">Ribbonç»„ä»¶</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Ribbonæ”¯æŒçš„è´Ÿè½½å‡è¡¡ç­–ç•¥"><span class="toc-number">3.3.3.</span> <span class="toc-text">Ribbonæ”¯æŒçš„è´Ÿè½½å‡è¡¡ç­–ç•¥</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#FeignæœåŠ¡è°ƒç”¨"><span class="toc-number">3.4.</span> <span class="toc-text">FeignæœåŠ¡è°ƒç”¨</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ä»€ä¹ˆæ˜¯Feign"><span class="toc-number">3.4.1.</span> <span class="toc-text">ä»€ä¹ˆæ˜¯Feign</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#åŸºäºFeignå®ç°æœåŠ¡è°ƒç”¨"><span class="toc-number">3.4.2.</span> <span class="toc-text">åŸºäºFeignå®ç°æœåŠ¡è°ƒç”¨</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#æœåŠ¡å®¹é”™ï¼ˆSentinelï¼‰"><span class="toc-number">3.5.</span> <span class="toc-text">æœåŠ¡å®¹é”™ï¼ˆSentinelï¼‰</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#æœåŠ¡é›ªå´©"><span class="toc-number">3.5.1.</span> <span class="toc-text">æœåŠ¡é›ªå´©</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#å¸¸è§çš„å®¹é”™æ–¹æ¡ˆ"><span class="toc-number">3.5.2.</span> <span class="toc-text">å¸¸è§çš„å®¹é”™æ–¹æ¡ˆ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#å¸¸ç”¨çš„å®¹é”™ç»„ä»¶"><span class="toc-number">3.5.3.</span> <span class="toc-text">å¸¸ç”¨çš„å®¹é”™ç»„ä»¶</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ä»€ä¹ˆæ˜¯Sentinel"><span class="toc-number">3.5.4.</span> <span class="toc-text">ä»€ä¹ˆæ˜¯Sentinel</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#è¿è¡ŒSentinel"><span class="toc-number">3.5.5.</span> <span class="toc-text">è¿è¡ŒSentinel</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#å¾®æœåŠ¡é›†æˆSentinel"><span class="toc-number">3.5.6.</span> <span class="toc-text">å¾®æœåŠ¡é›†æˆSentinel</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#æµ‹è¯•Sentinel"><span class="toc-number">3.5.7.</span> <span class="toc-text">æµ‹è¯•Sentinel</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Sentinelçš„æ¦‚å¿µ"><span class="toc-number">3.5.8.</span> <span class="toc-text">Sentinelçš„æ¦‚å¿µ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Sentinelæµæ§"><span class="toc-number">3.5.9.</span> <span class="toc-text">Sentinelæµæ§</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#æµæ§è§„åˆ™"><span class="toc-number">3.5.9.1.</span> <span class="toc-text">æµæ§è§„åˆ™</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#æµæ§æ¨¡å¼"><span class="toc-number">3.5.9.2.</span> <span class="toc-text">æµæ§æ¨¡å¼</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#æµæ§æ•ˆæœ"><span class="toc-number">3.5.9.3.</span> <span class="toc-text">æµæ§æ•ˆæœ</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Sentinelé™çº§"><span class="toc-number">3.5.10.</span> <span class="toc-text">Sentinelé™çº§</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#é™çº§è§„åˆ™"><span class="toc-number">3.5.10.1.</span> <span class="toc-text">é™çº§è§„åˆ™</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Sentinelçƒ­ç‚¹"><span class="toc-number">3.5.11.</span> <span class="toc-text">Sentinelçƒ­ç‚¹</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#çƒ­ç‚¹è§„åˆ™"><span class="toc-number">3.5.11.1.</span> <span class="toc-text">çƒ­ç‚¹è§„åˆ™</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Sentinelæˆæƒ"><span class="toc-number">3.5.12.</span> <span class="toc-text">Sentinelæˆæƒ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Sentinelç³»ç»Ÿè§„åˆ™"><span class="toc-number">3.5.13.</span> <span class="toc-text">Sentinelç³»ç»Ÿè§„åˆ™</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#è‡ªå®šä¹‰å¼‚å¸¸è¿”å›"><span class="toc-number">3.5.14.</span> <span class="toc-text">è‡ªå®šä¹‰å¼‚å¸¸è¿”å›</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SentinelResourceæ³¨è§£"><span class="toc-number">3.5.15.</span> <span class="toc-text">@SentinelResourceæ³¨è§£</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Sentinelè§„åˆ™æŒä¹…åŒ–"><span class="toc-number">3.5.16.</span> <span class="toc-text">Sentinelè§„åˆ™æŒä¹…åŒ–</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Feignæ•´åˆSentinel"><span class="toc-number">3.5.17.</span> <span class="toc-text">Feignæ•´åˆSentinel</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#æœåŠ¡ç½‘å…³ï¼ˆGatewayï¼‰"><span class="toc-number">3.6.</span> <span class="toc-text">æœåŠ¡ç½‘å…³ï¼ˆGatewayï¼‰</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Gatewayç®€ä»‹"><span class="toc-number">3.6.1.</span> <span class="toc-text">Gatewayç®€ä»‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#åŸºæœ¬ä½¿ç”¨"><span class="toc-number">3.6.2.</span> <span class="toc-text">åŸºæœ¬ä½¿ç”¨</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Gatewayæ ¸å¿ƒæ¶æ„"><span class="toc-number">3.6.3.</span> <span class="toc-text">Gatewayæ ¸å¿ƒæ¶æ„</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#æ–­è¨€"><span class="toc-number">3.6.4.</span> <span class="toc-text">æ–­è¨€</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#å†…ç½®è·¯ç”±æ–­è¨€å·¥å‚"><span class="toc-number">3.6.4.1.</span> <span class="toc-text">å†…ç½®è·¯ç”±æ–­è¨€å·¥å‚</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#è‡ªå®šä¹‰è·¯ç”±æ–­è¨€å·¥å‚"><span class="toc-number">3.6.4.2.</span> <span class="toc-text">è‡ªå®šä¹‰è·¯ç”±æ–­è¨€å·¥å‚</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#è¿‡æ»¤å™¨"><span class="toc-number">3.6.5.</span> <span class="toc-text">è¿‡æ»¤å™¨</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#å±€éƒ¨è¿‡æ»¤å™¨"><span class="toc-number">3.6.5.1.</span> <span class="toc-text">å±€éƒ¨è¿‡æ»¤å™¨</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#å…¨å±€è¿‡æ»¤å™¨"><span class="toc-number">3.6.5.2.</span> <span class="toc-text">å…¨å±€è¿‡æ»¤å™¨</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ç½‘å…³é™æµ"><span class="toc-number">3.6.6.</span> <span class="toc-text">ç½‘å…³é™æµ</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Routeç»´åº¦é™æµ"><span class="toc-number">3.6.6.1.</span> <span class="toc-text">Routeç»´åº¦é™æµ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#APIç»´åº¦é™æµ"><span class="toc-number">3.6.6.2.</span> <span class="toc-text">APIç»´åº¦é™æµ</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#é“¾è·¯è¿½è¸ªï¼ˆSleuth-Zipkinï¼‰"><span class="toc-number">3.7.</span> <span class="toc-text">é“¾è·¯è¿½è¸ªï¼ˆSleuth + Zipkinï¼‰</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#é“¾è·¯è¿½è¸ªç®€ä»‹"><span class="toc-number">3.7.1.</span> <span class="toc-text">é“¾è·¯è¿½è¸ªç®€ä»‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Sleuthç®€ä»‹"><span class="toc-number">3.7.2.</span> <span class="toc-text">Sleuthç®€ä»‹</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SleuthåŸºæœ¬ä½¿ç”¨"><span class="toc-number">3.7.3.</span> <span class="toc-text">SleuthåŸºæœ¬ä½¿ç”¨</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Zipkinä»‹ç»"><span class="toc-number">3.7.4.</span> <span class="toc-text">Zipkinä»‹ç»</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Zipkinå®‰è£…"><span class="toc-number">3.7.5.</span> <span class="toc-text">Zipkinå®‰è£…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Zipkiné›†æˆ"><span class="toc-number">3.7.6.</span> <span class="toc-text">Zipkiné›†æˆ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ZipKinæ•°æ®æŒä¹…åŒ–"><span class="toc-number">3.7.7.</span> <span class="toc-text">ZipKinæ•°æ®æŒä¹…åŒ–</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆRocketMQï¼‰"><span class="toc-number">3.8.</span> <span class="toc-text">æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆRocketMQï¼‰</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#RocketMQå®‰è£…"><span class="toc-number">3.8.1.</span> <span class="toc-text">RocketMQå®‰è£…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RocketMQæ§åˆ¶å°å®‰è£…"><span class="toc-number">3.8.2.</span> <span class="toc-text">RocketMQæ§åˆ¶å°å®‰è£…</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#æ¡ˆä¾‹"><span class="toc-number">3.8.3.</span> <span class="toc-text">æ¡ˆä¾‹</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#é…ç½®ä¸­å¿ƒï¼ˆNacos-Configï¼‰"><span class="toc-number">3.9.</span> <span class="toc-text">é…ç½®ä¸­å¿ƒï¼ˆNacos Configï¼‰</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#åŸºæœ¬ä½¿ç”¨-1"><span class="toc-number">3.9.1.</span> <span class="toc-text">åŸºæœ¬ä½¿ç”¨</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#åŠ¨æ€æ›´æ–°é…ç½®"><span class="toc-number">3.9.2.</span> <span class="toc-text">åŠ¨æ€æ›´æ–°é…ç½®</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#é…ç½®å…±äº«"><span class="toc-number">3.9.3.</span> <span class="toc-text">é…ç½®å…±äº«</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#åˆ†å¸ƒå¼äº‹åŠ¡ï¼ˆSeataï¼‰"><span class="toc-number">3.10.</span> <span class="toc-text">åˆ†å¸ƒå¼äº‹åŠ¡ï¼ˆSeataï¼‰</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#å®‰è£…Seata"><span class="toc-number">3.10.1.</span> <span class="toc-text">å®‰è£…Seata</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#å¾®æœåŠ¡é…ç½®Seata"><span class="toc-number">3.10.2.</span> <span class="toc-text">å¾®æœåŠ¡é…ç½®Seata</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#æ”¹é€ ä¸‹å•é€»è¾‘"><span class="toc-number">3.10.3.</span> <span class="toc-text">æ”¹é€ ä¸‹å•é€»è¾‘</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ç»“è¯­"><span class="toc-number">4.</span> <span class="toc-text">ç»“è¯­</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#æ€»ç»“"><span class="toc-number">4.1.</span> <span class="toc-text">æ€»ç»“</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#æ„Ÿè¨€"><span class="toc-number">4.2.</span> <span class="toc-text">æ„Ÿè¨€</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar_b.png"></div><div class="author-info__name text-center">imxushuai</div><div class="author-info__description text-center">æœ¬ç«™æ˜¯imxushuaiçš„ä¸ªäººåšå®¢ã€‚å†…å®¹åŒ…å«æœ‰å­¦ä¹ èµ„æºåˆ†äº«ã€ITæŠ€æœ¯åˆ†äº«å’Œç”Ÿæ´»å‘¨è¾¹ï¼Œè®°å½•ä¸‹ç”Ÿæ´»çš„ç‚¹æ»´ï¼Œæ„¿ä¸å›å…±å‹‰ã€‚</div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">æ–‡ç« </span><span class="pull-right">87</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">æ ‡ç­¾</span><span class="pull-right">276</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">åˆ†ç±»</span><span class="pull-right">37</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Links</div><a class="author-info-links__name text-center" href="https://github.com/imxushuai">GitHub</a><a class="author-info-links__name text-center" href="https://me.csdn.net/qq1031893936">CSDN</a><a class="author-info-links__name text-center" href="https://spring.io/projects">Spring</a><a class="author-info-links__name text-center" href="http://www.cx1314.cn/forum.php">ITèµ„æº</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://imxushuai-blog.oss-cn-chengdu.aliyuncs.com/background.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">imxushuai</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> ç«™å†…æœç´¢</span></a><a class="site-page" href="/">é¦–é¡µ</a><a class="site-page" href="/categories">åˆ†ç±»</a><a class="site-page" href="/archives">æ–‡ç« æ€»è§ˆ</a><a class="site-page" href="/2000/01/01/%e5%ad%a6%e4%b9%a0%e8%b5%84%e6%ba%90/">å­¦ä¹ èµ„æº</a><a class="site-page" href="/about">å…³äº</a></span></div><div id="post-info"><div id="post-title">Spring Cloud Alibaba ä»å…¥é—¨åˆ°ç²¾é€š</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2021-11-28</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Spring-Cloud/">Spring Cloud</a><i class="fa fa-angle-right" aria-hidden="true"></i><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Spring-Cloud/Spring-Cloud-Alibaba/">Spring Cloud Alibaba</a><div class="post-meta-wordcount"><span>å­—æ•°æ€»è®¡: </span><span class="word-count">23.1k</span><span class="post-meta__separator">|</span><span>é˜…è¯»æ—¶é•¿: 90 åˆ†é’Ÿ</span></div></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><center><i>Spring Cloud Alibaba å…¨ç»„ä»¶ä»å…¥é—¨åˆ°ç²¾é€š</i></center>

<p><img src="https://imxushuai-blog.oss-cn-chengdu.aliyuncs.com/20211128020051.png" alt></p>
<a id="more"></a>
<blockquote>
<p>Spring Boot AlibabaæŠ€æœ¯æ ˆä»‹ç»ä¸å®è·µ</p>
</blockquote>
<h1 id="SpringCloud-Alibabaä»‹ç»"><a href="#SpringCloud-Alibabaä»‹ç»" class="headerlink" title="SpringCloud Alibabaä»‹ç»"></a>SpringCloud Alibabaä»‹ç»</h1><p>â€‹        <code>Spring Cloud Alibaba</code> è‡´åŠ›äºæä¾›å¾®æœåŠ¡å¼€å‘çš„ä¸€ç«™å¼è§£å†³æ–¹æ¡ˆã€‚æ­¤é¡¹ç›®åŒ…å«å¼€å‘åˆ†å¸ƒå¼åº”ç”¨å¾®æœåŠ¡çš„å¿…éœ€ç»„ä»¶ï¼Œæ–¹ä¾¿å¼€å‘è€…é€šè¿‡ <code>Spring Cloud</code> ç¼–ç¨‹æ¨¡å‹è½»æ¾ä½¿ç”¨è¿™äº›ç»„ä»¶æ¥å¼€å‘åˆ†å¸ƒå¼åº”ç”¨æœåŠ¡ã€‚<br>â€‹        ä¾æ‰˜ <code>Spring Cloud Alibaba</code>ï¼Œæ‚¨åªéœ€è¦æ·»åŠ ä¸€äº›æ³¨è§£å’Œå°‘é‡é…ç½®ï¼Œå°±å¯ä»¥å°† <code>Spring Cloud</code> åº”ç”¨æ¥å…¥é˜¿é‡Œå¾®æœåŠ¡è§£å†³æ–¹æ¡ˆï¼Œé€šè¿‡é˜¿é‡Œä¸­é—´ä»¶æ¥è¿…é€Ÿæ­å»ºåˆ†å¸ƒå¼åº”ç”¨ç³»ç»Ÿã€‚</p>
<h2 id="ä¸»è¦åŠŸèƒ½"><a href="#ä¸»è¦åŠŸèƒ½" class="headerlink" title="ä¸»è¦åŠŸèƒ½"></a>ä¸»è¦åŠŸèƒ½</h2><ul>
<li><p>æœåŠ¡é™æµé™çº§</p>
<p>é»˜è®¤æ”¯æŒ <code>WebServlet</code>ã€<code>WebFlux</code>ï¼Œ <code>OpenFeign</code>ã€<code>RestTemplate</code>ã€<code>Spring Cloud Gateway</code>ï¼Œ<code>Zuul</code>ï¼Œ<code>Dubbo</code>å’Œ<code>RocketMQ</code>é™æµé™çº§åŠŸèƒ½çš„æ¥å…¥ï¼Œå¯ä»¥åœ¨è¿è¡Œæ—¶é€šè¿‡æ§åˆ¶å°å®æ—¶ä¿®æ”¹é™æµé™çº§è§„åˆ™ï¼Œè¿˜æ”¯æŒæŸ¥çœ‹é™æµé™çº§<code>Metrics</code>ç›‘æ§ã€‚</p>
</li>
<li><p>æœåŠ¡æ³¨å†Œä¸å‘ç°</p>
<p>é€‚é… <code>Spring Cloud</code> æœåŠ¡æ³¨å†Œä¸å‘ç°æ ‡å‡†ï¼Œé»˜è®¤é›†æˆäº†<code>Ribbon</code>çš„æ”¯æŒã€‚</p>
</li>
<li><p>åˆ†å¸ƒå¼é…ç½®ç®¡ç†</p>
<p>æ”¯æŒåˆ†å¸ƒå¼ç³»ç»Ÿä¸­çš„å¤–éƒ¨åŒ–é…ç½®ï¼Œé…ç½®æ›´æ”¹æ—¶è‡ªåŠ¨åˆ·æ–°ã€‚</p>
</li>
<li><p>æ¶ˆæ¯é©±åŠ¨èƒ½åŠ›</p>
<p>åŸºäº <code>Spring Cloud Stream</code> ä¸ºå¾®æœåŠ¡åº”ç”¨æ„å»ºæ¶ˆæ¯é©±åŠ¨èƒ½åŠ›ã€‚</p>
</li>
<li><p>åˆ†å¸ƒå¼äº‹åŠ¡</p>
<p>ä½¿ç”¨ <code>@GlobalTransactional</code> æ³¨è§£ï¼Œ é«˜æ•ˆå¹¶ä¸”å¯¹ä¸šåŠ¡é›¶ä¾µå…¥åœ°è§£å†³åˆ†å¸ƒå¼äº‹åŠ¡é—®é¢˜ã€‚</p>
</li>
<li><p>é˜¿é‡Œäº‘å¯¹è±¡å­˜å‚¨</p>
<p>é˜¿é‡Œäº‘æä¾›çš„æµ·é‡ã€å®‰å…¨ã€ä½æˆæœ¬ã€é«˜å¯é çš„äº‘å­˜å‚¨æœåŠ¡ã€‚æ”¯æŒåœ¨ä»»ä½•åº”ç”¨ã€ä»»<br>ä½•æ—¶é—´ã€ä»»ä½•åœ°ç‚¹å­˜å‚¨å’Œè®¿é—®ä»»æ„ç±»å‹çš„æ•°æ®ã€‚</p>
</li>
<li><p>åˆ†å¸ƒå¼ä»»åŠ¡è°ƒåº¦</p>
<p>æä¾›ç§’çº§ã€ç²¾å‡†ã€é«˜å¯é ã€é«˜å¯ç”¨çš„å®šæ—¶ï¼ˆåŸºäº <code>Cron</code> è¡¨è¾¾å¼ï¼‰ä»»åŠ¡è°ƒåº¦æœåŠ¡ã€‚<br>åŒæ—¶æä¾›åˆ†å¸ƒå¼çš„ä»»åŠ¡æ‰§è¡Œæ¨¡å‹ï¼Œå¦‚ç½‘æ ¼ä»»åŠ¡ã€‚ç½‘æ ¼ä»»åŠ¡æ”¯æŒæµ·é‡å­ä»»åŠ¡å‡åŒ€åˆ†é…åˆ°æ‰€æœ‰<br><code>Workerï¼ˆschedulerx-clientï¼‰</code>ä¸Šæ‰§è¡Œã€‚</p>
</li>
<li><p>é˜¿é‡Œäº‘çŸ­ä¿¡æœåŠ¡</p>
<p>è¦†ç›–å…¨çƒçš„çŸ­ä¿¡æœåŠ¡ï¼Œå‹å¥½ã€é«˜æ•ˆã€æ™ºèƒ½çš„äº’è”åŒ–é€šè®¯èƒ½åŠ›ï¼Œå¸®åŠ©ä¼ä¸šè¿…é€Ÿæ­å»ºå®¢æˆ·è§¦è¾¾é€šé“ã€‚</p>
</li>
</ul>
<h2 id="ç»„ä»¶"><a href="#ç»„ä»¶" class="headerlink" title="ç»„ä»¶"></a>ç»„ä»¶</h2><ul>
<li><p>Sentinel</p>
<p>æŠŠæµé‡ä½œä¸ºåˆ‡å…¥ç‚¹ï¼Œä»æµé‡æ§åˆ¶ã€ç†”æ–­é™çº§ã€ç³»ç»Ÿè´Ÿè½½ä¿æŠ¤ç­‰å¤šä¸ªç»´åº¦ä¿æŠ¤æœåŠ¡çš„ç¨³å®šæ€§ã€‚</p>
</li>
<li><p>Nacos</p>
<p>ä¸€ä¸ªæ›´æ˜“äºæ„å»ºäº‘åŸç”Ÿåº”ç”¨çš„åŠ¨æ€æœåŠ¡å‘ç°ã€é…ç½®ç®¡ç†å’ŒæœåŠ¡ç®¡ç†å¹³å°ã€‚</p>
</li>
<li><p>RocketMQ</p>
<p>ä¸€æ¬¾å¼€æºçš„åˆ†å¸ƒå¼æ¶ˆæ¯ç³»ç»Ÿï¼ŒåŸºäºé«˜å¯ç”¨åˆ†å¸ƒå¼é›†ç¾¤æŠ€æœ¯ï¼Œæä¾›ä½å»¶æ—¶çš„ã€é«˜å¯é çš„æ¶ˆæ¯å‘å¸ƒä¸è®¢é˜…æœåŠ¡ã€‚</p>
</li>
<li><p>Dubbo</p>
<p><code>Apache Dubbo</code> æ˜¯ä¸€æ¬¾é«˜æ€§èƒ½ <code>Java RPC</code> æ¡†æ¶ã€‚</p>
</li>
<li><p>Seata</p>
<p>é˜¿é‡Œå·´å·´å¼€æºäº§å“ï¼Œä¸€ä¸ªæ˜“äºä½¿ç”¨çš„é«˜æ€§èƒ½å¾®æœåŠ¡åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆã€‚</p>
</li>
<li><p>Sentinel</p>
<p>é˜¿é‡Œå¼€æºçš„ä¸€å¥—ç”¨äºæœåŠ¡å®¹é”™çš„ç»¼åˆæ€§è§£å†³æ–¹æ¡ˆã€‚å®ƒä»¥æµé‡ä¸ºåˆ‡å…¥ç‚¹, ä»æµé‡æ§åˆ¶ã€ç†”æ–­é™çº§ã€ç³»ç»Ÿè´Ÿè½½ä¿æŠ¤ç­‰å¤šä¸ªç»´åº¦æ¥ä¿æŠ¤æœåŠ¡çš„ç¨³å®šæ€§ã€‚</p>
</li>
<li><p>Spring Cloud Gateway</p>
<p>Spring Cloud Gatewayæ˜¯Springå…¬å¸åŸºäºSpring 5.0ï¼ŒSpring Boot 2.0 å’Œ Project Reactor ç­‰æŠ€æœ¯å¼€å‘çš„ç½‘å…³ï¼Œå®ƒæ—¨åœ¨ä¸ºå¾®æœåŠ¡æ¶æ„æä¾›ä¸€ç§ç®€å•æœ‰æ•ˆçš„ç»Ÿä¸€çš„ API è·¯ç”±ç®¡ç†æ–¹å¼ã€‚</p>
</li>
<li><p>Spring Cloud Sleuth</p>
<p>â€‹      ä¸»è¦åŠŸèƒ½å°±æ˜¯åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­æä¾›è¿½è¸ªè§£å†³æ–¹æ¡ˆã€‚</p>
</li>
<li><p>RocketMQ</p>
<p>Rocketmqæ˜¯ä¸€æ¬¾åˆ†å¸ƒå¼ï¼Œé˜Ÿåˆ—æ¨¡å‹çš„æ¶ˆæ¯ä¸­é—´ä»¶ï¼Œç”±é˜¿é‡Œå·´å·´ç ”å‘ï¼Œå€Ÿé‰´å‚è€ƒäº†JMSè§„èŒƒçš„MQå®ç°ï¼Œæ›´å‚è€ƒäº†ä¼˜ç§€çš„å¼€æºæ¶ˆæ¯ä¸­é—´ä»¶KAFKAï¼Œå¹¶ä¸”ç»“åˆé˜¿é‡Œå®é™…ä¸šåŠ¡éœ€æ±‚åœ¨å¤©çŒ«åŒåä¸€çš„åœºæ™¯ï¼Œå®ç°ä¸šåŠ¡å‰Šå³°</p>
</li>
</ul>
<h1 id="Spring-Cloud-Alibabaå…¨ç»„ä»¶æ¡ˆä¾‹"><a href="#Spring-Cloud-Alibabaå…¨ç»„ä»¶æ¡ˆä¾‹" class="headerlink" title="Spring Cloud Alibabaå…¨ç»„ä»¶æ¡ˆä¾‹"></a>Spring Cloud Alibabaå…¨ç»„ä»¶æ¡ˆä¾‹</h1><blockquote>
<p>Tipsï¼šä¸‹é¢çš„å®è·µï¼Œæ˜¯æˆ‘åœ¨é»‘é©¬å®˜ç½‘æ‰¾çš„è§†é¢‘ä¸­çš„å®è·µï¼Œä½¿ç”¨çš„æ˜¯ç”¨æˆ·-å•†å“-è®¢å•æœåŠ¡çš„æ¡ˆä¾‹ã€‚ä¸ªäººè§‰å¾—è¿™ç§ç»“åˆæ¡ˆä¾‹è®²è§£æ˜¯å¾ˆå¥½çš„æ–¹æ³•ã€‚</p>
</blockquote>
<h2 id="ä»£ç è·å–"><a href="#ä»£ç è·å–" class="headerlink" title="ä»£ç è·å–"></a>ä»£ç è·å–</h2><p>Githubåœ°å€ï¼šğŸ‘‰<a href="https://github.com/imxushuai/springcloud-alibaba" target="_blank" rel="noopener">https://github.com/imxushuai/springcloud-alibaba</a>ğŸ‘ˆ</p>
<h2 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h2><h3 id="æŠ€æœ¯é€‰å‹"><a href="#æŠ€æœ¯é€‰å‹" class="headerlink" title="æŠ€æœ¯é€‰å‹"></a>æŠ€æœ¯é€‰å‹</h3><p>JDKï¼š1.8</p>
<p>Mavenï¼š3.3.9åŠä»¥ä¸Š</p>
<p>æ•°æ®åº“ï¼šMySQL 5.7</p>
<p>Spring Cloud Alibabaï¼š2.1.0.RELEASEï¼ˆå¯¹æ ‡Spring Cloudçš„Gç‰ˆï¼‰</p>
<blockquote>
<p>å°½é‡ä¿å­˜ç‰ˆæœ¬ä¸€è‡´ï¼Œå¯ä»¥é¿å…ä¸€äº›é—®é¢˜ã€‚</p>
</blockquote>
<h3 id="æ¡ˆä¾‹æ¨¡å—"><a href="#æ¡ˆä¾‹æ¨¡å—" class="headerlink" title="æ¡ˆä¾‹æ¨¡å—"></a>æ¡ˆä¾‹æ¨¡å—</h3><table>
<thead>
<tr>
<th>æ¨¡å—å</th>
<th>æè¿°</th>
<th>ç«¯å£å·</th>
</tr>
</thead>
<tbody>
<tr>
<td>springcloud-alibaba</td>
<td>çˆ¶å·¥ç¨‹</td>
<td></td>
</tr>
<tr>
<td>springcloud-alibaba-common</td>
<td>å…¬å…±æ¨¡å—ï¼Œå­˜æ”¾å®ä½“ç±»å’Œå·¥å…·ç±»ç­‰</td>
<td></td>
</tr>
<tr>
<td>springcloud-alibaba-user</td>
<td>ç”¨æˆ·å¾®æœåŠ¡</td>
<td>807x</td>
</tr>
<tr>
<td>springcloud-alibaba-product</td>
<td>å•†å“å¾®æœåŠ¡</td>
<td>808x</td>
</tr>
<tr>
<td>springcloud-alibaba-order</td>
<td>è®¢å•å¾®æœåŠ¡</td>
<td>809x</td>
</tr>
</tbody>
</table>
<h2 id="åˆ›å»ºçˆ¶å·¥ç¨‹"><a href="#åˆ›å»ºçˆ¶å·¥ç¨‹" class="headerlink" title="åˆ›å»ºçˆ¶å·¥ç¨‹"></a>åˆ›å»ºçˆ¶å·¥ç¨‹</h2><blockquote>
<p>é¦–å…ˆï¼Œåˆ›å»ºä¸€ä¸ªmavené¡¹ç›®</p>
</blockquote>
<h3 id="pom-xml"><a href="#pom-xml" class="headerlink" title="pom.xml"></a>pom.xml</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springcloud-alibaba<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modules</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>springcloud-alibaba-common<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>springcloud-alibaba-user<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>springcloud-alibaba-product<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">module</span>&gt;</span>springcloud-alibaba-order<span class="tag">&lt;/<span class="name">module</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">modules</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.3.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.reporting.outputEncoding</span>&gt;</span>UTF8<span class="tag">&lt;/<span class="name">project.reporting.outputEncoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">spring-cloud.version</span>&gt;</span>Greenwich.RELEASE<span class="tag">&lt;/<span class="name">spring-cloud.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">spring-cloud-alibaba.version</span>&gt;</span>2.1.0.RELEASE<span class="tag">&lt;/<span class="name">spring-cloud-alibaba.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-cloud.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-alibaba-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-cloud-alibaba.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="åˆ›å»ºå…¬å…±æ¨¡å—"><a href="#åˆ›å»ºå…¬å…±æ¨¡å—" class="headerlink" title="åˆ›å»ºå…¬å…±æ¨¡å—"></a>åˆ›å»ºå…¬å…±æ¨¡å—</h2><blockquote>
<p>åˆ›å»ºä¸€ä¸ªmavené¡¹ç›®</p>
</blockquote>
<h3 id="pom-xml-1"><a href="#pom-xml-1" class="headerlink" title="pom.xml"></a>pom.xml</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springcloud-alibaba<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springcloud-alibaba-common<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-jpa<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.56<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="ç¼–å†™å®ä½“ç±»"><a href="#ç¼–å†™å®ä½“ç±»" class="headerlink" title="ç¼–å†™å®ä½“ç±»"></a>ç¼–å†™å®ä½“ç±»</h3><ol>
<li><p>Userï¼ˆç”¨æˆ·å®ä½“ç±»ï¼‰</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.springcloud.alibaba.common.entity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.persistence.Entity;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.GeneratedValue;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.GenerationType;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.Id;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Entity</span>(name = <span class="string">"shop_user"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue</span>(strategy = GenerationType.IDENTITY)</span><br><span class="line">    <span class="keyword">private</span> Integer uid;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String telephone;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Productï¼ˆå•†å“å®ä½“ç±»ï¼‰</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.springcloud.alibaba.common.entity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.persistence.Entity;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.GeneratedValue;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.GenerationType;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.Id;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Entity</span>(name = <span class="string">"shop_product"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Product</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue</span>(strategy = GenerationType.IDENTITY)</span><br><span class="line">    <span class="keyword">private</span> Integer pid;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å•†å“åç§°</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String pname;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å•†å“ä»·æ ¼</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Double pprice;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å•†å“åº“å­˜</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer stock;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Orderï¼ˆè®¢å•å®ä½“ç±»ï¼‰</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.springcloud.alibaba.common.entity;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.persistence.Entity;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.GeneratedValue;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.GenerationType;</span><br><span class="line"><span class="keyword">import</span> javax.persistence.Id;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Entity</span>(name = <span class="string">"shop_order"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Order</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue</span>(strategy = GenerationType.IDENTITY)</span><br><span class="line">    <span class="keyword">private</span> Long oid;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç”¨æˆ·id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer uid;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç”¨æˆ·å</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å•†å“id</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer pid;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å•†å“åç§°</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String pname;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å•†å“å•ä»·</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Double pprice;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è´­ä¹°æ•°é‡</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer number;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="åˆ›å»ºç”¨æˆ·å¾®æœåŠ¡"><a href="#åˆ›å»ºç”¨æˆ·å¾®æœåŠ¡" class="headerlink" title="åˆ›å»ºç”¨æˆ·å¾®æœåŠ¡"></a>åˆ›å»ºç”¨æˆ·å¾®æœåŠ¡</h2><blockquote>
<p>åˆ›å»ºä¸€ä¸ªmavené¡¹ç›®</p>
</blockquote>
<h3 id="pom-xml-2"><a href="#pom-xml-2" class="headerlink" title="pom.xml"></a>pom.xml</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springcloud-alibaba<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springcloud-alibaba-user<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springcloud-alibaba-common<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="ç¼–å†™Spring-Bootå¯åŠ¨ç±»"><a href="#ç¼–å†™Spring-Bootå¯åŠ¨ç±»" class="headerlink" title="ç¼–å†™Spring Bootå¯åŠ¨ç±»"></a>ç¼–å†™Spring Bootå¯åŠ¨ç±»</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.springcloud.alibaba.user;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.domain.EntityScan;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EntityScan</span>(<span class="string">"com.springcloud.alibaba.common.entity"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(UserApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ç¼–å†™application-ymlé…ç½®æ–‡ä»¶"><a href="#ç¼–å†™application-ymlé…ç½®æ–‡ä»¶" class="headerlink" title="ç¼–å†™application.ymlé…ç½®æ–‡ä»¶"></a>ç¼–å†™application.ymlé…ç½®æ–‡ä»¶</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">8071</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">service-user</span></span><br><span class="line"><span class="attr">  datasource:</span></span><br><span class="line"><span class="attr">    driver-class-name:</span> <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line"><span class="attr">    url:</span> <span class="attr">jdbc:mysql:///shop?serverTimezone=UTC&amp;useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=true</span></span><br><span class="line"><span class="attr">    username:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    password:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  jpa:</span></span><br><span class="line"><span class="attr">    properties:</span></span><br><span class="line"><span class="attr">      hibernate:</span></span><br><span class="line"><span class="attr">        hbm2ddl:</span></span><br><span class="line"><span class="attr">          auto:</span> <span class="string">update</span></span><br><span class="line"><span class="attr">        dialect:</span> <span class="string">org.hibernate.dialect.MySQL5InnoDBDialect</span></span><br></pre></td></tr></table></figure>
<h2 id="åˆ›å»ºå•†å“å¾®æœåŠ¡"><a href="#åˆ›å»ºå•†å“å¾®æœåŠ¡" class="headerlink" title="åˆ›å»ºå•†å“å¾®æœåŠ¡"></a>åˆ›å»ºå•†å“å¾®æœåŠ¡</h2><blockquote>
<p>åˆ›å»ºä¸€ä¸ªmavené¡¹ç›®</p>
</blockquote>
<h3 id="pom-xml-3"><a href="#pom-xml-3" class="headerlink" title="pom.xml"></a>pom.xml</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springcloud-alibaba<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springcloud-alibaba-product<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springcloud-alibaba-common<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="ç¼–å†™Spring-Bootå¯åŠ¨ç±»-1"><a href="#ç¼–å†™Spring-Bootå¯åŠ¨ç±»-1" class="headerlink" title="ç¼–å†™Spring Bootå¯åŠ¨ç±»"></a>ç¼–å†™Spring Bootå¯åŠ¨ç±»</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.springcloud.alibaba.product;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.domain.EntityScan;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EntityScan</span>(<span class="string">"com.springcloud.alibaba.common.entity"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProductApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(ProductApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ç¼–å†™application-ymlé…ç½®æ–‡ä»¶-1"><a href="#ç¼–å†™application-ymlé…ç½®æ–‡ä»¶-1" class="headerlink" title="ç¼–å†™application.ymlé…ç½®æ–‡ä»¶"></a>ç¼–å†™application.ymlé…ç½®æ–‡ä»¶</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">8081</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">service-product</span></span><br><span class="line"><span class="attr">  datasource:</span></span><br><span class="line"><span class="attr">    driver-class-name:</span> <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line"><span class="attr">    url:</span> <span class="attr">jdbc:mysql:///shop?serverTimezone=UTC&amp;useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=true</span></span><br><span class="line"><span class="attr">    username:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    password:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  jpa:</span></span><br><span class="line"><span class="attr">    properties:</span></span><br><span class="line"><span class="attr">      hibernate:</span></span><br><span class="line"><span class="attr">        hbm2ddl:</span></span><br><span class="line"><span class="attr">          auto:</span> <span class="string">update</span></span><br><span class="line"><span class="attr">        dialect:</span> <span class="string">org.hibernate.dialect.MySQL5InnoDBDialect</span></span><br></pre></td></tr></table></figure>
<h3 id="åŸºç¡€ä»£ç ç¼–å†™"><a href="#åŸºç¡€ä»£ç ç¼–å†™" class="headerlink" title="åŸºç¡€ä»£ç ç¼–å†™"></a>åŸºç¡€ä»£ç ç¼–å†™</h3><ol>
<li><p>dao</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.springcloud.alibaba.product.repository;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.springcloud.alibaba.common.entity.Product;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.jpa.repository.JpaRepository;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ProductRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">Product</span>, <span class="title">Integer</span>&gt; </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>service</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.springcloud.alibaba.product.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.springcloud.alibaba.common.entity.Product;</span><br><span class="line"><span class="keyword">import</span> com.springcloud.alibaba.product.repository.ProductRepository;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProductService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ProductRepository productRepository;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Product <span class="title">findByPid</span><span class="params">(Integer pid)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> productRepository.findById(pid).orElse(<span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>controller</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.springcloud.alibaba.product.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.springcloud.alibaba.common.entity.Product;</span><br><span class="line"><span class="keyword">import</span> com.springcloud.alibaba.product.service.ProductService;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProductController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ProductService productService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"product/&#123;pid&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Product <span class="title">product</span><span class="params">(@PathVariable Integer pid)</span> </span>&#123;</span><br><span class="line">        Product product = productService.findByPid(pid);</span><br><span class="line">        log.info(<span class="string">"&gt;&gt; æŸ¥è¯¢åˆ°å•†å“: &#123;&#125;"</span>, JSON.toJSONString(product));</span><br><span class="line">        <span class="keyword">return</span> product;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="æ•°æ®æ’å…¥"><a href="#æ•°æ®æ’å…¥" class="headerlink" title="æ•°æ®æ’å…¥"></a>æ•°æ®æ’å…¥</h3><blockquote>
<p>æ•°æ®åº“éœ€è¦æå‰å»ºå¥½ï¼Œå¯åŠ¨é¡¹ç›®åï¼Œ<code>JPA</code>ä¼šè‡ªåŠ¨å»ºè¡¨</p>
</blockquote>
<p>è¿è¡Œä¸‹æ–¹<code>SQL</code>è¯­å¥</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> shop_product <span class="keyword">VALUE</span>(<span class="literal">NULL</span>,<span class="string">'å°ç±³'</span>,<span class="string">'1000'</span>,<span class="string">'5000'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> shop_product <span class="keyword">VALUE</span>(<span class="literal">NULL</span>,<span class="string">'åä¸º'</span>,<span class="string">'2000'</span>,<span class="string">'5000'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> shop_product <span class="keyword">VALUE</span>(<span class="literal">NULL</span>,<span class="string">'è‹¹æœ'</span>,<span class="string">'3000'</span>,<span class="string">'5000'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> shop_product <span class="keyword">VALUE</span>(<span class="literal">NULL</span>,<span class="string">'OPPO'</span>,<span class="string">'4000'</span>,<span class="string">'5000'</span>);</span><br></pre></td></tr></table></figure>
<h3 id="æµ‹è¯•API"><a href="#æµ‹è¯•API" class="headerlink" title="æµ‹è¯•API"></a>æµ‹è¯•API</h3><p>ä½¿ç”¨æµè§ˆå™¨æˆ–è€…<code>PostMan</code>è°ƒç”¨ï¼š<code>http://localhost:8081/product/1</code></p>
<p><img src="https://imxushuai-blog.oss-cn-chengdu.aliyuncs.com/20201027173305.png" alt></p>
<h2 id="åˆ›å»ºè®¢å•å¾®æœåŠ¡"><a href="#åˆ›å»ºè®¢å•å¾®æœåŠ¡" class="headerlink" title="åˆ›å»ºè®¢å•å¾®æœåŠ¡"></a>åˆ›å»ºè®¢å•å¾®æœåŠ¡</h2><blockquote>
<p>åˆ›å»ºä¸€ä¸ªmavené¡¹ç›®</p>
</blockquote>
<h3 id="pom-xml-4"><a href="#pom-xml-4" class="headerlink" title="pom.xml"></a>pom.xml</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springcloud-alibaba<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springcloud-alibaba-order<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springcloud-alibaba-common<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="ç¼–å†™Spring-Bootå¯åŠ¨ç±»-2"><a href="#ç¼–å†™Spring-Bootå¯åŠ¨ç±»-2" class="headerlink" title="ç¼–å†™Spring Bootå¯åŠ¨ç±»"></a>ç¼–å†™Spring Bootå¯åŠ¨ç±»</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.springcloud.alibaba.order;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.domain.EntityScan;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EntityScan</span>(<span class="string">"com.springcloud.alibaba.common.entity"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(OrderApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestTemplate <span class="title">getRestTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="ç¼–å†™application-ymlé…ç½®æ–‡ä»¶-2"><a href="#ç¼–å†™application-ymlé…ç½®æ–‡ä»¶-2" class="headerlink" title="ç¼–å†™application.ymlé…ç½®æ–‡ä»¶"></a>ç¼–å†™application.ymlé…ç½®æ–‡ä»¶</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">8091</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">service-order</span></span><br><span class="line"><span class="attr">  datasource:</span></span><br><span class="line"><span class="attr">    driver-class-name:</span> <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line"><span class="attr">    url:</span> <span class="attr">jdbc:mysql:///shop?serverTimezone=UTC&amp;useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=true</span></span><br><span class="line"><span class="attr">    username:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">    password:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  jpa:</span></span><br><span class="line"><span class="attr">    properties:</span></span><br><span class="line"><span class="attr">      hibernate:</span></span><br><span class="line"><span class="attr">        hbm2ddl:</span></span><br><span class="line"><span class="attr">          auto:</span> <span class="string">update</span></span><br><span class="line"><span class="attr">        dialect:</span> <span class="string">org.hibernate.dialect.MySQL5InnoDBDialect</span></span><br></pre></td></tr></table></figure>
<h3 id="åŸºç¡€ä»£ç ç¼–å†™-1"><a href="#åŸºç¡€ä»£ç ç¼–å†™-1" class="headerlink" title="åŸºç¡€ä»£ç ç¼–å†™"></a>åŸºç¡€ä»£ç ç¼–å†™</h3><ol>
<li><p>dao</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.springcloud.alibaba.order.repository;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.springcloud.alibaba.common.entity.Order;</span><br><span class="line"><span class="keyword">import</span> org.springframework.data.jpa.repository.JpaRepository;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OrderRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">Order</span>, <span class="title">Integer</span>&gt; </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>service</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.springcloud.alibaba.order.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.springcloud.alibaba.common.entity.Order;</span><br><span class="line"><span class="keyword">import</span> com.springcloud.alibaba.order.repository.OrderRepository;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OrderRepository orderRepository;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Order&gt; <span class="title">findAll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> orderRepository.findAll();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">save</span><span class="params">(Order order)</span> </span>&#123;</span><br><span class="line">        orderRepository.save(order);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>controller</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.springcloud.alibaba.order.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.springcloud.alibaba.common.entity.Order;</span><br><span class="line"><span class="keyword">import</span> com.springcloud.alibaba.common.entity.Product;</span><br><span class="line"><span class="keyword">import</span> com.springcloud.alibaba.order.service.OrderService;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> OrderService orderService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"order"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Order&gt; <span class="title">orderList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> orderService.findAll();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å‡†å¤‡ä¹°1ä»¶å•†å“</span></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/order/prod/&#123;pid&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Order <span class="title">order</span><span class="params">(@PathVariable(<span class="string">"pid"</span>)</span> Integer pid) </span>&#123;</span><br><span class="line">        log.info(<span class="string">"&gt;&gt; å®¢æˆ·ä¸‹å•ï¼Œè¿™æ—¶å€™è¦è°ƒç”¨å•†å“å¾®æœåŠ¡æŸ¥è¯¢å•†å“ä¿¡æ¯"</span>);</span><br><span class="line">        <span class="comment">//é€šè¿‡restTemplateè°ƒç”¨å•†å“å¾®æœåŠ¡</span></span><br><span class="line">        Product product = restTemplate.getForObject(<span class="string">"http://localhost:8081/product/"</span> + pid, Product.class);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (product != <span class="keyword">null</span>) &#123;</span><br><span class="line">            log.info(<span class="string">"&gt;&gt; å•†å“ä¿¡æ¯,æŸ¥è¯¢ç»“æœ: &#123;&#125;"</span>, JSON.toJSONString(product));</span><br><span class="line">            Order order = <span class="keyword">new</span> Order();</span><br><span class="line">            order.setUid(<span class="number">1</span>);</span><br><span class="line">            order.setUsername(<span class="string">"æµ‹è¯•ç”¨æˆ·"</span>);</span><br><span class="line">            order.setPid(product.getPid());</span><br><span class="line">            order.setPname(product.getPname());</span><br><span class="line">            order.setPprice(product.getPprice());</span><br><span class="line">            order.setNumber(<span class="number">1</span>);</span><br><span class="line">            orderService.save(order);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> order;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"è´­ä¹°å¤±è´¥!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="æµ‹è¯•API-1"><a href="#æµ‹è¯•API-1" class="headerlink" title="æµ‹è¯•API"></a>æµ‹è¯•API</h3><p>ä½¿ç”¨æµè§ˆå™¨æˆ–è€…<code>PostMan</code>è°ƒç”¨ï¼š<code>http://localhost:8091/order/prod/1</code></p>
<p><img src="https://imxushuai-blog.oss-cn-chengdu.aliyuncs.com/20201027181649.png" alt></p>
<h1 id="Spring-Cloud-Alibabaå®è·µ"><a href="#Spring-Cloud-Alibabaå®è·µ" class="headerlink" title="Spring Cloud Alibabaå®è·µ"></a>Spring Cloud Alibabaå®è·µ</h1><h2 id="æœåŠ¡æ²»ç†ï¼ˆNacos-Discoveryï¼‰"><a href="#æœåŠ¡æ²»ç†ï¼ˆNacos-Discoveryï¼‰" class="headerlink" title="æœåŠ¡æ²»ç†ï¼ˆNacos Discoveryï¼‰"></a>æœåŠ¡æ²»ç†ï¼ˆNacos Discoveryï¼‰</h2><h3 id="ä»€ä¹ˆæ˜¯æœåŠ¡æ²»ç†"><a href="#ä»€ä¹ˆæ˜¯æœåŠ¡æ²»ç†" class="headerlink" title="ä»€ä¹ˆæ˜¯æœåŠ¡æ²»ç†"></a>ä»€ä¹ˆæ˜¯æœåŠ¡æ²»ç†</h3><p>æœåŠ¡æ²»ç†æ˜¯å¾®æœåŠ¡æ¶æ„ä¸­æœ€æ ¸å¿ƒæœ€åŸºæœ¬çš„æ¨¡å—ã€‚ç”¨äºå®ç°å„ä¸ªå¾®æœåŠ¡çš„è‡ªåŠ¨åŒ–æ³¨å†Œä¸å‘ç°ã€‚</p>
<ul>
<li><strong>æœåŠ¡æ³¨å†Œï¼š</strong>åœ¨æœåŠ¡æ²»ç†æ¡†æ¶ä¸­ï¼Œéƒ½ä¼šæ„å»ºä¸€ä¸ªæ³¨å†Œä¸­å¿ƒï¼Œæ¯ä¸ªæœåŠ¡å•å…ƒå‘æ³¨å†Œä¸­å¿ƒç™»è®°è‡ªå·±æä¾›æœ<br>åŠ¡çš„è¯¦ç»†ä¿¡æ¯ã€‚å¹¶åœ¨æ³¨å†Œä¸­å¿ƒå½¢æˆä¸€å¼ æœåŠ¡çš„æ¸…å•ï¼ŒæœåŠ¡æ³¨å†Œä¸­å¿ƒéœ€è¦ä»¥å¿ƒè·³çš„æ–¹å¼å»ç›‘æµ‹æ¸…å•ä¸­<br>çš„æœåŠ¡æ˜¯å¦å¯ç”¨ï¼Œå¦‚æœä¸å¯ç”¨ï¼Œéœ€è¦åœ¨æœåŠ¡æ¸…å•ä¸­å‰”é™¤ä¸å¯ç”¨çš„æœåŠ¡ã€‚</li>
<li><strong>æœåŠ¡å‘ç°ï¼š</strong>æœåŠ¡è°ƒç”¨æ–¹å‘æœåŠ¡æ³¨å†Œä¸­å¿ƒå’¨è¯¢æœåŠ¡ï¼Œå¹¶è·å–æ‰€æœ‰æœåŠ¡çš„å®ä¾‹æ¸…å•ï¼Œå®ç°å¯¹å…·ä½“æœåŠ¡å®<br>ä¾‹çš„è®¿é—®ã€‚</li>
</ul>
<p><img src="https://imxushuai-blog.oss-cn-chengdu.aliyuncs.com/20201028223445.png" alt></p>
<p>é€šè¿‡ä¸Šé¢çš„è°ƒç”¨å›¾ä¼šå‘ç°ï¼Œé™¤äº†å¾®æœåŠ¡ï¼Œè¿˜æœ‰ä¸€ä¸ªç»„ä»¶æ˜¯æœåŠ¡æ³¨å†Œä¸­å¿ƒï¼Œå®ƒæ˜¯å¾®æœåŠ¡æ¶æ„éå¸¸é‡è¦çš„ä¸€ä¸ªç»„ä»¶ï¼Œåœ¨å¾®æœåŠ¡æ¶æ„é‡Œä¸»è¦èµ·åˆ°äº†åè°ƒè€…çš„ä¸€ä¸ªä½œç”¨ã€‚æ³¨å†Œä¸­å¿ƒä¸€èˆ¬åŒ…å«å¦‚ä¸‹å‡ ä¸ªåŠŸèƒ½ï¼š</p>
<ol>
<li><p>æœåŠ¡å‘ç°ï¼š</p>
<p>æœåŠ¡æ³¨å†Œï¼šä¿å­˜æœåŠ¡æä¾›è€…å’ŒæœåŠ¡è°ƒç”¨è€…çš„ä¿¡æ¯<br>æœåŠ¡è®¢é˜…ï¼šæœåŠ¡è°ƒç”¨è€…è®¢é˜…æœåŠ¡æä¾›è€…çš„ä¿¡æ¯ï¼Œæ³¨å†Œä¸­å¿ƒå‘è®¢é˜…è€…æ¨é€æä¾›è€…çš„ä¿¡æ¯</p>
</li>
<li><p>æœåŠ¡é…ç½®ï¼š</p>
<p>é…ç½®è®¢é˜…ï¼šæœåŠ¡æä¾›è€…å’ŒæœåŠ¡è°ƒç”¨è€…è®¢é˜…å¾®æœåŠ¡ç›¸å…³çš„é…ç½®<br>é…ç½®ä¸‹å‘ï¼šä¸»åŠ¨å°†é…ç½®æ¨é€ç»™æœåŠ¡æä¾›è€…å’ŒæœåŠ¡è°ƒç”¨è€…</p>
</li>
<li><p>æœåŠ¡å¥åº·æ£€æµ‹</p>
<p>æ£€æµ‹æœåŠ¡æä¾›è€…çš„å¥åº·æƒ…å†µï¼Œå¦‚æœå‘ç°å¼‚å¸¸ï¼Œæ‰§è¡ŒæœåŠ¡å‰”é™¤</p>
</li>
</ol>
<h3 id="å¸¸è§çš„æ³¨å†Œä¸­å¿ƒ"><a href="#å¸¸è§çš„æ³¨å†Œä¸­å¿ƒ" class="headerlink" title="å¸¸è§çš„æ³¨å†Œä¸­å¿ƒ"></a>å¸¸è§çš„æ³¨å†Œä¸­å¿ƒ</h3><ul>
<li><p><strong>Zookeeper</strong></p>
<p><code>zookeeper</code>æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼æœåŠ¡æ¡†æ¶ï¼Œæ˜¯<code>Apache Hadoop</code>çš„ä¸€ä¸ªå­é¡¹ç›®ï¼Œå®ƒä¸»è¦æ˜¯ç”¨æ¥è§£å†³åˆ†å¸ƒå¼åº”ç”¨ä¸­ç»å¸¸é‡åˆ°çš„ä¸€äº›æ•°æ®ç®¡ç†é—®é¢˜ï¼Œå¦‚ï¼šç»Ÿä¸€å‘½åæœåŠ¡ã€çŠ¶æ€åŒæ­¥æœåŠ¡ã€é›†ç¾¤ç®¡ç†ã€åˆ†å¸ƒå¼åº”ç”¨é…ç½®é¡¹çš„ç®¡ç†ç­‰ã€‚</p>
</li>
<li><p><strong>Eureka</strong></p>
<p><code>Eureka</code>æ˜¯<code>Springcloud Netflix</code>ä¸­çš„é‡è¦ç»„ä»¶ï¼Œä¸»è¦ä½œç”¨å°±æ˜¯åšæœåŠ¡æ³¨å†Œå’Œå‘ç°ã€‚ä½†æ˜¯ç°åœ¨å·²ç»é—­<br>æº</p>
</li>
<li><p><strong>Consul</strong></p>
<p><code>Consul</code>æ˜¯åŸºäº<code>GO</code>è¯­è¨€å¼€å‘çš„å¼€æºå·¥å…·ï¼Œä¸»è¦é¢å‘åˆ†å¸ƒå¼ï¼ŒæœåŠ¡åŒ–çš„ç³»ç»Ÿæä¾›æœåŠ¡æ³¨å†Œã€æœåŠ¡å‘ç°å’Œé…ç½®ç®¡ç†çš„åŠŸèƒ½ã€‚<code>Consul</code>çš„åŠŸèƒ½éƒ½å¾ˆå®ç”¨ï¼Œå…¶ä¸­åŒ…æ‹¬ï¼šæœåŠ¡æ³¨å†Œ/å‘ç°ã€å¥åº·æ£€æŸ¥ã€Key/Valueå­˜å‚¨ã€å¤šæ•°æ®ä¸­å¿ƒå’Œåˆ†å¸ƒå¼ä¸€è‡´æ€§ä¿è¯ç­‰ç‰¹æ€§ã€‚<code>Consul</code>æœ¬èº«åªæ˜¯ä¸€ä¸ªäºŒè¿›åˆ¶çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œæ‰€ä»¥å®‰è£…å’Œéƒ¨ç½²éƒ½éå¸¸ç®€å•ï¼Œåªéœ€è¦ä»å®˜ç½‘ä¸‹è½½åï¼Œåœ¨æ‰§è¡Œå¯¹åº”çš„å¯åŠ¨è„šæœ¬å³å¯ã€‚</p>
</li>
<li><p><strong>Nacos</strong></p>
<p><code>Nacos</code>æ˜¯ä¸€ä¸ªæ›´æ˜“äºæ„å»ºäº‘åŸç”Ÿåº”ç”¨çš„åŠ¨æ€æœåŠ¡å‘ç°ã€é…ç½®ç®¡ç†å’ŒæœåŠ¡ç®¡ç†å¹³å°ã€‚å®ƒæ˜¯<code>SpringCloud Alibaba</code>ç»„ä»¶ä¹‹ä¸€ï¼Œè´Ÿè´£æœåŠ¡æ³¨å†Œå‘ç°å’ŒæœåŠ¡é…ç½®ï¼Œå¯ä»¥è¿™æ ·è®¤ä¸ºæ³¨å†Œä¸­å¿ƒ + é…ç½®ä¸­å¿ƒã€‚</p>
</li>
</ul>
<h2 id="Nacos"><a href="#Nacos" class="headerlink" title="Nacos"></a>Nacos</h2><p><a href="https://nacos.io/zh-cn/" target="_blank" rel="noopener">Nacoså®˜ç½‘</a></p>
<h3 id="Nacoså®‰è£…"><a href="#Nacoså®‰è£…" class="headerlink" title="Nacoså®‰è£…"></a>Nacoså®‰è£…</h3><ol>
<li><p>é¢„å¤‡ç¯å¢ƒå‡†å¤‡</p>
<p>Nacos ä¾èµ– <a href="https://docs.oracle.com/cd/E19182-01/820-7851/inst_cli_jdk_javahome_t/" target="_blank" rel="noopener">Java</a> ç¯å¢ƒæ¥è¿è¡Œã€‚å¦‚æœæ‚¨æ˜¯ä»ä»£ç å¼€å§‹æ„å»ºå¹¶è¿è¡ŒNacosï¼Œè¿˜éœ€è¦ä¸ºæ­¤é…ç½® <a href="https://maven.apache.org/index.html" target="_blank" rel="noopener">Maven</a>ç¯å¢ƒï¼Œè¯·ç¡®ä¿æ˜¯åœ¨ä»¥ä¸‹ç‰ˆæœ¬ç¯å¢ƒä¸­å®‰è£…ä½¿ç”¨:</p>
<ol>
<li>64 bit OSï¼Œæ”¯æŒ Linux/Unix/Mac/Windowsï¼Œæ¨èé€‰ç”¨ Linux/Unix/Macã€‚</li>
<li>64 bit JDK 1.8+ï¼›<a href="http://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html" target="_blank" rel="noopener">ä¸‹è½½</a> &amp; <a href="https://docs.oracle.com/cd/E19182-01/820-7851/inst_cli_jdk_javahome_t/" target="_blank" rel="noopener">é…ç½®</a>ã€‚</li>
<li>Maven 3.2.x+ï¼›<a href="https://maven.apache.org/download.cgi" target="_blank" rel="noopener">ä¸‹è½½</a> &amp; <a href="https://maven.apache.org/settings.html" target="_blank" rel="noopener">é…ç½®</a>ã€‚</li>
</ol>
</li>
<li><p>ä¸‹è½½æœ€æ–°çš„ç¨³å®šç‰ˆæœ¬</p>
<p>ä»è¯¥åœ°å€<a href="https://github.com/alibaba/nacos/releases" target="_blank" rel="noopener">ä¸‹è½½åœ°å€</a>ä¸‹è½½æœ€æ–°çš„ç¨³å®šç‰ˆæœ¬ï¼Œæˆ‘è¿™é‡Œä½¿ç”¨çš„æ˜¯æœ€æ–°çš„ç¨³å®šç‰ˆï¼š1.3.2</p>
</li>
<li><p>è§£å‹ä¸‹è½½å¥½çš„å‹ç¼©åŒ…</p>
</li>
<li><p>å¯åŠ¨Nacos</p>
<ul>
<li><p>Linux</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd nacos/bin # è¿›å…¥nacosä¸‹çš„binç›®å½•</span><br><span class="line">./startup.sh -m standalone # ä»¥å•æœºæ¨¡å¼å¯åŠ¨</span><br></pre></td></tr></table></figure>
</li>
<li><p>Windows</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd nacos/bin</span><br><span class="line">./startup.cmd -m standalone</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>è®¿é—®ç½‘é¡µæ§åˆ¶å°</p>
<p>è®¿é—®ï¼š<a href="http://localhost:8848/nacos" target="_blank" rel="noopener">http://your-host:8848/nacos</a></p>
<p>å¯ä»¥ç›´æ¥ç™»å½•ï¼Œè´¦å·å¯†ç ï¼šnacos/nacos</p>
<p><img src="https://imxushuai-blog.oss-cn-chengdu.aliyuncs.com/20201028231144.png" alt></p>
</li>
</ol>
<h3 id="æ³¨å†Œå•†å“å’Œè®¢å•å¾®æœåŠ¡åˆ°Nacos"><a href="#æ³¨å†Œå•†å“å’Œè®¢å•å¾®æœåŠ¡åˆ°Nacos" class="headerlink" title="æ³¨å†Œå•†å“å’Œè®¢å•å¾®æœåŠ¡åˆ°Nacos"></a>æ³¨å†Œå•†å“å’Œè®¢å•å¾®æœåŠ¡åˆ°Nacos</h3><p>æ³¨å†Œå•†å“ä»¥åŠè®¢å•å¾®æœåŠ¡åˆ°Nacosæ“ä½œç›¸åŒï¼Œå¦‚ä¸‹ï¼š</p>
<ol>
<li><p>åœ¨å•†å“ä»¥åŠè®¢å•å¾®æœåŠ¡ä¸­åŠ å…¥<code>Nacos-client</code>ä¾èµ–</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>åœ¨å•†å“ä»¥åŠè®¢å•å¾®æœåŠ¡çš„å¯åŠ¨ç±»ä¸Šæ·»åŠ <code>@EnableDiscoveryClient</code>æ³¨è§£</p>
</li>
<li><p>åœ¨å•†å“ä»¥åŠè®¢å•å¾®æœåŠ¡çš„<code>application.yml</code>é…ç½®æ–‡ä»¶ä¸­é…ç½®<code>Nacos</code>çš„åœ°å€</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    nacos:</span></span><br><span class="line"><span class="attr">      discovery:</span></span><br><span class="line"><span class="attr">        server-addr:</span> <span class="number">192.168</span><span class="number">.149</span><span class="number">.101</span><span class="string">:8848</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>ä¿®æ”¹<code>OrderController</code>ä»£ç é€»è¾‘ï¼Œä½¿ç”¨<code>DiscoveryClient</code>è·å–æœåŠ¡å®ä¾‹å¹¶ä»ä¸­è·å–æœåŠ¡IPåœ°å€å’Œç«¯å£å·è¿›è¡Œè¿œç¨‹è°ƒç”¨</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å‡†å¤‡ä¹°1ä»¶å•†å“</span></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/order/prod/&#123;pid&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Order <span class="title">order</span><span class="params">(@PathVariable(<span class="string">"pid"</span>)</span> Integer pid) </span>&#123;</span><br><span class="line">        log.info(<span class="string">"&gt;&gt; å®¢æˆ·ä¸‹å•ï¼Œè¿™æ—¶å€™è¦è°ƒç”¨å•†å“å¾®æœåŠ¡æŸ¥è¯¢å•†å“ä¿¡æ¯"</span>);</span><br><span class="line"></span><br><span class="line">        List&lt;ServiceInstance&gt; instances = discoveryClient.getInstances(<span class="string">"service-product"</span>);</span><br><span class="line">        <span class="keyword">if</span> (instances != <span class="keyword">null</span> &amp;&amp; instances.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            ServiceInstance serviceInstance = instances.get(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//é€šè¿‡restTemplateè°ƒç”¨å•†å“å¾®æœåŠ¡</span></span><br><span class="line">            Product product = restTemplate.getForObject(</span><br><span class="line">                    <span class="string">"http://"</span> + serviceInstance.getHost() + <span class="string">":"</span> + serviceInstance.getPort() + <span class="string">"/product/"</span> + pid, Product.class);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (product != <span class="keyword">null</span>) &#123;</span><br><span class="line">                log.info(<span class="string">"&gt;&gt; å•†å“ä¿¡æ¯,æŸ¥è¯¢ç»“æœ: &#123;&#125;"</span>, JSON.toJSONString(product));</span><br><span class="line">                Order order = <span class="keyword">new</span> Order();</span><br><span class="line">                order.setUid(<span class="number">1</span>);</span><br><span class="line">                order.setUsername(<span class="string">"æµ‹è¯•ç”¨æˆ·"</span>);</span><br><span class="line">                order.setPid(product.getPid());</span><br><span class="line">                order.setPname(product.getPname());</span><br><span class="line">                order.setPprice(product.getPprice());</span><br><span class="line">                order.setNumber(<span class="number">1</span>);</span><br><span class="line">                orderService.save(order);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> order;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"è´­ä¹°å¤±è´¥!"</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>å¯åŠ¨è®¢å•å’Œå•†å“å¾®æœåŠ¡</p>
<p>æŸ¥çœ‹<code>Nacos</code>æœåŠ¡åˆ—è¡¨</p>
<p><img src="https://imxushuai-blog.oss-cn-chengdu.aliyuncs.com/20201028234522.png" alt></p>
</li>
<li><p><strong>è°ƒç”¨è´­ä¹°å•†å“API</strong></p>
<p>æˆåŠŸè°ƒç”¨è´­ä¹°å•†å“API</p>
</li>
</ol>
<h2 id="è´Ÿè½½å‡è¡¡"><a href="#è´Ÿè½½å‡è¡¡" class="headerlink" title="è´Ÿè½½å‡è¡¡"></a>è´Ÿè½½å‡è¡¡</h2><h3 id="ä»€ä¹ˆæ˜¯è´Ÿè½½å‡è¡¡"><a href="#ä»€ä¹ˆæ˜¯è´Ÿè½½å‡è¡¡" class="headerlink" title="ä»€ä¹ˆæ˜¯è´Ÿè½½å‡è¡¡"></a>ä»€ä¹ˆæ˜¯è´Ÿè½½å‡è¡¡</h3><p>è´Ÿè½½å‡è¡¡å°±æ˜¯å°†è´Ÿè½½ï¼ˆå·¥ä½œä»»åŠ¡ï¼Œè®¿é—®è¯·æ±‚ï¼‰è¿›è¡Œåˆ†æ‘Šåˆ°å¤šä¸ªæ“ä½œå•å…ƒï¼ˆæœåŠ¡å™¨,ç»„ä»¶ï¼‰ä¸Šè¿›è¡Œæ‰§è¡Œã€‚</p>
<p>æ ¹æ®è´Ÿè½½å‡è¡¡å‘ç”Ÿä½ç½®çš„ä¸åŒ,ä¸€èˆ¬åˆ†ä¸º<strong>æœåŠ¡ç«¯è´Ÿè½½å‡è¡¡</strong>å’Œ<strong>å®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡</strong>ã€‚</p>
<p>æœåŠ¡ç«¯è´Ÿè½½å‡è¡¡æŒ‡çš„æ˜¯å‘ç”Ÿåœ¨æœåŠ¡æä¾›è€…ä¸€æ–¹,æ¯”å¦‚å¸¸è§çš„<code>nginx</code>è´Ÿè½½å‡è¡¡</p>
<p>è€Œå®¢æˆ·ç«¯è´Ÿè½½å‡è¡¡æŒ‡çš„æ˜¯å‘ç”Ÿåœ¨æœåŠ¡è¯·æ±‚çš„ä¸€æ–¹ï¼Œä¹Ÿå°±æ˜¯åœ¨å‘é€è¯·æ±‚ä¹‹å‰å·²ç»é€‰å¥½äº†ç”±å“ªä¸ªå®ä¾‹å¤„ç†è¯·æ±‚ã€‚</p>
<p><img src="https://imxushuai-blog.oss-cn-chengdu.aliyuncs.com/20201028235442.png" alt></p>
<h3 id="Ribbonç»„ä»¶"><a href="#Ribbonç»„ä»¶" class="headerlink" title="Ribbonç»„ä»¶"></a>Ribbonç»„ä»¶</h3><p>ä½¿ç”¨<code>Ribbon</code>ç»„ä»¶å®Œæˆè´Ÿè½½å‡è¡¡è°ƒç”¨</p>
<ol>
<li><p>åœ¨<code>RestTemplate</code>çš„<code>JavaBean</code>é…ç½®æ–¹æ³•ä¸ŠåŠ å…¥<code>@LoadBalanced</code>æ³¨è§£</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line">   <span class="meta">@LoadBalanced</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> RestTemplate <span class="title">getRestTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>ä¿®æ”¹ä»£ç ï¼Œä½¿ç”¨<code>RestTemplate</code>ä»¥åŠæœåŠ¡åç›´æ¥è°ƒç”¨API</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å‡†å¤‡ä¹°1ä»¶å•†å“</span></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/order/prod/&#123;pid&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Order <span class="title">order</span><span class="params">(@PathVariable(<span class="string">"pid"</span>)</span> Integer pid) </span>&#123;</span><br><span class="line">        log.info(<span class="string">"&gt;&gt; å®¢æˆ·ä¸‹å•ï¼Œè¿™æ—¶å€™è¦è°ƒç”¨å•†å“å¾®æœåŠ¡æŸ¥è¯¢å•†å“ä¿¡æ¯"</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//é€šè¿‡restTemplateè°ƒç”¨å•†å“å¾®æœåŠ¡</span></span><br><span class="line">        Product product = restTemplate.getForObject(</span><br><span class="line">                <span class="string">"http://product-service/product/"</span> + pid, Product.class);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (product != <span class="keyword">null</span>) &#123;</span><br><span class="line">            log.info(<span class="string">"&gt;&gt; å•†å“ä¿¡æ¯,æŸ¥è¯¢ç»“æœ: &#123;&#125;"</span>, JSON.toJSONString(product));</span><br><span class="line">            Order order = <span class="keyword">new</span> Order();</span><br><span class="line">            order.setUid(<span class="number">1</span>);</span><br><span class="line">            order.setUsername(<span class="string">"æµ‹è¯•ç”¨æˆ·"</span>);</span><br><span class="line">            order.setPid(product.getPid());</span><br><span class="line">            order.setPname(product.getPname());</span><br><span class="line">            order.setPprice(product.getPprice());</span><br><span class="line">            order.setNumber(<span class="number">1</span>);</span><br><span class="line">            orderService.save(order);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> order;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"è´­ä¹°å¤±è´¥!"</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>å¯åŠ¨å¤šä¸ª<code>Product</code>æœåŠ¡</p>
</li>
<li><p>è°ƒç”¨è´­ä¹°å•†å“API</p>
</li>
</ol>
<h3 id="Ribbonæ”¯æŒçš„è´Ÿè½½å‡è¡¡ç­–ç•¥"><a href="#Ribbonæ”¯æŒçš„è´Ÿè½½å‡è¡¡ç­–ç•¥" class="headerlink" title="Ribbonæ”¯æŒçš„è´Ÿè½½å‡è¡¡ç­–ç•¥"></a>Ribbonæ”¯æŒçš„è´Ÿè½½å‡è¡¡ç­–ç•¥</h3><p><code>Ribbon</code>é»˜è®¤é‡‡ç”¨çš„æ˜¯è½®è¯¢</p>
<table>
<thead>
<tr>
<th>ç­–ç•¥å</th>
<th>æè¿°</th>
<th>å®ç°è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>BestAvailableRule</td>
<td>é€‰æ‹©ä¸€ä¸ªæœ€å°çš„å¹¶å‘è¯·æ±‚çš„server</td>
<td>é€ä¸ªè€ƒå¯ŸServerï¼Œå¦‚æœServerè¢«trippedäº†ï¼Œåˆ™å¿½ç•¥ï¼Œåœ¨é€‰æ‹©å…¶ä¸­ActiveRequestsCountæœ€å°çš„server</td>
</tr>
<tr>
<td>AvailabilityFilteringRule</td>
<td>è¿‡æ»¤æ‰é‚£äº›å› ä¸ºä¸€ç›´è¿æ¥å¤±è´¥çš„è¢«æ ‡è®°ä¸ºcircuit trippedçš„åç«¯serverï¼Œå¹¶è¿‡æ»¤æ‰é‚£äº›é«˜å¹¶å‘çš„çš„åç«¯serverï¼ˆactiveconnections è¶…è¿‡é…ç½®çš„é˜ˆå€¼ï¼‰</td>
<td>ä½¿ç”¨ä¸€ä¸ªAvailabilityPredicateæ¥åŒ…å«è¿‡æ»¤serverçš„é€»è¾‘ï¼Œå…¶å®å°±å°±æ˜¯æ£€æŸ¥statusé‡Œè®°å½•çš„å„ä¸ªserverçš„è¿è¡ŒçŠ¶æ€</td>
</tr>
<tr>
<td>WeightedResponseTimeRule</td>
<td>æ ¹æ®ç›¸åº”æ—¶é—´åˆ†é…ä¸€ä¸ªweightï¼Œç›¸åº”æ—¶é—´è¶Šé•¿ï¼Œweightè¶Šå°ï¼Œè¢«é€‰ä¸­çš„å¯èƒ½æ€§è¶Šä½</td>
<td>ä¸€ä¸ªåå°çº¿ç¨‹å®šæœŸçš„ä»statusé‡Œé¢è¯»å–è¯„ä»·å“åº”æ—¶é—´ï¼Œä¸ºæ¯ä¸ªserverè®¡ç®—ä¸€ä¸ªweightã€‚Weightçš„è®¡ç®—ä¹Ÿæ¯”è¾ƒç®€å•responsetime å‡å»æ¯ä¸ªserverè‡ªå·±å¹³å‡çš„responsetimeæ˜¯serverçš„æƒé‡ã€‚å½“åˆšå¼€å§‹è¿è¡Œï¼Œæ²¡æœ‰å½¢æˆstatasæ—¶ï¼Œä½¿ç”¨roubineç­–ç•¥é€‰æ‹©server</td>
</tr>
<tr>
<td>RetryRule</td>
<td>å¯¹é€‰å®šçš„è´Ÿè½½å‡è¡¡ç­–ç•¥æœºä¸Šé‡è¯•æœºåˆ¶</td>
<td>åœ¨ä¸€ä¸ªé…ç½®æ—¶é—´æ®µå†…å½“é€‰æ‹©serverä¸æˆåŠŸï¼Œåˆ™ä¸€ç›´å°è¯•ä½¿ç”¨subRuleçš„æ–¹å¼é€‰æ‹©ä¸€ä¸ªå¯ç”¨çš„server</td>
</tr>
<tr>
<td>RoundRobinRule</td>
<td>è½®è¯¢æ–¹å¼è½®è¯¢é€‰æ‹©server</td>
<td>è½®è¯¢indexï¼Œé€‰æ‹©indexå¯¹åº”ä½ç½®çš„server</td>
</tr>
<tr>
<td>RandomRule</td>
<td>éšæœºé€‰æ‹©ä¸€ä¸ªserver</td>
<td>åœ¨indexä¸Šéšæœºï¼Œé€‰æ‹©indexå¯¹åº”ä½ç½®çš„server</td>
</tr>
<tr>
<td>ZoneAvoidanceRule</td>
<td>å¤åˆåˆ¤æ–­serveræ‰€åœ¨åŒºåŸŸçš„æ€§èƒ½å’Œserverçš„å¯ç”¨æ€§é€‰æ‹©server</td>
<td>ä½¿ç”¨ZoneAvoidancePredicateå’ŒAvailabilityPredicateæ¥åˆ¤æ–­æ˜¯å¦é€‰æ‹©æŸä¸ªserverï¼Œå‰ä¸€ä¸ªåˆ¤æ–­åˆ¤å®šä¸€ä¸ªzoneçš„è¿è¡Œæ€§èƒ½æ˜¯å¦å¯ç”¨ï¼Œå‰”é™¤ä¸å¯ç”¨çš„zoneï¼ˆçš„æ‰€æœ‰serverï¼‰ï¼ŒAvailabilityPredicateç”¨äºè¿‡æ»¤æ‰è¿æ¥æ•°è¿‡å¤šçš„Server</td>
</tr>
</tbody>
</table>
<p>é€šè¿‡å¦‚ä¸‹é…ç½®å¯ä»¥è¿›è¡Œå‡è¡¡è´Ÿè½½ç­–ç•¥çš„é…ç½®</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">service-product:</span> <span class="comment"># è°ƒç”¨çš„æä¾›è€…çš„åç§°</span></span><br><span class="line"><span class="attr">  ribbon:</span></span><br><span class="line"><span class="attr">    NFLoadBalancerRuleClassName:</span> <span class="string">com.netflix.loadbalancer.RandomRule</span></span><br></pre></td></tr></table></figure>
<h2 id="FeignæœåŠ¡è°ƒç”¨"><a href="#FeignæœåŠ¡è°ƒç”¨" class="headerlink" title="FeignæœåŠ¡è°ƒç”¨"></a>FeignæœåŠ¡è°ƒç”¨</h2><h3 id="ä»€ä¹ˆæ˜¯Feign"><a href="#ä»€ä¹ˆæ˜¯Feign" class="headerlink" title="ä»€ä¹ˆæ˜¯Feign"></a>ä»€ä¹ˆæ˜¯Feign</h3><p><code>Feign</code>æ˜¯<code>Spring Cloud</code>æä¾›çš„ä¸€ä¸ªå£°æ˜å¼çš„ä¼ªHttpå®¢æˆ·ç«¯ï¼Œ å®ƒä½¿å¾—è°ƒç”¨è¿œç¨‹æœåŠ¡å°±åƒè°ƒç”¨æœ¬åœ°æœåŠ¡ä¸€æ ·ç®€å•ï¼Œ åªéœ€è¦åˆ›å»ºä¸€ä¸ªæ¥å£å¹¶æ·»åŠ ä¸€ä¸ªæ³¨è§£å³å¯ã€‚</p>
<p><code>Nacos</code>å¾ˆå¥½çš„å…¼å®¹äº†<code>Feign</code>ï¼Œ <code>Feign</code>é»˜è®¤é›†æˆäº†<code>Ribbon</code>ï¼Œ æ‰€ä»¥åœ¨<code>Nacos</code>ä¸‹ä½¿ç”¨<code>Fegin</code>é»˜è®¤å°±å®ç°äº†è´Ÿè½½å‡è¡¡çš„æ•ˆæœã€‚</p>
<h3 id="åŸºäºFeignå®ç°æœåŠ¡è°ƒç”¨"><a href="#åŸºäºFeignå®ç°æœåŠ¡è°ƒç”¨" class="headerlink" title="åŸºäºFeignå®ç°æœåŠ¡è°ƒç”¨"></a>åŸºäºFeignå®ç°æœåŠ¡è°ƒç”¨</h3><ol>
<li><p>åŠ å…¥<code>Feign</code>ä¾èµ–</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--feginç»„ä»¶--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>åœ¨è®¢å•å¾®æœåŠ¡çš„å¯åŠ¨ç±»åŠ ä¸Š<code>@EnableFeignClients</code>æ³¨è§£</p>
</li>
<li><p>ç¼–å†™<code>FeignClient</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.springcloud.alibaba.order.client;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.springcloud.alibaba.common.entity.Product;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.FeignClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"></span><br><span class="line"><span class="meta">@FeignClient</span>(<span class="string">"service-product"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ProductClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"product/&#123;pid&#125;"</span>)</span><br><span class="line">    <span class="function">Product <span class="title">findById</span><span class="params">(@PathVariable Integer pid)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>ä¿®æ”¹è´­ä¹°å•†å“é€»è¾‘ï¼Œè°ƒç”¨ç¼–å†™çš„FeignClientä¸­çš„æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">   <span class="meta">@Autowired</span></span><br><span class="line">   <span class="keyword">private</span> ProductClient productClient;</span><br><span class="line"><span class="comment">//å‡†å¤‡ä¹°1ä»¶å•†å“</span></span><br><span class="line">   <span class="meta">@GetMapping</span>(<span class="string">"/order/prod/&#123;pid&#125;"</span>)</span><br><span class="line">   <span class="function"><span class="keyword">public</span> Order <span class="title">order</span><span class="params">(@PathVariable(<span class="string">"pid"</span>)</span> Integer pid) </span>&#123;</span><br><span class="line">       log.info(<span class="string">"&gt;&gt; å®¢æˆ·ä¸‹å•ï¼Œè¿™æ—¶å€™è¦è°ƒç”¨å•†å“å¾®æœåŠ¡æŸ¥è¯¢å•†å“ä¿¡æ¯"</span>);</span><br><span class="line">       <span class="comment">//é€šè¿‡Feignå®¢æˆ·ç«¯è°ƒç”¨</span></span><br><span class="line">       Product product = productClient.findById(pid);</span><br><span class="line">   </span><br><span class="line">       <span class="keyword">if</span> (product != <span class="keyword">null</span>) &#123;</span><br><span class="line">           log.info(<span class="string">"&gt;&gt; å•†å“ä¿¡æ¯,æŸ¥è¯¢ç»“æœ: &#123;&#125;"</span>, JSON.toJSONString(product));</span><br><span class="line">           Order order = <span class="keyword">new</span> Order();</span><br><span class="line">           order.setUid(<span class="number">1</span>);</span><br><span class="line">           order.setUsername(<span class="string">"æµ‹è¯•ç”¨æˆ·"</span>);</span><br><span class="line">           order.setPid(product.getPid());</span><br><span class="line">           order.setPname(product.getPname());</span><br><span class="line">           order.setPprice(product.getPprice());</span><br><span class="line">           order.setNumber(<span class="number">1</span>);</span><br><span class="line">           orderService.save(order);</span><br><span class="line">   </span><br><span class="line">           <span class="keyword">return</span> order;</span><br><span class="line">       &#125;</span><br><span class="line">   </span><br><span class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"è´­ä¹°å¤±è´¥!"</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>æµ‹è¯•è´­ä¹°å•†å“API</p>
</li>
</ol>
<h2 id="æœåŠ¡å®¹é”™ï¼ˆSentinelï¼‰"><a href="#æœåŠ¡å®¹é”™ï¼ˆSentinelï¼‰" class="headerlink" title="æœåŠ¡å®¹é”™ï¼ˆSentinelï¼‰"></a>æœåŠ¡å®¹é”™ï¼ˆSentinelï¼‰</h2><h3 id="æœåŠ¡é›ªå´©"><a href="#æœåŠ¡é›ªå´©" class="headerlink" title="æœåŠ¡é›ªå´©"></a>æœåŠ¡é›ªå´©</h3><p>â€‹        åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­,ç”±äºç½‘ç»œåŸå› æˆ–è‡ªèº«çš„åŸå› ,æœåŠ¡ä¸€èˆ¬æ— æ³•ä¿è¯ 100% å¯ç”¨ã€‚å¦‚æœä¸€ä¸ªæœåŠ¡å‡ºç°äº†é—®é¢˜ï¼Œè°ƒç”¨è¿™ä¸ªæœåŠ¡å°±ä¼šå‡ºç°çº¿ç¨‹é˜»å¡çš„æƒ…å†µï¼Œæ­¤æ—¶è‹¥æœ‰å¤§é‡çš„è¯·æ±‚æ¶Œå…¥ï¼Œå°±ä¼šå‡ºç°å¤šæ¡çº¿ç¨‹é˜»å¡ç­‰å¾…ï¼Œè¿›è€Œå¯¼è‡´æœåŠ¡ç˜«ç—ªã€‚ </p>
<p>â€‹        ç”±äºæœåŠ¡ä¸æœåŠ¡ä¹‹é—´çš„ä¾èµ–æ€§ï¼Œæ•…éšœä¼šä¼ æ’­ï¼Œä¼šå¯¹æ•´ä¸ªå¾®æœåŠ¡ç³»ç»Ÿé€ æˆç¾éš¾æ€§çš„ä¸¥é‡åæœï¼Œè¿™å°±æ˜¯æœåŠ¡æ•…éšœçš„ â€œé›ªå´©æ•ˆåº”â€ã€‚</p>
<p><img src="https://imxushuai-blog.oss-cn-chengdu.aliyuncs.com/20201102231726.png" alt="æœåŠ¡é›ªå´©"></p>
<p>â€‹        é›ªå´©å‘ç”Ÿçš„åŸå› å¤šç§å¤šæ ·ï¼Œæœ‰ä¸åˆç†çš„å®¹é‡è®¾è®¡ï¼Œæˆ–è€…æ˜¯é«˜å¹¶å‘ä¸‹æŸä¸€ä¸ªæ–¹æ³•å“åº”å˜æ…¢ï¼Œäº¦æˆ–æ˜¯æŸå°æœºå™¨çš„èµ„æºè€—å°½ã€‚æˆ‘ä»¬æ— æ³•å®Œå…¨æœç»é›ªå´©æºå¤´çš„å‘ç”Ÿï¼Œåªæœ‰åšå¥½è¶³å¤Ÿçš„å®¹é”™ï¼Œä¿è¯åœ¨ä¸€ä¸ªæœåŠ¡å‘ç”Ÿé—®é¢˜ï¼Œä¸ä¼šå½±å“åˆ°å…¶å®ƒæœåŠ¡çš„æ­£å¸¸è¿è¡Œã€‚ä¹Ÿå°±æ˜¯ï¼‚é›ªè½è€Œä¸é›ªå´©ï¼‚ã€‚</p>
<h3 id="å¸¸è§çš„å®¹é”™æ–¹æ¡ˆ"><a href="#å¸¸è§çš„å®¹é”™æ–¹æ¡ˆ" class="headerlink" title="å¸¸è§çš„å®¹é”™æ–¹æ¡ˆ"></a>å¸¸è§çš„å®¹é”™æ–¹æ¡ˆ</h3><p>å¸¸è§çš„å®¹é”™æ€è·¯æœ‰éš”ç¦»ã€è¶…æ—¶ã€é™æµã€ç†”æ–­ã€é™çº§</p>
<ul>
<li><p>éš”ç¦»</p>
<p>å®ƒæ˜¯æŒ‡å°†ç³»ç»ŸæŒ‰ç…§ä¸€å®šçš„åŸåˆ™åˆ’åˆ†ä¸ºè‹¥å¹²ä¸ªæœåŠ¡æ¨¡å—ï¼Œå„ä¸ªæ¨¡å—ä¹‹é—´ç›¸å¯¹ç‹¬ç«‹ï¼Œæ— å¼ºä¾èµ–ã€‚å½“æœ‰æ•…éšœå‘ç”Ÿæ—¶ï¼Œèƒ½å°†é—®é¢˜å’Œå½±å“éš”ç¦»åœ¨æŸä¸ªæ¨¡å—å†…éƒ¨ï¼Œè€Œä¸æ‰©æ•£é£é™©ï¼Œä¸æ³¢åŠå…¶å®ƒæ¨¡å—ï¼Œä¸å½±å“æ•´ä½“çš„ç³»ç»ŸæœåŠ¡ã€‚å¸¸è§çš„éš”ç¦»æ–¹å¼æœ‰ï¼šçº¿ç¨‹æ± éš”ç¦»å’Œä¿¡å·é‡éš”ç¦»ã€‚</p>
<p><img src="https://imxushuai-blog.oss-cn-chengdu.aliyuncs.com/20201102231926.png" alt></p>
</li>
<li><p>è¶…æ—¶</p>
<p>åœ¨ä¸Šæ¸¸æœåŠ¡è°ƒç”¨ä¸‹æ¸¸æœåŠ¡çš„æ—¶å€™ï¼Œè®¾ç½®ä¸€ä¸ªæœ€å¤§å“åº”æ—¶é—´ï¼Œå¦‚æœè¶…è¿‡è¿™ä¸ªæ—¶é—´ï¼Œä¸‹æ¸¸æœªä½œå‡ºååº”ï¼Œå°±æ–­å¼€è¯·æ±‚ï¼Œé‡Šæ”¾æ‰çº¿ç¨‹ã€‚</p>
<p><img src="https://imxushuai-blog.oss-cn-chengdu.aliyuncs.com/20201102232420.png" alt></p>
</li>
<li><p>é™æµ</p>
<p>é™æµå°±æ˜¯é™åˆ¶ç³»ç»Ÿçš„è¾“å…¥å’Œè¾“å‡ºæµé‡å·²è¾¾åˆ°ä¿æŠ¤ç³»ç»Ÿçš„ç›®çš„ã€‚ä¸ºäº†ä¿è¯ç³»ç»Ÿçš„ç¨³å›ºè¿è¡Œ,ä¸€æ—¦è¾¾åˆ°çš„éœ€è¦é™åˆ¶çš„é˜ˆå€¼,å°±éœ€è¦é™åˆ¶æµé‡å¹¶é‡‡å–å°‘é‡æªæ–½ä»¥å®Œæˆé™åˆ¶æµé‡çš„ç›®çš„ã€‚</p>
<p><img src="https://imxushuai-blog.oss-cn-chengdu.aliyuncs.com/20201102233151.png" alt></p>
</li>
<li><p>ç†”æ–­</p>
<p>åœ¨äº’è”ç½‘ç³»ç»Ÿä¸­ï¼Œå½“ä¸‹æ¸¸æœåŠ¡å› è®¿é—®å‹åŠ›è¿‡å¤§è€Œå“åº”å˜æ…¢æˆ–å¤±è´¥ï¼Œä¸Šæ¸¸æœåŠ¡ä¸ºäº†ä¿æŠ¤ç³»ç»Ÿæ•´ä½“çš„å¯ç”¨æ€§ï¼Œå¯ä»¥æš‚æ—¶åˆ‡æ–­å¯¹ä¸‹æ¸¸æœåŠ¡çš„è°ƒç”¨ã€‚è¿™ç§ç‰ºç‰²å±€éƒ¨ï¼Œä¿å…¨æ•´ä½“çš„æªæ–½å°±å«åšç†”æ–­ã€‚</p>
<p><img src="https://imxushuai-blog.oss-cn-chengdu.aliyuncs.com/20201102233415.png" alt></p>
</li>
<li><p>é™çº§</p>
<p>é™çº§å…¶å®å°±æ˜¯ä¸ºæœåŠ¡æä¾›ä¸€ä¸ªæ‰˜åº•æ–¹æ¡ˆï¼Œä¸€æ—¦æœåŠ¡æ— æ³•æ­£å¸¸è°ƒç”¨ï¼Œå°±ä½¿ç”¨æ‰˜åº•æ–¹æ¡ˆã€‚</p>
<p><img src="https://imxushuai-blog.oss-cn-chengdu.aliyuncs.com/20201102233627.png" alt></p>
</li>
</ul>
<h3 id="å¸¸ç”¨çš„å®¹é”™ç»„ä»¶"><a href="#å¸¸ç”¨çš„å®¹é”™ç»„ä»¶" class="headerlink" title="å¸¸ç”¨çš„å®¹é”™ç»„ä»¶"></a>å¸¸ç”¨çš„å®¹é”™ç»„ä»¶</h3><ul>
<li><p>Hystrix</p>
<p><code>Hystrix</code>æ˜¯ç”±<code>Netflix</code>å¼€æºçš„ä¸€ä¸ªå»¶è¿Ÿå’Œå®¹é”™åº“ï¼Œç”¨äºéš”ç¦»è®¿é—®è¿œç¨‹ç³»ç»Ÿã€æœåŠ¡æˆ–è€…ç¬¬ä¸‰æ–¹åº“ï¼Œé˜²æ­¢çº§è”å¤±è´¥ï¼Œä»è€Œæå‡ç³»ç»Ÿçš„å¯ç”¨æ€§ä¸å®¹é”™æ€§ã€‚</p>
</li>
<li><p>Resilience4J</p>
<p><code>Resilicence4J</code>ä¸€æ¬¾éå¸¸è½»é‡ã€ç®€å•ï¼Œå¹¶ä¸”æ–‡æ¡£éå¸¸æ¸…æ™°ã€ä¸°å¯Œçš„ç†”æ–­å·¥å…·ï¼Œè¿™ä¹Ÿæ˜¯<code>Hystrix</code>å®˜æ–¹æ¨èçš„æ›¿ä»£äº§å“ã€‚ä¸ä»…å¦‚æ­¤ï¼Œ<code>Resilicence4j</code>è¿˜åŸç”Ÿæ”¯æŒ<code>Spring Boot 1.x/2.x</code>ï¼Œè€Œä¸”ç›‘æ§ä¹Ÿæ”¯æŒå’Œ<code>prometheus</code>ç­‰å¤šæ¬¾ä¸»æµäº§å“è¿›è¡Œæ•´åˆã€‚</p>
</li>
<li><p>Sentinel</p>
<p><code>Sentinel</code>æ˜¯é˜¿é‡Œå·´å·´å¼€æºçš„ä¸€æ¬¾æ–­è·¯å™¨å®ç°ï¼Œæœ¬èº«åœ¨é˜¿é‡Œå†…éƒ¨å·²ç»è¢«å¤§è§„æ¨¡é‡‡ç”¨ï¼Œéå¸¸ç¨³å®šã€‚</p>
</li>
</ul>
<p>ä¸‰ä¸ªç»„ä»¶çš„å¯¹æ¯”è¡¨ï¼š</p>
<table>
<thead>
<tr>
<th></th>
<th>Sentinel</th>
<th>Hystrix</th>
<th>Resilience4J</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>éš”ç¦»ç­–ç•¥</strong></td>
<td>ä¿¡å·é‡éš”ç¦»ï¼ˆå¹¶å‘çº¿ç¨‹æ•°é™æµï¼‰</td>
<td>çº¿ç¨‹æ± éš”ç¦»/ä¿¡å·é‡éš”ç¦»</td>
<td>ä¿¡å·é‡éš”ç¦»</td>
</tr>
<tr>
<td><strong>ç†”æ–­é™çº§ç­–ç•¥</strong></td>
<td>åŸºäºå“åº”æ—¶é—´ã€å¼‚å¸¸æ¯”ç‡ã€å¼‚å¸¸æ•°</td>
<td>åŸºäºå¼‚å¸¸æ¯”ç‡</td>
<td>åŸºäºå¼‚å¸¸æ¯”ç‡ã€å“åº”æ—¶é—´</td>
</tr>
<tr>
<td><strong>å®æ—¶ç»Ÿè®¡å®ç°</strong></td>
<td>æ»‘åŠ¨çª—å£ï¼ˆLeapArrayï¼‰</td>
<td>æ»‘åŠ¨çª—å£ï¼ˆåŸºäºRxJavaï¼‰</td>
<td>Ring Bit Buffer</td>
</tr>
<tr>
<td><strong>åŠ¨æ€è§„åˆ™é…ç½®</strong></td>
<td>æ”¯æŒå¤šç§æ•°æ®æº</td>
<td>æ”¯æŒå¤šç§æ•°æ®æº</td>
<td>æœ‰é™æ”¯æŒ</td>
</tr>
<tr>
<td><strong>æ‰©å±•æ€§</strong></td>
<td>å¤šä¸ªæ‰©å±•ç‚¹</td>
<td>æ’ä»¶çš„å½¢å¼</td>
<td>æ¥å£çš„å½¢å¼</td>
</tr>
<tr>
<td><strong>åŸºäºæ³¨è§£çš„æ”¯æŒ</strong></td>
<td>æ”¯æŒ</td>
<td>æ”¯æŒ</td>
<td>æ”¯æŒ</td>
</tr>
<tr>
<td><strong>é™æµ</strong></td>
<td>åŸºäº QPSï¼Œæ”¯æŒåŸºäºè°ƒç”¨å…³ç³»çš„é™æµ</td>
<td>æœ‰é™çš„æ”¯æŒ</td>
<td>Rate Limiter</td>
</tr>
<tr>
<td><strong>æµé‡æ•´å½¢</strong></td>
<td>æ”¯æŒé¢„çƒ­æ¨¡å¼ã€åŒ€é€Ÿå™¨æ¨¡å¼ã€é¢„çƒ­æ’é˜Ÿæ¨¡å¼</td>
<td>ä¸æ”¯æŒ</td>
<td>ç®€å•çš„ Rate Limiteræ¨¡å¼</td>
</tr>
<tr>
<td><strong>ç³»ç»Ÿè‡ªé€‚åº”ä¿æŠ¤</strong></td>
<td>æ”¯æŒ</td>
<td>ä¸æ”¯æŒ</td>
<td>ä¸æ”¯æŒ</td>
</tr>
<tr>
<td><strong>æ§åˆ¶å°</strong></td>
<td>æä¾›å¼€ç®±å³ç”¨çš„æ§åˆ¶å°ï¼Œå¯é…ç½®è§„åˆ™ã€æŸ¥çœ‹ç§’çº§ç›‘æ§ã€æœºå™¨å‘ç°ç­‰</td>
<td>ç®€å•çš„ç›‘æ§æŸ¥çœ‹</td>
<td>ä¸æä¾›æ§åˆ¶å°ï¼Œå¯å¯¹æ¥å…¶å®ƒç›‘æ§ç³»ç»Ÿ</td>
</tr>
</tbody>
</table>
<h3 id="ä»€ä¹ˆæ˜¯Sentinel"><a href="#ä»€ä¹ˆæ˜¯Sentinel" class="headerlink" title="ä»€ä¹ˆæ˜¯Sentinel"></a>ä»€ä¹ˆæ˜¯Sentinel</h3><p>â€‹        <code>Sentinel</code>(åˆ†å¸ƒå¼ç³»ç»Ÿçš„æµé‡é˜²å«å…µ) æ˜¯é˜¿é‡Œå¼€æºçš„ä¸€å¥—ç”¨äºæœåŠ¡å®¹é”™çš„ç»¼åˆæ€§è§£å†³æ–¹æ¡ˆã€‚å®ƒä»¥æµé‡ä¸ºåˆ‡å…¥ç‚¹, ä»æµé‡æ§åˆ¶ã€ç†”æ–­é™çº§ã€ç³»ç»Ÿè´Ÿè½½ä¿æŠ¤ç­‰å¤šä¸ªç»´åº¦æ¥ä¿æŠ¤æœåŠ¡çš„ç¨³å®šæ€§ã€‚</p>
<p><strong>Sentinel å…·æœ‰ä»¥ä¸‹ç‰¹å¾:</strong></p>
<ul>
<li><strong>ä¸°å¯Œçš„åº”ç”¨åœºæ™¯</strong>ï¼š<code>Sentinel</code>æ‰¿æ¥äº†é˜¿é‡Œå·´å·´è¿‘ 10 å¹´çš„åŒåä¸€å¤§ä¿ƒæµé‡çš„æ ¸å¿ƒåœºæ™¯, ä¾‹å¦‚ç§’æ€ï¼ˆå³çªå‘æµé‡æ§åˆ¶åœ¨ç³»ç»Ÿå®¹é‡å¯ä»¥æ‰¿å—çš„èŒƒå›´ï¼‰ã€æ¶ˆæ¯å‰Šå³°å¡«è°·ã€é›†ç¾¤æµé‡æ§åˆ¶ã€å®æ—¶ç†”æ–­ä¸‹æ¸¸ä¸å¯ç”¨åº”ç”¨ç­‰ã€‚</li>
<li><strong>å®Œå¤‡çš„å®æ—¶ç›‘æ§</strong>ï¼š<code>Sentinel</code>æä¾›äº†å®æ—¶çš„ç›‘æ§åŠŸèƒ½ã€‚é€šè¿‡æ§åˆ¶å°å¯ä»¥çœ‹åˆ°æ¥å…¥åº”ç”¨çš„å•å°æœºå™¨ç§’çº§æ•°æ®, ç”šè‡³ 500 å°ä»¥ä¸‹è§„æ¨¡çš„é›†ç¾¤çš„æ±‡æ€»è¿è¡Œæƒ…å†µã€‚</li>
<li><strong>å¹¿æ³›çš„å¼€æºç”Ÿæ€</strong>ï¼š<code>Sentinel</code>æä¾›å¼€ç®±å³ç”¨çš„ä¸å…¶å®ƒå¼€æºæ¡†æ¶/åº“çš„æ•´åˆæ¨¡å—, ä¾‹å¦‚ä¸<code>SpringCloud</code>ã€<code>Dubbo</code>ã€<code>gRPC</code>çš„æ•´åˆã€‚åªéœ€è¦å¼•å…¥ç›¸åº”çš„ä¾èµ–å¹¶è¿›è¡Œç®€å•çš„é…ç½®å³å¯å¿«é€Ÿåœ°æ¥å…¥<code>Sentinel</code>ã€‚</li>
<li><strong>å®Œå–„çš„ SPI æ‰©å±•ç‚¹</strong>ï¼š<code>Sentinel</code>æä¾›ç®€å•æ˜“ç”¨ã€å®Œå–„çš„<code>SPI</code>æ‰©å±•æ¥å£ã€‚æ‚¨å¯ä»¥é€šè¿‡å®ç°æ‰©å±•æ¥å£æ¥å¿«é€Ÿåœ°å®šåˆ¶é€»è¾‘ã€‚ä¾‹å¦‚å®šåˆ¶è§„åˆ™ç®¡ç†ã€é€‚é…åŠ¨æ€æ•°æ®æºç­‰ã€‚</li>
</ul>
<p><strong>Sentinel åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†:</strong></p>
<ul>
<li><strong>æ ¸å¿ƒåº“</strong>ï¼ˆJava å®¢æˆ·ç«¯ï¼‰ä¸ä¾èµ–ä»»ä½•æ¡†æ¶/åº“,èƒ½å¤Ÿè¿è¡Œäºæ‰€æœ‰ Java è¿è¡Œæ—¶ç¯å¢ƒï¼ŒåŒæ—¶å¯¹<code>Dubbo</code>æˆ–è€…<code>Spring Cloud</code>ç­‰æ¡†æ¶ä¹Ÿæœ‰è¾ƒå¥½çš„æ”¯æŒã€‚</li>
<li><strong>æ§åˆ¶å°</strong>ï¼ˆDashboardï¼‰åŸºäº<code>Spring Boot</code>å¼€å‘ï¼Œæ‰“åŒ…åå¯ä»¥ç›´æ¥è¿è¡Œï¼Œä¸éœ€è¦é¢å¤–çš„<code>Tomcat</code>ç­‰åº”ç”¨å®¹å™¨ã€‚</li>
</ul>
<h3 id="è¿è¡ŒSentinel"><a href="#è¿è¡ŒSentinel" class="headerlink" title="è¿è¡ŒSentinel"></a>è¿è¡ŒSentinel</h3><p><code>Sentinel</code>æä¾›ä¸€ä¸ªè½»é‡çº§çš„æ§åˆ¶å°, å®ƒæä¾›æœºå™¨å‘ç°ã€å•æœºèµ„æºå®æ—¶ç›‘æ§ä»¥åŠè§„åˆ™ç®¡ç†ç­‰åŠŸèƒ½ã€‚</p>
<p>æœ€æ–°çš„æ­£å¼ç‰ˆä¸‹è½½ï¼š<a href="https://github.com/alibaba/Sentinel/releases" target="_blank" rel="noopener">https://github.com/alibaba/Sentinel/releases</a></p>
<p>ç›´æ¥ä¸‹è½½jaråŒ…å³å¯ã€‚</p>
<blockquote>
<p>æˆ‘è¿™é‡Œç”±äºæƒ³ä¿®æ”¹å¯åŠ¨çš„é…ç½®ï¼Œåˆä¸æƒ³ä½¿ç”¨å‚æ•°ï¼Œæ‰€ä»¥æŠŠjaråŒ…é‡Œé¢çš„é…ç½®æ–‡ä»¶æ‰’å‡ºæ¥äº†ï¼Œä¿®æ”¹äº†ä¸€äº›é…ç½®ï¼Œç„¶åæŠŠé…ç½®æ–‡ä»¶å’ŒjaråŒ…æ”¾åœ¨åŒçº§ç›®å½•ç›´æ¥ä½¿ç”¨<code>java -jar</code>å¯åŠ¨äº†ï¼ŒSpring bootå¯åŠ¨çš„æ—¶å€™ï¼ŒåŠ è½½é…ç½®æ–‡ä»¶æ˜¯æœ‰ä¼˜å…ˆçº§çš„ï¼ˆæƒ³äº†è§£çš„å“¥ä»¬å„¿ï¼Œå¯ä»¥è‡ªè¡Œç™¾åº¦å“ˆï¼‰ï¼Œä½†å®é™…ç”Ÿäº§ç¯å¢ƒéœ€é¿å…é…ç½®æ–‡ä»¶ä¼˜å…ˆçº§ï¼Œé˜²æ­¢ä¸å¿…è¦çš„é”™è¯¯ã€‚</p>
</blockquote>
<p>å¯åŠ¨å®Œæ¯•åï¼Œè®¿é—®: <code>localhost:18080</code></p>
<p><img src="https://imxushuai-blog.oss-cn-chengdu.aliyuncs.com/20201104163002.png" alt></p>
<blockquote>
<p>æˆ‘è¿™é‡Œæ˜¯ä¿®æ”¹è¿‡server.portçš„ï¼Œé»˜è®¤æ˜¯8080ã€‚é»˜è®¤çš„ç”¨æˆ·å¯†ç æ˜¯<code>sentinel/sentinel</code></p>
</blockquote>
<h3 id="å¾®æœåŠ¡é›†æˆSentinel"><a href="#å¾®æœåŠ¡é›†æˆSentinel" class="headerlink" title="å¾®æœåŠ¡é›†æˆSentinel"></a>å¾®æœåŠ¡é›†æˆSentinel</h3><p>ç›´æ¥å¼•å…¥<code>sentinel</code>çš„<code>starter</code>ä¾èµ–å³å¯ã€‚</p>
<p>ç„¶åé€šè¿‡é…ç½®<code>sentinel</code>çš„è§„åˆ™å®ç°æœåŠ¡å®¹é”™çš„å„ç§ç­–ç•¥ã€‚</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&lt;dependency&gt;</span></span><br><span class="line">    <span class="string">&lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;</span></span><br><span class="line">    <span class="string">&lt;artifactId&gt;spring-cloud-starter-alibaba-sentinel&lt;/artifactId&gt;</span></span><br><span class="line"><span class="string">&lt;/dependency&gt;</span></span><br></pre></td></tr></table></figure>
<p>ä¿®æ”¹<code>application.yml</code>ï¼ŒåŠ å…¥ä¸€ä¸‹é…ç½®</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    sentinel:</span></span><br><span class="line"><span class="attr">      transport:</span></span><br><span class="line">        <span class="comment"># ä¸æ§åˆ¶å°äº¤æµçš„ç«¯å£, é»˜è®¤ 8719</span></span><br><span class="line"><span class="attr">        port:</span> <span class="number">8719</span></span><br><span class="line">        <span class="comment"># web æ§åˆ¶å°åœ°å€</span></span><br><span class="line"><span class="attr">        dashboard:</span> <span class="attr">localhost:18080</span></span><br></pre></td></tr></table></figure>
<h3 id="æµ‹è¯•Sentinel"><a href="#æµ‹è¯•Sentinel" class="headerlink" title="æµ‹è¯•Sentinel"></a>æµ‹è¯•Sentinel</h3><blockquote>
<p>æ–°å¢ä¸€ä¸ªé™æµçš„è§„åˆ™ï¼Œæµ‹è¯•Sentinel</p>
</blockquote>
<ol>
<li><p>ç™»å½•<code>Sentinel</code>æ§åˆ¶å°</p>
</li>
<li><p>ç‚¹å‡»å³ä¾§çš„å¾®æœåŠ¡åç§°ï¼Œå¦‚æœæ²¡æœ‰ï¼Œéœ€è¦ä»»æ„è°ƒç”¨ä¸€ä¸ªæ¥å£ï¼ŒSentinelå°±ä¼šåŠ è½½åˆ°è¯¥å¾®æœåŠ¡</p>
</li>
<li><p>é€‰æ‹© â€œæµæ§è§„åˆ™â€ -&gt; â€œæ–°å¢æµæ§è§„åˆ™â€ï¼Œå¼¹å‡ºè¾“å…¥æ¡†ï¼Œè¾“å…¥è¦é™æµçš„APIä»¥åŠç›¸å…³å‚æ•°ï¼Œå¦‚å›¾</p>
<p><img src="https://imxushuai-blog.oss-cn-chengdu.aliyuncs.com/20201104163930.png" alt></p>
<blockquote>
<p>è¿™é‡Œæˆ‘è®¾ç½®äº†<code>/sentinel/message1</code>è¿™ä¸ªAPIï¼Œæ¯ç§’åªå…è®¸ä¸€ä¸ªè¯·æ±‚è®¿é—®æˆåŠŸï¼Œè‹¥è¶…è¿‡ä¸€ä¸ªè¯·æ±‚ï¼Œåˆ™å¿«é€Ÿè¿”å›å¤±è´¥ã€‚</p>
</blockquote>
</li>
<li><p>æµ‹è¯•æ•ˆæœ</p>
<p><img src="https://imxushuai-blog.oss-cn-chengdu.aliyuncs.com/20201104164302.png" alt></p>
<blockquote>
<p>å¿«é€Ÿåˆ·æ–°ï¼Œåˆ™ä¼šæ˜¾ç¤ºå›¾ä¸Šçš„æ•ˆæœã€‚</p>
</blockquote>
</li>
</ol>
<h3 id="Sentinelçš„æ¦‚å¿µ"><a href="#Sentinelçš„æ¦‚å¿µ" class="headerlink" title="Sentinelçš„æ¦‚å¿µ"></a>Sentinelçš„æ¦‚å¿µ</h3><p>åŸºæœ¬æ¦‚å¿µ</p>
<ul>
<li><p><strong>èµ„æº</strong></p>
<p>èµ„æºå°±æ˜¯<code>Sentinel</code>è¦ä¿æŠ¤çš„ä¸œè¥¿ã€‚å®ƒå¯ä»¥æ˜¯Javaåº”ç”¨ç¨‹åºä¸­çš„ä»»ä½•å†…å®¹ï¼Œå¯ä»¥æ˜¯ä¸€ä¸ªæœåŠ¡ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªæ–¹æ³•ï¼Œç”šè‡³å¯ä»¥æ˜¯ä¸€æ®µä»£ç ã€‚</p>
</li>
<li><p><strong>è§„åˆ™</strong></p>
<p>è§„åˆ™å°±æ˜¯ç”¨æ¥å®šä¹‰å¦‚ä½•ä¿æŠ¤èµ„æºã€‚ä½œç”¨åœ¨èµ„æºä¹‹ä¸Šï¼Œå®šä¹‰ä»¥ä»€ä¹ˆæ ·çš„æ–¹å¼æ¥ä¿æŠ¤èµ„æºï¼Œä¸»è¦åŒ…æ‹¬æµé‡æ§åˆ¶è§„åˆ™ã€ç†”æ–­é™çº§è§„åˆ™ä»¥åŠç³»ç»Ÿä¿æŠ¤è§„åˆ™</p>
</li>
</ul>
<p>é‡è¦åŠŸèƒ½</p>
<p><code>Sentinel</code>çš„ä¸»è¦åŠŸèƒ½å°±æ˜¯è£ä½œï¼Œä¸»è¦ä½“ç°ï¼š</p>
<ul>
<li><p>æµé‡æ§åˆ¶</p>
<p>æµé‡æ§åˆ¶åœ¨ç½‘ç»œä¼ è¾“ä¸­æ˜¯ä¸€ä¸ªå¸¸ç”¨çš„æ¦‚å¿µï¼Œå®ƒç”¨äºè°ƒæ•´ç½‘ç»œåŒ…çš„æ•°æ®ã€‚ä»»æ„æ—¶é—´åˆ°æ¥çš„è¯·æ±‚å¾€å¾€æ˜¯éšå³ä¸å¯æ§çš„ï¼Œè€Œç³»ç»Ÿçš„å¤„ç†èƒ½åŠ›æ˜¯æœ‰é™çš„ã€‚æˆ‘ä»¬éœ€è¦æ ¹æ®ç³»ç»Ÿçš„å¤„ç†èƒ½åŠ›å¯¹æµé‡è¿›è¡Œæ§åˆ¶ã€‚<code>Sentinel</code>ä½œä¸ºä¸€ä¸ªè°ƒé…å™¨ï¼Œå¯ä»¥æ ¹æ®éœ€è¦æŠŠéšæœºçš„è¯·æ±‚è°ƒæ•´æˆå¯æ§çš„ã€‚</p>
</li>
<li><p>ç†”æ–­é™çº§</p>
<p>å½“æ£€æµ‹åˆ°è°ƒç”¨é“¾è·¯ä¸­æŸä¸ªèµ„æºå‡ºç°ä¸ç¨³å®šçš„è¡¨ç°ï¼Œä¾‹å¦‚è¯·æ±‚å“åº”æ—¶é—´è¿‡é•¿æˆ–å¼‚å¸¸è¯·æ±‚æ¯”ä¾‹å‡é«˜çš„æ—¶å€™ï¼Œåˆ™å¯¹è¿™ä¸ªèµ„æºçš„è°ƒç”¨è¿›è¡Œé™åˆ¶ï¼Œè®©è¯·æ±‚å¿«é€Ÿå¤±è´¥ï¼Œé¿å…å½±å“åˆ°å…¶å®ƒèµ„æºè€Œå¯¼è‡´é›ªå´©ã€‚</p>
<p><code>Sentinel</code>å¯¹è¿™ä¸ªé—®é¢˜é‡‡å–äº†ä¸¤ç§æ‰‹æ®µï¼š</p>
<ul>
<li><p>é€šè¿‡å¹¶å‘çº¿ç¨‹æ•°è¿›è¡Œé™åˆ¶</p>
<p><code>Sentinel</code>é€šè¿‡é™åˆ¶èµ„æºå¹¶å‘çº¿ç¨‹æ•°é‡ï¼Œæ¥å‡å°‘ä¸ç¨³å®šèµ„æºå¯¹å…¶å®ƒèµ„æºçš„å½±å“ã€‚å½“æŸä¸ªèµ„æºå‡ºç°ä¸ç¨³å®šçš„æƒ…å†µä¸‹ï¼Œä¾‹å¦‚å“åº”æ—¶é—´è¿‡é•¿ï¼Œå¯¹èµ„æºçš„ç›´æ¥å½±å“å°±æ˜¯ä¼šé€ æˆçº¿ç¨‹æ•°çš„é€æ­¥å †ç§¯ã€‚å½“çº¿ç¨‹æ•°åœ¨ç‰¹å®šèµ„æºä¸Šå †ç§¯åˆ°ä¸€å®šçš„æ•°é‡ä¹‹åï¼Œå¯¹è¯¥èµ„æºçš„æ–°è¯·æ±‚å°±ä¼šè¢«æ‹’ç»ã€‚å †ç§¯çš„çº¿ç¨‹å®Œæˆä»»åŠ¡åæ‰å¼€å§‹ç»§ç»­æ¥å—æ–°çš„è¯·æ±‚ã€‚</p>
</li>
<li><p>é€šè¿‡å“åº”æ—¶é—´å¯¹èµ„æºè¿›è¡Œé™çº§</p>
<p>é™¤äº†å¯¹å¹¶å‘çº¿ç¨‹æ•°è¿›è¡Œæ§åˆ¶ä»¥å¤–ã€‚<code>Sentinel</code>è¿˜å¯ä»¥é€šè¿‡å“åº”æ—¶é—´æ¥å¿«é€Ÿé™çº§ä¸ç¨³å®šçš„èµ„æºã€‚å½“ä¾èµ–çš„èµ„æºå‡ºç°å“åº”æ—¶é—´è¿‡é•¿åï¼Œæ‰€æœ‰å¯¹è¯¥èµ„æºçš„è®¿é—®éƒ½ä¼šè¢«æ‹’ç»ï¼Œç›´åˆ°è¿‡äº†æŒ‡å®šçš„æ—¶é—´çª—å£ä¹‹åæ‰é‡æ–°æ¢å¤ã€‚</p>
</li>
</ul>
<blockquote>
<p><code>Sentinel</code> å’Œ <code>Hystrix</code> çš„åŒºåˆ«</p>
<p>  ä¸¤è€…çš„åŸåˆ™æ˜¯ä¸€è‡´çš„, éƒ½æ˜¯å½“ä¸€ä¸ªèµ„æºå‡ºç°é—®é¢˜æ—¶, è®©å…¶å¿«é€Ÿå¤±è´¥, ä¸è¦æ³¢åŠåˆ°å…¶å®ƒæœåŠ¡ã€‚ä½†æ˜¯åœ¨é™åˆ¶çš„æ‰‹æ®µä¸Š, ç¡®é‡‡å–äº†å®Œå…¨ä¸ä¸€æ ·çš„æ–¹æ³•</p>
<p>  <code>Hystrix</code>é‡‡ç”¨çš„æ˜¯çº¿ç¨‹æ± éš”ç¦»çš„æ–¹å¼, ä¼˜ç‚¹æ˜¯åšåˆ°äº†èµ„æºä¹‹é—´çš„éš”ç¦», ç¼ºç‚¹æ˜¯å¢åŠ äº†çº¿ç¨‹ åˆ‡æ¢çš„æˆæœ¬ã€‚</p>
<p>  <code>Sentinel</code>é‡‡ç”¨çš„æ˜¯é€šè¿‡å¹¶å‘çº¿ç¨‹çš„æ•°é‡å’Œå“åº”æ—¶é—´æ¥å¯¹èµ„æºåšé™åˆ¶ã€‚</p>
</blockquote>
</li>
<li><p>ç³»ç»Ÿè´Ÿè½½ä¿æŠ¤</p>
<p><code>Sentinel</code> åŒæ—¶æä¾›ç³»ç»Ÿç»´åº¦çš„è‡ªé€‚åº”ä¿æŠ¤èƒ½åŠ›ã€‚å½“ç³»ç»Ÿè´Ÿè½½è¾ƒé«˜çš„æ—¶å€™ï¼Œå¦‚æœè¿˜æŒç»­è®© è¯·æ±‚è¿›å…¥å¯èƒ½ä¼šå¯¼è‡´ç³»ç»Ÿå´©æºƒï¼Œæ— æ³•å“åº”ã€‚åœ¨é›†ç¾¤ç¯å¢ƒä¸‹ï¼Œä¼šæŠŠæœ¬åº”è¿™å°æœºå™¨æ‰¿è½½çš„æµé‡è½¬å‘åˆ°å…¶ å®ƒçš„æœºå™¨ä¸Šå»ã€‚å¦‚æœè¿™ä¸ªæ—¶å€™å…¶å®ƒçš„æœºå™¨ä¹Ÿå¤„åœ¨ä¸€ä¸ªè¾¹ç¼˜çŠ¶æ€çš„æ—¶å€™ï¼Œ<code>Sentinel</code> æä¾›äº†å¯¹åº”çš„ä¿æŠ¤æœºåˆ¶ï¼Œè®©ç³»ç»Ÿçš„å…¥å£æµé‡å’Œç³»ç»Ÿçš„è´Ÿè½½è¾¾åˆ°ä¸€ä¸ªå¹³è¡¡ï¼Œä¿è¯ç³»ç»Ÿåœ¨èƒ½åŠ›èŒƒå›´ä¹‹å†…å¤„ç†æœ€å¤šçš„è¯· æ±‚ã€‚</p>
</li>
</ul>
<h3 id="Sentinelæµæ§"><a href="#Sentinelæµæ§" class="headerlink" title="Sentinelæµæ§"></a>Sentinelæµæ§</h3><h4 id="æµæ§è§„åˆ™"><a href="#æµæ§è§„åˆ™" class="headerlink" title="æµæ§è§„åˆ™"></a>æµæ§è§„åˆ™</h4><p>æµé‡æ§åˆ¶ï¼Œå…¶åŸç†æ˜¯ç›‘æ§åº”ç”¨æµé‡çš„QPS(æ¯ç§’æŸ¥è¯¢ç‡) æˆ–å¹¶å‘çº¿ç¨‹æ•°ç­‰æŒ‡æ ‡ï¼Œå½“è¾¾åˆ°æŒ‡å®šçš„é˜ˆå€¼æ—¶æµé‡è¿›è¡Œæ§åˆ¶ï¼Œä»¥é¿å…è¢«ç¬æ—¶çš„æµé‡é«˜å³°å†²å®ï¼Œä»è€Œä¿éšœåº”ç”¨çš„é«˜å¯ç”¨æ€§ã€‚</p>
<p>æ‰¾åˆ°è¦è®¾ç½®æµæ§è§„åˆ™çš„æ¥å£åœ°å€ï¼Œç‚¹å‡»æµæ§æŒ‰é’®ï¼Œæ‰“å¼€å¦‚ä¸‹å›¾çš„è®¾ç½®ç•Œé¢ï¼š</p>
<p><img src="https://imxushuai-blog.oss-cn-chengdu.aliyuncs.com/20210515221502.png" alt></p>
<ol>
<li>èµ„æºåï¼šå”¯ä¸€åç§°ï¼Œé»˜è®¤æ˜¯è¯·æ±‚è·¯å¾„ï¼Œå¯è‡ªå®šä¹‰</li>
<li>é’ˆå¯¹æ¥æºï¼Œé»˜è®¤defaultï¼Œä¸åŒºåˆ†æ¥æº</li>
<li>é˜ˆå€¼ç±»å‹/å•æœºé˜ˆå€¼<ul>
<li>QPSï¼šå½“å‰æ¥å£çš„æ¯ç§’è¯·æ±‚ä¸Šé™æ•°é‡ï¼Œè¾¾åˆ°è®¾ç½®çš„æ•°é‡æ—¶åˆ™è¿›è¡Œé™æµ</li>
<li>çº¿ç¨‹æ•°ï¼šå½“å‰æ¥å£çš„çº¿ç¨‹æ•°è¾¾åˆ°é˜ˆå€¼æ—¶åˆ™è¿›è¡Œé™æµ</li>
</ul>
</li>
<li>æ˜¯å¦é›†ç¾¤ï¼šæ˜¯å¦ä¸ºé›†ç¾¤ç¯å¢ƒ</li>
</ol>
<p>ä»¥ä¸Šæ˜¯åŸºæœ¬çš„è®¾ç½®ï¼Œè¿˜æœ‰æµæ§æ¨¡å¼å’Œæµæ§æ•ˆæœï¼Œä¸‹é¢è¯¦ç»†è®²è§£</p>
<h4 id="æµæ§æ¨¡å¼"><a href="#æµæ§æ¨¡å¼" class="headerlink" title="æµæ§æ¨¡å¼"></a>æµæ§æ¨¡å¼</h4><ol>
<li><p>ç›´æ¥æµæ§æ¨¡å¼</p>
<p>ç›´æ¥æµæ§æ¨¡å¼æ˜¯æœ€ç®€å•çš„æ¨¡å¼ï¼Œå½“æŒ‡å®šçš„æ¥å£è¾¾åˆ°é™æµæ¡ä»¶æ—¶å¼€å¯é™æµã€‚ä¸Šé¢æ¡ˆä¾‹ä½¿ç”¨çš„å°±æ˜¯ç›´æ¥æµæ§æ¨¡å¼ã€‚</p>
</li>
<li><p>å…³è”æµæ§æ¨¡å¼</p>
<p>å…³è”æµæ§æ¨¡å¼æŒ‡çš„æ˜¯ï¼Œå½“æŒ‡å®šæ¥å£å…³è”çš„æ¥å£è¾¾åˆ°é™æµæ¡ä»¶æ—¶ï¼Œå¼€å¯å¯¹æŒ‡å®šæ¥å£å¼€å¯é™æµã€‚é€‰æ‹©å…³è”æµæ§æ¨¡å¼æ—¶ï¼Œä¼šå¤šä¸€ä¸ªè¾“å…¥æ¡†ï¼Œè®©ä½ è¾“å…¥å…³è”èµ„æºåï¼Œå½“è¾“å…¥çš„å…³è”èµ„æºåè¾¾åˆ°é˜ˆå€¼æ—¶å°±ä¼šè¿›è¡Œé™æµ</p>
</li>
<li><p>é“¾è·¯æµæ§æ¨¡å¼</p>
<p>é“¾è·¯æµæ§æ¨¡å¼æŒ‡çš„æ˜¯ï¼Œå½“ä»æŸä¸ªæ¥å£è¿‡æ¥çš„èµ„æºè¾¾åˆ°é™æµæ¡ä»¶æ—¶ï¼Œå¼€å¯é™æµã€‚å®ƒçš„åŠŸèƒ½æœ‰ç‚¹ç±»ä¼¼äºé’ˆå¯¹æ¥æºé…ç½®é¡¹ï¼ŒåŒºåˆ«åœ¨äºï¼š<strong>é’ˆå¯¹æ¥æºæ˜¯é’ˆå¯¹ä¸Šçº§å¾®æœåŠ¡ï¼Œè€Œé“¾è·¯æµæ§æ˜¯é’ˆå¯¹ä¸Šçº§æ¥å£ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒçš„ç²’åº¦æ›´ç»†</strong>ã€‚</p>
</li>
</ol>
<h4 id="æµæ§æ•ˆæœ"><a href="#æµæ§æ•ˆæœ" class="headerlink" title="æµæ§æ•ˆæœ"></a>æµæ§æ•ˆæœ</h4><ol>
<li><p>å¿«é€Ÿå¤±è´¥ï¼ˆé»˜è®¤ï¼‰</p>
<p>ç›´æ¥å¤±è´¥ï¼ŒæŠ›å‡ºå¼‚å¸¸ã€‚</p>
</li>
<li><p>Warm Up</p>
<p>å®ƒä»å¼€å§‹é˜ˆå€¼åˆ°æœ€å¤§QPSé˜ˆå€¼ä¼šæœ‰ä¸€ä¸ªç¼“å†²é˜¶æ®µï¼Œä¸€å¼€å§‹çš„é˜ˆå€¼æ˜¯æœ€å¤§QPSé˜ˆå€¼çš„1/3ï¼Œç„¶åæ…¢æ…¢å¢é•¿ï¼Œç›´åˆ°æœ€å¤§é˜ˆå€¼ï¼Œé€‚ç”¨äºå°†çªç„¶å¢å¤§çš„æµé‡è½¬æ¢ä¸ºç¼“æ­¥å¢é•¿çš„åœºæ™¯ã€‚</p>
</li>
<li><p>æ’é˜Ÿç­‰å¾…</p>
<p>è®©è¯·æ±‚ä»¥å‡åŒ€çš„é€Ÿåº¦é€šè¿‡ï¼Œå•æœºé˜ˆå€¼ä¸ºæ¯ç§’é€šè¿‡æ•°é‡ï¼Œå…¶ä½™çš„æ’é˜Ÿç­‰å¾…ï¼› å®ƒè¿˜ä¼šè®©è®¾ç½®ä¸€ä¸ªè¶…æ—¶æ—¶é—´ï¼Œå½“è¯·æ±‚è¶…è¿‡è¶…æ—¶é—´æ—¶é—´è¿˜æœªå¤„ç†ï¼Œåˆ™ä¼šè¢«ä¸¢å¼ƒã€‚</p>
</li>
</ol>
<h3 id="Sentinelé™çº§"><a href="#Sentinelé™çº§" class="headerlink" title="Sentinelé™çº§"></a>Sentinelé™çº§</h3><p>é™çº§è§„åˆ™å°±æ˜¯è®¾ç½®å½“æ»¡è¶³ä»€ä¹ˆæ¡ä»¶çš„æ—¶å€™ï¼Œå¯¹æœåŠ¡è¿›è¡Œé™çº§ã€‚Sentinelæä¾›äº†ä¸‰ä¸ªè¡¡é‡æ¡ä»¶ï¼š</p>
<h4 id="é™çº§è§„åˆ™"><a href="#é™çº§è§„åˆ™" class="headerlink" title="é™çº§è§„åˆ™"></a>é™çº§è§„åˆ™</h4><ol>
<li><p>å¹³å‡å“åº”æ—¶é—´</p>
<p>å½“èµ„æºçš„å¹³å‡å“åº”æ—¶é—´è¶…è¿‡é˜ˆå€¼ï¼ˆä»¥ ms ä¸ºå•ä½ï¼‰ä¹‹åï¼Œèµ„æºè¿›å…¥å‡†é™çº§çŠ¶æ€ã€‚å¦‚æœæ¥ä¸‹æ¥ 1s å†…æŒç»­è¿›å…¥ 5 ä¸ªè¯·æ±‚ï¼Œå®ƒä»¬çš„ RTéƒ½æŒç»­è¶…è¿‡è¿™ä¸ªé˜ˆå€¼ï¼Œé‚£ä¹ˆåœ¨æ¥ä¸‹çš„æ—¶é—´çª—å£ï¼ˆä»¥ s ä¸ºå•ä½ï¼‰ä¹‹å†…ï¼Œå°±ä¼šå¯¹è¿™ä¸ªæ–¹æ³•è¿›è¡ŒæœåŠ¡é™çº§ã€‚</p>
</li>
<li><p>å¼‚å¸¸æ¯”ä¾‹</p>
<p>å½“èµ„æºçš„æ¯ç§’å¼‚å¸¸æ€»æ•°å é€šè¿‡é‡çš„æ¯”å€¼è¶…è¿‡é˜ˆå€¼ä¹‹åï¼Œèµ„æºè¿›å…¥é™çº§çŠ¶æ€ï¼Œå³åœ¨æ¥ä¸‹çš„æ—¶é—´çª—å£ï¼ˆä»¥ s ä¸ºå•ä½ï¼‰ä¹‹å†…ï¼Œå¯¹è¿™ä¸ªæ–¹æ³•çš„è°ƒç”¨éƒ½ä¼šè‡ªåŠ¨åœ°è¿”å›ã€‚å¼‚å¸¸æ¯”ç‡çš„é˜ˆå€¼èŒƒå›´æ˜¯ [0.0,1.0]ã€‚</p>
</li>
</ol>
<h3 id="Sentinelçƒ­ç‚¹"><a href="#Sentinelçƒ­ç‚¹" class="headerlink" title="Sentinelçƒ­ç‚¹"></a>Sentinelçƒ­ç‚¹</h3><p>çƒ­ç‚¹å‚æ•°æµæ§è§„åˆ™æ˜¯ä¸€ç§æ›´ç»†ç²’åº¦çš„æµæ§è§„åˆ™, å®ƒå…è®¸å°†è§„åˆ™å…·ä½“åˆ°å‚æ•°ä¸Šã€‚</p>
<h4 id="çƒ­ç‚¹è§„åˆ™"><a href="#çƒ­ç‚¹è§„åˆ™" class="headerlink" title="çƒ­ç‚¹è§„åˆ™"></a>çƒ­ç‚¹è§„åˆ™</h4><p>ç›´æ¥ä¸Šç¤ºä¾‹</p>
<ol>
<li><p>ç¼–å†™ç”¨äºè®¾ç½®çƒ­ç‚¹è§„åˆ™çš„æ¥å£</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"message3"</span>)</span><br><span class="line"><span class="meta">@SentinelResource</span>(<span class="string">"message3"</span>)<span class="comment">// å¿…é¡»æ·»åŠ è¯¥æ³¨è§£, å¦åˆ™çƒ­ç‚¹è§„åˆ™ä¸ä¼šç”Ÿæ•ˆ</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">message3</span><span class="params">(String name, Integer age)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"Message 3. name = "</span> + name + <span class="string">",age = "</span> + age;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>çƒ­ç‚¹è§„åˆ™è®¾ç½®å¦‚ä¸‹</p>
<p><img src="https://imxushuai-blog.oss-cn-chengdu.aliyuncs.com/QQ%E5%9B%BE%E7%89%8720210515223326.png" alt></p>
<p>é¢„æœŸè¾¾åˆ°çš„é™æµæ•ˆæœï¼Œå½“è®¿é—®message3æ¥å£æ—¶ï¼Œå¦‚æœnameå‚æ•°ä¸ä¸ºç©ºï¼Œåˆ™æ¯ç§’è®¿é—®æ•°è¶…è¿‡1ï¼Œå°±ä¼šé™æµã€‚è€Œåªä¼ ageå‚æ•°çš„æ—¶å€™ï¼ŒAPIè®¿é—®ä¸ä¼šè¢«é™åˆ¶</p>
</li>
<li><p>é«˜çº§é€‰é¡¹è®¾ç½®</p>
<p>å¯ä»¥åœ¨é«˜çº§é€‰é¡¹ä¸­è®¾ç½®å…·ä½“çš„å‚æ•°çš„å€¼çš„é˜ˆå€¼ï¼Œæ¯”å¦‚ï¼šè®¾ç½®name=imxushuaiæ—¶ï¼Œé˜ˆå€¼è®¾ç½®åˆ°1000ã€‚è¿™æ ·å°±å¯ä»¥è¾¾åˆ°å¯¹å…·ä½“çš„å‚æ•°å€¼çš„é™æµ</p>
</li>
</ol>
<h3 id="Sentinelæˆæƒ"><a href="#Sentinelæˆæƒ" class="headerlink" title="Sentinelæˆæƒ"></a>Sentinelæˆæƒ</h3><p>å¾ˆå¤šæ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦æ ¹æ®è°ƒç”¨æ¥æºæ¥åˆ¤æ–­è¯¥æ¬¡è¯·æ±‚æ˜¯å¦å…è®¸æ”¾è¡Œï¼Œè¿™æ—¶å€™å¯ä»¥ä½¿ç”¨ Sentinel çš„æ¥æºè®¿é—®æ§åˆ¶çš„åŠŸèƒ½ã€‚æ¥æºè®¿é—®æ§åˆ¶æ ¹æ®èµ„æºçš„è¯·æ±‚æ¥æºï¼ˆoriginï¼‰é™åˆ¶èµ„æºæ˜¯å¦é€šè¿‡ã€‚</p>
<p><img src="https://imxushuai-blog.oss-cn-chengdu.aliyuncs.com/QQ%E5%9B%BE%E7%89%8720210515224322.png" alt></p>
<p>è®¾ç½®æŒ‡å®šçš„æµæ§åº”ç”¨ä»¥åŠæˆæƒçš„ç±»å‹ï¼Œå…¶ä¸­æˆæƒç±»å‹ä¸ºç™½åå•/é»‘åå•ï¼Œç›¸ä¿¡æˆæƒç±»å‹æ—¶å¾ˆå¥½ç†è§£çš„ï¼Œä½†æ˜¯ä»€ä¹ˆæ˜¯æµæ§åº”ç”¨å‘¢ã€‚</p>
<p><code>Sentinel</code>æä¾›äº†æ¥å£æ¥è®©æˆ‘ä»¬è‡ªå®šä¹‰æˆæƒçš„è§„åˆ™ï¼Œéå¸¸çš„çµæ´»ï¼Œç›´æ¥ä¸Šä»£ç ç¤ºä¾‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.springcloud.alibaba.order.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.csp.sentinel.adapter.servlet.callback.RequestOriginParser;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è‡ªå®šä¹‰æµæ§è§„åˆ™</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestOriginParserDefinition</span> <span class="keyword">implements</span> <span class="title">RequestOriginParser</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">parseOrigin</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        String serviceName = request.getHeader(<span class="string">"serviceName"</span>);</span><br><span class="line">        <span class="keyword">return</span> serviceName;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¦‚ä»£ç ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä»è¯·æ±‚ä¸­è·å–ä»»æ„çš„å‚æ•°ä½œä¸ºæ¥è¿›è¡Œè‡ªå®šä¹‰åˆ¤æ–­ï¼Œè¾¾åˆ°æˆ‘ä»¬æƒ³è¦çš„æ•ˆæœï¼Œä¸Šæ–¹ç»™å‡ºçš„ä»£ç ä¸­ï¼Œåªæ˜¯ç®€å•çš„ä»headerä¸­è·å–äº†åä¸º<code>serviceName</code>çš„å‚æ•°ç›´æ¥è¿”å›ï¼Œè¿™ä¸ªè¿”å›å€¼å¦‚æœå’Œæˆ‘ä»¬è®¾ç½®çš„æµæ§åº”ç”¨çš„å€¼ä¸€è‡´åˆ™ä¼šè§¦å‘æˆ‘ä»¬çš„æˆæƒè§„åˆ™ï¼Œä»è€Œè¾¾åˆ°é™æµçš„æ•ˆæœã€‚</p>
<h3 id="Sentinelç³»ç»Ÿè§„åˆ™"><a href="#Sentinelç³»ç»Ÿè§„åˆ™" class="headerlink" title="Sentinelç³»ç»Ÿè§„åˆ™"></a>Sentinelç³»ç»Ÿè§„åˆ™</h3><p>ç³»ç»Ÿä¿æŠ¤è§„åˆ™æ˜¯ä»åº”ç”¨çº§åˆ«çš„å…¥å£æµé‡è¿›è¡Œæ§åˆ¶ï¼Œä»å•å°æœºå™¨çš„æ€»ä½“ Loadã€RTã€å…¥å£ QPS ã€CPUä½¿ç”¨ç‡å’Œçº¿ç¨‹æ•°äº”ä¸ªç»´åº¦ç›‘æ§åº”ç”¨æ•°æ®ï¼Œè®©ç³»ç»Ÿå°½å¯èƒ½è·‘åœ¨æœ€å¤§ååé‡çš„åŒæ—¶ä¿è¯ç³»ç»Ÿæ•´ä½“çš„ç¨³å®šæ€§ã€‚</p>
<ol>
<li><strong>Loadï¼ˆä»…å¯¹ Linux/Unix-like æœºå™¨ç”Ÿæ•ˆï¼‰</strong>ï¼šå½“ç³»ç»Ÿ load1 è¶…è¿‡é˜ˆå€¼ï¼Œä¸”ç³»ç»Ÿå½“å‰çš„å¹¶å‘çº¿ç¨‹æ•°è¶…è¿‡ç³»ç»Ÿå®¹é‡æ—¶æ‰ä¼šè§¦å‘ç³»ç»Ÿä¿æŠ¤ã€‚ç³»ç»Ÿå®¹é‡ç”±ç³»ç»Ÿçš„ maxQps <em> minRt è®¡ç®—å¾—å‡ºã€‚è®¾å®šå‚è€ƒå€¼ä¸€èˆ¬æ˜¯ CPU cores </em> 2.5ã€‚</li>
<li><strong>RT</strong>ï¼šå½“å•å°æœºå™¨ä¸Šæ‰€æœ‰å…¥å£æµé‡çš„å¹³å‡ RT è¾¾åˆ°é˜ˆå€¼å³è§¦å‘ç³»ç»Ÿä¿æŠ¤ï¼Œå•ä½æ˜¯æ¯«ç§’ã€‚</li>
<li><strong>çº¿ç¨‹æ•°</strong>ï¼šå½“å•å°æœºå™¨ä¸Šæ‰€æœ‰å…¥å£æµé‡çš„å¹¶å‘çº¿ç¨‹æ•°è¾¾åˆ°é˜ˆå€¼å³è§¦å‘ç³»ç»Ÿä¿æŠ¤ã€‚</li>
<li><strong>å…¥å£ QPS</strong>ï¼šå½“å•å°æœºå™¨ä¸Šæ‰€æœ‰å…¥å£æµé‡çš„ QPS è¾¾åˆ°é˜ˆå€¼å³è§¦å‘ç³»ç»Ÿä¿æŠ¤ã€‚</li>
<li><strong>CPUä½¿ç”¨ç‡</strong>ï¼šå½“å•å°æœºå™¨ä¸Šæ‰€æœ‰å…¥å£æµé‡çš„ CPUä½¿ç”¨ç‡è¾¾åˆ°é˜ˆå€¼å³è§¦å‘ç³»ç»Ÿä¿æŠ¤ã€‚</li>
</ol>
<h3 id="è‡ªå®šä¹‰å¼‚å¸¸è¿”å›"><a href="#è‡ªå®šä¹‰å¼‚å¸¸è¿”å›" class="headerlink" title="è‡ªå®šä¹‰å¼‚å¸¸è¿”å›"></a>è‡ªå®šä¹‰å¼‚å¸¸è¿”å›</h3><p>åœ¨ä¸Šé¢çš„æµ‹è¯•ä¸­ï¼Œæˆ‘ä»¬ä¼šå‘ç°ï¼Œå½“é™æµåçš„è¿”å›æƒ…å†µç›´æ¥è·³è½¬åˆ°äº†ä¸€ä¸ªé”™è¯¯é¡µé¢ï¼Œåœ¨çœŸå®çš„åœºæ™¯ä¸­ï¼Œå…¶å®æˆ‘ä»¬æ˜¯éœ€è¦è¿”å›ç‰¹å®šçš„æ•°æ®çš„ï¼Œè¿™å°±éœ€è¦æˆ‘ä»¬è¿›è¡Œå¼‚å¸¸çš„è‡ªå®šä¹‰è¿”å›äº†ã€‚</p>
<p>Sentinelæä¾›äº†å„ç§å¼‚å¸¸çš„æ¥å£ï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©éœ€è¦è‡ªå®šä¹‰çš„å¼‚å¸¸ç±»å‹è¿›è¡Œè‡ªå®šä¹‰ï¼Œå¼‚å¸¸ç±»å‹å¦‚ä¸‹ï¼š</p>
<ul>
<li><p>å¼‚å¸¸æ¥å£ï¼š<code>BlockException</code></p>
<p>åŒ…å«äº†æ‰€æœ‰çš„Sentinelé™æµå¼‚å¸¸ï¼Œå³ç»Ÿä¸€è®¾ç½®æ‰€æœ‰çš„é™æµå¼‚å¸¸è¿”å›</p>
</li>
<li><p>æµæ§å¼‚å¸¸ï¼š<code>FlowException</code></p>
</li>
<li><p>é™çº§å¼‚å¸¸ï¼š<code>DegradeException</code></p>
</li>
<li><p>å‚æ•°é™æµå¼‚å¸¸ï¼š<code>ParamFlowException</code></p>
</li>
<li><p>æˆæƒå¼‚å¸¸ï¼š<code>AuthorityException</code></p>
</li>
<li><p>ç³»ç»Ÿè´Ÿè½½å¼‚å¸¸ï¼š<code>SystemBlockException</code></p>
</li>
</ul>
<p>æœ‰äº†è¿™äº›ç±»å‹ï¼Œæˆ‘ä»¬æ—¢å¯ä»¥ä½¿ç”¨Spring bootçš„ç»Ÿä¸€å¼‚å¸¸å¤„ç†ï¼Œå»å•ç‹¬å¤„ç†ä»¥ä¸Šçš„å¼‚å¸¸ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨Sentinelæä¾›çš„æ¥å£ç±»è¿›è¡Œå¼‚å¸¸å¤„ç†ï¼Œä¸‹æ–¹æˆ‘ç»™å‡ºä¸€ä¸ªä½¿ç”¨Sentinelæä¾›çš„æ¥å£ç±»çš„æ–¹å¼å¤„ç†ç»Ÿä¸€å¼‚å¸¸è¿”å›çš„ä»£ç ç¤ºä¾‹</p>
<p>ä»£ç ç¤ºä¾‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.springcloud.alibaba.order.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.csp.sentinel.adapter.servlet.callback.UrlBlockHandler;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.csp.sentinel.slots.block.BlockException;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSONObject;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è‡ªå®šä¹‰é™æµå¼‚å¸¸è¿”å›</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExceptionHandlerConfig</span> <span class="keyword">implements</span> <span class="title">UrlBlockHandler</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">blocked</span><span class="params">(HttpServletRequest request, HttpServletResponse response, BlockException e)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        response.setContentType(<span class="string">"application/json;charset=utf-8"</span>);</span><br><span class="line">        JSONObject result = <span class="keyword">new</span> JSONObject();</span><br><span class="line">        result.put(<span class="string">"message"</span>, <span class="string">"å½“å‰æœåŠ¡å™¨å¿™, è¯·ç¨åå†è¯•!"</span>);</span><br><span class="line"></span><br><span class="line">        response.getWriter().write(result.toJSONString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="SentinelResourceæ³¨è§£"><a href="#SentinelResourceæ³¨è§£" class="headerlink" title="@SentinelResourceæ³¨è§£"></a>@SentinelResourceæ³¨è§£</h3><p><code>@SentinelResource</code>çš„å‚æ•°è®¾ç½®å¾ˆå¤šï¼Œæˆ‘ç›´æ¥è´´å‡ºæºç ç±»ä»¥åŠå¯¹åº”çš„å«ä¹‰å’Œè§£é‡Š</p>
<blockquote>
<p>æˆ‘ç›´æ¥è´´å‡ºçš„æ˜¯<code>@SentinelResource</code>çš„æºç ï¼Œå¦‚æœçœ‹ä¸æ‡‚æ³¨è§£ç±»ä¸­çš„è¯­æ³•å¯ä»¥å¿½ç•¥ä»£ç ï¼Œåªçœ‹æ³¨é‡Šã€‚</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target</span>(ElementType.METHOD)</span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Inherited</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> SentinelResource &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * èµ„æºåç§°</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * entryç±»å‹ï¼Œæ ‡è®°æµé‡çš„æ–¹å‘ï¼Œå–å€¼IN/OUTï¼Œé»˜è®¤æ˜¯OUT</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">EntryType <span class="title">entryType</span><span class="params">()</span> <span class="keyword">default</span> EntryType.OUT</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * èµ„æºç±»å‹</span></span><br><span class="line"><span class="comment">     * Sentinelæä¾›çš„å¸¸é‡ç±»ï¼šResourceTypeConstants</span></span><br><span class="line"><span class="comment">     * COMMON = 0;</span></span><br><span class="line"><span class="comment">     * COMMON_WEB = 1;</span></span><br><span class="line"><span class="comment">     * COMMON_RPC = 2;</span></span><br><span class="line"><span class="comment">     * COMMON_API_GATEWAY = 3;</span></span><br><span class="line"><span class="comment">     * COMMON_DB_SQL = 4;</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">resourceType</span><span class="params">()</span> <span class="keyword">default</span> 0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å¤„ç†BlockExceptionçš„å‡½æ•°åç§°,å‡½æ•°è¦æ±‚ï¼š</span></span><br><span class="line"><span class="comment">     * 1. å¿…é¡»æ˜¯ public</span></span><br><span class="line"><span class="comment">     * 2.è¿”å›ç±»å‹ å‚æ•°ä¸åŸæ–¹æ³•ä¸€è‡´</span></span><br><span class="line"><span class="comment">     * 3. é»˜è®¤éœ€å’ŒåŸæ–¹æ³•åœ¨åŒä¸€ä¸ªç±»ä¸­ã€‚è‹¥å¸Œæœ›ä½¿ç”¨å…¶ä»–ç±»çš„å‡½æ•°ï¼Œå¯é…ç½®</span></span><br><span class="line"><span class="comment">     * blockHandlerClass ï¼Œå¹¶æŒ‡å®šblockHandlerClassé‡Œé¢çš„æ–¹æ³•ã€‚</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">String <span class="title">blockHandler</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å­˜æ”¾blockHandlerçš„ç±»,å¯¹åº”çš„å¤„ç†å‡½æ•°å¿…é¡»staticä¿®é¥°ã€‚</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Class&lt;?&gt;[] blockHandlerClass() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç”¨äºåœ¨æŠ›å‡ºå¼‚å¸¸çš„æ—¶å€™æä¾›fallbackå¤„ç†é€»è¾‘ã€‚fallbackå‡½æ•°å¯ä»¥é’ˆå¯¹æ‰€</span></span><br><span class="line"><span class="comment">     * æœ‰ç±»å‹çš„å¼‚å¸¸ï¼ˆé™¤äº† exceptionsToIgnore é‡Œé¢æ’é™¤æ‰çš„å¼‚å¸¸ç±»å‹ï¼‰è¿›</span></span><br><span class="line"><span class="comment">     * è¡Œå¤„ç†ã€‚å‡½æ•°è¦æ±‚ï¼š</span></span><br><span class="line"><span class="comment">     * 1. è¿”å›ç±»å‹ä¸åŸæ–¹æ³•ä¸€è‡´</span></span><br><span class="line"><span class="comment">     * 2. å‚æ•°ç±»å‹éœ€è¦å’ŒåŸæ–¹æ³•ç›¸åŒ¹é…</span></span><br><span class="line"><span class="comment">     * 3. é»˜è®¤éœ€å’ŒåŸæ–¹æ³•åœ¨åŒä¸€ä¸ªç±»ä¸­ã€‚è‹¥å¸Œæœ›ä½¿ç”¨å…¶ä»–ç±»çš„å‡½æ•°ï¼Œå¯é…ç½®</span></span><br><span class="line"><span class="comment">     * fallbackClassï¼Œå¹¶æŒ‡å®šfallbackClassé‡Œé¢çš„æ–¹æ³•ã€‚</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">String <span class="title">fallback</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç”¨äºé€šç”¨çš„ fallback é€»è¾‘ã€‚é»˜è®¤fallbackå‡½æ•°å¯ä»¥é’ˆå¯¹æ‰€æœ‰ç±»å‹çš„å¼‚å¸¸è¿›</span></span><br><span class="line"><span class="comment">     * è¡Œå¤„ç†ã€‚è‹¥åŒæ—¶é…ç½®äº† fallback å’Œ defaultFallbackï¼Œä»¥fallbackä¸ºå‡†ã€‚å‡½</span></span><br><span class="line"><span class="comment">     * æ•°è¦æ±‚ï¼š</span></span><br><span class="line"><span class="comment">     * 1. è¿”å›ç±»å‹ä¸åŸæ–¹æ³•ä¸€è‡´</span></span><br><span class="line"><span class="comment">     * 2. æ–¹æ³•å‚æ•°åˆ—è¡¨ä¸ºç©ºï¼Œæˆ–è€…æœ‰ä¸€ä¸ª Throwable ç±»å‹çš„å‚æ•°ã€‚</span></span><br><span class="line"><span class="comment">     * 3. é»˜è®¤éœ€è¦å’ŒåŸæ–¹æ³•åœ¨åŒä¸€ä¸ªç±»ä¸­ã€‚è‹¥å¸Œæœ›ä½¿ç”¨å…¶ä»–ç±»çš„å‡½æ•°ï¼Œå¯é…ç½®</span></span><br><span class="line"><span class="comment">     * fallbackClassï¼Œå¹¶æŒ‡å®š fallbackClass é‡Œé¢çš„æ–¹æ³•ã€‚</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">String <span class="title">defaultFallback</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å­˜æ”¾fallbackçš„ç±»ã€‚å¯¹åº”çš„å¤„ç†å‡½æ•°å¿…é¡»staticä¿®é¥°ã€‚</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Class&lt;?&gt;[] fallbackClass() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * éœ€è¦traceçš„å¼‚å¸¸</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Class&lt;? extends Throwable&gt;[] exceptionsToTrace() <span class="keyword">default</span> &#123;Throwable.class&#125;;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æŒ‡å®šæ’é™¤æ‰å“ªäº›å¼‚å¸¸ã€‚æ’é™¤çš„å¼‚å¸¸ä¸ä¼šè®¡å…¥å¼‚å¸¸ç»Ÿè®¡ï¼Œä¹Ÿä¸ä¼šè¿›å…¥</span></span><br><span class="line"><span class="comment">     * fallbacké€»è¾‘ï¼Œè€Œæ˜¯åŸæ ·æŠ›å‡ºã€‚</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Class&lt;? extends Throwable&gt;[] exceptionsToIgnore() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨<code>@SentinelResource</code>æ³¨è§£ä¸­æˆ‘ä»¬å¯ä»¥å®šä¹‰å½“å‘ç°é™æµæ—¶è¿›å…¥çš„æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æ–¹æ³•è‡ªå®šä¹‰æˆ‘ä»¬è‡ªå·±çš„ä¸šåŠ¡é€»è¾‘ï¼Œä»è€Œè¾¾åˆ°æˆ‘ä»¬æƒ³è¦çš„æ•ˆæœã€‚</p>
<h3 id="Sentinelè§„åˆ™æŒä¹…åŒ–"><a href="#Sentinelè§„åˆ™æŒä¹…åŒ–" class="headerlink" title="Sentinelè§„åˆ™æŒä¹…åŒ–"></a>Sentinelè§„åˆ™æŒä¹…åŒ–</h3><p>è¿™ä¸ªå°±ä¸åšè¯¦ç»†ä»‹ç»äº†ï¼Œä¸»è¦å°±æ˜¯æŒ‡å¦‚ä½•å°†å­˜åœ¨<code>Sentinel</code>é‡Œçš„è§„åˆ™æŒä¹…åŒ–åˆ°ç¡¬ç›˜ï¼Œé¿å…æ¯æ¬¡é‡å¯<code>Sentinel</code>åä¹‹å‰çš„è®¾ç½®çš„é™æµè§„åˆ™å°±ä¸åœ¨äº†ï¼Œä¸éœ€è¦ç‰¹åˆ«è®°ï¼Œåˆ°æ—¶å€™ç™¾åº¦å°±è¡Œã€‚ï¼ˆæ¯•ç«Ÿæˆ‘ä¸ä¼šçš„ç™¾åº¦éƒ½ä¼š ~ï¼‰</p>
<h3 id="Feignæ•´åˆSentinel"><a href="#Feignæ•´åˆSentinel" class="headerlink" title="Feignæ•´åˆSentinel"></a>Feignæ•´åˆSentinel</h3><ol>
<li><p>å¼•å…¥ä¾èµ–</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>ç¼–å†™é…ç½®æ–‡ä»¶ï¼Œæ‰“å¼€<code>Feign</code>å¯¹<code>Sentinel</code>çš„æ”¯æŒ</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line"><span class="attr">  sentinel:</span></span><br><span class="line">    <span class="comment"># å¼€å¯sentinelæ”¯æŒ</span></span><br><span class="line"><span class="attr">    enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>ç¼–å†™å®¹é”™ç±»</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.springcloud.alibaba.order.client.fallback;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.springcloud.alibaba.common.entity.Product;</span><br><span class="line"><span class="keyword">import</span> com.springcloud.alibaba.order.client.ProductClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * product serviceå®¹é”™ç±»</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProductClientFallback</span> <span class="keyword">implements</span> <span class="title">ProductClient</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Product <span class="title">findById</span><span class="params">(Integer pid)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// å…·ä½“çš„å®¹é”™ä¸šåŠ¡é€»è¾‘, æˆ‘è¿™é‡Œç›´æ¥è¿”å›ç©ºçš„å•†å“å¯¹è±¡</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Product();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>ä¿®æ”¹FiegnClientæŒ‡å®šèµ·å®¹é”™ç±»</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.springcloud.alibaba.order.client;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.springcloud.alibaba.common.entity.Product;</span><br><span class="line"><span class="keyword">import</span> com.springcloud.alibaba.order.client.fallback.ProductClientFallback;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.openfeign.FeignClient;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span><br><span class="line"></span><br><span class="line"><span class="meta">@FeignClient</span>(value = <span class="string">"service-product"</span>, fallback = ProductClientFallback.class)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ProductClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"product/&#123;pid&#125;"</span>)</span><br><span class="line">    <span class="function">Product <span class="title">findById</span><span class="params">(@PathVariable Integer pid)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>ä»¥ä¸Šå°±æ˜¯<code>Sentinel</code>çš„åŸºæœ¬ç”¨æ³•äº†ã€‚</p>
<h2 id="æœåŠ¡ç½‘å…³ï¼ˆGatewayï¼‰"><a href="#æœåŠ¡ç½‘å…³ï¼ˆGatewayï¼‰" class="headerlink" title="æœåŠ¡ç½‘å…³ï¼ˆGatewayï¼‰"></a>æœåŠ¡ç½‘å…³ï¼ˆGatewayï¼‰</h2><p>åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œä¸€ä¸ªç³»ç»Ÿä¼šè¢«æ‹†åˆ†ä¸ºå¾ˆå¤šä¸ªå¾®æœåŠ¡ã€‚é‚£ä¹ˆä½œä¸ºå®¢æˆ·ç«¯è¦å¦‚ä½•å»è°ƒç”¨è¿™ä¹ˆå¤šçš„å¾®æœåŠ¡å‘¢ï¼Ÿå¦‚æœæ²¡æœ‰ç½‘å…³çš„å­˜åœ¨ï¼Œæˆ‘ä»¬åªèƒ½åœ¨å®¢æˆ·ç«¯è®°å½•æ¯ä¸ªå¾®æœåŠ¡çš„åœ°å€ï¼Œç„¶ååˆ†åˆ«å»è°ƒç”¨ã€‚</p>
<p>è¿™æ ·çš„æ¶æ„ï¼Œä¼šå­˜åœ¨ç€è¯¸å¤šçš„é—®é¢˜ï¼š</p>
<ul>
<li>å®¢æˆ·ç«¯å¤šæ¬¡è¯·æ±‚ä¸åŒçš„å¾®æœåŠ¡ï¼Œå¢åŠ å®¢æˆ·ç«¯ä»£ç æˆ–é…ç½®ç¼–å†™çš„å¤æ‚æ€§</li>
<li>è®¤è¯å¤æ‚ï¼Œæ¯ä¸ªæœåŠ¡éƒ½éœ€è¦ç‹¬ç«‹è®¤è¯ã€‚</li>
<li>å­˜åœ¨è·¨åŸŸè¯·æ±‚ï¼Œåœ¨ä¸€å®šåœºæ™¯ä¸‹å¤„ç†ç›¸å¯¹å¤æ‚ã€‚</li>
</ul>
<p>è¿™äº›é—®é¢˜å¯ä»¥å€ŸåŠ©APIç½‘å…³æ¥è§£å†³</p>
<p>APIç½‘å…³ï¼Œå°±æ˜¯æŒ‡ç³»ç»Ÿçš„ç»Ÿä¸€å…¥å£ï¼Œå®ƒå°è£…äº†åº”ç”¨ç¨‹åºçš„å†…éƒ¨ç»“æ„ï¼Œä¸ºå®¢æˆ·ç«¯æä¾›ç»Ÿä¸€æœåŠ¡ï¼Œä¸€äº›ä¸ä¸šåŠ¡æœ¬èº«åŠŸèƒ½æ— å…³çš„å…¬å…±é€»è¾‘å¯ä»¥åœ¨è¿™é‡Œå®ç°ï¼Œè¯¸å¦‚è®¤è¯ã€é‰´æƒã€ç›‘æ§ã€è·¯ç”±è½¬å‘ç­‰ç­‰ã€‚</p>
<p>åœ¨ä¸šç•Œæ¯”è¾ƒæµè¡Œçš„ç½‘å…³ï¼Œæœ‰ä¸‹é¢è¿™äº›ï¼š</p>
<ul>
<li><p>Ngnix+lua</p>
<p>ä½¿ç”¨nginxçš„åå‘ä»£ç†å’Œè´Ÿè½½å‡è¡¡å¯å®ç°å¯¹apiæœåŠ¡å™¨çš„è´Ÿè½½å‡è¡¡åŠé«˜å¯ç”¨ã€‚luaæ˜¯ä¸€ç§è„šæœ¬è¯­è¨€,å¯ä»¥æ¥ç¼–å†™ä¸€äº›ç®€å•çš„é€»è¾‘, nginxæ”¯æŒluaè„šæœ¬</p>
</li>
<li><p>Kong</p>
<p>åŸºäºNginx+Luaå¼€å‘ï¼Œæ€§èƒ½é«˜ï¼Œç¨³å®šï¼Œæœ‰å¤šä¸ªå¯ç”¨çš„æ’ä»¶(é™æµã€é‰´æƒç­‰ç­‰)å¯ä»¥å¼€ç®±å³ç”¨ã€‚ é—®é¢˜ï¼šåªæ”¯æŒHttpåè®®ï¼›äºŒæ¬¡å¼€å‘ï¼Œè‡ªç”±æ‰©å±•å›°éš¾ï¼›æä¾›ç®¡ç†APIï¼Œç¼ºä¹æ›´æ˜“ç”¨çš„ç®¡æ§ã€é…ç½®æ–¹å¼ã€‚</p>
</li>
<li><p>Zuul</p>
<p>Netflixå¼€æºçš„ç½‘å…³ï¼ŒåŠŸèƒ½ä¸°å¯Œï¼Œä½¿ç”¨JAVAå¼€å‘ï¼Œæ˜“äºäºŒæ¬¡å¼€å‘ é—®é¢˜ï¼šç¼ºä¹ç®¡æ§ï¼Œæ— æ³•åŠ¨æ€é…ç½®ï¼›ä¾èµ–ç»„ä»¶è¾ƒå¤šï¼›å¤„ç†Httpè¯·æ±‚ä¾èµ–çš„æ˜¯Webå®¹å™¨ï¼Œæ€§èƒ½ä¸å¦‚Nginx</p>
</li>
<li><p>Spring Cloud Gateway</p>
<p>Springå…¬å¸ä¸ºäº†æ›¿æ¢Zuulè€Œå¼€å‘çš„ç½‘å…³æœåŠ¡ï¼Œè¿™æ˜¯æˆ‘ä»¬è¦ä½¿ç”¨çš„ç½‘å…³ã€‚</p>
</li>
</ul>
<h3 id="Gatewayç®€ä»‹"><a href="#Gatewayç®€ä»‹" class="headerlink" title="Gatewayç®€ä»‹"></a>Gatewayç®€ä»‹</h3><p>Spring Cloud Gatewayæ˜¯Springå…¬å¸åŸºäºSpring 5.0ï¼ŒSpring Boot 2.0 å’Œ Project Reactor ç­‰æŠ€æœ¯å¼€å‘çš„ç½‘å…³ï¼Œå®ƒæ—¨åœ¨ä¸ºå¾®æœåŠ¡æ¶æ„æä¾›ä¸€ç§ç®€å•æœ‰æ•ˆçš„ç»Ÿä¸€çš„ API è·¯ç”±ç®¡ç†æ–¹å¼ã€‚å®ƒçš„ç›®æ ‡æ˜¯æ›¿ä»£Netflix Zuulï¼Œå…¶ä¸ä»…æä¾›ç»Ÿä¸€çš„è·¯ç”±æ–¹å¼ï¼Œå¹¶ä¸”åŸºäº Filter é“¾çš„æ–¹å¼æä¾›äº†ç½‘å…³åŸºæœ¬çš„åŠŸèƒ½ï¼Œä¾‹å¦‚ï¼šå®‰å…¨ï¼Œç›‘æ§å’Œé™æµã€‚</p>
<p>ä¼˜ç‚¹ï¼š</p>
<ul>
<li>æ€§èƒ½å¼ºåŠ²ï¼šæ˜¯ç¬¬ä¸€ä»£ç½‘å…³Zuulçš„1.6å€</li>
<li>åŠŸèƒ½å¼ºå¤§ï¼šå†…ç½®äº†å¾ˆå¤šå®ç”¨çš„åŠŸèƒ½ï¼Œä¾‹å¦‚è½¬å‘ã€ç›‘æ§ã€é™æµç­‰</li>
<li>è®¾è®¡ä¼˜é›…ï¼Œå®¹æ˜“æ‰©å±•</li>
</ul>
<p>ç¼ºç‚¹ï¼š</p>
<ul>
<li>å…¶å®ç°ä¾èµ–Nettyä¸WebFluxï¼Œä¸æ˜¯ä¼ ç»Ÿçš„Servletç¼–ç¨‹æ¨¡å‹ï¼Œå­¦ä¹ æˆæœ¬é«˜</li>
<li>ä¸èƒ½å°†å…¶éƒ¨ç½²åœ¨Tomcatã€Jettyç­‰Servletå®¹å™¨é‡Œï¼Œåªèƒ½æ‰“æˆjaråŒ…æ‰§è¡Œ</li>
<li>éœ€è¦Spring Boot 2.0åŠä»¥ä¸Šçš„ç‰ˆæœ¬ï¼Œæ‰æ”¯æŒ</li>
</ul>
<h3 id="åŸºæœ¬ä½¿ç”¨"><a href="#åŸºæœ¬ä½¿ç”¨" class="headerlink" title="åŸºæœ¬ä½¿ç”¨"></a>åŸºæœ¬ä½¿ç”¨</h3><ol>
<li><p>æ–°å»ºmavené¡¹ç›®</p>
</li>
<li><p>å¼•å…¥ä¾èµ–</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springcloud-alibaba<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>springcloud-alibaba-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--nacoså®¢æˆ·ç«¯--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>ç¼–å†™å¯åŠ¨ç±»</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.springcloud.alibaba;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.client.discovery.EnableDiscoveryClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GatewayApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(GatewayApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>ç¼–å†™é…ç½®æ–‡ä»¶</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line"><span class="attr">  port:</span> <span class="number">7000</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">api-gateway</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    nacos:</span></span><br><span class="line"><span class="attr">      discovery:</span></span><br><span class="line"><span class="attr">        server-addr:</span> <span class="number">192.168</span><span class="number">.149</span><span class="number">.101</span><span class="string">:8848</span></span><br><span class="line"><span class="attr">    gateway:</span></span><br><span class="line"><span class="attr">      routes:</span> <span class="comment"># è·¯ç”±æ•°ç»„[è·¯ç”± å°±æ˜¯æŒ‡å®šå½“è¯·æ±‚æ»¡è¶³ä»€ä¹ˆæ¡ä»¶çš„æ—¶å€™è½¬åˆ°å“ªä¸ªå¾®æœåŠ¡]</span></span><br><span class="line">        <span class="comment"># å½“å‰è·¯ç”±çš„æ ‡è¯†, è¦æ±‚å”¯ä¸€</span></span><br><span class="line"><span class="attr">        - id:</span> <span class="string">product_route</span></span><br><span class="line">          <span class="comment"># è¯·æ±‚è¦è½¬å‘åˆ°çš„åœ°å€</span></span><br><span class="line"><span class="attr">          uri:</span> <span class="attr">lb://service-product</span></span><br><span class="line">          <span class="comment"># è·¯ç”±çš„ä¼˜å…ˆçº§,æ•°å­—è¶Šå°çº§åˆ«è¶Šé«˜</span></span><br><span class="line"><span class="attr">          order:</span> <span class="number">1</span></span><br><span class="line">          <span class="comment"># æ–­è¨€(å°±æ˜¯è·¯ç”±è½¬å‘è¦æ»¡è¶³çš„æ¡ä»¶)</span></span><br><span class="line"><span class="attr">          predicates:</span></span><br><span class="line">            <span class="comment"># å½“è¯·æ±‚è·¯å¾„æ»¡è¶³PathæŒ‡å®šçš„è§„åˆ™æ—¶,æ‰è¿›è¡Œè·¯ç”±è½¬å‘</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">Path=/product-serv/**</span></span><br><span class="line">          <span class="comment"># è¿‡æ»¤å™¨,è¯·æ±‚åœ¨ä¼ é€’è¿‡ç¨‹ä¸­å¯ä»¥é€šè¿‡è¿‡æ»¤å™¨å¯¹å…¶è¿›è¡Œä¸€å®šçš„ä¿®æ”¹</span></span><br><span class="line"><span class="attr">          filters:</span></span><br><span class="line">            <span class="comment"># è½¬å‘ä¹‹å‰å»æ‰1å±‚è·¯å¾„,å¦‚æœä¸º0åˆ™åŸæ ·è½¬å‘URLåˆ°å¾®æœåŠ¡</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">StripPrefix=1</span></span><br><span class="line"><span class="attr">        - id:</span> <span class="string">order_route</span></span><br><span class="line">          <span class="comment"># è¯·æ±‚è¦è½¬å‘åˆ°çš„åœ°å€</span></span><br><span class="line"><span class="attr">          uri:</span> <span class="attr">lb://service-order</span></span><br><span class="line">          <span class="comment"># è·¯ç”±çš„ä¼˜å…ˆçº§,æ•°å­—è¶Šå°çº§åˆ«è¶Šé«˜</span></span><br><span class="line"><span class="attr">          order:</span> <span class="number">1</span></span><br><span class="line">          <span class="comment"># æ–­è¨€(å°±æ˜¯è·¯ç”±è½¬å‘è¦æ»¡è¶³çš„æ¡ä»¶)</span></span><br><span class="line"><span class="attr">          predicates:</span></span><br><span class="line">            <span class="comment"># å½“è¯·æ±‚è·¯å¾„æ»¡è¶³PathæŒ‡å®šçš„è§„åˆ™æ—¶,æ‰è¿›è¡Œè·¯ç”±è½¬å‘</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">Path=/order-serv/**</span></span><br><span class="line">          <span class="comment"># è¿‡æ»¤å™¨,è¯·æ±‚åœ¨ä¼ é€’è¿‡ç¨‹ä¸­å¯ä»¥é€šè¿‡è¿‡æ»¤å™¨å¯¹å…¶è¿›è¡Œä¸€å®šçš„ä¿®æ”¹</span></span><br><span class="line"><span class="attr">          filters:</span></span><br><span class="line">            <span class="comment"># è½¬å‘ä¹‹å‰å»æ‰1å±‚è·¯å¾„</span></span><br><span class="line"><span class="bullet">            -</span> <span class="string">StripPrefix=1</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>æµ‹è¯•è®¿é—®æ•ˆæœ</p>
<p><img src="https://imxushuai-blog.oss-cn-chengdu.aliyuncs.com/QQ%E6%88%AA%E5%9B%BE20210516150041.png" alt></p>
<p>å¯ä»¥çœ‹åˆ°ï¼ŒæˆåŠŸä»ç½‘å…³è®¿é—®åˆ°äº†productå¾®æœåŠ¡çš„APIã€‚</p>
</li>
</ol>
<h3 id="Gatewayæ ¸å¿ƒæ¶æ„"><a href="#Gatewayæ ¸å¿ƒæ¶æ„" class="headerlink" title="Gatewayæ ¸å¿ƒæ¶æ„"></a>Gatewayæ ¸å¿ƒæ¶æ„</h3><p>è·¯ç”±(Route) æ˜¯ gateway ä¸­æœ€åŸºæœ¬çš„ç»„ä»¶ä¹‹ä¸€ï¼Œè¡¨ç¤ºä¸€ä¸ªå…·ä½“çš„è·¯ç”±ä¿¡æ¯è½½ä½“ã€‚ä¸»è¦å®šä¹‰äº†ä¸‹é¢çš„å‡ ä¸ªä¿¡æ¯:</p>
<ul>
<li><strong>id</strong>ï¼Œè·¯ç”±æ ‡è¯†ç¬¦ï¼ŒåŒºåˆ«äºå…¶ä»– Routeã€‚</li>
<li><strong>uri</strong>ï¼Œè·¯ç”±æŒ‡å‘çš„ç›®çš„åœ° uriï¼Œå³å®¢æˆ·ç«¯è¯·æ±‚æœ€ç»ˆè¢«è½¬å‘åˆ°çš„å¾®æœåŠ¡ã€‚</li>
<li><strong>order</strong>ï¼Œç”¨äºå¤šä¸ª Route ä¹‹é—´çš„æ’åºï¼Œæ•°å€¼è¶Šå°æ’åºè¶Šé å‰ï¼ŒåŒ¹é…ä¼˜å…ˆçº§è¶Šé«˜ã€‚</li>
<li><strong>predicate</strong>ï¼Œæ–­è¨€çš„ä½œç”¨æ˜¯è¿›è¡Œæ¡ä»¶åˆ¤æ–­ï¼Œåªæœ‰æ–­è¨€éƒ½è¿”å›çœŸï¼Œæ‰ä¼šçœŸæ­£çš„æ‰§è¡Œè·¯ç”±ã€‚</li>
<li><strong>filter</strong>ï¼Œè¿‡æ»¤å™¨ç”¨äºä¿®æ”¹è¯·æ±‚å’Œå“åº”ä¿¡æ¯ã€‚</li>
</ul>
<p><strong>Gatewayçš„è¿è¡Œæµç¨‹ï¼š</strong></p>
<p><img src="https://imxushuai-blog.oss-cn-chengdu.aliyuncs.com/springgateway%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B.jpg" alt></p>
<ol>
<li>Gateway Clientå‘Gateway Serverå‘é€è¯·æ±‚</li>
<li>è¯·æ±‚é¦–å…ˆä¼šè¢«HttpWebHandlerAdapterè¿›è¡Œæå–ç»„è£…æˆç½‘å…³ä¸Šä¸‹æ–‡</li>
<li>ç„¶åç½‘å…³çš„ä¸Šä¸‹æ–‡ä¼šä¼ é€’åˆ°DispatcherHandlerï¼Œå®ƒè´Ÿè´£å°†è¯·æ±‚åˆ†å‘ç»™RoutePredicateHandlerMapping</li>
<li>RoutePredicateHandlerMappingè´Ÿè´£è·¯ç”±æŸ¥æ‰¾ï¼Œå¹¶æ ¹æ®è·¯ç”±æ–­è¨€åˆ¤æ–­è·¯ç”±æ˜¯å¦å¯ç”¨</li>
<li>å¦‚æœè¿‡æ–­è¨€æˆåŠŸï¼Œç”±FilteringWebHandleråˆ›å»ºè¿‡æ»¤å™¨é“¾å¹¶è°ƒç”¨</li>
<li>è¯·æ±‚ä¼šä¸€æ¬¡ç»è¿‡PreFilterâ€“å¾®æœåŠ¡â€“PostFilterçš„æ–¹æ³•ï¼Œæœ€ç»ˆè¿”å›å“åº”</li>
</ol>
<h3 id="æ–­è¨€"><a href="#æ–­è¨€" class="headerlink" title="æ–­è¨€"></a>æ–­è¨€</h3><p>Predicate(æ–­è¨€, è°“è¯) ç”¨äºè¿›è¡Œæ¡ä»¶åˆ¤æ–­ï¼Œåªæœ‰æ–­è¨€éƒ½è¿”å›çœŸï¼Œæ‰ä¼šçœŸæ­£çš„æ‰§è¡Œè·¯ç”±ã€‚</p>
<p>æ–­è¨€å°±æ˜¯è¯´: åœ¨<strong>ä»€ä¹ˆæ¡ä»¶</strong>ä¸‹ï¼Œæ‰èƒ½ç»§ç»­æ‰§è¡Œ</p>
<h4 id="å†…ç½®è·¯ç”±æ–­è¨€å·¥å‚"><a href="#å†…ç½®è·¯ç”±æ–­è¨€å·¥å‚" class="headerlink" title="å†…ç½®è·¯ç”±æ–­è¨€å·¥å‚"></a>å†…ç½®è·¯ç”±æ–­è¨€å·¥å‚</h4><p><code>SpringCloud Gateway</code>åŒ…æ‹¬è®¸å¤šå†…ç½®çš„æ–­è¨€å·¥å‚ï¼Œæ‰€æœ‰è¿™äº›æ–­è¨€éƒ½ä¸HTTPè¯·æ±‚çš„ä¸åŒå±æ€§åŒ¹é…ã€‚å…·ä½“å¦‚ä¸‹ï¼š</p>
<ul>
<li><p>åŸºäºDatetimeç±»å‹çš„æ–­è¨€å·¥å‚</p>
<p>æ­¤ç±»å‹çš„æ–­è¨€æ ¹æ®æ—¶é—´åšåˆ¤æ–­ï¼Œä¸»è¦æœ‰ä¸‰ä¸ªï¼š</p>
<p>AfterRoutePredicateFactoryï¼š æ¥æ”¶ä¸€ä¸ªæ—¥æœŸå‚æ•°ï¼Œåˆ¤æ–­è¯·æ±‚æ—¥æœŸæ˜¯å¦æ™šäºæŒ‡å®šæ—¥æœŸ</p>
<p>BeforeRoutePredicateFactoryï¼š æ¥æ”¶ä¸€ä¸ªæ—¥æœŸå‚æ•°ï¼Œåˆ¤æ–­è¯·æ±‚æ—¥æœŸæ˜¯å¦æ—©äºæŒ‡å®šæ—¥æœŸ</p>
<p>BetweenRoutePredicateFactoryï¼š æ¥æ”¶ä¸¤ä¸ªæ—¥æœŸå‚æ•°ï¼Œåˆ¤æ–­è¯·æ±‚æ—¥æœŸæ˜¯å¦åœ¨æŒ‡å®šæ—¶é—´æ®µå†…</p>
<p>ç¤ºä¾‹ï¼š<code>After=2019-12-31T23:59:59.789+08:00[Asia/Shanghai]</code></p>
</li>
<li><p>åŸºäºè¿œç¨‹åœ°å€çš„æ–­è¨€å·¥å‚ RemoteAddrRoutePredicateFactoryï¼šæ¥æ”¶ä¸€ä¸ªIPåœ°å€æ®µï¼Œåˆ¤æ–­è¯·æ±‚ä¸»æœºåœ°å€æ˜¯å¦åœ¨åœ°å€æ®µä¸­</p>
<p>ç¤ºä¾‹ï¼š<code>RemoteAddr=192.168.1.1/24</code></p>
</li>
<li><p>åŸºäºCookieçš„æ–­è¨€å·¥å‚</p>
<p>CookieRoutePredicateFactoryï¼šæ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼Œcookie åå­—å’Œä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼ã€‚ åˆ¤æ–­è¯·æ±‚cookieæ˜¯å¦å…·æœ‰ç»™å®šåç§°ä¸”å€¼ä¸æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ã€‚</p>
<p>ç¤ºä¾‹ï¼š<code>Cookie=chocolate, ch.</code></p>
</li>
<li><p>åŸºäºHeaderçš„æ–­è¨€å·¥å‚</p>
<p>HeaderRoutePredicateFactoryï¼šæ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼Œæ ‡é¢˜åç§°å’Œæ­£åˆ™è¡¨è¾¾å¼ã€‚ åˆ¤æ–­è¯·æ±‚Headeræ˜¯å¦å…·æœ‰ç»™å®šåç§°ä¸”å€¼ä¸æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ã€‚</p>
<p>ç¤ºä¾‹ï¼š<code>Header=X-Request-Id, \d+</code></p>
</li>
<li><p>åŸºäºHostçš„æ–­è¨€å·¥å‚</p>
<p>HostRoutePredicateFactoryï¼šæ¥æ”¶ä¸€ä¸ªå‚æ•°ï¼Œä¸»æœºåæ¨¡å¼ã€‚åˆ¤æ–­è¯·æ±‚çš„Hostæ˜¯å¦æ»¡è¶³åŒ¹é…è§„åˆ™ã€‚</p>
<p>ç¤ºä¾‹ï¼š<code>Host=**.testhost.org</code></p>
</li>
<li><p>åŸºäºMethodè¯·æ±‚æ–¹æ³•çš„æ–­è¨€å·¥å‚</p>
<p>MethodRoutePredicateFactoryï¼šæ¥æ”¶ä¸€ä¸ªå‚æ•°ï¼Œåˆ¤æ–­è¯·æ±‚ç±»å‹æ˜¯å¦è·ŸæŒ‡å®šçš„ç±»å‹åŒ¹é…ã€‚</p>
<p>ç¤ºä¾‹ï¼š<code>Method=GET</code></p>
</li>
<li><p>åŸºäºPathè¯·æ±‚è·¯å¾„çš„æ–­è¨€å·¥å‚</p>
<p>PathRoutePredicateFactoryï¼šæ¥æ”¶ä¸€ä¸ªå‚æ•°ï¼Œåˆ¤æ–­è¯·æ±‚çš„URIéƒ¨åˆ†æ˜¯å¦æ»¡è¶³è·¯å¾„è§„åˆ™ã€‚</p>
<p>ç¤ºä¾‹ï¼š<code>Path=/foo/{segment}</code></p>
</li>
<li><p>åŸºäºQueryè¯·æ±‚å‚æ•°çš„æ–­è¨€å·¥å‚</p>
<p>QueryRoutePredicateFactory ï¼šæ¥æ”¶ä¸¤ä¸ªå‚æ•°ï¼Œè¯·æ±‚paramå’Œæ­£åˆ™è¡¨è¾¾å¼ï¼Œ åˆ¤æ–­è¯·æ±‚å‚æ•°æ˜¯å¦å…·æœ‰ç»™å®šåç§°ä¸”å€¼ä¸æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ã€‚</p>
<p>ç¤ºä¾‹ï¼š<code>Query=baz, ba.</code></p>
</li>
<li><p>åŸºäºè·¯ç”±æƒé‡çš„æ–­è¨€å·¥å‚</p>
<p>WeightRoutePredicateFactoryï¼šæ¥æ”¶ä¸€ä¸ª[ç»„å,æƒé‡], ç„¶åå¯¹äºåŒä¸€ä¸ªç»„å†…çš„è·¯ç”±æŒ‰ç…§æƒé‡è½¬å‘</p>
<p>ç¤ºä¾‹:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">routes:</span></span><br><span class="line"><span class="attr">  - id:</span> <span class="string">weight_route1</span> </span><br><span class="line"><span class="attr">    uri:</span> <span class="string">host1</span></span><br><span class="line"><span class="attr">    predicates:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">Path=/product/**</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">Weight=group3,</span> <span class="number">1</span></span><br><span class="line"><span class="attr">  - id:</span> <span class="string">weight_route2</span></span><br><span class="line"><span class="attr">    uri:</span> <span class="string">host2</span></span><br><span class="line"><span class="attr">    predicates:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">Path=/product/**</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">Weight=</span> <span class="string">group3,</span> <span class="number">9</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="è‡ªå®šä¹‰è·¯ç”±æ–­è¨€å·¥å‚"><a href="#è‡ªå®šä¹‰è·¯ç”±æ–­è¨€å·¥å‚" class="headerlink" title="è‡ªå®šä¹‰è·¯ç”±æ–­è¨€å·¥å‚"></a>è‡ªå®šä¹‰è·¯ç”±æ–­è¨€å·¥å‚</h4><ol>
<li><p>æ–°å¢è‡ªå®šä¹‰æ–­è¨€é…ç½®</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">gateway:</span></span><br><span class="line"><span class="attr">  routes:</span></span><br><span class="line"><span class="attr">    - id:</span> <span class="string">product_route</span></span><br><span class="line"><span class="attr">      uri:</span> <span class="attr">lb://service-product</span></span><br><span class="line"><span class="attr">      order:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">      predicates:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">Path=/product-serv/**</span></span><br><span class="line">        <span class="comment"># æ–°å¢çš„è‡ªå®šä¹‰æ–­è¨€é…ç½®</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">Age=20,80</span></span><br><span class="line"><span class="attr">      filters:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">StripPrefix=1</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>ç¼–å†™è‡ªå®šä¹‰æ–­è¨€ç±»</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.springcloud.alibaba.predicates;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.handler.predicate.AbstractRoutePredicateFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.handler.predicate.AfterRoutePredicateFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.handler.predicate.BeforeRoutePredicateFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.server.ServerWebExchange;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.time.ZonedDateTime;</span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.function.Predicate;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Ageè‡ªå®šä¹‰æ–­è¨€ç±»</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * è‡ªå®šä¹‰æ–­è¨€ç±»å‘½åè§„èŒƒï¼šé…ç½®é¡¹ + RoutePredicateFactory</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AgeRoutePredicateFactory</span> <span class="keyword">extends</span> <span class="title">AbstractRoutePredicateFactory</span>&lt;<span class="title">AgeRoutePredicateFactory</span>.<span class="title">Config</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">AgeRoutePredicateFactory</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(AgeRoutePredicateFactory.Config.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">shortcutFieldOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Arrays.asList(<span class="string">"minAge"</span>, <span class="string">"maxAge"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Predicate&lt;ServerWebExchange&gt; <span class="title">apply</span><span class="params">(Config config)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (exchange) -&gt; &#123;</span><br><span class="line">            <span class="comment">// è·å–è¯·æ±‚å‚æ•°age</span></span><br><span class="line">            String ageString = exchange.getRequest().getQueryParams().getFirst(<span class="string">"age"</span>);</span><br><span class="line">            <span class="keyword">if</span> (StringUtils.isBlank(ageString)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// åˆ¤æ–­age</span></span><br><span class="line">            <span class="keyword">int</span> age = Integer.parseInt(ageString);</span><br><span class="line">            <span class="keyword">return</span> age &gt; config.minAge &amp;&amp; age &lt; config.maxAge;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Config</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> minAge;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> maxAge;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>æµ‹è¯•ä¼šå‘ç°ï¼Œå½“ä¸ä¼ Ageå‚æ•°æˆ–è€…Ageçš„å‚æ•°å€¼ä¸åœ¨20-80ä¹‹é—´æ—¶ï¼Œå°±ä¼šç›´æ¥è·³è½¬åˆ°é”™è¯¯é¡µé¢ã€‚åä¹‹åˆ™æ­£å¸¸è¿”å›æ•°æ®</p>
</li>
</ol>
<h3 id="è¿‡æ»¤å™¨"><a href="#è¿‡æ»¤å™¨" class="headerlink" title="è¿‡æ»¤å™¨"></a>è¿‡æ»¤å™¨</h3><p>åœ¨Gatewayä¸­, Filterçš„ç”Ÿå‘½å‘¨æœŸåªæœ‰ä¸¤ä¸ªï¼š<code>Pre</code> å’Œ <code>Post</code></p>
<ul>
<li><p><strong>Pre</strong></p>
<p>è¿™ç§è¿‡æ»¤å™¨åœ¨è¯·æ±‚è¢«è·¯ç”±ä¹‹å‰è°ƒç”¨ã€‚æˆ‘ä»¬å¯åˆ©ç”¨è¿™ç§è¿‡æ»¤å™¨å®ç°èº«ä»½éªŒè¯ã€åœ¨é›†ç¾¤ä¸­é€‰æ‹©è¯·æ±‚çš„å¾®æœåŠ¡ã€è®°å½•è°ƒè¯•ä¿¡æ¯ç­‰ã€‚</p>
</li>
<li><p><code>Post</code></p>
<p>è¿™ç§è¿‡æ»¤å™¨åœ¨è·¯ç”±åˆ°å¾®æœåŠ¡ä»¥åæ‰§è¡Œã€‚è¿™ç§è¿‡æ»¤å™¨å¯ç”¨æ¥ä¸ºå“åº”æ·»åŠ æ ‡å‡†çš„HTTP Headerã€æ”¶é›†ç»Ÿè®¡ä¿¡æ¯å’ŒæŒ‡æ ‡ã€å°†å“åº”ä»å¾®æœåŠ¡å‘é€ç»™å®¢æˆ·ç«¯ç­‰ã€‚</p>
</li>
</ul>
<p>Gateway çš„Filterä»ä½œç”¨èŒƒå›´å¯åˆ†ä¸ºä¸¤ç§: <code>GatewayFilter</code>ä¸<code>GlobalFilter</code>ã€‚</p>
<ul>
<li><p><strong>GatewayFilter</strong></p>
<p>åº”ç”¨åˆ°å•ä¸ªè·¯ç”±æˆ–è€…ä¸€ä¸ªåˆ†ç»„çš„è·¯ç”±ä¸Šã€‚</p>
</li>
<li><p><strong>GlobalFilter</strong></p>
<p>åº”ç”¨åˆ°æ‰€æœ‰çš„è·¯ç”±ä¸Šã€‚</p>
</li>
</ul>
<h4 id="å±€éƒ¨è¿‡æ»¤å™¨"><a href="#å±€éƒ¨è¿‡æ»¤å™¨" class="headerlink" title="å±€éƒ¨è¿‡æ»¤å™¨"></a>å±€éƒ¨è¿‡æ»¤å™¨</h4><ul>
<li><p>Spring Gatewayå†…ç½®å…·å¤‡è¿‡æ»¤å™¨</p>
<p> åœ¨SpringCloud Gatewayä¸­å†…ç½®äº†å¾ˆå¤šä¸åŒç±»å‹çš„ç½‘å…³è·¯ç”±è¿‡æ»¤å™¨ã€‚å…·ä½“å¦‚ä¸‹ï¼š</p>
<p> | è¿‡æ»¤å™¨å·¥å‚ç±»                | ä½œç”¨                                                         | å‚æ•°                                                         |<br> | â€”â€”â€”â€”â€”â€”â€”â€”â€” | â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” | â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€” |<br> | AddRequestHeader            | ä¸ºåŸå§‹è¯·æ±‚æ·»åŠ Header                                         | Headerçš„åç§°åŠå€¼                                             |<br> | AddRequestParameter         | ä¸ºåŸå§‹è¯·æ±‚æ·»åŠ è¯·æ±‚å‚æ•°                                       | å‚æ•°åç§°åŠå€¼                                                 |<br> | AddResponseHeader           | ä¸ºåŸå§‹å“åº”æ·»åŠ Header                                         | Headerçš„åç§°åŠå€¼                                             |<br> | DedupeResponseHeader        | å‰”é™¤å“åº”å¤´ä¸­é‡å¤çš„å€¼                                         | éœ€è¦å»é‡çš„Headeråç§°åŠå»é‡ç­–ç•¥                               |<br> | Hystrix                     | ä¸ºè·¯ç”±å¼•å…¥Hystrixçš„æ–­è·¯å™¨ä¿æŠ¤                                | HystrixCommandçš„åç§°                                         |<br> | FallbackHeaders             | ä¸ºfallbackUriçš„è¯·æ±‚å¤´ä¸­æ·»åŠ å…·ä½“çš„å¼‚å¸¸ä¿¡æ¯                    | Headerçš„åç§°                                                 |<br> | PrefixPath                  | ä¸ºåŸå§‹è¯·æ±‚è·¯å¾„æ·»åŠ å‰ç¼€                                       | å‰ç¼€è·¯å¾„                                                     |<br> | PreserveHostHeader          | ä¸ºè¯·æ±‚æ·»åŠ ä¸€ä¸ªpreserveHostHeader=trueçš„å±æ€§ï¼Œè·¯ç”±è¿‡æ»¤å™¨ä¼šæ£€æŸ¥è¯¥å±æ€§ä»¥å†³å®šæ˜¯å¦è¦å‘é€åŸå§‹çš„Host | æ—                                                            |<br> | RequestRateLimiter          | ç”¨äºå¯¹è¯·æ±‚é™æµï¼Œé™æµç®—æ³•ä¸ºä»¤ç‰Œæ¡¶                             | keyResolverã€rateLimiterã€statusCodeã€denyEmptyKeyã€emptyKeyStatus |<br> | RedirectTo                  | å°†åŸå§‹è¯·æ±‚é‡å®šå‘åˆ°æŒ‡å®šçš„URL                                  | httpçŠ¶æ€ç åŠé‡å®šå‘çš„url                                      |<br> | RemoveHopByHopHeadersFilter | ä¸ºåŸå§‹è¯·æ±‚åˆ é™¤IETFç»„ç»‡è§„å®šçš„ä¸€ç³»åˆ—Header                     | é»˜è®¤å°±ä¼šå¯ç”¨ï¼Œå¯ä»¥é€šè¿‡é…ç½®æŒ‡å®šä»…åˆ é™¤å“ªäº›Header               |<br> | RemoveRequestHeader         | ä¸ºåŸå§‹è¯·æ±‚åˆ é™¤æŸä¸ªHeader                                     | Headeråç§°                                                   |<br> | RemoveResponseHeader        | ä¸ºåŸå§‹å“åº”åˆ é™¤æŸä¸ªHeader                                     | Headeråç§°                                                   |<br> | RewritePath                 | é‡å†™åŸå§‹çš„è¯·æ±‚è·¯å¾„                                           | åŸå§‹è·¯å¾„æ­£åˆ™è¡¨è¾¾å¼ä»¥åŠé‡å†™åè·¯å¾„çš„æ­£åˆ™è¡¨è¾¾å¼                 |<br> | RewriteResponseHeader       | é‡å†™åŸå§‹å“åº”ä¸­çš„æŸä¸ªHeader                                   | Headeråç§°ï¼Œå€¼çš„æ­£åˆ™è¡¨è¾¾å¼ï¼Œé‡å†™åçš„å€¼                       |<br> | SaveSession                 | åœ¨è½¬å‘è¯·æ±‚ä¹‹å‰ï¼Œå¼ºåˆ¶æ‰§è¡ŒWebSession::saveæ“ä½œ                 | æ—                                                            |<br> | secureHeaders               | ä¸ºåŸå§‹å“åº”æ·»åŠ ä¸€ç³»åˆ—èµ·å®‰å…¨ä½œç”¨çš„å“åº”å¤´                       | æ— ï¼Œæ”¯æŒä¿®æ”¹è¿™äº›å®‰å…¨å“åº”å¤´çš„å€¼                               |<br> | SetPath                     | ä¿®æ”¹åŸå§‹çš„è¯·æ±‚è·¯å¾„                                           | ä¿®æ”¹åçš„è·¯å¾„                                                 |<br> | SetResponseHeader           | ä¿®æ”¹åŸå§‹å“åº”ä¸­æŸä¸ªHeaderçš„å€¼                                 | Headeråç§°ï¼Œä¿®æ”¹åçš„å€¼                                       |<br> | SetStatus                   | ä¿®æ”¹åŸå§‹å“åº”çš„çŠ¶æ€ç                                          | HTTP çŠ¶æ€ç ï¼Œå¯ä»¥æ˜¯æ•°å­—ï¼Œä¹Ÿå¯ä»¥æ˜¯å­—ç¬¦ä¸²                      |<br> | StripPrefix                 | ç”¨äºæˆªæ–­åŸå§‹è¯·æ±‚çš„è·¯å¾„                                       | ä½¿ç”¨æ•°å­—è¡¨ç¤ºè¦æˆªæ–­çš„è·¯å¾„çš„æ•°é‡                               |<br> | Retry                       | é’ˆå¯¹ä¸åŒçš„å“åº”è¿›è¡Œé‡è¯•                                       | retriesã€statusesã€methodsã€series                           |<br> | RequestSize                 | è®¾ç½®å…è®¸æ¥æ”¶æœ€å¤§è¯·æ±‚åŒ…çš„å¤§å°ã€‚å¦‚æœè¯·æ±‚åŒ…å¤§å°è¶…è¿‡è®¾ç½®çš„&lt;å€¼ï¼Œåˆ™è¿”å› 413 Payload TooLarge | è¯·æ±‚åŒ…å¤§å°ï¼Œå•ä½ä¸ºå­—èŠ‚ï¼Œé»˜è®¤å€¼ä¸º5M                           |<br> | ModifyRequestBody           | åœ¨è½¬å‘è¯·æ±‚ä¹‹å‰ä¿®æ”¹åŸå§‹è¯·æ±‚ä½“å†…å®¹                             | ä¿®æ”¹åçš„è¯·æ±‚ä½“å†…å®¹                                           |<br> | ModifyResponseBody          | ä¿®æ”¹åŸå§‹å“åº”ä½“çš„å†…å®¹                                         | ä¿®æ”¹åçš„å“åº”ä½“å†…å®¹                                           |</p>
<p> å…·ä½“ä½¿ç”¨ï¼Œå»ºè®®ç™¾åº¦ã€‚</p>
</li>
<li><p>è‡ªå®šä¹‰å…·å¤‡è¿‡æ»¤å™¨</p>
<p> è‡ªå®šä¹‰è¿‡æ»¤å™¨çš„æ–¹å¼å’Œè‡ªå®šä¹‰æ–­è¨€å·¥å‚ç±»æ–¹æ³•ç±»ä¼¼</p>
<ol>
<li><p>æ–°å¢è‡ªå®šä¹‰è¿‡æ»¤å™¨é…ç½®</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">gateway:</span></span><br><span class="line"><span class="attr">  routes:</span></span><br><span class="line"><span class="attr">    - id:</span> <span class="string">product_route</span></span><br><span class="line"><span class="attr">      uri:</span> <span class="attr">lb://service-product</span></span><br><span class="line"><span class="attr">      order:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">      predicates:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">Path=/product-serv/**</span></span><br><span class="line"><span class="attr">      filters:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">StripPrefix=1</span></span><br><span class="line">        <span class="comment"># æ–°å¢è‡ªå®šä¹‰è¿‡æ»¤å™¨é…ç½®</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">Log=true,false</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>ç¼–å†™è‡ªå®šä¹‰è¿‡æ»¤å™¨ç±»</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.springcloud.alibaba.filter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.filter.GatewayFilter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.filter.factory.AbstractGatewayFilterFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è‡ªå®šä¹‰å±€éƒ¨è¿‡æ»¤å™¨</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * è¿‡æ»¤å™¨å‘½åè§„åˆ™ï¼šé…ç½®é¡¹ + GatewayFilterFactory</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LogGatewayFilterFactory</span> <span class="keyword">extends</span> <span class="title">AbstractGatewayFilterFactory</span>&lt;<span class="title">LogGatewayFilterFactory</span>.<span class="title">Config</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">shortcutFieldOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Arrays.asList(<span class="string">"consoleLog"</span>, <span class="string">"cacheLog"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> GatewayFilter <span class="title">apply</span><span class="params">(Config config)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (exchange, chain) -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (config.consoleLog) &#123;</span><br><span class="line">                log.info(<span class="string">"å¼€å¯ConsoleLog...."</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (config.cacheLog) &#123;</span><br><span class="line">                log.info(<span class="string">"å¼€å¯CacheLog...."</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Config</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">boolean</span> consoleLog;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">boolean</span> cacheLog;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>æµ‹è¯•</p>
<p>æ³¨æ„è§‚å¯Ÿæ§åˆ¶å°æ‰“å°çš„æ—¥å¿—ã€‚</p>
</li>
</ol>
</li>
</ul>
<h4 id="å…¨å±€è¿‡æ»¤å™¨"><a href="#å…¨å±€è¿‡æ»¤å™¨" class="headerlink" title="å…¨å±€è¿‡æ»¤å™¨"></a>å…¨å±€è¿‡æ»¤å™¨</h4><p>   å…¨å±€è¿‡æ»¤å™¨ä½œç”¨äºæ‰€æœ‰è·¯ç”±, æ— éœ€é…ç½®ã€‚é€šè¿‡å…¨å±€è¿‡æ»¤å™¨å¯ä»¥å®ç°å¯¹æƒé™çš„ç»Ÿä¸€æ ¡éªŒï¼Œå®‰å…¨æ€§éªŒè¯ç­‰åŠŸèƒ½ã€‚</p>
<ul>
<li><p>Spring Gatewayå†…ç½®å…¨å±€è¿‡æ»¤å™¨</p>
<p><img src="https://imxushuai-blog.oss-cn-chengdu.aliyuncs.com/springgateway%E5%86%85%E7%BD%AE%E5%85%A8%E5%B1%80%E8%BF%87%E6%BB%A4%E5%99%A8.jpg" alt></p>
</li>
<li><p>è‡ªå®šä¹‰å…¨å±€è¿‡æ»¤å™¨</p>
<p>å†…ç½®çš„è¿‡æ»¤å™¨å·²ç»å¯ä»¥å®Œæˆå¤§éƒ¨åˆ†çš„åŠŸèƒ½ï¼Œä½†æ˜¯å¯¹äºä¼ä¸šå¼€å‘çš„ä¸€äº›ä¸šåŠ¡åŠŸèƒ½å¤„ç†ï¼Œè¿˜æ˜¯éœ€è¦æˆ‘ä»¬è‡ªå·±ç¼–å†™è¿‡æ»¤å™¨æ¥å®ç°çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¸€èµ·é€šè¿‡ä»£ç çš„å½¢å¼è‡ªå®šä¹‰ä¸€ä¸ªè¿‡æ»¤å™¨ï¼Œå»å®Œæˆç»Ÿä¸€çš„æƒé™æ ¡éªŒã€‚</p>
<p>å¼€å‘ä¸­çš„é‰´æƒé€»è¾‘ï¼š</p>
<ul>
<li>å½“å®¢æˆ·ç«¯ç¬¬ä¸€æ¬¡è¯·æ±‚æœåŠ¡æ—¶ï¼ŒæœåŠ¡ç«¯å¯¹ç”¨æˆ·è¿›è¡Œä¿¡æ¯è®¤è¯ï¼ˆç™»å½•ï¼‰</li>
<li>è®¤è¯é€šè¿‡ï¼Œå°†ç”¨æˆ·ä¿¡æ¯è¿›è¡ŒåŠ å¯†å½¢æˆtokenï¼Œè¿”å›ç»™å®¢æˆ·ç«¯ï¼Œä½œä¸ºç™»å½•å‡­è¯</li>
<li>ä»¥åæ¯æ¬¡è¯·æ±‚ï¼Œå®¢æˆ·ç«¯éƒ½æºå¸¦è®¤è¯çš„token</li>
<li>æœåŠ¡ç«¯å¯¹tokenè¿›è¡Œè§£å¯†ï¼Œåˆ¤æ–­æ˜¯å¦æœ‰æ•ˆ</li>
</ul>
<p><img src="https://imxushuai-blog.oss-cn-chengdu.aliyuncs.com/springcloudalibaba%E9%89%B4%E6%9D%83%E6%B5%81%E7%A8%8B%E7%A4%BA%E4%BE%8B.jpg" alt></p>
<p>æˆ‘ä»¬è‡ªå®šä¹‰ä¸€ä¸ªè¿‡æ»¤å™¨æ¥å®Œæˆç±»ä¼¼æ“ä½œ</p>
<p>å…¨å±€è¿‡æ»¤å™¨æ¯”å±€éƒ¨è¿‡æ»¤å™¨è¯ç®€å•ä¸€äº›ï¼Œç›´æ¥å®šä¹‰è¿‡æ»¤å™¨ç±»å°±OK</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.springcloud.alibaba.filter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.lang3.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.filter.GatewayFilterChain;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.filter.GlobalFilter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.Ordered;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.server.ServerWebExchange;</span><br><span class="line"><span class="keyword">import</span> reactor.core.publisher.Mono;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthGlobalFilterFactory</span> <span class="keyword">implements</span> <span class="title">GlobalFilter</span>, <span class="title">Ordered</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è‡ªå®šä¹‰çš„è¿‡æ»¤å™¨ä¸šåŠ¡é€»è¾‘</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> </span>&#123;</span><br><span class="line">        String token = exchange.getRequest().getQueryParams().getFirst(<span class="string">"token"</span>);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(token)) &#123;<span class="comment">// é‰´æƒå¤±è´¥</span></span><br><span class="line">            log.error(<span class="string">"éæ³•ç”¨æˆ·...."</span>);</span><br><span class="line">            exchange.getResponse().setStatusCode(HttpStatus.UNAUTHORIZED);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> exchange.getResponse().setComplete();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// é‰´æƒæˆåŠŸ, æ‰§è¡Œä¸€ç³»åˆ—ä¸šåŠ¡....</span></span><br><span class="line">        <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¿‡æ»¤å™¨çš„ä¼˜å…ˆçº§, å€¼è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> orderValue</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="ç½‘å…³é™æµ"><a href="#ç½‘å…³é™æµ" class="headerlink" title="ç½‘å…³é™æµ"></a>ç½‘å…³é™æµ</h3><p>ç½‘å…³æ˜¯æ‰€æœ‰è¯·æ±‚çš„å…¬å…±å…¥å£ï¼Œæ‰€ä»¥å¯ä»¥åœ¨ç½‘å…³è¿›è¡Œé™æµï¼Œè€Œä¸”é™æµçš„æ–¹å¼ä¹Ÿå¾ˆå¤šï¼Œæˆ‘ä»¬æœ¬æ¬¡é‡‡ç”¨å‰é¢å­¦è¿‡çš„Sentinelç»„ä»¶æ¥å®ç°ç½‘å…³çš„é™æµã€‚Sentinelæ”¯æŒå¯¹SpringCloud Gatewayã€Zuulç­‰ä¸»æµç½‘å…³è¿›è¡Œé™æµã€‚</p>
<p><img src="https://imxushuai-blog.oss-cn-chengdu.aliyuncs.com/sentinel%E7%BD%91%E5%85%B3%E9%99%90%E6%B5%81.jpg" alt></p>
<p>ä»1.6.0ç‰ˆæœ¬å¼€å§‹ï¼ŒSentinelæä¾›äº†SpringCloud Gatewayçš„é€‚é…æ¨¡å—ï¼Œå¯ä»¥æä¾›ä¸¤ç§èµ„æºç»´åº¦çš„é™æµï¼š</p>
<ul>
<li><strong>routeç»´åº¦</strong>ï¼šå³åœ¨Springé…ç½®æ–‡ä»¶ä¸­é…ç½®çš„è·¯ç”±æ¡ç›®ï¼Œèµ„æºåä¸ºå¯¹åº”çš„routeId</li>
<li><strong>è‡ªå®šä¹‰APIç»´åº¦</strong>ï¼šç”¨æˆ·å¯ä»¥åˆ©ç”¨Sentinelæä¾›çš„APIæ¥è‡ªå®šä¹‰ä¸€äº›APIåˆ†ç»„</li>
</ul>
<h4 id="Routeç»´åº¦é™æµ"><a href="#Routeç»´åº¦é™æµ" class="headerlink" title="Routeç»´åº¦é™æµ"></a>Routeç»´åº¦é™æµ</h4><ol>
<li><p>å¼•å…¥ä¾èµ–</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.csp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sentinel-spring-cloud-gateway-adapter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>ç¼–å†™é…ç½®ç±»</p>
<p>åŸºäºSentinel çš„Gatewayé™æµæ˜¯é€šè¿‡å…¶æä¾›çš„Filteræ¥å®Œæˆçš„ï¼Œä½¿ç”¨æ—¶åªéœ€æ³¨å…¥å¯¹åº”çš„SentinelGatewayFilterå®ä¾‹ä»¥åŠ SentinelGatewayBlockExceptionHandler å®ä¾‹å³å¯ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.springcloud.alibaba.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.csp.sentinel.adapter.gateway.common.rule.GatewayFlowRule;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.csp.sentinel.adapter.gateway.common.rule.GatewayRuleManager;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.csp.sentinel.adapter.gateway.sc.SentinelGatewayFilter;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.csp.sentinel.adapter.gateway.sc.callback.BlockRequestHandler;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.csp.sentinel.adapter.gateway.sc.callback.GatewayCallbackManager;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.csp.sentinel.adapter.gateway.sc.exception.SentinelGatewayBlockExceptionHandler;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.ObjectProvider;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.filter.GlobalFilter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.Ordered;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.annotation.Order;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.codec.ServerCodecConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.reactive.function.BodyInserters;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.reactive.function.server.ServerResponse;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.reactive.result.view.ViewResolver;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.PostConstruct;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GatewayRouteFilterConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;ViewResolver&gt; viewResolvers;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ServerCodecConfigurer serverCodecConfigurer;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GatewayRouteFilterConfiguration</span><span class="params">(ObjectProvider&lt;List&lt;ViewResolver&gt;&gt; viewResolversProvider, ServerCodecConfigurer serverCodecConfigurer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.viewResolvers = viewResolversProvider.getIfAvailable(Collections::emptyList);</span><br><span class="line">        <span class="keyword">this</span>.serverCodecConfigurer = serverCodecConfigurer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆå§‹åŒ–é™æµè¿‡æ»¤å™¨</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Order</span>(Ordered.HIGHEST_PRECEDENCE)<span class="comment">// æœ€é«˜ä¼˜å…ˆçº§</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> GlobalFilter <span class="title">sentinelGatewayFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SentinelGatewayFilter();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é…ç½®é™æµçš„å¼‚å¸¸å¤„ç†å™¨</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Order</span>(Ordered.HIGHEST_PRECEDENCE)<span class="comment">// æœ€é«˜ä¼˜å…ˆçº§</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SentinelGatewayBlockExceptionHandler <span class="title">sentinelGatewayBlockExceptionHandler</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SentinelGatewayBlockExceptionHandler(viewResolvers, serverCodecConfigurer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆå§‹åŒ–é™æµè§„åˆ™</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initGatewayRules</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Set&lt;GatewayFlowRule&gt; rules = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">        rules.add(</span><br><span class="line">                <span class="keyword">new</span> GatewayFlowRule(<span class="string">"product_route"</span>) <span class="comment">//èµ„æºåç§°,å¯¹åº”è·¯ç”±id</span></span><br><span class="line">                        .setCount(<span class="number">1</span>) <span class="comment">// é™æµé˜ˆå€¼</span></span><br><span class="line">                        .setIntervalSec(<span class="number">1</span>) <span class="comment">// ç»Ÿè®¡æ—¶é—´çª—å£ï¼Œå•ä½æ˜¯ç§’ï¼Œé»˜è®¤æ˜¯ 1 ç§’</span></span><br><span class="line">                );</span><br><span class="line">        GatewayRuleManager.loadRules(rules);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è‡ªå®šä¹‰é™æµå¼‚å¸¸é¡µé¢</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initBlockHandlers</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        BlockRequestHandler blockRequestHandler = (serverWebExchange, throwable) -&gt; &#123;</span><br><span class="line">            Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">            map.put(<span class="string">"code"</span>, <span class="number">0</span>);</span><br><span class="line">            map.put(<span class="string">"message"</span>, <span class="string">"æ¥å£è¢«é™æµäº†"</span>);</span><br><span class="line">            <span class="keyword">return</span> ServerResponse.status(HttpStatus.OK).</span><br><span class="line">                    contentType(MediaType.APPLICATION_JSON_UTF8).</span><br><span class="line">                    body(BodyInserters.fromObject(map));</span><br><span class="line">        &#125;;</span><br><span class="line">        GatewayCallbackManager.setBlockHandler(blockRequestHandler);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>æµ‹è¯•</p>
<p>å¤šæ¬¡åˆ·æ–°ç•Œé¢ï¼Œå¯ä»¥çœ‹åˆ°è¢«é™æµçš„è¿”å›å€¼</p>
<p><img src="https://imxushuai-blog.oss-cn-chengdu.aliyuncs.com/QQ%E5%9B%BE%E7%89%8720210516224551.png" alt></p>
</li>
</ol>
<h4 id="APIç»´åº¦é™æµ"><a href="#APIç»´åº¦é™æµ" class="headerlink" title="APIç»´åº¦é™æµ"></a>APIç»´åº¦é™æµ</h4><p>è‡ªå®šä¹‰APIåˆ†ç»„æ˜¯ä¸€ç§æ›´ç»†ç²’åº¦çš„é™æµè§„åˆ™å®šä¹‰</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.springcloud.alibaba.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.csp.sentinel.adapter.gateway.common.SentinelGatewayConstants;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.csp.sentinel.adapter.gateway.common.api.ApiDefinition;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.csp.sentinel.adapter.gateway.common.api.ApiPathPredicateItem;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.csp.sentinel.adapter.gateway.common.api.ApiPredicateItem;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.csp.sentinel.adapter.gateway.common.api.GatewayApiDefinitionManager;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.csp.sentinel.adapter.gateway.common.rule.GatewayFlowRule;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.csp.sentinel.adapter.gateway.common.rule.GatewayRuleManager;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.csp.sentinel.adapter.gateway.sc.SentinelGatewayFilter;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.csp.sentinel.adapter.gateway.sc.callback.BlockRequestHandler;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.csp.sentinel.adapter.gateway.sc.callback.GatewayCallbackManager;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.csp.sentinel.adapter.gateway.sc.exception.SentinelGatewayBlockExceptionHandler;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.ObjectProvider;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.gateway.filter.GlobalFilter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.Ordered;</span><br><span class="line"><span class="keyword">import</span> org.springframework.core.annotation.Order;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.codec.ServerCodecConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.reactive.function.BodyInserters;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.reactive.function.server.ServerResponse;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.reactive.result.view.ViewResolver;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.PostConstruct;</span><br><span class="line"><span class="keyword">import</span> java.util.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GatewayApiFilterConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;ViewResolver&gt; viewResolvers;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ServerCodecConfigurer serverCodecConfigurer;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GatewayApiFilterConfiguration</span><span class="params">(ObjectProvider&lt;List&lt;ViewResolver&gt;&gt; viewResolversProvider, ServerCodecConfigurer serverCodecConfigurer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.viewResolvers = viewResolversProvider.getIfAvailable(Collections::emptyList);</span><br><span class="line">        <span class="keyword">this</span>.serverCodecConfigurer = serverCodecConfigurer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆå§‹åŒ–é™æµè¿‡æ»¤å™¨</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Order</span>(Ordered.HIGHEST_PRECEDENCE)<span class="comment">// æœ€é«˜ä¼˜å…ˆçº§</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> GlobalFilter <span class="title">sentinelGatewayFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SentinelGatewayFilter();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é…ç½®é™æµçš„å¼‚å¸¸å¤„ç†å™¨</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Order</span>(Ordered.HIGHEST_PRECEDENCE)<span class="comment">// æœ€é«˜ä¼˜å…ˆçº§</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SentinelGatewayBlockExceptionHandler <span class="title">sentinelGatewayBlockExceptionHandler</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SentinelGatewayBlockExceptionHandler(viewResolvers, serverCodecConfigurer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åˆå§‹åŒ–é™æµè§„åˆ™</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initGatewayRules</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Set&lt;GatewayFlowRule&gt; rules = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">        rules.add(<span class="keyword">new</span> GatewayFlowRule(<span class="string">"product_api1"</span>).setCount(<span class="number">1</span>).setIntervalSec(<span class="number">1</span>));</span><br><span class="line">        rules.add(<span class="keyword">new</span> GatewayFlowRule(<span class="string">"product_api2"</span>).setCount(<span class="number">1</span>).setIntervalSec(<span class="number">1</span>));</span><br><span class="line">        GatewayRuleManager.loadRules(rules);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å®šä¹‰éœ€è¦API</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initCustomizedApis</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Set&lt;ApiDefinition&gt; definitions = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ–°å¢æ–­è¨€é¡¹1</span></span><br><span class="line">        HashSet&lt;ApiPredicateItem&gt; apiPredicateItems1 = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">        ApiPathPredicateItem apiPathPredicateItem1 = <span class="keyword">new</span> ApiPathPredicateItem()</span><br><span class="line">                .setPattern(<span class="string">"/product-serv/product/api1/**"</span>)</span><br><span class="line">                .setMatchStrategy(SentinelGatewayConstants.URL_MATCH_STRATEGY_PREFIX);</span><br><span class="line">        apiPredicateItems1.add(apiPathPredicateItem1);</span><br><span class="line">        ApiDefinition api1 = <span class="keyword">new</span> ApiDefinition(<span class="string">"product_api1"</span>).setPredicateItems(apiPredicateItems1);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ–°å¢æ–­è¨€é¡¹2</span></span><br><span class="line">        HashSet&lt;ApiPredicateItem&gt; apiPredicateItems2 = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">        ApiPathPredicateItem apiPathPredicateItem2 = <span class="keyword">new</span> ApiPathPredicateItem()</span><br><span class="line">                .setPattern(<span class="string">"/product-serv/product/api2/**"</span>)</span><br><span class="line">                .setMatchStrategy(SentinelGatewayConstants.URL_MATCH_STRATEGY_PREFIX);</span><br><span class="line">        apiPredicateItems1.add(apiPathPredicateItem2);</span><br><span class="line">        ApiDefinition api2 = <span class="keyword">new</span> ApiDefinition(<span class="string">"product_api2"</span>)</span><br><span class="line">                .setPredicateItems(apiPredicateItems2);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ·»åŠ åˆ°APIå®šä¹‰åˆ—è¡¨ä¸­</span></span><br><span class="line">        definitions.add(api1);</span><br><span class="line">        definitions.add(api2);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å°†APIåˆ—è¡¨åŠ è½½åˆ°gatewayä¸­</span></span><br><span class="line">        GatewayApiDefinitionManager.loadApiDefinitions(definitions);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è‡ªå®šä¹‰é™æµå¼‚å¸¸é¡µé¢</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initBlockHandlers</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        BlockRequestHandler blockRequestHandler = (serverWebExchange, throwable) -&gt; &#123;</span><br><span class="line">            Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">            map.put(<span class="string">"code"</span>, <span class="number">0</span>);</span><br><span class="line">            map.put(<span class="string">"message"</span>, <span class="string">"æ¥å£è¢«é™æµäº†"</span>);</span><br><span class="line">            <span class="keyword">return</span> ServerResponse.status(HttpStatus.OK).</span><br><span class="line">                    contentType(MediaType.APPLICATION_JSON_UTF8).</span><br><span class="line">                    body(BodyInserters.fromObject(map));</span><br><span class="line">        &#125;;</span><br><span class="line">        GatewayCallbackManager.setBlockHandler(blockRequestHandler);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨<code>ProductController</code>ä¸­æ–°å¢æ¥å£</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"product/api1/&#123;string&#125;"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> JSONObject <span class="title">productApi1</span><span class="params">(@PathVariable String string)</span> </span>&#123;</span><br><span class="line">    JSONObject result = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    result.put(<span class="string">"message"</span>, <span class="string">"call product api1, param = "</span> + string);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"product/api2/&#123;string&#125;"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> JSONObject <span class="title">productApi2</span><span class="params">(@PathVariable String string)</span> </span>&#123;</span><br><span class="line">    JSONObject result = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    result.put(<span class="string">"message"</span>, <span class="string">"call product api2, param = "</span> + string);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æµ‹è¯•é™æµæ•ˆæœ</p>
<ul>
<li>æ­£å¸¸çš„è¿”å›</li>
</ul>
<p><img src="https://imxushuai-blog.oss-cn-chengdu.aliyuncs.com/QQ%E6%88%AA%E5%9B%BE20210516225937.png" alt></p>
<ul>
<li><p>å¿«é€Ÿåˆ·æ–°ï¼Œé™æµè¿”å›</p>
<p><img src="https://imxushuai-blog.oss-cn-chengdu.aliyuncs.com/QQ%E6%88%AA%E5%9B%BE20210516230013.png" alt></p>
</li>
</ul>
<h2 id="é“¾è·¯è¿½è¸ªï¼ˆSleuth-Zipkinï¼‰"><a href="#é“¾è·¯è¿½è¸ªï¼ˆSleuth-Zipkinï¼‰" class="headerlink" title="é“¾è·¯è¿½è¸ªï¼ˆSleuth + Zipkinï¼‰"></a>é“¾è·¯è¿½è¸ªï¼ˆSleuth + Zipkinï¼‰</h2><h3 id="é“¾è·¯è¿½è¸ªç®€ä»‹"><a href="#é“¾è·¯è¿½è¸ªç®€ä»‹" class="headerlink" title="é“¾è·¯è¿½è¸ªç®€ä»‹"></a>é“¾è·¯è¿½è¸ªç®€ä»‹</h3><p>â€‹        åœ¨å¤§å‹ç³»ç»Ÿçš„å¾®æœåŠ¡åŒ–æ„å»ºä¸­ï¼Œä¸€ä¸ªç³»ç»Ÿè¢«æ‹†åˆ†æˆäº†è®¸å¤šæ¨¡å—ã€‚è¿™äº›æ¨¡å—è´Ÿè´£ä¸åŒçš„åŠŸèƒ½ï¼Œç»„åˆæˆç³»ç»Ÿï¼Œæœ€ç»ˆå¯ä»¥æä¾›ä¸°å¯Œçš„åŠŸèƒ½ã€‚åœ¨è¿™ç§æ¶æ„ä¸­ï¼Œä¸€æ¬¡è¯·æ±‚å¾€å¾€éœ€è¦æ¶‰åŠåˆ°å¤šä¸ªæœåŠ¡ã€‚äº’è”ç½‘åº”ç”¨æ„å»ºåœ¨ä¸åŒçš„è½¯ä»¶æ¨¡å—é›†ä¸Šï¼Œè¿™äº›è½¯ä»¶æ¨¡å—ï¼Œæœ‰å¯èƒ½æ˜¯ç”±ä¸åŒçš„å›¢é˜Ÿå¼€å‘ã€å¯èƒ½ä½¿ç”¨ä¸åŒçš„ç¼–ç¨‹è¯­è¨€æ¥å®ç°ã€æœ‰å¯èƒ½å¸ƒåœ¨äº†å‡ åƒå°æœåŠ¡å™¨ï¼Œæ¨ªè·¨å¤šä¸ªä¸åŒçš„æ•°æ®ä¸­å¿ƒï¼Œä¹Ÿå°±æ„å‘³ç€è¿™ç§æ¶æ„å½¢å¼ä¹Ÿä¼šå­˜åœ¨ä¸€äº›é—®é¢˜ï¼š</p>
<ul>
<li>å¦‚ä½•å¿«é€Ÿå‘ç°é—®é¢˜ï¼Ÿ</li>
<li>å¦‚ä½•åˆ¤æ–­æ•…éšœå½±å“èŒƒå›´ï¼Ÿ</li>
<li>å¦‚ä½•æ¢³ç†æœåŠ¡ä¾èµ–ä»¥åŠä¾èµ–çš„åˆç†æ€§ï¼Ÿ</li>
<li>å¦‚ä½•åˆ†æé“¾è·¯æ€§èƒ½é—®é¢˜ä»¥åŠå®æ—¶å®¹é‡è§„åˆ’ï¼Ÿ</li>
</ul>
<p><img src="https://imxushuai-blog.oss-cn-chengdu.aliyuncs.com/springcloudalibaba%E9%93%BE%E8%B7%AF%E8%BF%BD%E8%B8%AA.jpg" alt></p>
<p>â€‹        åˆ†å¸ƒå¼é“¾è·¯è¿½è¸ªï¼ˆDistributed Tracingï¼‰ï¼Œå°±æ˜¯å°†ä¸€æ¬¡åˆ†å¸ƒå¼è¯·æ±‚è¿˜åŸæˆè°ƒç”¨é“¾è·¯ï¼Œè¿›è¡Œæ—¥å¿—è®°å½•ï¼Œæ€§èƒ½ç›‘æ§å¹¶å°†ä¸€æ¬¡åˆ†å¸ƒå¼è¯·æ±‚çš„è°ƒç”¨æƒ…å†µé›†ä¸­å±•ç¤ºã€‚æ¯”å¦‚å„ä¸ªæœåŠ¡èŠ‚ç‚¹ä¸Šçš„è€—æ—¶ã€è¯·æ±‚å…·ä½“åˆ°è¾¾å“ªå°æœºå™¨ä¸Šã€æ¯ä¸ªæœåŠ¡èŠ‚ç‚¹çš„è¯·æ±‚çŠ¶æ€ç­‰ç­‰ã€‚</p>
<p>å¸¸è§çš„é“¾è·¯è¿½è¸ªæŠ€æœ¯æœ‰ä¸‹é¢è¿™äº›ï¼š</p>
<ul>
<li><p><strong>cat</strong></p>
<p>ç”±å¤§ä¼—ç‚¹è¯„å¼€æºï¼ŒåŸºäºJavaå¼€å‘çš„å®æ—¶åº”ç”¨ç›‘æ§å¹³å°ï¼ŒåŒ…æ‹¬å®æ—¶åº”ç”¨ç›‘æ§ï¼Œä¸šåŠ¡ç›‘æ§ ã€‚ é›†æˆæ–¹æ¡ˆæ˜¯é€šè¿‡ä»£ç åŸ‹ç‚¹çš„æ–¹å¼æ¥å®ç°ç›‘æ§ï¼Œæ¯”å¦‚ï¼š æ‹¦æˆªå™¨ï¼Œè¿‡æ»¤å™¨ç­‰ã€‚ å¯¹ä»£ç çš„ä¾µå…¥æ€§å¾ˆå¤§ï¼Œé›†æˆæˆæœ¬è¾ƒé«˜ã€‚é£é™©è¾ƒå¤§ã€‚</p>
</li>
<li><p><strong>zipkin</strong></p>
<p>ç”±<code>Twitter</code>å…¬å¸å¼€æºï¼Œå¼€æ”¾æºä»£ç åˆ†å¸ƒå¼çš„è·Ÿè¸ªç³»ç»Ÿï¼Œç”¨äºæ”¶é›†æœåŠ¡çš„å®šæ—¶æ•°æ®ï¼Œä»¥è§£å†³å¾®æœåŠ¡æ¶æ„ä¸­çš„å»¶è¿Ÿé—®é¢˜ï¼ŒåŒ…æ‹¬ï¼šæ•°æ®çš„æ”¶é›†ã€å­˜å‚¨ã€æŸ¥æ‰¾å’Œå±•ç°ã€‚è¯¥äº§å“ç»“åˆ<code>spring-cloud-sleuth</code>ä½¿ç”¨è¾ƒä¸ºç®€å•ï¼Œ é›†æˆå¾ˆæ–¹ä¾¿ï¼Œ ä½†æ˜¯åŠŸèƒ½è¾ƒç®€å•ã€‚</p>
</li>
<li><p><strong>pinpoint</strong></p>
<p><code>Pinpoint</code>æ˜¯åŸºäºå­—èŠ‚ç æ³¨å…¥çš„è°ƒç”¨é“¾åˆ†æï¼Œä»¥åŠåº”ç”¨ç›‘æ§åˆ†æå·¥å…·ã€‚ç‰¹ç‚¹æ˜¯æ”¯æŒå¤šç§æ’ä»¶ï¼ŒUIåŠŸèƒ½å¼ºå¤§ï¼Œæ¥å…¥ç«¯æ— ä»£ç ä¾µå…¥ã€‚</p>
</li>
<li><p><strong>skywalking</strong></p>
<p><code>SkyWalking</code>æ˜¯æœ¬åœŸå¼€æºçš„åŸºäºå­—èŠ‚ç æ³¨å…¥çš„è°ƒç”¨é“¾åˆ†æï¼Œä»¥åŠåº”ç”¨ç›‘æ§åˆ†æå·¥å…·ã€‚ç‰¹ç‚¹æ˜¯æ”¯æŒå¤šç§æ’ä»¶ï¼ŒUIåŠŸèƒ½è¾ƒå¼ºï¼Œæ¥å…¥ç«¯æ— ä»£ç ä¾µå…¥ã€‚ç›®å‰å·²åŠ å…¥<code>Apache</code>å­µåŒ–å™¨ã€‚</p>
</li>
<li><p><strong>Sleuth</strong></p>
<p><code>SpringCloud</code>æä¾›çš„åˆ†å¸ƒå¼ç³»ç»Ÿä¸­é“¾è·¯è¿½è¸ªè§£å†³æ–¹æ¡ˆï¼Œä¸€èˆ¬ç»“åˆ<code>zipkin</code>ä¸€èµ·ä½¿ç”¨ï¼Œ<code>Seluth</code>åšé“¾è·¯è¿½è¸ªï¼Œ<code>zipkin</code>åšé“¾è·¯æƒ…å†µçš„å¯è§†åŒ–å±•ç¤ºã€‚</p>
</li>
</ul>
<h3 id="Sleuthç®€ä»‹"><a href="#Sleuthç®€ä»‹" class="headerlink" title="Sleuthç®€ä»‹"></a>Sleuthç®€ä»‹</h3><p>â€‹        <code>Spring Cloud Sleuth</code>ä¸»è¦åŠŸèƒ½å°±æ˜¯åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­æä¾›è¿½è¸ªè§£å†³æ–¹æ¡ˆã€‚å®ƒå¤§é‡å€Ÿç”¨äº†<code>Google Dapper</code>çš„è®¾è®¡ï¼Œ å…ˆæ¥äº†è§£ä¸€ä¸‹<code>Sleuth</code>ä¸­çš„æœ¯è¯­å’Œç›¸å…³æ¦‚å¿µã€‚</p>
<ul>
<li><p>Trace</p>
<p>ç”±ä¸€ç»„<code>Trace Id</code>ç›¸åŒçš„<code>Span</code>ä¸²è”å½¢æˆä¸€ä¸ªæ ‘çŠ¶ç»“æ„ã€‚ä¸ºäº†å®ç°è¯·æ±‚è·Ÿè¸ªï¼Œå½“è¯·æ±‚åˆ°è¾¾åˆ†å¸ƒå¼ç³»ç»Ÿçš„å…¥å£ç«¯ç‚¹æ—¶ï¼Œåªéœ€è¦æœåŠ¡è·Ÿè¸ªæ¡†æ¶ä¸ºè¯¥è¯·æ±‚åˆ›å»ºä¸€ä¸ªå”¯ä¸€çš„æ ‡è¯†ï¼ˆå³<code>Trace Id</code>ï¼‰ï¼ŒåŒæ—¶åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿå†…éƒ¨æµè½¬çš„æ—¶å€™ï¼Œæ¡†æ¶å§‹ç»ˆä¿æŒä¼ é€’è¯¥å”¯ä¸€å€¼ï¼Œç›´åˆ°æ•´ä¸ªè¯·æ±‚çš„è¿”å›ã€‚é‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨è¯¥å”¯ä¸€æ ‡è¯†å°†æ‰€æœ‰çš„è¯·æ±‚ä¸²è”èµ·æ¥ï¼Œå½¢æˆä¸€æ¡å®Œæ•´çš„è¯·æ±‚é“¾è·¯ã€‚</p>
</li>
<li><p>Span</p>
<p>ä»£è¡¨äº†ä¸€ç»„åŸºæœ¬çš„å·¥ä½œå•å…ƒã€‚ä¸ºäº†ç»Ÿè®¡å„å¤„ç†å•å…ƒçš„å»¶è¿Ÿï¼Œå½“è¯·æ±‚åˆ°è¾¾å„ä¸ªæœåŠ¡ç»„ä»¶çš„æ—¶å€™ï¼Œä¹Ÿé€šè¿‡ä¸€ä¸ªå”¯ä¸€æ ‡è¯†ï¼ˆ<code>Span Id</code>ï¼‰æ¥æ ‡è®°å®ƒçš„å¼€å§‹ã€å…·ä½“è¿‡ç¨‹å’Œç»“æŸã€‚é€šè¿‡<code>Span Id</code>çš„å¼€å§‹å’Œç»“æŸæ—¶é—´æˆ³ï¼Œå°±èƒ½ç»Ÿè®¡è¯¥<code>span</code>çš„è°ƒç”¨æ—¶é—´ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥è·å–å¦‚äº‹ä»¶çš„åç§°ã€‚è¯·æ±‚ä¿¡æ¯ç­‰å…ƒæ•°æ®ã€‚</p>
</li>
<li><p>Annotation</p>
<p>ç”¨å®ƒè®°å½•ä¸€æ®µæ—¶é—´å†…çš„äº‹ä»¶ï¼Œå†…éƒ¨ä½¿ç”¨çš„é‡è¦æ³¨é‡Šï¼š</p>
<p>csï¼ˆClient Sendï¼‰å®¢æˆ·ç«¯å‘å‡ºè¯·æ±‚ï¼Œå¼€å§‹ä¸€ä¸ªè¯·æ±‚çš„ç”Ÿå‘½</p>
<p>srï¼ˆServer Receivedï¼‰æœåŠ¡ç«¯æ¥å—åˆ°è¯·æ±‚å¼€å§‹è¿›è¡Œå¤„ç†ï¼Œ srï¼cs = ç½‘ç»œå»¶è¿Ÿï¼ˆæœåŠ¡è°ƒç”¨çš„æ—¶é—´ï¼‰</p>
<p>ssï¼ˆServer Sendï¼‰æœåŠ¡ç«¯å¤„ç†å®Œæ¯•å‡†å¤‡å‘é€åˆ°å®¢æˆ·ç«¯ï¼Œss - sr = æœåŠ¡å™¨ä¸Šçš„è¯·æ±‚å¤„ç†æ—¶é—´</p>
<p>crï¼ˆClient Reveivedï¼‰å®¢æˆ·ç«¯æ¥å—åˆ°æœåŠ¡ç«¯çš„å“åº”ï¼Œè¯·æ±‚ç»“æŸã€‚ cr - sr = è¯·æ±‚çš„æ€»æ—¶é—´</p>
</li>
</ul>
<p><img src="https://imxushuai-blog.oss-cn-chengdu.aliyuncs.com/springcloudalibabasleuth%E6%9E%B6%E6%9E%84.jpg" alt></p>
<h3 id="SleuthåŸºæœ¬ä½¿ç”¨"><a href="#SleuthåŸºæœ¬ä½¿ç”¨" class="headerlink" title="SleuthåŸºæœ¬ä½¿ç”¨"></a>SleuthåŸºæœ¬ä½¿ç”¨</h3><ol>
<li><p>å¼•å…¥ä¾èµ–</p>
<p>åœ¨çˆ¶å·¥ç¨‹çš„pomæ–‡ä»¶ä¸­å¼•å…¥ä¾èµ–</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--é“¾è·¯è¿½è¸ª Sleuth--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-sleuth<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>é‡å¯æ‰€æœ‰å¾®æœåŠ¡ï¼Œè°ƒç”¨APIåï¼Œè§‚å¯Ÿæ§åˆ¶å°ï¼Œå°±å¯ä»¥çœ‹åˆ°<code>Sleuth</code>çš„æ—¥å¿—æ‰“å°</p>
</li>
</ol>
<p>æŸ¥çœ‹æ—¥å¿—æ–‡ä»¶å¹¶ä¸æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„æ–¹æ³•ï¼Œå½“å¾®æœåŠ¡è¶Šæ¥è¶Šå¤šæ—¥å¿—æ–‡ä»¶ä¹Ÿä¼šè¶Šæ¥è¶Šå¤šï¼Œé€šè¿‡<code>Zipkin</code>å¯ä»¥å°†æ—¥å¿—èšåˆï¼Œå¹¶è¿›è¡Œå¯è§†åŒ–å±•ç¤ºå’Œå…¨æ–‡æ£€ç´¢ã€‚</p>
<h3 id="Zipkinä»‹ç»"><a href="#Zipkinä»‹ç»" class="headerlink" title="Zipkinä»‹ç»"></a>Zipkinä»‹ç»</h3><p><code>Zipkin</code> æ˜¯ <code>Twitter</code> çš„ä¸€ä¸ªå¼€æºé¡¹ç›®ï¼Œå®ƒåŸºäº<code>Google Dapper</code>å®ç°ï¼Œå®ƒè‡´åŠ›äºæ”¶é›†æœåŠ¡çš„å®šæ—¶æ•°æ®ï¼Œä»¥è§£å†³å¾®æœåŠ¡æ¶æ„ä¸­çš„å»¶è¿Ÿé—®é¢˜ï¼ŒåŒ…æ‹¬æ•°æ®çš„æ”¶é›†ã€å­˜å‚¨ã€æŸ¥æ‰¾å’Œå±•ç°ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å®ƒæ¥æ”¶é›†å„ä¸ªæœåŠ¡å™¨ä¸Šè¯·æ±‚é“¾è·¯çš„è·Ÿè¸ªæ•°æ®ï¼Œå¹¶é€šè¿‡å®ƒæä¾›çš„<code>REST API</code>æ¥å£æ¥è¾…åŠ©æˆ‘ä»¬æŸ¥è¯¢è·Ÿè¸ªæ•°æ®ä»¥å®ç°å¯¹åˆ†å¸ƒå¼ç³»ç»Ÿçš„ç›‘æ§ç¨‹åºï¼Œä»è€ŒåŠæ—¶åœ°å‘ç°ç³»ç»Ÿä¸­å‡ºç°çš„å»¶è¿Ÿå‡é«˜é—®é¢˜å¹¶æ‰¾å‡ºç³»ç»Ÿæ€§èƒ½ç“¶é¢ˆçš„æ ¹æºã€‚</p>
<p>é™¤äº†é¢å‘å¼€å‘çš„ <code>API</code> æ¥å£ä¹‹å¤–ï¼Œå®ƒä¹Ÿæä¾›äº†æ–¹ä¾¿çš„<code>UIç»„ä»¶</code>æ¥å¸®åŠ©æˆ‘ä»¬ç›´è§‚çš„æœç´¢è·Ÿè¸ªä¿¡æ¯å’Œåˆ†æè¯·æ±‚é“¾è·¯æ˜ç»†ï¼Œæ¯”å¦‚ï¼šå¯ä»¥æŸ¥è¯¢æŸæ®µæ—¶é—´å†…å„ç”¨æˆ·è¯·æ±‚çš„å¤„ç†æ—¶é—´ç­‰ã€‚</p>
<p><code>Zipkin</code> æä¾›äº†å¯æ’æ‹”æ•°æ®å­˜å‚¨æ–¹å¼ï¼š<code>In-Memory</code>ã€<code>MySql</code>ã€<code>Cassandra</code> ä»¥åŠ <code>Elasticsearch</code>ã€‚</p>
<p><img src="https://imxushuai-blog.oss-cn-chengdu.aliyuncs.com/springcloudalibaba_zipkin%E5%9F%BA%E7%A1%80%E6%9E%B6%E6%9E%84.jpg" alt></p>
<p>ä¸Šå›¾æ˜¯ <code>Zipkin</code> çš„åŸºç¡€æ¶æ„ï¼Œå®ƒä¸»è¦ç”± 4 ä¸ªæ ¸å¿ƒç»„ä»¶æ„æˆï¼š</p>
<ul>
<li><strong>Collector</strong>ï¼šæ”¶é›†å™¨ç»„ä»¶ï¼Œå®ƒä¸»è¦ç”¨äºå¤„ç†ä»å¤–éƒ¨ç³»ç»Ÿå‘é€è¿‡æ¥çš„è·Ÿè¸ªä¿¡æ¯ï¼Œå°†è¿™äº›ä¿¡æ¯è½¬æ¢ä¸º<code>Zipkin</code>å†…éƒ¨å¤„ç†çš„ <code>Span</code> æ ¼å¼ï¼Œä»¥æ”¯æŒåç»­çš„å­˜å‚¨ã€åˆ†æã€å±•ç¤ºç­‰åŠŸèƒ½ã€‚</li>
<li><strong>Storage</strong>ï¼šå­˜å‚¨ç»„ä»¶ï¼Œå®ƒä¸»è¦å¯¹å¤„ç†æ”¶é›†å™¨æ¥æ”¶åˆ°çš„è·Ÿè¸ªä¿¡æ¯ï¼Œé»˜è®¤ä¼šå°†è¿™äº›ä¿¡æ¯å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä¿®æ”¹æ­¤å­˜å‚¨ç­–ç•¥ï¼Œé€šè¿‡ä½¿ç”¨å…¶ä»–å­˜å‚¨ç»„ä»¶å°†è·Ÿè¸ªä¿¡æ¯å­˜å‚¨åˆ°æ•°æ®åº“ä¸­ã€‚</li>
<li><strong>RESTful API</strong>ï¼š<code>API</code>ç»„ä»¶ï¼Œå®ƒä¸»è¦ç”¨æ¥æä¾›å¤–éƒ¨è®¿é—®æ¥å£ã€‚æ¯”å¦‚ç»™å®¢æˆ·ç«¯å±•ç¤ºè·Ÿè¸ªä¿¡æ¯ï¼Œæˆ–æ˜¯å¤–æ¥ç³»ç»Ÿè®¿é—®ä»¥å®ç°ç›‘æ§ç­‰ã€‚</li>
<li><strong>Web UI</strong>ï¼šUIç»„ä»¶ï¼Œ åŸºäº<code>API</code>ç»„ä»¶å®ç°çš„ä¸Šå±‚åº”ç”¨ã€‚é€šè¿‡UIç»„ä»¶ç”¨æˆ·å¯ä»¥æ–¹ä¾¿è€Œæœ‰ç›´è§‚åœ°æŸ¥è¯¢å’Œåˆ†æè·Ÿè¸ªä¿¡æ¯ã€‚</li>
</ul>
<p><code>Zipkin</code>åˆ†ä¸ºä¸¤ç«¯ï¼Œä¸€ä¸ªæ˜¯ <code>Zipkin</code>æœåŠ¡ç«¯ï¼Œä¸€ä¸ªæ˜¯ <code>Zipkin</code>å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯ä¹Ÿå°±æ˜¯å¾®æœåŠ¡çš„åº”ç”¨ã€‚ å®¢æˆ·ç«¯ä¼šé…ç½®æœåŠ¡ç«¯çš„ URL åœ°å€ï¼Œä¸€æ—¦å‘ç”ŸæœåŠ¡é—´çš„è°ƒç”¨çš„æ—¶å€™ï¼Œä¼šè¢«é…ç½®åœ¨å¾®æœåŠ¡é‡Œé¢çš„ <code>Sleuth</code> çš„ç›‘å¬å™¨ç›‘å¬ï¼Œå¹¶ç”Ÿæˆç›¸åº”çš„ <code>Trace</code> å’Œ <code>Span</code> ä¿¡æ¯å‘é€ç»™æœåŠ¡ç«¯ã€‚</p>
<h3 id="Zipkinå®‰è£…"><a href="#Zipkinå®‰è£…" class="headerlink" title="Zipkinå®‰è£…"></a>Zipkinå®‰è£…</h3><ol>
<li>ä¸‹è½½ZipKinçš„jaråŒ…ï¼Œè®¿é—®ï¼š<a href="https://search.maven.org/remote_content?g=io.zipkin.java&amp;a=zipkin-server&amp;v=LATEST&amp;c=exec" target="_blank" rel="noopener">https://search.maven.org/remote_content?g=io.zipkin.java&amp;a=zipkin-server&amp;v=LATEST&amp;c=exec</a>ï¼Œä¼šè‡ªåŠ¨å¼€å§‹ä¸‹è½½ã€‚</li>
<li>è¿è¡ŒjaråŒ…ï¼Œ<code>java -jar zipkin-server-2.12.9-exec.jar</code></li>
<li>è®¿é—®UIç•Œé¢ï¼š<code>http://host:9411</code>ï¼Œé»˜è®¤ç«¯å£ä¸º<code>9411</code></li>
</ol>
<h3 id="Zipkiné›†æˆ"><a href="#Zipkiné›†æˆ" class="headerlink" title="Zipkiné›†æˆ"></a>Zipkiné›†æˆ</h3><ol>
<li><p>å¼•å…¥ä¾èµ–,ï¼Œåœ¨çˆ¶å·¥ç¨‹åŠ å…¥ä¸‹åˆ—ä¾èµ–</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--zipkiné›†æˆ--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-zipkin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>åœ¨æ¯ä¸ªå¾®æœåŠ¡åŠ å…¥ä¸‹åˆ—é…ç½®</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span>   </span><br><span class="line"><span class="attr">  zipkin:</span></span><br><span class="line"><span class="attr">    base-url:</span> <span class="attr">http://192.168.149.101:9411/</span></span><br><span class="line"><span class="attr">    discoveryClientEnabled:</span> <span class="literal">false</span> <span class="comment">#è®©nacosæŠŠå®ƒå½“æˆä¸€ä¸ªURLï¼Œè€Œä¸è¦å½“åšæœåŠ¡å</span></span><br><span class="line"><span class="attr">  sleuth:</span></span><br><span class="line"><span class="attr">    sampler:</span></span><br><span class="line"><span class="attr">      probability:</span> <span class="number">1.0</span> <span class="comment">#é‡‡æ ·çš„ç™¾åˆ†æ¯”</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>æµ‹è¯•ï¼Œè®¿é—®URLï¼š<code>http://localhost:7000/order-serv/order/prod/1</code>ï¼Œç„¶åè§‚å¯Ÿzipkinçš„UIç•Œé¢</p>
<p>æ³¨æ„ï¼šå…³é—­ä¹‹å‰gatewayæµ‹è¯•æ—¶åŠ å…¥çš„tokenè¿‡æ»¤å™¨</p>
<p><img src="https://imxushuai-blog.oss-cn-chengdu.aliyuncs.com/20211125230029.png" alt></p>
</li>
<li><p>å¯ä»¥ç‚¹å‡»ä¸‹æ–¹çš„è¯·æ±‚ï¼ŒæŸ¥çœ‹æ›´è¯¦ç»†çš„è°ƒç”¨æƒ…å†µï¼Œé‡Œé¢ä¼šç»™å‡ºAPIé€”ç»çš„å¾®æœåŠ¡çš„è€—æ—¶æƒ…å†µï¼Œä¾¿äºè§‚å¯Ÿé—®é¢˜æ‰€åœ¨å¾®æœåŠ¡ã€‚</p>
</li>
</ol>
<h3 id="ZipKinæ•°æ®æŒä¹…åŒ–"><a href="#ZipKinæ•°æ®æŒä¹…åŒ–" class="headerlink" title="ZipKinæ•°æ®æŒä¹…åŒ–"></a>ZipKinæ•°æ®æŒä¹…åŒ–</h3><blockquote>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒZipKinå°†é“¾è·¯æ•°æ®ä¿å­˜åœ¨å†…å­˜ä¸­çš„ï¼Œä¸€æ—¦ZipKiné‡å¯åï¼Œä¹‹å‰æ”¶é›†çš„é“¾è·¯æ•°æ®å°†å…¨éƒ¨å¤±æ•ˆï¼Œè¿™æ—¶æˆ‘ä»¬å°±éœ€è¦ç”¨åˆ°ZipKinçš„é“¾è·¯æ•°æ®æŒä¹…åŒ–äº†ã€‚</p>
<p>è¿™é‡Œä»…ä»‹ç»å°†æ•°æ®æŒä¹…åŒ–åˆ°mysqlæ•°æ®åº“ä¸­</p>
</blockquote>
<ol>
<li><p>æ‰§è¡Œzipkinå®˜æ–¹æä¾›çš„è§è¡¨è¯­å¥ï¼Œåˆ›å»ºæ•°æ®åº“è¡¨</p>
<p>æ³¨æ„ï¼šéœ€è¦æå‰åˆ›å»ºæ•°æ®åº“ï¼Œæˆ‘è¿™é‡Œåˆ›å»ºçš„æ•°æ®åº“åç§°ä¸ºï¼šzipkin</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> zipkin_spans (</span><br><span class="line">  <span class="string">`trace_id_high`</span> <span class="built_in">BIGINT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> <span class="keyword">COMMENT</span> <span class="string">'If non zero, this means the trace uses 128 bit traceIds instead of 64 bit'</span>,</span><br><span class="line">  <span class="string">`trace_id`</span> <span class="built_in">BIGINT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">BIGINT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`name`</span> <span class="built_in">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`parent_id`</span> <span class="built_in">BIGINT</span>,</span><br><span class="line">  <span class="string">`debug`</span> <span class="built_in">BIT</span>(<span class="number">1</span>),</span><br><span class="line">  <span class="string">`start_ts`</span> <span class="built_in">BIGINT</span> <span class="keyword">COMMENT</span> <span class="string">'Span.timestamp(): epoch micros used for endTs query and to implement TTL'</span>,</span><br><span class="line">  <span class="string">`duration`</span> <span class="built_in">BIGINT</span> <span class="keyword">COMMENT</span> <span class="string">'Span.duration(): micros used for minDuration and maxDuration query'</span></span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> ROW_FORMAT=COMPRESSED <span class="built_in">CHARACTER</span> <span class="keyword">SET</span>=utf8 <span class="keyword">COLLATE</span> utf8_general_ci;</span><br><span class="line"></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> zipkin_spans <span class="keyword">ADD</span> <span class="keyword">UNIQUE</span> <span class="keyword">KEY</span>(<span class="string">`trace_id_high`</span>, <span class="string">`trace_id`</span>, <span class="string">`id`</span>) <span class="keyword">COMMENT</span> <span class="string">'ignore insert on duplicate'</span>;</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> zipkin_spans <span class="keyword">ADD</span> <span class="keyword">INDEX</span>(<span class="string">`trace_id_high`</span>, <span class="string">`trace_id`</span>, <span class="string">`id`</span>) <span class="keyword">COMMENT</span> <span class="string">'for joining with zipkin_annotations'</span>;</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> zipkin_spans <span class="keyword">ADD</span> <span class="keyword">INDEX</span>(<span class="string">`trace_id_high`</span>, <span class="string">`trace_id`</span>) <span class="keyword">COMMENT</span> <span class="string">'for getTracesByIds'</span>;</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> zipkin_spans <span class="keyword">ADD</span> <span class="keyword">INDEX</span>(<span class="string">`name`</span>) <span class="keyword">COMMENT</span> <span class="string">'for getTraces and getSpanNames'</span>;</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> zipkin_spans <span class="keyword">ADD</span> <span class="keyword">INDEX</span>(<span class="string">`start_ts`</span>) <span class="keyword">COMMENT</span> <span class="string">'for getTraces ordering and range'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> zipkin_annotations (</span><br><span class="line">  <span class="string">`trace_id_high`</span> <span class="built_in">BIGINT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> <span class="keyword">COMMENT</span> <span class="string">'If non zero, this means the trace uses 128 bit traceIds instead of 64 bit'</span>,</span><br><span class="line">  <span class="string">`trace_id`</span> <span class="built_in">BIGINT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'coincides with zipkin_spans.trace_id'</span>,</span><br><span class="line">  <span class="string">`span_id`</span> <span class="built_in">BIGINT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'coincides with zipkin_spans.id'</span>,</span><br><span class="line">  <span class="string">`a_key`</span> <span class="built_in">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'BinaryAnnotation.key or Annotation.value if type == -1'</span>,</span><br><span class="line">  <span class="string">`a_value`</span> <span class="built_in">BLOB</span> <span class="keyword">COMMENT</span> <span class="string">'BinaryAnnotation.value(), which must be smaller than 64KB'</span>,</span><br><span class="line">  <span class="string">`a_type`</span> <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'BinaryAnnotation.type() or -1 if Annotation'</span>,</span><br><span class="line">  <span class="string">`a_timestamp`</span> <span class="built_in">BIGINT</span> <span class="keyword">COMMENT</span> <span class="string">'Used to implement TTL; Annotation.timestamp or zipkin_spans.timestamp'</span>,</span><br><span class="line">  <span class="string">`endpoint_ipv4`</span> <span class="built_in">INT</span> <span class="keyword">COMMENT</span> <span class="string">'Null when Binary/Annotation.endpoint is null'</span>,</span><br><span class="line">  <span class="string">`endpoint_ipv6`</span> <span class="built_in">BINARY</span>(<span class="number">16</span>) <span class="keyword">COMMENT</span> <span class="string">'Null when Binary/Annotation.endpoint is null, or no IPv6 address'</span>,</span><br><span class="line">  <span class="string">`endpoint_port`</span> <span class="built_in">SMALLINT</span> <span class="keyword">COMMENT</span> <span class="string">'Null when Binary/Annotation.endpoint is null'</span>,</span><br><span class="line">  <span class="string">`endpoint_service_name`</span> <span class="built_in">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">COMMENT</span> <span class="string">'Null when Binary/Annotation.endpoint is null'</span></span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> ROW_FORMAT=COMPRESSED <span class="built_in">CHARACTER</span> <span class="keyword">SET</span>=utf8 <span class="keyword">COLLATE</span> utf8_general_ci;</span><br><span class="line"></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> zipkin_annotations <span class="keyword">ADD</span> <span class="keyword">UNIQUE</span> <span class="keyword">KEY</span>(<span class="string">`trace_id_high`</span>, <span class="string">`trace_id`</span>, <span class="string">`span_id`</span>, <span class="string">`a_key`</span>, <span class="string">`a_timestamp`</span>) <span class="keyword">COMMENT</span> <span class="string">'Ignore insert on duplicate'</span>;</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> zipkin_annotations <span class="keyword">ADD</span> <span class="keyword">INDEX</span>(<span class="string">`trace_id_high`</span>, <span class="string">`trace_id`</span>, <span class="string">`span_id`</span>) <span class="keyword">COMMENT</span> <span class="string">'for joining with zipkin_spans'</span>;</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> zipkin_annotations <span class="keyword">ADD</span> <span class="keyword">INDEX</span>(<span class="string">`trace_id_high`</span>, <span class="string">`trace_id`</span>) <span class="keyword">COMMENT</span> <span class="string">'for getTraces/ByIds'</span>;</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> zipkin_annotations <span class="keyword">ADD</span> <span class="keyword">INDEX</span>(<span class="string">`endpoint_service_name`</span>) <span class="keyword">COMMENT</span> <span class="string">'for getTraces and getServiceNames'</span>;</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> zipkin_annotations <span class="keyword">ADD</span> <span class="keyword">INDEX</span>(<span class="string">`a_type`</span>) <span class="keyword">COMMENT</span> <span class="string">'for getTraces and autocomplete values'</span>;</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> zipkin_annotations <span class="keyword">ADD</span> <span class="keyword">INDEX</span>(<span class="string">`a_key`</span>) <span class="keyword">COMMENT</span> <span class="string">'for getTraces and autocomplete values'</span>;</span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> zipkin_annotations <span class="keyword">ADD</span> <span class="keyword">INDEX</span>(<span class="string">`trace_id`</span>, <span class="string">`span_id`</span>, <span class="string">`a_key`</span>) <span class="keyword">COMMENT</span> <span class="string">'for dependencies job'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> zipkin_dependencies (</span><br><span class="line">  <span class="string">`day`</span> <span class="built_in">DATE</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`parent`</span> <span class="built_in">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`child`</span> <span class="built_in">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`call_count`</span> <span class="built_in">BIGINT</span>,</span><br><span class="line">  <span class="string">`error_count`</span> <span class="built_in">BIGINT</span></span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> ROW_FORMAT=COMPRESSED <span class="built_in">CHARACTER</span> <span class="keyword">SET</span>=utf8 <span class="keyword">COLLATE</span> utf8_general_ci;</span><br><span class="line"></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> zipkin_dependencies <span class="keyword">ADD</span> <span class="keyword">UNIQUE</span> <span class="keyword">KEY</span>(<span class="string">`day`</span>, <span class="string">`parent`</span>, <span class="string">`child`</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>ä¿®æ”¹zipkin jaråŒ…çš„å¯åŠ¨å‚æ•°</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> å¯åŠ¨zipkin</span></span><br><span class="line">java -jar zipkin-server-2.12.9-exec.jar --STORAGE_TYPE=mysql --MYSQL_HOST=192.168.149.1 --MYSQL_TCP_PORT=3306 --MYSQL_DB=zipkin --MYSQL_USER=root --MYSQL_PASS=123456</span><br></pre></td></tr></table></figure>
</li>
<li><p>å†æ¬¡è®¿é—®APIï¼š<code>http://localhost:7000/order-serv/order/prod/1</code>å¹¶è§‚å¯Ÿæ•°æ®åº“çš„å˜åŒ–ï¼Œä¼šå‘ç°é“¾è·¯æ•°æ®å·²ç»å­˜å…¥äº†mysqlä¸­</p>
</li>
</ol>
<h2 id="æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆRocketMQï¼‰"><a href="#æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆRocketMQï¼‰" class="headerlink" title="æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆRocketMQï¼‰"></a>æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆRocketMQï¼‰</h2><blockquote>
<p>è€å®è¯´ï¼Œæ¶ˆæ¯é˜Ÿåˆ—å·²ç»æ˜¯ä¸ªè€ç”Ÿå¸¸è°ˆçš„åˆ†å¸ƒå¼ç»„ä»¶äº†ï¼Œæˆ‘ä¹‹å‰ä¹Ÿæœ‰å†™è¿‡å¾ˆè¯¦ç»†çš„æ¶ˆæ¯é˜Ÿåˆ—æ–‡ç« ï¼Œåªæ˜¯ç”¨çš„æ¶ˆæ¯é˜Ÿåˆ—äº§å“ä¸åŒè€Œå·²ã€‚</p>
<p>æ‰€ä»¥æ¶ˆæ¯é˜Ÿåˆ—çš„åŸºç¡€æ¦‚å¿µå°±ä¸åœ¨è¿™é‡Œåšä»‹ç»äº†ã€‚</p>
<p>è¯¦æƒ…å¯è§ï¼š </p>
<p><a href="https://www.imxushuai.com/2019/04/01/rabbitmq%E8%AF%A6%E8%A7%A3/">RabbitMQè¯¦è§£</a></p>
</blockquote>
<h3 id="RocketMQå®‰è£…"><a href="#RocketMQå®‰è£…" class="headerlink" title="RocketMQå®‰è£…"></a>RocketMQå®‰è£…</h3><ol>
<li><p>ä¸‹è½½RocketMqï¼Œç›´æ¥è®¿é—®å®˜æ–¹ç½‘ç«™ï¼š<a href="https://rocketmq.apache.org/" target="_blank" rel="noopener">https://rocketmq.apache.org</a>ï¼Œé¦–é¡µä¸Šå°±å¯ä»¥ä¸‹è½½åˆ°æœ€æ–°çš„æ­£å¼ç‰ˆæœ¬ï¼Œç›´æ¥ä¸‹è½½å³å¯</p>
<p>æ³¨æ„ï¼šå®‰è£…çš„æ—¶å€™ä¸‹è½½<code>Binary</code>åŒ…å°±å¯ä»¥äº†ã€‚</p>
<p><img src="https://imxushuai-blog.oss-cn-chengdu.aliyuncs.com/20211125234005.png" alt></p>
</li>
<li><p>ä¸Šä¼ ä¸‹è½½çš„å®‰è£…åŒ…åˆ°æœåŠ¡å™¨å¹¶å‡†å¤‡å®‰è£…ç¯å¢ƒï¼Œç”±äºrocketMQæ˜¯åŸºäºjavaè¯­è¨€å¼€å‘çš„ï¼Œæ‰€ä»¥éœ€è¦æå‰åœ¨æœåŠ¡å™¨å®‰è£…å¥½JDK</p>
<p>æˆ‘è¿™ç”¨çš„4.9.2ï¼Œå®‰è£…çš„JDK 1.8</p>
</li>
<li><p>è§£å‹ä¸Šä¼ åˆ°æœåŠ¡å™¨çš„å®‰è£…åŒ…</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> ä½¿ç”¨unzipè§£å‹ï¼Œè‹¥æç¤º <span class="built_in">command</span> not foundï¼Œåˆ™éœ€è¦å®‰è£…unzip</span></span><br><span class="line">unzip </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> å®‰è£…unzipçš„å‘½ä»¤</span></span><br><span class="line"><span class="meta">#</span><span class="bash">yum install -y unzip</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>å¯åŠ¨NameServer</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup ./bin/mqnamesrv &amp;</span><br></pre></td></tr></table></figure>
</li>
<li><p>ï¼ˆå¯é€‰æ“ä½œï¼‰ä¿®æ”¹brokerå’ŒserveræœåŠ¡å¯åŠ¨å‚æ•°</p>
<p>ç”±äºrocketMQé»˜è®¤çš„JVMå‚æ•°è®¾ç½®çš„å†…å­˜å ç”¨æ¯”è¾ƒé«˜ï¼Œæ‰€ä»¥å¯ä»¥è§†æƒ…å†µä¿®æ”¹JVMå‚æ•°è°ƒæ•´å†…å­˜å ç”¨</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> ä¿®æ”¹runserver.shï¼Œä¿®æ”¹JVMå‚æ•°</span></span><br><span class="line">vim runserver.sh</span><br><span class="line"><span class="meta">#</span><span class="bash"> ä¿®æ”¹runbroker.shï¼Œä¿®æ”¹JVMå‚æ•°</span></span><br><span class="line">vim runbroker.sh</span><br><span class="line"><span class="meta">#</span><span class="bash"> JAVA_OPT=<span class="string">"<span class="variable">$&#123;JAVA_OPT&#125;</span> -server -Xms8g -Xmx8g -Xmn4g"</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ä¿®æ”¹ä¸ºJAVA_OPT=<span class="string">"<span class="variable">$&#123;JAVA_OPT&#125;</span> -server -Xms256m -Xmx256m -Xmn128m"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> è‹¥vimæç¤º <span class="built_in">command</span> not fountï¼Œåˆ™éœ€è¦å®‰è£…vimæˆ–è€…ä½¿ç”¨vi</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> yum install -y vim</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>å¯åŠ¨broker</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup ./bin/mqbroker -n localhost:9876 &amp;</span><br></pre></td></tr></table></figure>
</li>
<li><p>å…³é—­å‘½ä»¤</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> å…³é—­broker</span></span><br><span class="line">./bin/mqshutdown broker</span><br><span class="line"><span class="meta">#</span><span class="bash"> å…³é—­namesrv</span></span><br><span class="line">./bin/mqshutdown namesrv</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="RocketMQæ§åˆ¶å°å®‰è£…"><a href="#RocketMQæ§åˆ¶å°å®‰è£…" class="headerlink" title="RocketMQæ§åˆ¶å°å®‰è£…"></a>RocketMQæ§åˆ¶å°å®‰è£…</h3><ol>
<li><p>ä¸‹è½½å®‰è£…åŒ…ï¼Œè®¿é—®ï¼š<a href="https://github.com/apache/rocketmq-externals/tags" target="_blank" rel="noopener">https://github.com/apache/rocketmq-externals/tags</a>ï¼Œä¸‹è½½å¯¹åº”ç³»ç»Ÿçš„å®‰è£…åŒ…</p>
</li>
<li><p>å°†ä¸‹è½½çš„æºç åŒ…æ‰“åŒ…æˆå¯æ‰§è¡ŒjaråŒ…</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> è‹¥æ²¡æœ‰MVNç¯å¢ƒè¿˜éœ€è¦å®‰è£…mavenç¯å¢ƒ</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> æ‰“åŒ…å‰ï¼Œéœ€è¦ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œè®¾ç½®å…¶rocketMQçš„nameServeråœ°å€</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> æ‰“åŒ…</span></span><br><span class="line">mvn clean package -Dmaven.test.skip=true</span><br></pre></td></tr></table></figure>
</li>
<li><p>æ‰“åŒ…å®Œæˆåï¼Œå°†targetä¸­çš„å¯æ‰§è¡ŒjaråŒ…è¿è¡Œ</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar rocketmq-console-ng-1.0.0.jar</span><br></pre></td></tr></table></figure>
</li>
<li><p>è®¿é—®ï¼š<a href="http://192.168.149.101:8080ï¼Œå…·ä½“IPç«¯å£ä»¥å®é™…å®‰è£…é…ç½®æƒ…å†µä¸ºå‡†" target="_blank" rel="noopener">http://192.168.149.101:8080ï¼Œå…·ä½“IPç«¯å£ä»¥å®é™…å®‰è£…é…ç½®æƒ…å†µä¸ºå‡†</a></p>
</li>
</ol>
<h3 id="æ¡ˆä¾‹"><a href="#æ¡ˆä¾‹" class="headerlink" title="æ¡ˆä¾‹"></a>æ¡ˆä¾‹</h3><p><strong>æ¶ˆæ¯ç”Ÿäº§è€…: è®¢å•å¾®æœåŠ¡</strong></p>
<ol>
<li><p>åœ¨è®¢å•å¾®æœåŠ¡ä¸­æ·»åŠ <code>RocketMQ</code>ä¾èµ–ä»¥åŠ<code>spring boot rocket starter</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--rocketmq--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.rocketmq<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rocketmq-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.rocketmq<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rocketmq-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>4.4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>ä¿®æ”¹é…ç½®æ–‡ä»¶</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">rocketmq:</span></span><br><span class="line"><span class="attr">  name-server:</span> <span class="number">192.168</span><span class="number">.149</span><span class="number">.101</span><span class="string">:9876</span> <span class="comment">#rocketMQæœåŠ¡çš„åœ°å€</span></span><br><span class="line"><span class="attr">  producer:</span></span><br><span class="line"><span class="attr">    group:</span> <span class="string">shop-order</span> <span class="comment"># ç”Ÿäº§è€…ç»„</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>ä¿®æ”¹ä¸‹å•çš„é€»è¾‘</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RocketMQTemplate rocketMQTemplate;</span><br><span class="line"><span class="comment">//å‡†å¤‡ä¹°1ä»¶å•†å“</span></span><br><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"/order/prod/&#123;pid&#125;"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Order <span class="title">order</span><span class="params">(@PathVariable(<span class="string">"pid"</span>)</span> Integer pid) </span>&#123;</span><br><span class="line">    log.info(<span class="string">"&gt;&gt; å®¢æˆ·ä¸‹å•ï¼Œè¿™æ—¶å€™è¦è°ƒç”¨å•†å“å¾®æœåŠ¡æŸ¥è¯¢å•†å“ä¿¡æ¯"</span>);</span><br><span class="line">    <span class="comment">// é€šè¿‡Feignå®¢æˆ·ç«¯è°ƒç”¨</span></span><br><span class="line">    Product product = productClient.findById(pid);</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">if</span> (product != <span class="keyword">null</span>) &#123;</span><br><span class="line">        log.info(<span class="string">"&gt;&gt; å•†å“ä¿¡æ¯,æŸ¥è¯¢ç»“æœ: &#123;&#125;"</span>, JSON.toJSONString(product));</span><br><span class="line">        Order order = <span class="keyword">new</span> Order();</span><br><span class="line">        order.setUid(<span class="number">1</span>);</span><br><span class="line">        order.setUsername(<span class="string">"æµ‹è¯•ç”¨æˆ·"</span>);</span><br><span class="line">        order.setPid(product.getPid());</span><br><span class="line">        order.setPname(product.getPname());</span><br><span class="line">        order.setPprice(product.getPprice());</span><br><span class="line">        order.setNumber(<span class="number">1</span>);</span><br><span class="line">        orderService.save(order);</span><br><span class="line">   </span><br><span class="line">        <span class="comment">// ä¸‹å•å®Œæˆ, å‘é€æ¶ˆæ¯åˆ°ç”¨æˆ·å¾®æœåŠ¡</span></span><br><span class="line">        rocketMQTemplate.convertAndSend(<span class="string">"order-topic"</span>, order);</span><br><span class="line">   </span><br><span class="line">        <span class="keyword">return</span> order;</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"è´­ä¹°å¤±è´¥!"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸‹å•å®Œæˆåï¼Œå‘é€è®¢å•æ¶ˆæ¯åˆ°<code>RocketMQ</code></p>
</li>
</ol>
<p><strong>æ¶ˆæ¯æ¶ˆè´¹è€…: ç”¨æˆ·å¾®æœåŠ¡</strong></p>
<ol>
<li><p>åœ¨ç”¨æˆ·å¾®æœåŠ¡ä¸­æ·»åŠ <code>RocketMQ</code>ä¾èµ–ä»¥åŠ<code>spring boot rocket starter</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--nacoså®¢æˆ·ç«¯--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--rocketmq--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.rocketmq<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rocketmq-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.rocketmq<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rocketmq-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>ä¿®æ”¹ä¸»ç±»ï¼ŒåŠ å…¥<code>@@EnableDiscoveryClient</code>æ³¨è§£</p>
</li>
<li><p>ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼ŒåŠ å…¥<code>nacos</code>ä¸<code>RocketMQ</code>ç›¸å…³é…ç½®</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span> </span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    nacos:</span></span><br><span class="line"><span class="attr">      discovery:</span></span><br><span class="line"><span class="attr">        server-addr:</span> <span class="number">192.168</span><span class="number">.149</span><span class="number">.101</span><span class="string">:8848</span>  </span><br><span class="line"><span class="attr">rocketmq:</span></span><br><span class="line"><span class="attr">  name-server:</span> <span class="number">192.168</span><span class="number">.149</span><span class="number">.101</span><span class="string">:9876</span> <span class="comment">#rocketMQæœåŠ¡çš„åœ°å€</span></span><br><span class="line"><span class="attr">  producer:</span></span><br><span class="line"><span class="attr">    group:</span> <span class="string">shop-order</span> <span class="comment"># ç”Ÿäº§è€…ç»„</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>ç¼–å†™æ¶ˆæ¯æ¶ˆè´¹è€…ç±»</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.springcloud.alibaba.user.service;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.springcloud.alibaba.common.entity.Order;</span><br><span class="line"><span class="keyword">import</span> lombok.extern.slf4j.Slf4j;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.spring.annotation.RocketMQMessageListener;</span><br><span class="line"><span class="keyword">import</span> org.apache.rocketmq.spring.core.RocketMQListener;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@RocketMQMessageListener</span>(consumerGroup = <span class="string">"shop-user"</span>, topic = <span class="string">"order-topic"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SmsService</span> <span class="keyword">implements</span> <span class="title">RocketMQListener</span>&lt;<span class="title">Order</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onMessage</span><span class="params">(Order order)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">"æ”¶åˆ°è®¢å•æ¶ˆæ¯: &#123;&#125;"</span>, JSON.toJSONString(order));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>å¯åŠ¨è®¢å•ï¼Œäº§å“ï¼Œç”¨æˆ·å¾®æœåŠ¡ï¼Œè°ƒç”¨ä¸‹å•APIå¹¶è§‚å¯Ÿæ¶ˆæ¯æ¶ˆè´¹è¿‡ç¨‹</p>
</li>
</ol>
<h2 id="é…ç½®ä¸­å¿ƒï¼ˆNacos-Configï¼‰"><a href="#é…ç½®ä¸­å¿ƒï¼ˆNacos-Configï¼‰" class="headerlink" title="é…ç½®ä¸­å¿ƒï¼ˆNacos Configï¼‰"></a>é…ç½®ä¸­å¿ƒï¼ˆNacos Configï¼‰</h2><p>å¾®æœåŠ¡æ¶æ„ä¸‹å…³äºé…ç½®æ–‡ä»¶çš„ä¸€äº›é—®é¢˜ï¼š</p>
<ol>
<li>é…ç½®æ–‡ä»¶ç›¸å¯¹åˆ†æ•£ã€‚åœ¨ä¸€ä¸ªå¾®æœåŠ¡æ¶æ„ä¸‹ï¼Œé…ç½®æ–‡ä»¶ä¼šéšç€å¾®æœåŠ¡çš„å¢å¤šå˜çš„è¶Šæ¥è¶Šå¤šï¼Œè€Œä¸”åˆ†æ•£åœ¨å„ä¸ªå¾®æœåŠ¡ä¸­ï¼Œä¸å¥½ç»Ÿä¸€é…ç½®å’Œç®¡ç†ã€‚</li>
<li>é…ç½®æ–‡ä»¶æ— æ³•åŒºåˆ†ç¯å¢ƒã€‚å¾®æœåŠ¡é¡¹ç›®å¯èƒ½ä¼šæœ‰å¤šä¸ªç¯å¢ƒï¼Œä¾‹å¦‚ï¼šæµ‹è¯•ç¯å¢ƒã€é¢„å‘å¸ƒç¯å¢ƒã€ç”Ÿäº§ç¯å¢ƒã€‚æ¯ä¸€ä¸ªç¯å¢ƒæ‰€ä½¿ç”¨çš„é…ç½®ç†è®ºä¸Šéƒ½æ˜¯ä¸åŒçš„ï¼Œä¸€æ—¦éœ€è¦ä¿®æ”¹ï¼Œå°±éœ€è¦æˆ‘ä»¬å»å„ä¸ªå¾®æœåŠ¡ä¸‹æ‰‹åŠ¨ç»´æŠ¤ï¼Œè¿™æ¯”è¾ƒå›°éš¾ã€‚</li>
<li>é…ç½®æ–‡ä»¶æ— æ³•å®æ—¶æ›´æ–°ã€‚æˆ‘ä»¬ä¿®æ”¹äº†é…ç½®æ–‡ä»¶ä¹‹åï¼Œå¿…é¡»é‡æ–°å¯åŠ¨å¾®æœåŠ¡æ‰èƒ½ä½¿é…ç½®ç”Ÿæ•ˆï¼Œè¿™å¯¹ä¸€ä¸ªæ­£åœ¨è¿è¡Œçš„é¡¹ç›®æ¥è¯´æ˜¯éå¸¸ä¸å‹å¥½çš„ã€‚åŸºäºä¸Šé¢è¿™äº›é—®é¢˜ï¼Œæˆ‘ä»¬å°±éœ€è¦é…ç½®ä¸­å¿ƒçš„åŠ å…¥æ¥è§£å†³è¿™äº›é—®é¢˜ã€‚</li>
</ol>
<p>é…ç½®ä¸­å¿ƒçš„æ€è·¯æ˜¯ï¼š</p>
<ul>
<li>é¦–å…ˆæŠŠé¡¹ç›®ä¸­å„ç§é…ç½®å…¨éƒ¨éƒ½æ”¾åˆ°ä¸€ä¸ªé›†ä¸­çš„åœ°æ–¹è¿›è¡Œç»Ÿä¸€ç®¡ç†ï¼Œå¹¶æä¾›ä¸€å¥—æ ‡å‡†çš„æ¥å£ã€‚</li>
<li>å½“å„ä¸ªæœåŠ¡éœ€è¦è·å–é…ç½®çš„æ—¶å€™ï¼Œå°±æ¥é…ç½®ä¸­å¿ƒçš„æ¥å£æ‹‰å–è‡ªå·±çš„é…ç½®ã€‚</li>
<li>å½“é…ç½®ä¸­å¿ƒä¸­çš„å„ç§å‚æ•°æœ‰æ›´æ–°çš„æ—¶å€™ï¼Œä¹Ÿèƒ½é€šçŸ¥åˆ°å„ä¸ªæœåŠ¡å®æ—¶çš„è¿‡æ¥åŒæ­¥æœ€æ–°çš„ä¿¡æ¯ï¼Œä½¿ä¹‹åŠ¨æ€æ›´æ–°ã€‚ </li>
</ul>
<h3 id="åŸºæœ¬ä½¿ç”¨-1"><a href="#åŸºæœ¬ä½¿ç”¨-1" class="headerlink" title="åŸºæœ¬ä½¿ç”¨"></a>åŸºæœ¬ä½¿ç”¨</h3><ol>
<li><p>å®‰è£…Nacos</p>
</li>
<li><p>å¼•å…¥Nacos Configä¾èµ–</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>æ·»åŠ <code>bootstrap.conf</code>çš„é…ç½®æ–‡ä»¶</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">service-order</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    nacos:</span></span><br><span class="line"><span class="attr">      config:</span></span><br><span class="line"><span class="attr">        server-addr:</span> <span class="number">192.168</span><span class="number">.149</span><span class="number">.101</span><span class="string">:8848</span> <span class="comment">#nacosä¸­å¿ƒåœ°å€</span></span><br><span class="line"><span class="attr">        file-extension:</span> <span class="string">yaml</span> <span class="comment"># é…ç½®æ–‡ä»¶æ ¼å¼</span></span><br><span class="line"><span class="attr">  profiles:</span></span><br><span class="line"><span class="attr">    active:</span> <span class="string">dev</span> <span class="comment"># ç¯å¢ƒæ ‡è¯†</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>å¤åˆ¶åŸæœ‰çš„é…ç½®æ–‡ä»¶åœ¨nacosä¸­åˆ›å»ºå¯¹åº”çš„é…ç½®æ–‡ä»¶ï¼Œdata idä¸ºï¼š<code>service-order-dev.yaml</code></p>
<p><img src="https://imxushuai-blog.oss-cn-chengdu.aliyuncs.com/20211127185343.png" alt></p>
</li>
<li><p>ä¿®æ”¹åŸæœ‰çš„é…ç½®æ–‡ä»¶çš„åå­—ä¸º: <code>application.yml.bak</code>ï¼Œç„¶åå¯åŠ¨åº”ç”¨å¹¶è§‚å¯Ÿèƒ½å¦æˆåŠŸè¿è¡Œ</p>
</li>
</ol>
<h3 id="åŠ¨æ€æ›´æ–°é…ç½®"><a href="#åŠ¨æ€æ›´æ–°é…ç½®" class="headerlink" title="åŠ¨æ€æ›´æ–°é…ç½®"></a>åŠ¨æ€æ›´æ–°é…ç½®</h3><blockquote>
<p>å®ç°äº†é…ç½®çš„è¿œç¨‹å­˜æ”¾ï¼Œä½†æ˜¯æ­¤æ—¶å¦‚æœä¿®æ”¹äº†é…ç½®ï¼Œæˆ‘ä»¬çš„ç¨‹åºæ˜¯æ— æ³•è¯»å–åˆ°çš„ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦å¼€å¯é…ç½®çš„åŠ¨æ€åˆ·æ–°åŠŸèƒ½ã€‚</p>
</blockquote>
<ol>
<li><p>åœ¨nacosçš„é…ç½®æ–‡ä»¶ä¸­æ·»åŠ è‡ªå®šä¹‰çš„é…ç½®é¡¹ï¼Œç”¨äºæµ‹è¯•é…ç½®åŠ¨æ€åˆ·æ–°</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">app:</span></span><br><span class="line"><span class="attr">  customer:</span> <span class="string">test</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>ç¼–å†™controllerç±»ï¼Œæ–¹ä¾¿æµ‹è¯•æ›´æ–°é…ç½®åæŸ¥çœ‹æ˜¯å¦åŠ¨æ€åˆ·æ–°äº†æœ¬åœ°é…ç½®</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.springcloud.alibaba.order.controller;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Value;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RefreshScope</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestConfigRefreshController</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;app.customer&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String CUSTOMER;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"getCustomerConfig"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getCustomerConfig</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> CUSTOMER;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>æ³¨æ„ï¼š</p>
<ul>
<li>åˆ·æ–°é…ç½®çš„å…³é”®åœ¨äº: <code>@RefreshScope</code>æ³¨è§£ã€‚å¦‚æœæ²¡æœ‰æ­¤æ³¨è§£ï¼Œå°†ä¸ä¼šè‡ªåŠ¨åˆ·æ–°é…ç½®ã€‚</li>
<li>åªæœ‰è‡ªå®šä¹‰çš„é…ç½®é¡¹éœ€è¦æ‰‹åŠ¨åŠ å…¥<code>@RefreshScope</code>æ‰èƒ½åº”ç”¨è‡ªåŠ¨åˆ·æ–°é…ç½®ï¼Œç±»ä¼¼æ•°æ®åº“é…ç½®ç­‰ï¼Œæ— éœ€é…ç½®æ³¨è§£ä¼šè‡ªåŠ¨åˆ·æ–°é…ç½®ã€‚</li>
</ul>
</blockquote>
</li>
<li><p>å¯åŠ¨å¾®æœåŠ¡ï¼Œå…ˆè°ƒç”¨æŸ¥çœ‹CUSTOMERçš„å€¼ï¼Œç„¶åä¿®æ”¹nacosä¸­çš„å€¼å†æ¬¡æŸ¥çœ‹ã€‚è§‚å¯Ÿæ˜¯å¦åŠ¨æ€åˆ·æ–°ã€‚</p>
</li>
</ol>
<h3 id="é…ç½®å…±äº«"><a href="#é…ç½®å…±äº«" class="headerlink" title="é…ç½®å…±äº«"></a>é…ç½®å…±äº«</h3><blockquote>
<p>â€‹        åœ¨æ—¥å¸¸çš„å¼€å‘ä¸­åŸºæœ¬ä¸ŠåŒæ ·çš„ä¸€æ®µé…ç½®ï¼Œå¯èƒ½åœ¨å¾ˆå¤šå¾®æœåŠ¡ä¸­æˆ–è€…åŒä¸ªå¾®æœåŠ¡ä¸­çš„ä¸åŒç¯å¢ƒä¸­ç”¨åˆ°ï¼Œè¿™ä¸ªæ—¶å€™å¦‚æœè¿™ä¸€æ®µé…ç½®åœ¨æ¯ä¸ªé…ç½®æ–‡ä»¶ä¸­éƒ½å†™ä¸€éï¼Œå½“é…ç½®éœ€è¦å˜æ›´æ—¶ï¼Œå°±å¿…é¡»æ¯ä¸ªé…ç½®æ–‡ä»¶éƒ½æ”¹ä¸€éï¼Œè¿™æ˜¯éå¸¸çš„éº»çƒ¦çš„ã€‚æ‰€ä»¥æ˜¯å¦æœ‰åŠæ³•å°†åŒä¸€æ®µé…ç½®åœ¨ä¸€ä¸ªåœ°æ–¹å†™å¥½ï¼Œå…¶ä»–é…ç½®æ–‡ä»¶éƒ½å»å¼•ç”¨è¿™ä¸ªé…ç½®æ–‡ä»¶å‘¢ï¼Ÿ</p>
</blockquote>
<ol>
<li><p>åœ¨Nacosçš„é…ç½®ä¸­å¿ƒä¸­æ–°å»ºä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œå‘½åä»»æ„å¹¶å°†å…¬å…±çš„é…ç½®ä¿¡æ¯æ”¾å…¥è¯¥é…ç½®æ–‡ä»¶</p>
</li>
<li><p>ä¿®æ”¹è¦å¼•å…¥è¯¥å…¬å…±é…ç½®æ–‡ä»¶çš„<code>bootstrap.yml</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  application:</span></span><br><span class="line"><span class="attr">    name:</span> <span class="string">service-order</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    nacos:</span></span><br><span class="line"><span class="attr">      config:</span></span><br><span class="line"><span class="attr">        server-addr:</span> <span class="number">192.168</span><span class="number">.149</span><span class="number">.101</span><span class="string">:8848</span> <span class="comment">#nacosä¸­å¿ƒåœ°å€</span></span><br><span class="line"><span class="attr">        file-extension:</span> <span class="string">yaml</span> <span class="comment"># é…ç½®æ–‡ä»¶æ ¼å¼</span></span><br><span class="line">        <span class="comment">#æŒ‡å®šå…±äº«é…ç½®ï¼Œä¸”æ”¯æŒåŠ¨æ€åˆ·æ–°</span></span><br><span class="line"><span class="attr">        ext-config:</span></span><br><span class="line"><span class="attr">          - data-id:</span> <span class="string">datasource.yaml</span></span><br><span class="line"><span class="attr">            group:</span> <span class="string">DEFAULT_GROUP</span></span><br><span class="line"><span class="attr">            refresh:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">          - data-id:</span> <span class="string">common.yaml</span></span><br><span class="line"><span class="attr">            group:</span> <span class="string">DEFAULT_GROUP</span></span><br><span class="line"><span class="attr">            refresh:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">  profiles:</span></span><br><span class="line"><span class="attr">    active:</span> <span class="string">dev</span> <span class="comment"># ç¯å¢ƒæ ‡è¯†</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>å¯åŠ¨å¹¶è§‚å¯Ÿæ˜¯å¦æŒ‰ç…§è®¾ç½®çš„é…ç½®å¯åŠ¨äº†å¾®æœåŠ¡</p>
</li>
</ol>
<h2 id="åˆ†å¸ƒå¼äº‹åŠ¡ï¼ˆSeataï¼‰"><a href="#åˆ†å¸ƒå¼äº‹åŠ¡ï¼ˆSeataï¼‰" class="headerlink" title="åˆ†å¸ƒå¼äº‹åŠ¡ï¼ˆSeataï¼‰"></a>åˆ†å¸ƒå¼äº‹åŠ¡ï¼ˆSeataï¼‰</h2><blockquote>
<p>åˆ†å¸ƒå¼çš„åŸºç¡€ç†è®ºå°±ä¸åœ¨è¿™é‡Œåšä»‹ç»äº†ã€‚</p>
<p>æƒ³äº†è§£çš„å¯ä»¥çœ‹ä¸‹æˆ‘çš„è¿™ç¯‡æ–‡ç« ï¼š<a href="https://www.imxushuai.com/2020/07/01/34.%E5%AD%A6%E6%88%90%E5%9C%A8%E7%BA%BF%E7%AC%94%E8%AE%B0%E5%8D%81%E4%BA%94%EF%BC%9A%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1-%E5%AE%8C%E7%BB%93/#%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1">åˆ†å¸ƒå¼äº‹åŠ¡</a></p>
</blockquote>
<h3 id="å®‰è£…Seata"><a href="#å®‰è£…Seata" class="headerlink" title="å®‰è£…Seata"></a>å®‰è£…Seata</h3><ol>
<li><p>ä¸‹è½½seataï¼Œè®¿é—®ï¼š<a href="https://github.com/seata/seata/releases" target="_blank" rel="noopener">https://github.com/seata/seata/releases</a>ï¼Œä¸‹è½½å¯¹åº”ç³»ç»Ÿçš„å®‰è£…åŒ…</p>
<p>æˆ‘è¿™é‡Œç”¨çš„ç‰ˆæœ¬ä¸ºï¼šseata 0.9.0</p>
</li>
<li><p>è§£å‹ç¼©å®‰è£…åŒ…</p>
</li>
<li><p>é…ç½®seata</p>
<ul>
<li><p>ä¿®æ”¹registry.conf</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">registry &#123;</span><br><span class="line">  # file ã€nacos ã€eurekaã€redisã€zkã€consulã€etcd3ã€sofa</span><br><span class="line">  type = &quot;nacos&quot;</span><br><span class="line"></span><br><span class="line">  nacos &#123;</span><br><span class="line">    serverAddr = &quot;192.168.149.101&quot;</span><br><span class="line">    namespace = &quot;&quot;</span><br><span class="line">    cluster = &quot;default&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">config &#123;</span><br><span class="line">  # fileã€nacos ã€apolloã€zkã€consulã€etcd3</span><br><span class="line">  type = &quot;nacos&quot;</span><br><span class="line"></span><br><span class="line">  nacos &#123;</span><br><span class="line">    serverAddr = &quot;192.168.149.101&quot;</span><br><span class="line">    namespace = &quot;&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>åœ¨å®‰è£…ç›®å½•åˆ›å»ºnacos-config.txtå¹¶ç²˜è´´ä¸‹æ–¹å†…å®¹</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">transport.type=TCP</span><br><span class="line">transport.server=NIO</span><br><span class="line">transport.heartbeat=true</span><br><span class="line">transport.thread-factory.boss-thread-prefix=NettyBoss</span><br><span class="line">transport.thread-factory.worker-thread-prefix=NettyServerNIOWorker</span><br><span class="line">transport.thread-factory.server-executor-thread-prefix=NettyServerBizHandler</span><br><span class="line">transport.thread-factory.share-boss-worker=false</span><br><span class="line">transport.thread-factory.client-selector-thread-prefix=NettyClientSelector</span><br><span class="line">transport.thread-factory.client-selector-thread-size=1</span><br><span class="line">transport.thread-factory.client-worker-thread-prefix=NettyClientWorkerThread</span><br><span class="line">transport.thread-factory.boss-thread-size=1</span><br><span class="line">transport.thread-factory.worker-thread-size=8</span><br><span class="line">transport.shutdown.wait=3</span><br><span class="line">service.vgroup_mapping.service-order=default</span><br><span class="line">service.vgroup_mapping.service-product=default</span><br><span class="line">service.enableDegrade=false</span><br><span class="line">service.disable=false</span><br><span class="line">service.max.commit.retry.timeout=-1</span><br><span class="line">service.max.rollback.retry.timeout=-1</span><br><span class="line">client.async.commit.buffer.limit=10000</span><br><span class="line">client.lock.retry.internal=10</span><br><span class="line">client.lock.retry.times=30</span><br><span class="line">client.lock.retry.policy.branch-rollback-on-conflict=true</span><br><span class="line">client.table.meta.check.enable=true</span><br><span class="line">client.report.retry.count=5</span><br><span class="line">client.tm.commit.retry.count=1</span><br><span class="line">client.tm.rollback.retry.count=1</span><br><span class="line">store.mode=file</span><br><span class="line">store.file.dir=file_store/data</span><br><span class="line">store.file.max-branch-session-size=16384</span><br><span class="line">store.file.max-global-session-size=512</span><br><span class="line">store.file.file-write-buffer-cache-size=16384</span><br><span class="line">store.file.flush-disk-mode=async</span><br><span class="line">store.file.session.reload.read_size=100</span><br><span class="line">store.db.datasource=dbcp</span><br><span class="line">store.db.db-type=mysql</span><br><span class="line">store.db.driver-class-name=com.mysql.jdbc.Driver</span><br><span class="line">store.db.url=jdbc:mysql://127.0.0.1:3306/seata?useUnicode=true</span><br><span class="line">store.db.user=root</span><br><span class="line">store.db.password=123456</span><br><span class="line">store.db.min-conn=1</span><br><span class="line">store.db.max-conn=3</span><br><span class="line">store.db.global.table=global_table</span><br><span class="line">store.db.branch.table=branch_table</span><br><span class="line">store.db.query-limit=100</span><br><span class="line">store.db.lock-table=lock_table</span><br><span class="line">recovery.committing-retry-period=1000</span><br><span class="line">recovery.asyn-committing-retry-period=1000</span><br><span class="line">recovery.rollbacking-retry-period=1000</span><br><span class="line">recovery.timeout-retry-period=1000</span><br><span class="line">transaction.undo.data.validation=true</span><br><span class="line">transaction.undo.log.serialization=jackson</span><br><span class="line">transaction.undo.log.save.days=7</span><br><span class="line">transaction.undo.log.delete.period=86400000</span><br><span class="line">transaction.undo.log.table=undo_log</span><br><span class="line">transport.serialization=seata</span><br><span class="line">transport.compressor=none</span><br><span class="line">metrics.enabled=false</span><br><span class="line">metrics.registry-type=compact</span><br><span class="line">metrics.exporter-list=prometheus</span><br><span class="line">metrics.exporter-prometheus-port=9898</span><br><span class="line">support.spring.datasource.autoproxy=false</span><br></pre></td></tr></table></figure>
<p>éœ€è¦ä¿®æ”¹çš„ç‚¹ï¼š</p>
<ul>
<li><p>æ·»åŠ äº‹åŠ¡ç»„ï¼Œå’Œå¾…ä¼šä»£ç ä¸­é…ç½®çš„åç§°æœ‰å…³ï¼Œéœ€è¦å’Œorder-serviceå’Œproduct-serviceä¸€è‡´</p>
<p>service.vgroup_mapping.service-order=default<br>service.vgroup_mapping.service-product=default</p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>åœ¨ä¸šåŠ¡æ•°æ®åº“ä¸­åˆ›å»ºæ•°æ®è¡¨</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> <span class="string">`undo_log`</span></span><br><span class="line">(</span><br><span class="line">    <span class="string">`branch_id`</span>     <span class="built_in">BIGINT</span>       <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'branch transaction id'</span>,</span><br><span class="line">    <span class="string">`xid`</span>           <span class="built_in">VARCHAR</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'global transaction id'</span>,</span><br><span class="line">    <span class="string">`context`</span>       <span class="built_in">VARCHAR</span>(<span class="number">128</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'undo_log context,such as serialization'</span>,</span><br><span class="line">    <span class="string">`rollback_info`</span> LONGBLOB     <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'rollback info'</span>,</span><br><span class="line">    <span class="string">`log_status`</span>    <span class="built_in">INT</span>(<span class="number">11</span>)      <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'0:normal status,1:defense status'</span>,</span><br><span class="line">    <span class="string">`log_created`</span>   DATETIME(<span class="number">6</span>)  <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'create datetime'</span>,</span><br><span class="line">    <span class="string">`log_modified`</span>  DATETIME(<span class="number">6</span>)  <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'modify datetime'</span>,</span><br><span class="line">    <span class="keyword">UNIQUE</span> <span class="keyword">KEY</span> <span class="string">`ux_undo_log`</span> (<span class="string">`xid`</span>, <span class="string">`branch_id`</span>)</span><br><span class="line">    ) <span class="keyword">ENGINE</span> = <span class="keyword">INNODB</span></span><br><span class="line">    AUTO_INCREMENT = <span class="number">1</span></span><br><span class="line">    <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span> = utf8 <span class="keyword">COMMENT</span> =<span class="string">'AT transaction mode undo table'</span>;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<ol start="5">
<li><p>æ‰§è¡Œè„šæœ¬å°†<code>seata</code>çš„é…ç½®å¯¼å…¥<code>nacos</code>ä¸­</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> å‘½ä»¤è§£æï¼š-h -p æŒ‡å®šnacosçš„ç«¯å£åœ°å€ï¼›-g æŒ‡å®šé…ç½®çš„åˆ†ç»„ï¼Œæ³¨æ„ï¼Œæ˜¯é…ç½®çš„åˆ†ç»„ï¼›-t æŒ‡å®šå‘½åç©ºé—´idï¼› -u -wæŒ‡å®šnacosçš„ç”¨æˆ·åå’Œå¯†ç ï¼ŒåŒæ ·ï¼Œè¿™é‡Œå¼€å¯äº†nacosæ³¨å†Œå’Œé…ç½®è®¤è¯çš„æ‰éœ€è¦æŒ‡å®šã€‚</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> sh nacos-config.sh -h localhost -p 8848 -g SEATA_GROUP -t 0af6e97b-a684-4647-b696-7c6d42aecce7 -u nacos -w nacos</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> æˆ‘è¿™é‡Œå°±å…¨éƒ¨ä½¿ç”¨é»˜è®¤çš„é…ç½®ï¼Œé»˜è®¤ä¼šå°†seataé…ç½®å…¨éƒ¨å¯¼å…¥åˆ°publicå·¥ä½œç©ºé—´ä¸­</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> æ³¨æ„ï¼Œå¦‚æœæ˜¯åœ¨windosç¯å¢ƒä¸­éœ€è¦ç”¨èƒ½å¤Ÿè¿è¡Œshå‘½ä»¤çš„å®¢æˆ·ç«¯ï¼Œæ¯”å¦‚ï¼šgit bash</span></span><br><span class="line">./nacos-config.sh 192.168.149.101</span><br></pre></td></tr></table></figure>
</li>
<li><p>å¯åŠ¨<code>seata</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> windows, åœ¨binç›®å½•ä¸­æ‰§è¡Œ</span></span><br><span class="line">seata-server.bat -p 9000 -m file</span><br><span class="line"><span class="meta">#</span><span class="bash"> linux, åœ¨binç›®å½•ä¸­æ‰§è¡Œ</span></span><br><span class="line">./seata-server.sh -p 9000 -m file</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># å¯ä»¥ä½¿ç”¨ -p æŒ‡å®šseataè¿è¡Œçš„ç«¯å£</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p>å¯ä»¥åœ¨<code>nacos</code>çš„æœåŠ¡åˆ—è¡¨ä¸­çœ‹åˆ°<code>serverAddr</code>çš„æœåŠ¡ï¼Œè¯´æ˜å¯åŠ¨æˆåŠŸ</p>
</li>
</ol>
<h3 id="å¾®æœåŠ¡é…ç½®Seata"><a href="#å¾®æœåŠ¡é…ç½®Seata" class="headerlink" title="å¾®æœåŠ¡é…ç½®Seata"></a>å¾®æœåŠ¡é…ç½®Seata</h3><ol>
<li><p>å¼•å…¥ä¾èµ–ï¼Œ<code>order-service</code>ä¸<code>product-service</code>ä¸­éƒ½éœ€è¦å¼•å…¥</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-seata<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>é…ç½®<code>seata</code>ï¼Œ<code>order-service</code>ä¸<code>product-service</code>ä¸­éƒ½éœ€è¦é…ç½®</p>
<ul>
<li><p>order-serviceçš„bootstrap.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    alibaba:</span></span><br><span class="line"><span class="attr">      seata:</span></span><br><span class="line"><span class="attr">        tx-service-group:</span> <span class="string">service-order</span>  <span class="comment">#è¦ä¸é…ç½®æ–‡ä»¶ä¸­çš„vgroupMappingä¸€è‡´</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>product-serviceçš„bootstrap.yml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line"><span class="attr">  cloud:</span></span><br><span class="line"><span class="attr">    alibaba:</span></span><br><span class="line"><span class="attr">      seata:</span></span><br><span class="line"><span class="attr">        tx-service-group:</span> <span class="string">service-product</span>  <span class="comment">#è¦ä¸é…ç½®æ–‡ä»¶ä¸­çš„vgroupMappingä¸€è‡´</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>é…ç½®ä»£ç†æ•°æ®æº</p>
<p>Seata æ˜¯é€šè¿‡ä»£ç†æ•°æ®æºå®ç°äº‹åŠ¡åˆ†æ”¯çš„ï¼Œæ‰€ä»¥éœ€è¦é…ç½® io.seata.rm.datasource.DataSourceProxy çš„Beanï¼Œä¸”æ˜¯ @Primaryé»˜è®¤çš„æ•°æ®æºï¼Œå¦åˆ™äº‹åŠ¡ä¸ä¼šå›æ»šï¼Œæ— æ³•å®ç°åˆ†å¸ƒå¼äº‹åŠ¡ã€‚</p>
<p><code>order-service</code>å’Œ<code>product-service</code>éƒ½éœ€è¦é…ç½®</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.springcloud.alibaba.order.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.alibaba.druid.pool.DruidDataSource;</span><br><span class="line"><span class="keyword">import</span> io.seata.rm.datasource.DataSourceProxy;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.context.properties.ConfigurationProperties;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Primary;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataSourceProxyConfig</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@ConfigurationProperties</span>(prefix = <span class="string">"spring.datasource"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> DruidDataSource <span class="title">druidDataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DruidDataSource();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Primary</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataSourceProxy <span class="title">dataSource</span><span class="params">(DruidDataSource druidDataSource)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DataSourceProxy(druidDataSource);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>å¤åˆ¶<code>registry.conf</code>æ–‡ä»¶åˆ°<code>order-service</code>å’Œ<code>product-service</code>çš„resourcesç›®å½•ä¸­</p>
</li>
<li><p>é…ç½®å®Œæˆ</p>
</li>
</ol>
<h3 id="æ”¹é€ ä¸‹å•é€»è¾‘"><a href="#æ”¹é€ ä¸‹å•é€»è¾‘" class="headerlink" title="æ”¹é€ ä¸‹å•é€»è¾‘"></a>æ”¹é€ ä¸‹å•é€»è¾‘</h3><ol>
<li><p>åœ¨<code>product-service</code>ä¸­çš„æ–°å¢APIç”¨äºæ‰£å‡åº“å­˜</p>
<ul>
<li><p>productServiceï¼Œæ–°å¢æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reduceInventory</span><span class="params">(Integer pid, <span class="keyword">int</span> num)</span> </span>&#123;</span><br><span class="line">    Product product = <span class="keyword">this</span>.findByPid(pid);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å‘ç”Ÿå¼‚å¸¸</span></span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">1</span>/<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    product.setStock(product.getStock() - num);</span><br><span class="line">    productRepository.save(product);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>productControllerï¼Œæ–°å¢API</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"product/reduceInventory"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reduceInventory</span><span class="params">(@RequestParam Integer pid, @RequestParam <span class="keyword">int</span> num)</span> </span>&#123;</span><br><span class="line">    productService.reduceInventory(pid, num);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>åœ¨<code>order-service</code>ä¸­çš„<code>ProductClient</code>æ–°å¢API</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"product/reduceInventory"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reduceInventory</span><span class="params">(@RequestParam Integer pid, @RequestParam <span class="keyword">int</span> num)</span></span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>order-service</code>ä¸­çš„<code>OrderService</code>æ–°å¢æ–¹æ³•</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> ProductClient productClient;</span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RocketMQTemplate rocketMQTemplate;</span><br><span class="line">   </span><br><span class="line"><span class="meta">@GlobalTransactional</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Order <span class="title">createOrder</span><span class="params">(Integer pid)</span> </span>&#123;</span><br><span class="line">    log.info(<span class="string">"&gt;&gt; å®¢æˆ·ä¸‹å•ï¼Œè¿™æ—¶å€™è¦è°ƒç”¨å•†å“å¾®æœåŠ¡æŸ¥è¯¢å•†å“ä¿¡æ¯"</span>);</span><br><span class="line">    <span class="comment">// é€šè¿‡Feignå®¢æˆ·ç«¯è°ƒç”¨</span></span><br><span class="line">    Product product = productClient.findById(pid);</span><br><span class="line">   </span><br><span class="line">    <span class="keyword">if</span> (product != <span class="keyword">null</span>) &#123;</span><br><span class="line">        log.info(<span class="string">"&gt;&gt; å•†å“ä¿¡æ¯,æŸ¥è¯¢ç»“æœ: &#123;&#125;"</span>, JSON.toJSONString(product));</span><br><span class="line">        Order order = <span class="keyword">new</span> Order();</span><br><span class="line">        order.setUid(<span class="number">1</span>);</span><br><span class="line">        order.setUsername(<span class="string">"æµ‹è¯•ç”¨æˆ·"</span>);</span><br><span class="line">        order.setPid(product.getPid());</span><br><span class="line">        order.setPname(product.getPname());</span><br><span class="line">        order.setPprice(product.getPprice());</span><br><span class="line">        order.setNumber(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">this</span>.save(order);</span><br><span class="line">   </span><br><span class="line">        <span class="comment">// å‡å°‘åº“å­˜</span></span><br><span class="line">        productClient.reduceInventory(pid, order.getNumber());</span><br><span class="line">   </span><br><span class="line">        <span class="comment">// ä¸‹å•å®Œæˆ, å‘é€æ¶ˆæ¯åˆ°ç”¨æˆ·å¾®æœåŠ¡</span></span><br><span class="line">        rocketMQTemplate.convertAndSend(<span class="string">"order-topic"</span>, order);</span><br><span class="line">   </span><br><span class="line">        <span class="keyword">return</span> order;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨æ–¹æ³•ä¸ŠåŠ ä¸Š<code>@GlobalTransactional</code>åï¼Œåˆ†å¸ƒå¼äº‹åŠ¡å°±ä¼šç”Ÿæ•ˆï¼Œæµ‹è¯•æ—¶ï¼Œå¯ä»¥å…ˆä½¿ç”¨æ™®é€šçš„<code>@Transactional</code>æ³¨è§£å¯¹æ¯”äº‹åŠ¡æ˜¯å¦ç”Ÿæ•ˆã€‚</p>
</li>
<li><p>ä¿®æ”¹<code>order-service</code>ä¸­çš„<code>OrderController</code>çš„ä¸‹å•API</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å‡†å¤‡ä¹°1ä»¶å•†å“</span></span><br><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"/order/prod/&#123;pid&#125;"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Order <span class="title">order</span><span class="params">(@PathVariable(<span class="string">"pid"</span>)</span> Integer pid) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> orderService.createOrder(pid);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>è°ƒç”¨ä¸‹å•APIè§‚å¯Ÿåˆ†å¸ƒå¼äº‹åŠ¡ç”Ÿæ•ˆæƒ…å†µ</p>
</li>
</ol>
<h1 id="ç»“è¯­"><a href="#ç»“è¯­" class="headerlink" title="ç»“è¯­"></a>ç»“è¯­</h1><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>â€‹        <code>Spring Cloud Alibaba</code>åœ¨å›½å†…çš„ä½¿ç”¨ç‡è¿˜ç®—ä¸é”™ï¼Œå»å¹´ä¹Ÿç”¨<code>Spring Cloud Alibaba</code>å®Œæˆäº†å®æˆ˜ä½¿ç”¨ï¼Œç”¨åœ¨äº† å››å·é˜²æ±›äº‘å¹³å°ï¼ˆçœçº§é¡¹ç›®ï¼‰ä¸Šï¼Œæ€»ä½“æ¥è¯´<code>Spring Cloud Alibaba</code>è¿˜æ˜¯æ¯”è¾ƒå¥½ç”¨çš„ï¼ŒæŠ€æœ¯æ ˆä¹Ÿæ…¢æ…¢å˜å¾—è¶Šæ¥è¶Šæˆç†Ÿï¼Œç¤¾åŒºä¹Ÿæ¯”è¾ƒæ´»è·ƒã€‚</p>
<h2 id="æ„Ÿè¨€"><a href="#æ„Ÿè¨€" class="headerlink" title="æ„Ÿè¨€"></a>æ„Ÿè¨€</h2><p>â€‹        æœ€è¿‘çš„ä¸€å¹´ï¼Œå¯¹æ¯”ä¹‹å‰æ„Ÿè§‰è‡ªå·±æœ‰ç‚¹æ‡ˆæ€ äº†ã€‚ä¸»è¦æ˜¯å·¥ä½œä¸Šæ¯”è¾ƒå¿™ï¼Œä¼‘æ¯æ—¶é—´æœ‰ç‚¹ç–²äºå­¦ä¹ äº†ï¼Œå¯¼è‡´è¿™ç¯‡æ–‡ç« å®Œç»“æ¨è¿Ÿäº†å·®ä¸å¤šåŠå¹´ã€‚å¸Œæœ›å°ä¼™ä¼´ä»¬åˆ«åƒæˆ‘è¿™æ ·ï¼ŒåŠ æ²¹åŠªåŠ›çš„å­¦ä¹ ï¼Œæ—©æ—¥å®ç°ç»æµè‡ªç”±ã€‚å†²å†²å†²ï¼ï¼ï¼</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">æ–‡ç« ä½œè€…: </span><span class="post-copyright-info"><a href="mailto:undefined">imxushuai</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">æ–‡ç« é“¾æ¥: </span><span class="post-copyright-info"><a href="https://www.imxushuai.com/2021/11/28/39.Spring-Cloud-Alibabaä»å…¥é—¨åˆ°ç²¾é€š/">https://www.imxushuai.com/2021/11/28/39.Spring-Cloud-Alibabaä»å…¥é—¨åˆ°ç²¾é€š/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">ç‰ˆæƒå£°æ˜: </span><span class="post-copyright-info">æœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ«å£°æ˜å¤–ï¼Œå‡é‡‡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> è®¸å¯åè®®ã€‚è½¬è½½è¯·æ³¨æ˜æ¥è‡ª <a href="https://www.imxushuai.com">imxushuai</a>ï¼</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Spring-Cloud/">Spring Cloud</a><a class="post-meta__tags" href="/tags/Spring-Cloud-Alibaba/">Spring Cloud Alibaba</a><a class="post-meta__tags" href="/tags/Nacos/">Nacos</a><a class="post-meta__tags" href="/tags/Nacos-Config/">Nacos Config</a><a class="post-meta__tags" href="/tags/Sentinel/">Sentinel</a><a class="post-meta__tags" href="/tags/Gateway/">Gateway</a><a class="post-meta__tags" href="/tags/Sleuth/">Sleuth</a><a class="post-meta__tags" href="/tags/Zipkin/">Zipkin</a><a class="post-meta__tags" href="/tags/RocketMQ/">RocketMQ</a><a class="post-meta__tags" href="/tags/Seata/">Seata</a></div><div class="post-qr-code"><div class="post-qr-code-item"><img class="post-qr-code__img" src="/img/alipay.jpg"><div class="post-qr-code__desc">æ”¯ä»˜å®æ‰“èµ</div></div><div class="post-qr-code-item"><img class="post-qr-code__img" src="/img/wechatpay.jpg"><div class="post-qr-code__desc">å¾®ä¿¡æ‰“èµ</div></div></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2021/12/13/40.CentOSæ›´æ–°OpenSSH/"><i class="fa fa-chevron-left">  </i><span>CentOSæ›´æ–°OpenSSH</span></a></div><div class="next-post pull-right"><a href="/2021/11/07/38.æ­å–œEDGå¤ºå† /"><span>æ­å–œEDGå¤ºå† </span><i class="fa fa-chevron-right"></i></a></div></nav><div id="gitalk-container"></div><script>var gitalk = new Gitalk({
  clientID: '5d894987ff69ff0ceb17',
  clientSecret: '411e2ea94ae376885bd6355986f98bf42462b8f3',
  repo: 'gitalk',
  owner: 'imxushuai',
  admin: 'imxushuai',
  id: md5(decodeURI(location.pathname)),
  language: 'zh-CN'
})
gitalk.render('gitalk-container')</script></div></div><footer class="footer-bg" style="background-image: url(https://imxushuai-blog.oss-cn-chengdu.aliyuncs.com/background.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2018 - 2022 By imxushuai</div><div class="framework-info"><span>é©±åŠ¨ - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>ä¸»é¢˜ - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv"><i class="fa fa-user"></i><span id="busuanzi_value_site_uv"></span><span></span></span><span class="footer-separator">|</span><span id="busuanzi_container_site_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_site_pv"></span><span></span></span></div><script>(function (T, h, i, n, k, P, a, g, e) {
    g = function () {
        P = h.createElement(i);
        a = h.getElementsByTagName(i)[0];
        P.src = k;
        P.charset = "utf-8";
        P.async = 1;
        a.parentNode.insertBefore(P, a)
    };
    T["ThinkPageWeatherWidgetObject"] = n;
    T[n] || (T[n] = function () {
        (T[n].q = T[n].q || []).push(arguments)
    });
    T[n].l = +new Date();
    if (T.attachEvent) {
        T.attachEvent("onload", g)
    } else {
        T.addEventListener("load", g, false)
    }
}(window, document, "script", "tpwidget", "//widget.seniverse.com/widget/chameleon.js"))</script><script>var showFlag = true;
var os = function() {var ua = navigator.userAgent,isWindowsPhone = /(?:Windows Phone)/.test(ua),isSymbian = /(?:SymbianOS)/.test(ua) || isWindowsPhone, isAndroid = /(?:Android)/.test(ua), isFireFox = /(?:Firefox)/.test(ua), isChrome = /(?:Chrome|CriOS)/.test(ua), isTablet = /(?:iPad|PlayBook)/.test(ua) || (isAndroid && !/(?:Mobile)/.test(ua)) || (isFireFox && /(?:Tablet)/.test(ua)), isPhone = /(?:iPhone)/.test(ua) && !isTablet, isPc = !isPhone && !isAndroid && !isSymbian;return {isTablet: isTablet, isPhone: isPhone, isAndroid : isAndroid, isPc : isPc};}();
if (os.isAndroid || os.isPhone) {
    showFlag = false;
}
tpwidget("init", {
    "flavor": "bubble",
    "location": "WM6N2PM3WY2K",
    "geolocation": "enabled",
    "position": "bottom-right",
    "margin": "17px 70px",
    "language": "auto",
    "unit": "c",
    "theme": "chameleon",
    "uid": "UEB839A1CD",
    "hash": "28ca33b0751401a8e994a76ed0e253cd"
})
if (showFlag) {
    tpwidget("show");
}
window.addEventListener("resize", function(){
    console.log(document.documentElement.clientWidth)
    if (document.documentElement.clientWidth < 1065) {
        console.log("false")
    } else {
        console.log("true")
    }
})</script></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.6.1"></script><script src="/js/fancybox.js?version=1.6.1"></script><script src="/js/sidebar.js?version=1.6.1"></script><script src="/js/copy.js?version=1.6.1"></script><script src="/js/fireworks.js?version=1.6.1"></script><script src="/js/transition.js?version=1.6.1"></script><script src="/js/scroll.js?version=1.6.1"></script><script src="/js/head.js?version=1.6.1"></script><script src="/js/search/algolia.js"></script><script>if(/Android|webOS|iPhone|iPod|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
}</script><div class="search-dialog" id="algolia-search"><div class="search-dialog__title" id="algolia-search-title">Algolia</div><div id="algolia-input-panel"><div id="algolia-search-input"></div></div><hr><div id="algolia-search-results"><div id="algolia-hits"></div><div id="algolia-pagination"></div><div id="algolia-stats"></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>